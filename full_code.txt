

================================================================
FILE PATH: C:\Users\User\chabad-trips\app\dashboard\contact\page.tsx
================================================================
"use client"

import React, { useState } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { Header } from '@/components/layout/Header'
import { Button } from '@/components/ui/Button'
import { Input } from '@/components/ui/Input'
import { Modal } from '@/components/ui/Modal'
import { Send, HelpCircle, Image as ImageIcon, X, AlertTriangle, Info, Loader2 } from 'lucide-react'

// ׳™׳™׳‘׳•׳ Hook ׳•-Zod
import { useUser } from '@/hooks/useUser'
import { contactSchema } from '@/lib/schemas'

export default function ContactPage() {
  // 1. ׳©׳™׳׳•׳© ׳‘-Hook
  const { user, loading: userLoading } = useUser('/');

  const [submitting, setSubmitting] = useState(false);
  
  // ׳ ׳™׳”׳•׳ ׳׳•׳“׳ ׳׳×׳•׳§׳
  const [modal, setModal] = useState({
      isOpen: false,
      type: 'info' as 'success' | 'error' | 'info' | 'confirm',
      title: '',
      message: '',
      onConfirm: undefined as (() => void) | undefined
  });

  const showModal = (type: 'success' | 'error' | 'info' | 'confirm', title: string, msg: string) => 
      setModal({ isOpen: true, type, title, message: msg, onConfirm: undefined });

  const [type, setType] = useState<'general' | 'bug'>('general');
  const [screenshot, setScreenshot] = useState<File | null>(null);
  const [previewUrl, setPreviewUrl] = useState<string | null>(null);
  const [formData, setFormData] = useState({ subject: '', message: '' });

  const handlePaste = (e: React.ClipboardEvent) => {
    const items = e.clipboardData.items;
    for (let i = 0; i < items.length; i++) {
      if (items[i].type.indexOf('image') !== -1) {
        const blob = items[i].getAsFile();
        if (blob) {
            setScreenshot(blob);
            setPreviewUrl(URL.createObjectURL(blob));
        }
      }
    }
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
      if (e.target.files && e.target.files[0]) {
          const file = e.target.files[0];
          setScreenshot(file);
          setPreviewUrl(URL.createObjectURL(file));
      }
  };

  const removeImage = () => {
      setScreenshot(null);
      setPreviewUrl(null);
  };

  const handleSubmit = async () => {
    // 2. ׳•׳׳™׳“׳¦׳™׳” ׳¢׳ Zod
    const validation = contactSchema.safeParse(formData);

    if (!validation.success) {
        showModal('error', '׳—׳¡׳¨׳™׳ ׳₪׳¨׳˜׳™׳', validation.error.issues[0].message);
        return;
    }

    setSubmitting(true);

    let imageUrl = null;

    // ׳”׳¢׳׳׳× ׳×׳׳•׳ ׳” ׳׳ ׳™׳©
    if (screenshot && user) {
        const fileName = `bugs/${user.id}_${Date.now()}.png`;
        const { error: uploadError } = await supabase.storage.from('trip-files').upload(fileName, screenshot);
        if (!uploadError) {
            const { data } = supabase.storage.from('trip-files').getPublicUrl(fileName);
            imageUrl = data.publicUrl;
        }
    }
    
    // ׳”׳¨׳›׳‘׳× ׳”׳”׳•׳“׳¢׳” ׳”׳¡׳•׳₪׳™׳×
    const finalMessage = imageUrl 
        ? `${formData.message}\n\n[׳¦׳•׳¨׳£ ׳¦׳™׳׳•׳ ׳׳¡׳]: ${imageUrl}`
        : formData.message;

    const { error } = await supabase.from('contact_messages').insert([{
        user_id: user?.id,
        subject: `[${type === 'bug' ? '׳×׳§׳׳”' : '׳₪׳ ׳™׳™׳”'}] ${formData.subject}`,
        message: finalMessage,
        status: 'new'
    }]);

    setSubmitting(false);

    if (error) {
        showModal('error', '׳©׳’׳™׳׳”', '׳׳™׳¨׳¢׳” ׳©׳’׳™׳׳” ׳‘׳©׳׳™׳—׳”: ' + error.message);
    } else {
        showModal('success', '׳ ׳©׳׳— ׳‘׳”׳¦׳׳—׳”', '׳”׳₪׳ ׳™׳™׳” ׳”׳×׳§׳‘׳׳” ׳•׳׳¡׳₪׳¨׳” ׳ ׳¨׳©׳ ׳‘׳׳¢׳¨׳›׳×.\n׳׳ ׳• ׳ ׳˜׳₪׳ ׳‘׳” ׳‘׳”׳§׳“׳.');
        setFormData({ subject: '', message: '' });
        removeImage();
    }
  };

  if (userLoading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-[#00BCD4]" size={40}/></div>;

  return (
    <>
      <Header title="׳¦׳•׳¨ ׳§׳©׳¨ / ׳“׳™׳•׳•׳— ׳¢׳ ׳×׳§׳׳”" />
      <Modal 
        isOpen={modal.isOpen} 
        onClose={() => setModal({...modal, isOpen: false})} 
        type={modal.type} 
        title={modal.title} 
        message={modal.message} 
        onConfirm={modal.onConfirm}
      />

      <div className="max-w-3xl mx-auto p-4 md:p-8 animate-fadeIn pb-32">
         <div className="bg-white rounded-[32px] border border-gray-200 p-6 md:p-8 shadow-sm text-center md:text-right">
             
             <div className="flex flex-col sm:flex-row gap-4 mb-6">
                 <button 
                    onClick={() => setType('general')}
                    className={`flex-1 py-4 rounded-2xl border-2 flex flex-col items-center gap-2 transition-all font-bold
                    ${type === 'general' ? 'border-[#00BCD4] bg-cyan-50 text-[#00BCD4]' : 'border-gray-100 text-gray-400 hover:bg-gray-50'}`}
                 >
                     <HelpCircle size={28}/>
                     ׳©׳׳׳” ׳›׳׳׳™׳×
                 </button>
                 <button 
                    onClick={() => setType('bug')}
                    className={`flex-1 py-4 rounded-2xl border-2 flex flex-col items-center gap-2 transition-all font-bold
                    ${type === 'bug' ? 'border-[#E91E63] bg-pink-50 text-[#E91E63]' : 'border-gray-100 text-gray-400 hover:bg-gray-50'}`}
                 >
                     <AlertTriangle size={28}/>
                     ׳“׳™׳•׳•׳— ׳¢׳ ׳×׳§׳׳”
                 </button>
             </div>

             <div className="space-y-6">
                 {type === 'bug' && (
                    <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-4 flex items-start gap-3 animate-fadeIn text-right">
                        <Info size={22} className="text-yellow-600 shrink-0 mt-0.5"/>
                        <div>
                            <p className="text-sm font-bold text-yellow-800 mb-1">׳׳™׳ ׳׳“׳•׳•׳—׳™׳ ׳¢׳ ׳×׳§׳׳” ׳‘׳™׳¢׳™׳׳•׳×?</p>
                            <ul className="text-xs text-yellow-700 list-disc list-inside leading-relaxed space-y-1">
                                <li>׳—׳•׳‘׳” ׳׳¦׳¨׳£ <b>׳¦׳™׳׳•׳ ׳׳¡׳</b> ׳©׳ ׳”׳‘׳¢׳™׳” (׳ ׳™׳×׳ ׳׳”׳¢׳׳•׳× ׳§׳•׳‘׳¥ ׳׳• ׳׳”׳“׳‘׳™׳§).</li>
                                <li>׳—׳•׳‘׳” ׳׳”׳•׳¡׳™׳£ <b>׳”׳¡׳‘׳¨ ׳׳™׳׳•׳׳™</b>: ׳׳” ׳ ׳™׳¡׳™׳×׳ ׳׳¢׳©׳•׳×? ׳•׳׳” ׳§׳¨׳” ׳‘׳₪׳•׳¢׳?</li>
                            </ul>
                        </div>
                    </div>
                 )}

                 <Input 
                    label="׳ ׳•׳©׳" 
                    placeholder={type === 'bug' ? "׳‘׳§׳¦׳¨׳”: ׳׳” ׳”׳‘׳¢׳™׳”?" : "׳‘׳ ׳•׳©׳..."}
                    value={formData.subject}
                    onChange={(e: any) => setFormData({...formData, subject: e.target.value})}
                 />

                 <div>
                     <label className="text-xs font-bold text-gray-500 mb-1.5 mr-1 block text-right">
                        {type === 'bug' ? '׳×׳™׳׳•׳¨ ׳”׳×׳§׳׳” ׳•׳”׳“׳‘׳§׳× ׳¦׳™׳׳•׳ ׳׳¡׳' : '׳×׳•׳›׳ ׳”׳”׳•׳“׳¢׳”'}
                     </label>
                     <div className="relative">
                        <textarea 
                            className="w-full p-4 rounded-xl border border-gray-200 outline-none focus:border-[#E91E63] focus:ring-1 focus:ring-[#E91E63] min-h-[150px] resize-none text-base md:text-sm font-medium bg-white transition-all text-right"
                            placeholder={type === 'bug' ? "׳׳ ׳ ׳₪׳¨׳˜׳• ׳›׳׳ ׳׳× ׳”׳©׳׳‘׳™׳ ׳©׳’׳¨׳׳• ׳׳×׳§׳׳”...\n\n(׳ ׳™׳×׳ ׳׳”׳“׳‘׳™׳§ ׳›׳׳ ׳¦׳™׳׳•׳ ׳׳¡׳ ׳׳• ׳׳‘׳—׳•׳¨ ׳§׳•׳‘׳¥)" : "׳×׳•׳›׳ ׳”׳₪׳ ׳™׳™׳”..."}
                            value={formData.message}
                            onChange={e => setFormData({...formData, message: e.target.value})}
                            onPaste={handlePaste}
                        ></textarea>
                        
                        <label className="absolute bottom-3 left-3 text-gray-400 hover:text-[#E91E63] cursor-pointer p-3 bg-gray-50 rounded-lg shadow-sm border border-gray-200 transition-all active:scale-95" title="׳¦׳¨׳£ ׳§׳•׳‘׳¥ ׳×׳׳•׳ ׳”">
                            <ImageIcon size={22}/>
                            <input type="file" accept="image/*" className="hidden" onChange={handleFileChange}/>
                        </label>
                     </div>
                 </div>

                 {previewUrl && (
                     <div className="bg-gray-50 p-3 rounded-xl border border-gray-200 relative w-fit animate-fadeIn mx-auto md:mx-0">
                         <p className="text-xs font-bold text-gray-500 mb-2 flex items-center gap-1 justify-center md:justify-start"><ImageIcon size={12}/> ׳¦׳™׳׳•׳ ׳׳¡׳ ׳׳¦׳•׳¨׳£:</p>
                         <img src={previewUrl} alt="Screenshot" className="max-h-48 rounded-lg border border-gray-200 shadow-sm"/>
                         <button onClick={removeImage} className="absolute -top-2 -left-2 bg-white text-red-500 rounded-full p-2 shadow-md hover:bg-red-50 border border-gray-200 transition-all active:scale-95">
                             <X size={16}/>
                         </button>
                     </div>
                 )}

                 <div className="pt-4 flex flex-col-reverse md:flex-row items-center justify-end gap-4 border-t border-gray-100">
                     <Button 
                        onClick={handleSubmit} 
                        isLoading={submitting}
                        className={`w-full md:w-auto px-12 shadow-lg h-12 md:h-10 text-base md:text-sm ${type === 'bug' ? 'bg-[#E91E63] hover:bg-pink-600 shadow-pink-100' : 'bg-[#00BCD4] hover:bg-cyan-600 shadow-cyan-100'}`}
                        icon={<Send size={18}/>}
                     >
                         ׳©׳׳™׳—׳”
                     </Button>
                 </div>
             </div>
         </div>
      </div>
    </>
  )
}


================================================================
FILE PATH: C:\Users\User\chabad-trips\app\dashboard\inbox\page.tsx
================================================================
"use client"

import React, { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { Header } from '@/components/layout/Header'
import { Modal } from '@/components/ui/Modal'
import { 
  Bell, CheckCircle, AlertTriangle, Info, X, Clock, MailOpen, Trash2, Send, 
  ChevronDown, ChevronUp, Loader2, MessageCircle, HelpCircle, Wrench
} from 'lucide-react'

// ׳™׳™׳‘׳•׳ Hook
import { useUser } from '@/hooks/useUser'

// --- ׳₪׳•׳ ׳§׳¦׳™׳•׳× ׳¢׳–׳¨ (׳׳׳ ׳©׳™׳ ׳•׳™) ---
const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('he-IL', {
        day: 'numeric', month: 'numeric', year: '2-digit', hour: '2-digit', minute: '2-digit'
    });
};

const parseMessageSubject = (originalSubject: string) => {
    let type = 'general';
    let cleanSubject = originalSubject || '';

    if (cleanSubject.includes('׳×׳§׳׳”')) {
        type = 'bug';
        cleanSubject = cleanSubject.replace(/\[\s*׳×׳§׳׳”\s*\]/g, '').trim();
    } else if (cleanSubject.includes('׳₪׳ ׳™׳”') || cleanSubject.includes('׳₪׳ ׳™׳™׳”')) {
        type = 'general';
        cleanSubject = cleanSubject.replace(/\[\s*׳₪׳ ׳™׳”\s*\]/g, '').replace(/\[\s*׳₪׳ ׳™׳™׳”\s*\]/g, '').trim();
    }

    cleanSubject = cleanSubject.replace(/^[:\-\s]+/, '');
    return { type, cleanSubject };
};

export default function InboxPage() {
  // 1. ׳©׳™׳׳•׳© ׳‘-Hook
  const { user, loading: userLoading } = useUser('/');

  const [dataLoading, setDataLoading] = useState(true);
  const [activeTab, setActiveTab] = useState<'incoming' | 'outgoing'>('incoming');
  const [expandedId, setExpandedId] = useState<string | null>(null);
  
  const [notifications, setNotifications] = useState<any[]>([]); 
  const [sentMessages, setSentMessages] = useState<any[]>([]);

  // ׳׳•׳“׳ ׳’׳׳•׳‘׳׳™
  const [modal, setModal] = useState({
      isOpen: false,
      type: 'info' as 'success' | 'error' | 'info' | 'confirm',
      title: '',
      message: '',
      onConfirm: undefined as (() => void) | undefined
  });

  // 2. ׳˜׳¢׳™׳ ׳× ׳ ׳×׳•׳ ׳™׳ ׳×׳׳•׳™׳” ׳‘-User
  useEffect(() => {
    const fetchData = async () => {
        if (!user) return;

        try {
            // ׳˜׳¢׳™׳ ׳× ׳”׳×׳¨׳׳•׳× ׳ ׳›׳ ׳¡׳•׳×
            const { data: incomingData } = await supabase
                .from('notifications')
                .select('*')
                .eq('user_id', user.id)
                .order('created_at', { ascending: false });
            
            setNotifications(incomingData || []);

            // ׳˜׳¢׳™׳ ׳× ׳”׳•׳“׳¢׳•׳× ׳™׳•׳¦׳׳•׳×
            const { data: outgoingData } = await supabase
                .from('contact_messages')
                .select('*')
                .eq('user_id', user.id)
                .order('created_at', { ascending: false });
            
            setSentMessages(outgoingData || []);
        } catch (error) {
            console.error('Error fetching inbox data:', error);
        } finally {
            setDataLoading(false);
        }
    };

    if (!userLoading && user) {
        fetchData();
    }
  }, [user, userLoading]);

  const markAsRead = async (id: string) => {
      setNotifications(prev => prev.map(n => n.id === id ? { ...n, is_read: true } : n));
      await supabase.from('notifications').update({ is_read: true }).eq('id', id);
  };

  const deleteNotification = (id: string, e: React.MouseEvent) => {
      e.stopPropagation();
      setModal({
          isOpen: true,
          type: 'confirm',
          title: '׳׳—׳™׳§׳× ׳”׳•׳“׳¢׳”',
          message: '׳”׳׳ ׳׳׳—׳•׳§ ׳”׳•׳“׳¢׳” ׳–׳•?',
          onConfirm: async () => {
             setNotifications(prev => prev.filter(n => n.id !== id));
             await supabase.from('notifications').delete().eq('id', id);
             setModal(prev => ({ ...prev, isOpen: false }));
          }
      });
  };

  const toggleExpand = (id: string, isRead: boolean = true) => {
      if (expandedId === id) {
          setExpandedId(null);
      } else {
          setExpandedId(id);
          if (activeTab === 'incoming' && !isRead) {
              markAsRead(id);
          }
      }
  };

  const getIcon = (type: string) => {
      switch (type) {
          case 'success': return <CheckCircle size={20} className="text-green-500" />;
          case 'warning': return <AlertTriangle size={20} className="text-orange-500" />;
          case 'error': return <X size={20} className="text-red-500" />;
          default: return <Info size={20} className="text-[#00BCD4]" />;
      }
  };

  const getStatusBadge = (status: string) => {
      const styles: any = {
          new: "bg-blue-50 text-blue-600 border-blue-200",
          in_progress: "bg-orange-50 text-orange-600 border-orange-200",
          closed: "bg-green-50 text-green-600 border-green-200"
      };
      const labels: any = { new: '׳ ׳©׳׳—', in_progress: '׳‘׳˜׳™׳₪׳•׳', closed: '׳˜׳•׳₪׳' };
      return (
          <span className={`px-2 py-0.5 rounded text-xs font-bold border ${styles[status] || styles.new}`}>
              {labels[status] || '׳ ׳©׳׳—'}
          </span>
      );
  };

  // ׳‘׳“׳™׳§׳× ׳˜׳¢׳™׳ ׳” ׳׳©׳•׳׳‘׳×
  if (userLoading || dataLoading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-[#00BCD4]" size={40}/></div>;

  return (
    <>
      <Header title="׳”׳•׳“׳¢׳•׳× ׳•׳¢׳“׳›׳•׳ ׳™׳" />
      <Modal 
        isOpen={modal.isOpen} 
        onClose={() => setModal({...modal, isOpen: false})} 
        type={modal.type} 
        title={modal.title} 
        message={modal.message} 
        onConfirm={modal.onConfirm} 
      />

      <div className="max-w-5xl mx-auto p-4 md:p-8 animate-fadeIn pb-32">
        
        <div className="flex bg-gray-100 p-1.5 rounded-2xl w-full md:w-fit mb-6 mx-auto md:mx-0">
            <button 
                onClick={() => { setActiveTab('incoming'); setExpandedId(null); }}
                className={`flex-1 md:flex-none px-6 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2
                ${activeTab === 'incoming' ? 'bg-white text-[#00BCD4] shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
            >
                <Bell size={16}/>
                ׳“׳•׳׳¨ ׳ ׳›׳ ׳¡
                {notifications.filter(n => !n.is_read).length > 0 && (
                    <span className="bg-[#E91E63] text-white text-[10px] px-1.5 rounded-full min-w-[18px] h-[18px] flex items-center justify-center">
                        {notifications.filter(n => !n.is_read).length}
                    </span>
                )}
            </button>
            <button 
                onClick={() => { setActiveTab('outgoing'); setExpandedId(null); }}
                className={`flex-1 md:flex-none px-6 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2
                ${activeTab === 'outgoing' ? 'bg-white text-[#00BCD4] shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
            >
                <Send size={16}/>
                ׳₪׳ ׳™׳•׳× ׳©׳©׳׳—׳×׳™
            </button>
        </div>

        <div className="bg-white rounded-[24px] shadow-sm border border-gray-200 overflow-hidden min-h-[400px]">
            
            {activeTab === 'incoming' && (
                notifications.length === 0 ? (
                    <div className="flex flex-col items-center justify-center py-20 text-gray-400">
                        <MailOpen size={48} className="opacity-20 mb-4"/>
                        <p className="font-bold text-lg">׳׳™׳ ׳”׳•׳“׳¢׳•׳× ׳—׳“׳©׳•׳×</p>
                    </div>
                ) : (
                    <div className="divide-y divide-gray-100">
                        {notifications.map((note) => {
                            const isExpanded = expandedId === note.id;
                            return (
                                <div key={note.id} className={`transition-all hover:bg-gray-50 ${isExpanded ? 'bg-gray-50' : 'bg-white'}`}>
                                    <div 
                                        onClick={() => toggleExpand(note.id, note.is_read)}
                                        className={`p-4 flex items-center gap-4 cursor-pointer ${!note.is_read ? 'bg-cyan-50/30' : ''}`}
                                    >
                                        <div className="shrink-0">{getIcon(note.type)}</div>
                                        <div className="flex-1 min-w-0 grid grid-cols-1 md:grid-cols-12 gap-2 md:gap-4 items-center">
                                            <div className={`md:col-span-8 text-sm truncate ${!note.is_read ? 'text-gray-900 font-bold' : 'text-gray-600'}`}>
                                                {note.title}
                                            </div>
                                            <div className="md:col-span-4 text-xs text-gray-400 flex items-center justify-end gap-2">
                                                <span>{formatDate(note.created_at)}</span>
                                                {isExpanded ? <ChevronUp size={16}/> : <ChevronDown size={16}/>}
                                            </div>
                                        </div>
                                    </div>
                                    {isExpanded && (
                                        <div className="px-4 pb-6 pt-2 pl-12 border-t border-gray-100 animate-fadeIn">
                                            <p className="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">{note.message}</p>
                                            <div className="mt-4 flex items-center gap-3">
                                                {note.link && (
                                                    <a href={note.link} className="text-xs font-bold text-white bg-[#00BCD4] px-4 py-2 rounded-lg hover:bg-cyan-600 transition-colors">׳׳₪׳¨׳˜׳™׳ ׳ ׳•׳¡׳₪׳™׳</a>
                                                )}
                                                <button onClick={(e) => deleteNotification(note.id, e)} className="text-xs font-bold text-red-500 hover:bg-red-50 px-3 py-2 rounded-lg transition-colors flex items-center gap-1">
                                                    <Trash2 size={14}/> ׳׳—׳§ ׳”׳•׳“׳¢׳”
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                )
            )}

            {activeTab === 'outgoing' && (
                sentMessages.length === 0 ? (
                    <div className="flex flex-col items-center justify-center py-20 text-gray-400">
                        <Send size={48} className="opacity-20 mb-4"/>
                        <p className="font-bold text-lg">׳׳ ׳ ׳©׳׳—׳• ׳₪׳ ׳™׳•׳× ׳¢׳“׳™׳™׳</p>
                    </div>
                ) : (
                    <div className="divide-y divide-gray-100">
                        {sentMessages.map((msg) => {
                            const isExpanded = expandedId === msg.id;
                            const { cleanSubject } = parseMessageSubject(msg.subject);
                            // ׳–׳™׳”׳•׳™ ׳׳ ׳–׳• ׳×׳§׳׳” ׳׳₪׳™ ׳”׳›׳•׳×׳¨׳× ׳”׳׳§׳•׳¨׳™׳× ׳‘׳׳¡׳“ ׳”׳ ׳×׳•׳ ׳™׳
                            const isBug = msg.subject.includes('׳×׳§׳׳”');

                            return (
                                <div key={msg.id} className={`transition-all hover:bg-gray-50 relative overflow-hidden ${isExpanded ? 'bg-gray-50' : 'bg-white'}`}>
                                    
                                    <div className={`absolute top-0 right-0 px-3 py-1 rounded-bl-xl text-[10px] font-bold text-white flex items-center gap-1.5 shadow-sm z-10
                                        ${isBug ? 'bg-[#E91E63]' : 'bg-[#00BCD4]'}`}
                                    >
                                        {isBug ? <Wrench size={12}/> : <HelpCircle size={12}/>}
                                        {isBug ? '׳“׳™׳•׳•׳— ׳×׳§׳׳”' : '׳₪׳ ׳™׳™׳” ׳›׳׳׳™׳×'}
                                    </div>

                                    <div 
                                        onClick={() => toggleExpand(msg.id)}
                                        className="p-4 flex items-start gap-3 cursor-pointer"
                                    >
                                        <div className="shrink-0 w-16 mt-6">
                                            {getStatusBadge(msg.status)}
                                        </div>
                                        
                                        <div className="flex-1 min-w-0 grid grid-cols-1 md:grid-cols-12 gap-1 md:gap-4 items-center mt-6">
                                            <div className="md:col-span-8 text-sm font-bold text-gray-800 truncate">
                                                {cleanSubject}
                                            </div>
                                            <div className="md:col-span-4 text-xs text-gray-400 flex items-center justify-end gap-2">
                                                <span>{formatDate(msg.created_at)}</span>
                                                {isExpanded ? <ChevronUp size={16}/> : <ChevronDown size={16}/>}
                                            </div>
                                        </div>
                                    </div>

                                    {isExpanded && (
                                        <div className="px-4 pb-6 pt-2 pl-4 md:pl-12 border-t border-gray-100 animate-fadeIn space-y-4">
                                            <div className="bg-white p-4 rounded-xl border border-gray-100 relative">
                                                <div className="text-xs font-bold text-gray-400 mb-1">׳”׳•׳“׳¢׳” ׳©׳׳:</div>
                                                <p className="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">{msg.message}</p>
                                            </div>

                                            {msg.admin_reply && (
                                                <div className="bg-green-50 p-4 rounded-xl border border-green-100">
                                                    <div className="flex items-center gap-2 text-green-800 text-xs font-bold mb-2">
                                                        <MessageCircle size={14}/> ׳×׳©׳•׳‘׳× ׳”׳׳¢׳¨׳›׳×:
                                                    </div>
                                                    <p className="text-sm text-gray-800 leading-relaxed whitespace-pre-wrap">{msg.admin_reply}</p>
                                                </div>
                                            )}
                                            
                                            {!msg.admin_reply && msg.status !== 'closed' && (
                                                <div className="text-xs text-gray-400 italic flex items-center gap-1">
                                                    <Loader2 size={12} className="animate-spin"/>
                                                    ׳”׳₪׳ ׳™׳™׳” ׳‘׳˜׳™׳₪׳•׳, ׳˜׳¨׳ ׳”׳×׳§׳‘׳׳” ׳×׳©׳•׳‘׳”.
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                )
            )}
        </div>
      </div>
    </>
  )
}


================================================================
FILE PATH: C:\Users\User\chabad-trips\app\dashboard\my-trips\page.tsx
================================================================
"use client"

import React, { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { Header } from '@/components/layout/Header'
import { Loader2, Search, History, Trash2 } from 'lucide-react'
import { useRouter } from 'next/navigation'
import { TripCard } from '@/components/TripCard' 
import { MultiSelectFilter } from '@/components/ui/MultiSelectFilter'
import { Modal } from '@/components/ui/Modal'

// ׳™׳™׳‘׳•׳ Hook ׳•-Zod
import { useUser } from '@/hooks/useUser'
import { cancellationSchema } from '@/lib/schemas'

export default function MyTripsPage() {
  const router = useRouter();
  const { user, loading: userLoading } = useUser('/');

  const [tripsLoading, setTripsLoading] = useState(true);
  const [trips, setTrips] = useState<any[]>([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [activeFilter, setActiveFilter] = useState('all');
  const [selectedTypes, setSelectedTypes] = useState<string[]>([]);
  
  const [modal, setModal] = useState({
      isOpen: false,
      type: 'info' as 'success' | 'error' | 'info' | 'confirm',
      title: '',
      message: '',
      onConfirm: undefined as (() => void) | undefined,
      confirmText: '׳׳™׳©׳•׳¨',
      cancelText: '׳‘׳™׳˜׳•׳'
  });

  const [showCustomCancelModal, setShowCustomCancelModal] = useState(false);
  const [cancelReason, setCancelReason] = useState('');
  const [pendingTripId, setPendingTripId] = useState<string | null>(null);

  const filterOptions = [
      { id: "׳˜׳™׳•׳ ׳׳—׳•׳¥ ׳׳¡׳ ׳™׳£", label: "׳˜׳™׳•׳ ׳׳—׳•׳¥ ׳׳¡׳ ׳™׳£", color: "bg-[#4DD0E1]" },
      { id: "׳›׳ ׳¡/׳׳™׳¨׳•׳¢ ׳׳—׳•׳¥ ׳׳¡׳ ׳™׳£", label: "׳›׳ ׳¡/׳׳™׳¨׳•׳¢ ׳—׳•׳¥", color: "bg-[#BA68C8]" },
      { id: "׳₪׳¢׳™׳׳•׳× ׳׳ ׳©׳’׳¨׳×׳™׳× ׳‘׳¡׳ ׳™׳£", label: "׳₪׳¢׳™׳׳•׳× ׳‘׳¡׳ ׳™׳£", color: "bg-[#81C784]" },
      { id: "׳™׳¦׳™׳׳” ׳¨׳’׳׳™׳× ׳‘׳׳–׳•׳¨ ׳”׳¡׳ ׳™׳£", label: "׳™׳¦׳™׳׳” ׳¨׳’׳׳™׳×", color: "bg-[#FFB74D]" },
      { id: "׳׳—׳¨", label: "׳׳—׳¨", color: "bg-slate-400" }
  ];

  useEffect(() => {
    const fetchTrips = async () => {
        if (!user) return;
        try {
            const { data, error } = await supabase
                .from('trips')
                .select('*')
                .eq('user_id', user.id)
                .order('start_date', { ascending: false });
            
            if (error) throw error;
            setTrips(data || []);
        } catch (e) { 
            console.error('Error fetching trips:', e); 
        } finally { 
            setTripsLoading(false); 
        }
    };

    if (!userLoading && user) fetchTrips();
  }, [user, userLoading]);

  const handleDeleteDraftClick = (id: string) => {
      setPendingTripId(id);
      setModal({
          isOpen: true,
          type: 'confirm',
          title: '׳׳—׳™׳§׳× ׳˜׳™׳•׳˜׳”',
          message: '׳”׳׳ ׳׳׳—׳•׳§ ׳׳× ׳”׳˜׳™׳•׳˜׳” ׳׳¦׳׳™׳×׳•׳×?\n׳׳ ׳ ׳™׳×׳ ׳׳©׳—׳–׳¨ ׳₪׳¢׳•׳׳” ׳–׳•.',
          confirmText: '׳׳—׳§ ׳˜׳™׳•׳˜׳”',
          cancelText: '׳‘׳™׳˜׳•׳',
          onConfirm: () => executeDeleteDraft(id)
      });
  };

  const executeDeleteDraft = async (id: string) => {
      const { error } = await supabase.from('trips').delete().eq('id', id);
      if (!error) {
          setTrips(prev => prev.filter(t => t.id !== id));
          setModal(prev => ({...prev, isOpen: false}));
      } else {
          setModal({
              isOpen: true,
              type: 'error',
              title: '׳©׳’׳™׳׳”',
              message: '׳©׳’׳™׳׳” ׳‘׳׳—׳™׳§׳”: ' + error.message,
              confirmText: '׳¡׳’׳•׳¨',
              cancelText: '',
              onConfirm: undefined
          });
      }
  };

  const handleCancelClick = (id: string) => {
      setPendingTripId(id);
      setCancelReason('');
      setShowCustomCancelModal(true);
  };

  const executeCancelTrip = async () => {
      if (!pendingTripId) return;
      const validation = cancellationSchema.safeParse({ reason: cancelReason });
      if (!validation.success) {
          setModal({
              isOpen: true,
              type: 'error',
              title: '׳—׳¡׳¨ ׳₪׳™׳¨׳•׳˜',
              message: validation.error.issues[0].message,
              confirmText: '׳”׳‘׳ ׳×׳™',
              cancelText: '',
              onConfirm: undefined
          });
          return;
      }

      try {
          const trip = trips.find(t => t.id === pendingTripId);
          const updatedDetails = { ...trip.details, cancellationReason: cancelReason };
          
          const { error } = await supabase.from('trips').update({
              status: 'cancelled',
              cancellation_reason: cancelReason, 
              details: updatedDetails
          }).eq('id', pendingTripId);
          
          if (error) throw error;
          
          setTrips(prev => prev.map(t => t.id === pendingTripId ? {...t, status: 'cancelled', cancellation_reason: cancelReason, details: updatedDetails} : t));
          setShowCustomCancelModal(false);
          
          setModal({
              isOpen: true,
              type: 'success',
              title: '׳”׳₪׳¢׳™׳׳•׳× ׳‘׳•׳˜׳׳”',
              message: '׳”׳¡׳˜׳˜׳•׳¡ ׳¢׳•׳“׳›׳ ׳•׳”׳•׳“׳¢׳” ׳ ׳©׳׳—׳” ׳׳’׳•׳¨׳׳™׳ ׳”׳¨׳׳•׳•׳ ׳˜׳™׳™׳.',
              onConfirm: undefined,
              confirmText: '׳¡׳’׳•׳¨',
              cancelText: ''
          });

      } catch (e: any) { 
          setModal({
              isOpen: true,
              type: 'error',
              title: '׳©׳’׳™׳׳”',
              message: '׳׳ ׳ ׳™׳×׳ ׳”׳™׳” ׳׳‘׳˜׳ ׳׳× ׳”׳₪׳¢׳™׳׳•׳×: ' + e.message,
              onConfirm: undefined,
              confirmText: '׳¡׳’׳•׳¨',
              cancelText: ''
          });
      }
  };

  if (userLoading || tripsLoading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-[#00BCD4]" size={40}/></div>;

  const displayTrips = trips.filter(t => {
      const today = new Date();
      today.setHours(0,0,0,0);
      const tripDate = new Date(t.start_date);
      
      let matchesFilter = true;
      if (activeFilter === 'future') matchesFilter = tripDate >= today;
      else if (activeFilter === 'past') matchesFilter = tripDate < today;
      else if (activeFilter !== 'all') matchesFilter = t.status === activeFilter;

      const matchesType = selectedTypes.length === 0 
        ? true 
        : selectedTypes.includes(t.details?.tripType);

      const matchesSearch = t.name.toLowerCase().includes(searchTerm.toLowerCase());

      return matchesFilter && matchesType && matchesSearch;
  });

  return (
    <>
      <Header title="׳”׳˜׳™׳•׳׳™׳ ׳©׳׳™" />
      
      <Modal 
        isOpen={modal.isOpen} 
        onClose={() => setModal({...modal, isOpen: false})} 
        type={modal.type} 
        title={modal.title} 
        message={modal.message} 
        onConfirm={modal.onConfirm}
        confirmText={modal.confirmText}
        cancelText={modal.cancelText}
      />

      {showCustomCancelModal && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fadeIn">
              <div className="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-sm text-center border-t-4 border-red-500">
                  <div className="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4"><Trash2 size={32}/></div>
                  <h3 className="text-xl font-black text-gray-800 mb-2">׳‘׳™׳˜׳•׳ ׳₪׳¢׳™׳׳•׳×</h3>
                  <p className="text-sm text-gray-500 mb-4 font-medium leading-relaxed">׳”׳׳ ׳׳×/׳” ׳‘׳˜׳•׳—/׳”? <br/>׳₪׳¢׳•׳׳” ׳–׳• ׳×׳¢׳“׳›׳ ׳׳× ׳׳—׳׳§׳× ׳”׳׳₪׳¢׳׳™׳.</p>
                  <textarea 
                    className="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl text-sm mb-4 outline-none focus:border-red-400 min-h-[100px] resize-none" 
                    placeholder="׳—׳•׳‘׳” ׳׳₪׳¨׳˜ ׳׳× ׳¡׳™׳‘׳× ׳”׳‘׳™׳˜׳•׳..." 
                    value={cancelReason} 
                    onChange={e => setCancelReason(e.target.value)}
                  ></textarea>
                  <div className="flex gap-3">
                      <button onClick={() => setShowCustomCancelModal(false)} className="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl text-sm hover:bg-gray-200">׳—׳–׳¨׳”</button>
                      <button onClick={executeCancelTrip} className="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl text-sm hover:bg-red-600 shadow-lg shadow-red-100">׳׳©׳¨ ׳‘׳™׳˜׳•׳</button>
                  </div>
              </div>
          </div>
      )}

      {/* ׳×׳™׳§׳•׳: ׳”׳•׳¡׳₪׳×׳™ min-h-screen ׳›׳׳ */}
      <div className="p-4 md:p-8 space-y-6 animate-fadeIn pb-32 max-w-[100vw] overflow-x-hidden md:max-w-7xl md:mx-auto min-h-screen">
          <div className="space-y-4 pt-2">
              <div className="flex flex-col md:flex-row justify-between items-end gap-4">
                  <div className="flex gap-2 bg-white p-1.5 rounded-2xl border border-gray-100 w-full md:w-auto overflow-x-auto no-scrollbar shadow-sm">
                      {[
                          { id: 'all', label: '׳›׳ ׳”׳˜׳™׳•׳׳™׳' }, { id: 'future', label: '׳¢׳×׳™׳“׳™׳™׳' }, { id: 'past', label: '׳”׳™׳¡׳˜׳•׳¨׳™׳”' },
                          { id: 'draft', label: '׳˜׳™׳•׳˜׳•׳×' }, { id: 'approved', label: '׳׳•׳©׳¨' }, { id: 'pending', label: '׳‘׳‘׳“׳™׳§׳”' },
                          { id: 'rejected', label: '׳ ׳“׳—׳”' }, { id: 'cancelled', label: '׳‘׳•׳˜׳' },
                      ].map(f => {
                          const isActive = activeFilter === f.id;
                          return (<button key={f.id} onClick={() => setActiveFilter(f.id)} className={`px-4 py-2 rounded-xl text-xs font-bold transition-all whitespace-nowrap flex-1 md:flex-none ${isActive ? 'bg-[#00BCD4] text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'}`}>{f.label}</button>)
                      })}
                  </div>

                  {/* ׳”׳•׳¡׳₪׳× z-50 ׳›׳“׳™ ׳©׳”׳₪׳™׳׳˜׳¨ ׳™׳¢׳׳” ׳׳¢׳ ׳”׳›׳ */}
                  <div className="flex flex-col-reverse md:flex-row gap-2 w-full md:w-auto z-50">
                      <MultiSelectFilter 
                        options={filterOptions}
                        selected={selectedTypes}
                        onChange={setSelectedTypes}
                      />
                      <div className="relative flex-1 md:w-64">
                          <input type="text" placeholder="׳—׳™׳₪׳•׳©..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full pl-4 pr-10 py-3 bg-white border border-gray-200 rounded-2xl text-sm font-bold focus:border-[#00BCD4] outline-none transition-all shadow-sm focus:ring-4 focus:ring-cyan-50"/>
                          <Search className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400" size={18}/>
                      </div>
                  </div>
              </div>

              <div className="grid grid-cols-1 gap-4">
                  {displayTrips.length === 0 ? (
                      <div className="py-20 text-center bg-white rounded-3xl border border-dashed border-gray-200 flex flex-col items-center"><div className="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-3"><History size={24} className="text-gray-300"/></div><span className="text-gray-400 font-bold">׳׳ ׳ ׳׳¦׳׳• ׳₪׳¢׳™׳׳•׳™׳•׳×</span></div>
                  ) : displayTrips.map(trip => (
                      <TripCard 
                          key={trip.id} 
                          trip={trip} 
                          onDeleteDraft={() => handleDeleteDraftClick(trip.id)}
                          onCancelTrip={() => handleCancelClick(trip.id)}
                      />
                  ))}
              </div>
          </div>
      </div>
    </>
  )
}


================================================================
FILE PATH: C:\Users\User\chabad-trips\app\dashboard\new-trip\page.tsx
================================================================
"use client"

import React, { useState, useEffect, useRef, Suspense } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { Header } from '@/components/layout/Header'
import { Modal } from '@/components/ui/Modal'
import { Input } from '@/components/ui/Input'
import { 
  Calendar, MapPin, AlertTriangle, Save, CheckCircle, FileUp, 
  Flag, ChevronDown, ChevronUp, Lock, Unlock, Check, Trash2, Loader2, Link as LinkIcon,
  Home, ArrowRight, FileEdit, User, Phone, CreditCard, Mail, Plus, X, Briefcase, UserPlus, Edit2, MessageSquare
} from 'lucide-react'
import { useSearchParams, useRouter } from 'next/navigation'

import { 
    ISRAEL_CITIES, GRADES, STAFF_AGES, TRIP_LOGIC, 
    TRIP_TYPES_CONFIG, CATEGORIES, getColorHex 
} from '@/lib/constants'
import { getHebrewDateString } from '@/lib/dateUtils'

// ׳™׳™׳‘׳•׳ Hook ׳•-Zod
import { useUser } from '@/hooks/useUser'
import { tripGeneralSchema, tripLineSchema, staffSchema } from '@/lib/schemas'

function NewTripContent() {
  const router = useRouter();
  
  // 1. ׳©׳™׳׳•׳© ׳‘-Hook
  const { user, profile, loading: userLoading } = useUser('/'); 

  const [loading, setLoading] = useState(false);
  const [step, setStep] = useState(0); 
  const [userGender, setUserGender] = useState<'male' | 'female' | 'mixed'>('mixed');
  const searchParams = useSearchParams();
  const editId = searchParams.get('id');
  
  const [isOtherSelected, setIsOtherSelected] = useState(false);
  const [tempOtherType, setTempOtherType] = useState('');

  // ׳׳•׳“׳ ׳’׳׳•׳‘׳׳™
  const [modal, setModal] = useState({
      isOpen: false,
      type: 'info' as 'success' | 'error' | 'info' | 'confirm',
      title: '', 
      message: '',
      onConfirm: undefined as (() => void) | undefined
  });

  const showModal = (type: 'success' | 'error' | 'info' | 'confirm', title: string, msg: string, onConfirm?: () => void) => {
      setModal({ isOpen: true, type, title, message: msg, onConfirm });
  };

  // State ׳׳§׳‘׳¦׳™׳ ׳•׳ ׳¢׳™׳׳× ׳©׳•׳¨׳•׳×
  const [uploadingFileId, setUploadingFileId] = useState<string | null>(null); 
  const [isUploadingLicense, setIsUploadingLicense] = useState(false);
  const [isUploadingInsurance, setIsUploadingInsurance] = useState(false);
  const [expandedItem, setExpandedItem] = useState<string | null>(null);
  const [isRowsLocked, setIsRowsLocked] = useState(false);
  
  // State ׳׳”׳¦׳¢׳•׳× ׳׳™׳§׳•׳ ׳•׳§׳˜׳’׳•׳¨׳™׳•׳×
  const [showLocationSuggestions, setShowLocationSuggestions] = useState(false);
  const [showCategoryDropdown, setShowCategoryDropdown] = useState(false);
  const [showSubCategoryDropdown, setShowSubCategoryDropdown] = useState(false);

  // Refs ׳׳×׳׳¨׳™׳›׳™׳
  const startDateRef = useRef<HTMLInputElement>(null);
  const startTimeRef = useRef<HTMLInputElement>(null);
  const endDateRef = useRef<HTMLInputElement>(null);
  const endTimeRef = useRef<HTMLInputElement>(null);

  // State ׳¨׳׳©׳™ ׳©׳ ׳”׳˜׳™׳•׳
  const [generalInfo, setGeneralInfo] = useState({ 
      name: '', 
      tripType: '', 
      tripTypeOther: '',
      startDate: '', 
      startTime: '08:00', 
      endDate: '', 
      endTime: '18:00', 
      gradeFrom: '', 
      gradeTo: '', 
      chanichimCount: '', 
      totalTravelers: '', 
      staffAges: [] as string[], 
      staffOther: '', 
      generalComments: '',
      
      coordName: '',
      coordId: '',
      coordPhone: '',
      coordEmail: '',
      coordDob: '',

      secondaryStaffObj: null as any 
  });

  // State ׳׳˜׳•׳₪׳¡ ׳”׳•׳¡׳₪׳× ׳׳—׳¨׳׳™ ׳ ׳•׳¡׳£
  const [showAddStaffForm, setShowAddStaffForm] = useState(false);
  const [isVerifyingStaff, setIsVerifyingStaff] = useState(false);
  const [newStaffData, setNewStaffData] = useState({ name: '', role: '', idNumber: '', dob: '', phone: '', email: '' });

  const [timeline, setTimeline] = useState<any[]>([]);
  const [currentLine, setCurrentLine] = useState({ 
    date: '', locationType: 'custom', locationValue: '', category: '', subCategory: '', 
    otherDetail: '', details: '', 
    licenseFile: null as {url: string, name: string} | null,
    insuranceFile: null as {url: string, name: string} | null
  });

  const [startHebrewDate, setStartHebrewDate] = useState('');
  const [endHebrewDate, setEndHebrewDate] = useState('');
  const [isUrgentError, setIsUrgentError] = useState(false);

  const checkGender = (dept: string) => {
      if (!dept) return 'mixed';
      if (['׳”׳₪׳ ׳¡׳׳™׳', '׳”׳×׳׳™׳', '׳‘׳ ׳™ ׳—׳‘"׳“'].some(d => dept.includes(d))) return 'male';
      if (['׳‘׳× ׳׳׳', '׳‘׳ ׳•׳× ׳—׳‘"׳“', '׳‘׳ ׳•׳× ׳—׳‘׳´׳“'].some(d => dept.includes(d))) return 'female';
      return 'mixed';
  };

  const t = (key: string) => {
      const dict: any = {
          'save_draft': { male: '׳©׳׳•׳¨ ׳›׳˜׳™׳•׳˜׳”', female: '׳©׳׳¨׳™ ׳›׳˜׳™׳•׳˜׳”', mixed: '׳©׳׳•׳¨/׳©׳׳¨׳™ ׳›׳˜׳™׳•׳˜׳”' },
          'submit': { male: '׳©׳׳— ׳‘׳§׳©׳”', female: '׳©׳׳—׳™ ׳‘׳§׳©׳”', mixed: '׳©׳׳™׳—׳× ׳‘׳§׳©׳”' },
          'select_type': { male: '׳‘׳—׳¨ ׳¡׳•׳’ ׳₪׳¢׳™׳׳•׳×', female: '׳‘׳—׳¨׳™ ׳¡׳•׳’ ׳₪׳¢׳™׳׳•׳×', mixed: '׳‘׳—׳™׳¨׳× ׳¡׳•׳’ ׳₪׳¢׳™׳׳•׳×' },
      };
      return dict[key]?.[userGender] || key;
  };

  // ׳׳™׳׳•׳™ ׳׳•׳˜׳•׳׳˜׳™ ׳©׳ ׳₪׳¨׳˜׳™ ׳”׳׳©׳×׳׳©
  useEffect(() => {
    if (user && !userLoading) {
        setUserGender(checkGender(user.user_metadata?.department));
        
        // ׳׳ ׳–׳” ׳˜׳™׳•׳ ׳—׳“׳© (׳׳ ׳¢׳¨׳™׳›׳”), ׳ ׳׳׳ ׳׳× ׳₪׳¨׳˜׳™ ׳”׳׳—׳¨׳׳™ ׳׳•׳˜׳•׳׳˜׳™׳× ׳׳”׳₪׳¨׳•׳₪׳™׳
        if (!editId && profile) {
            setGeneralInfo(prev => ({
                ...prev,
                coordName: `${profile.official_name} ${profile.last_name}`,
                coordId: profile.identity_number || '',
                coordPhone: profile.phone || '',
                coordEmail: profile.email || '',
                coordDob: profile.birth_date || ''
            }));
        }
    }
  }, [user, profile, userLoading, editId]);

  useEffect(() => {
      const fetchTrip = async () => {
          if (!editId) return;
          setLoading(true);
          const { data, error } = await supabase.from('trips').select('*').eq('id', editId).single();
          if (data && !error) {
              const d = data.details || {};
              setGeneralInfo({
                  name: data.name,
                  tripType: d.tripType,
                  tripTypeOther: d.tripTypeOther,
                  startDate: data.start_date,
                  startTime: d.startTime,
                  endDate: d.endDate,
                  endTime: d.endTime,
                  gradeFrom: d.gradeFrom,
                  gradeTo: d.gradeTo,
                  chanichimCount: d.chanichimCount,
                  totalTravelers: d.totalTravelers,
                  staffAges: d.staffAges || [],
                  staffOther: d.staffOther,
                  generalComments: d.generalComments,
                  coordName: d.coordName || '',
                  coordId: d.coordId || '',
                  coordPhone: d.coordPhone || '',
                  coordEmail: d.coordEmail || '',
                  coordDob: d.coordDob || '',
                  secondaryStaffObj: d.secondaryStaffObj || null
              });
              setTimeline(d.timeline || []);
              setStep(1); 
          }
          setLoading(false);
      };
      fetchTrip();
  }, [editId]);

  useEffect(() => { 
    setStartHebrewDate(getHebrewDateString(generalInfo.startDate));
    setEndHebrewDate(getHebrewDateString(generalInfo.endDate));
    if (generalInfo.startDate && !currentLine.date) setCurrentLine(prev => ({ ...prev, date: generalInfo.startDate }));
    
    if (generalInfo.startDate) {
        const dateObj = new Date(generalInfo.startDate);
        const now = new Date();
        const diffTime = dateObj.getTime() - now.getTime();
        const diffHours = diffTime / (1000 * 3600);
        if (diffHours < 48 && diffTime > -86400000) setIsUrgentError(true);
        else setIsUrgentError(false);
    } else setIsUrgentError(false);
  }, [generalInfo.startDate, generalInfo.endDate]);

  const getNextDate = (d: string) => { if(!d) return ''; const x=new Date(d); x.setDate(x.getDate()+1); return x.toISOString().split('T')[0]; };
  const toggleStaffAge = (age: string) => setGeneralInfo(prev => ({ ...prev, staffAges: prev.staffAges.includes(age) ? prev.staffAges.filter(a => a !== age) : [...prev.staffAges, age] }));
  const isLicenseRequired = (cat: string, sub: string) => CATEGORIES[cat]?.options.find((o: any) => o.label === sub)?.license || false;

  const handleTypeSelect = (typeId: string) => {
      if (typeId === "׳׳—׳¨") setIsOtherSelected(true);
      else { setGeneralInfo(prev => ({ ...prev, tripType: typeId, tripTypeOther: '' })); setStep(1); window.scrollTo(0,0); }
  };

  const submitOtherType = () => {
      if (!tempOtherType.trim()) return showModal('error', '׳©׳’׳™׳׳”', '׳ ׳ ׳׳₪׳¨׳˜ ׳׳× ׳¡׳•׳’ ׳”׳₪׳¢׳™׳׳•׳×');
      setGeneralInfo(prev => ({ ...prev, tripType: '׳׳—׳¨', tripTypeOther: tempOtherType }));
      setStep(1); window.scrollTo(0,0);
  };

  const handleEndDateChange = (e: React.ChangeEvent<HTMLInputElement>) => {
      const newEnd = e.target.value;
      if (generalInfo.startDate && newEnd < generalInfo.startDate) {
          showModal('error', '׳×׳׳¨׳™׳ ׳©׳’׳•׳™', '׳×׳׳¨׳™׳ ׳”׳¡׳™׳•׳ ׳׳ ׳™׳›׳•׳ ׳׳”׳™׳•׳× ׳׳₪׳ ׳™ ׳×׳׳¨׳™׳ ׳”׳”׳×׳—׳׳”.');
          setGeneralInfo(prev => ({ ...prev, endDate: '' }));
      } else setGeneralInfo(prev => ({ ...prev, endDate: newEnd }));
  };

  const handleSaveStaff = async () => {
      const validation = staffSchema.safeParse(newStaffData);
      if (!validation.success) {
          return showModal('error', '׳₪׳¨׳˜׳™׳ ׳—׳¡׳¨׳™׳', validation.error.issues[0].message);
      }

      setIsVerifyingStaff(true);
      try {
          const { data: existingUser, error } = await supabase.from('profiles').select('id, official_name, last_name').eq('identity_number', newStaffData.idNumber).single();
          if (error || !existingUser) {
              setIsVerifyingStaff(false);
              return showModal('error', '׳©׳’׳™׳׳”', '׳×׳¢׳•׳“׳× ׳”׳–׳”׳•׳× ׳׳™׳ ׳” ׳§׳™׳™׳׳× ׳‘׳׳¢׳¨׳›׳×.\n׳ ׳™׳×׳ ׳׳”׳•׳¡׳™׳£ ׳›׳׳—׳¨׳׳™ ׳¨׳§ ׳׳©׳×׳׳© ׳¨׳©׳•׳.');
          }
          setGeneralInfo(prev => ({
              ...prev,
              secondaryStaffObj: {
                  ...newStaffData,
                  userId: existingUser.id,
                  verifiedName: `${existingUser.official_name} ${existingUser.last_name}`
              }
          }));
          setShowAddStaffForm(false);
          setNewStaffData({ name: '', role: '', idNumber: '', dob: '', phone: '', email: '' });
      } catch (err) {
          showModal('error', '׳©׳’׳™׳׳”', '׳׳™׳¨׳¢׳” ׳©׳’׳™׳׳” ׳‘׳׳™׳׳•׳× ׳”׳ ׳×׳•׳ ׳™׳.');
      } finally {
          setIsVerifyingStaff(false);
      }
  };

  const handleRemoveStaff = () => {
      setGeneralInfo(prev => ({ ...prev, secondaryStaffObj: null }));
  };

  const handleAddLine = () => {
    const lineToValidate = {
        date: currentLine.date,
        category: currentLine.category,
        subCategory: currentLine.subCategory,
        locationValue: currentLine.locationType === 'branch' ? '׳‘׳¡׳ ׳™׳£ ׳”׳§׳‘׳•׳¢' : currentLine.locationValue,
        otherDetail: currentLine.otherDetail
    };

    const validation = tripLineSchema.safeParse(lineToValidate);
    if (!validation.success) {
        return showModal('error', '׳—׳¡׳¨׳™׳ ׳₪׳¨׳˜׳™׳ ׳‘׳׳•"׳–', validation.error.issues[0].message);
    }

    let nextDate = currentLine.date;
    let didDateChange = false;

    if (currentLine.category === 'sleeping') {
        const calculatedNextDate = getNextDate(currentLine.date);
        if (new Date(calculatedNextDate) > new Date(generalInfo.endDate)) {
            return showModal('error', '׳×׳׳¨׳™׳ ׳©׳’׳•׳™', `׳׳ ׳ ׳™׳×׳ ׳׳”׳•׳¡׳™׳£ ׳׳™׳ ׳” ׳‘׳×׳׳¨׳™׳ ׳–׳”.\n׳”׳˜׳™׳•׳ ׳׳•׳’׳“׳¨ ׳׳”׳¡׳×׳™׳™׳ ׳‘-${generalInfo.endDate.split('-').reverse().join('/')}.\n׳™׳© ׳׳¢׳“׳›׳ ׳׳× ׳×׳׳¨׳™׳›׳™ ׳”׳˜׳™׳•׳ ׳‘׳₪׳¨׳˜׳™׳ ׳”׳›׳׳׳™׳™׳ ׳׳׳¢׳׳”.`);
        }
        nextDate = calculatedNextDate;
        didDateChange = true;
    }

    const needsLicense = isLicenseRequired(currentLine.category, currentLine.subCategory);
    
    const newLine = {
      id: Math.random().toString(36).substr(2, 9),
      ...currentLine,
      finalLocation: currentLine.locationType === 'branch' ? '׳‘׳¡׳ ׳™׳£ ׳”׳§׳‘׳•׳¢' : currentLine.locationValue,
      finalSubCategory: currentLine.subCategory === '׳׳—׳¨' ? currentLine.otherDetail : currentLine.subCategory,
      requiresLicense: needsLicense,
      licenseFile: currentLine.licenseFile,
      insuranceFile: currentLine.insuranceFile
    };
    
    setTimeline([...timeline, newLine]);
    setExpandedItem(null);
    if (didDateChange) showModal('info', '׳©׳™׳׳• ׳׳‘', '׳”׳•׳¡׳₪׳× ׳׳™׳ ׳”: ׳”׳×׳׳¨׳™׳ ׳‘׳©׳•׳¨׳” ׳”׳‘׳׳” ׳¢׳•׳“׳›׳ ׳׳•׳˜׳•׳׳˜׳™׳× ׳׳™׳•׳ ׳”׳׳—׳¨׳×.');
    
    setCurrentLine({ 
        date: nextDate, locationType: 'custom', locationValue: '', category: '', subCategory: '', 
        otherDetail: '', details: '', licenseFile: null, insuranceFile: null
    });
  };

  const handleRemoveLine = (id: string, e: React.MouseEvent) => { e.stopPropagation(); setTimeline(timeline.filter(item => item.id !== id)); };

  const handleUpload = async (file: File, type: 'license' | 'insurance', itemId?: string) => {
    if(!file) return;
    if (itemId) setUploadingFileId(`${itemId}_${type}`);
    else { if(type === 'license') setIsUploadingLicense(true); else setIsUploadingInsurance(true); }

    try {
        const fileExt = file.name.split('.').pop();
        const storageName = `${user.id}/${Date.now()}_${type}_${Math.random().toString(36).substring(7)}.${fileExt}`;
        const { error } = await supabase.storage.from('trip-files').upload(storageName, file);
        if (error) throw error;
        const { data: { publicUrl } } = supabase.storage.from('trip-files').getPublicUrl(storageName);
        const fileObj = { url: publicUrl, name: file.name };
        
        if (itemId) setTimeline(prev => prev.map(item => item.id === itemId ? { ...item, [type === 'license' ? 'licenseFile' : 'insuranceFile']: fileObj } : item));
        else setCurrentLine(prev => ({ ...prev, [type === 'license' ? 'licenseFile' : 'insuranceFile']: fileObj }));
    } catch (e: any) { showModal('error', '׳©׳’׳™׳׳”', '׳©׳’׳™׳׳” ׳‘׳”׳¢׳׳׳”: ' + e.message); } 
    finally { 
        if (itemId) setUploadingFileId(null); 
        else { if(type === 'license') setIsUploadingLicense(false); else setIsUploadingInsurance(false); } 
    }
  };

  const handleExistingLineDualUpload = async (event: any, itemId: string, type: 'license' | 'insurance') => {
    const file = event.target.files[0];
    if (!file) return;
    event.target.value = '';
    handleUpload(file, type, itemId);
  };

  const handleLockToggle = () => {
      const config = TRIP_LOGIC[generalInfo.tripType] || TRIP_LOGIC['׳׳—׳¨'];
      const minRows = config.minRows || 2;
      if (!isRowsLocked && timeline.length < minRows) return showModal('error', '׳©׳’׳™׳׳”', `׳׳ ׳ ׳™׳×׳ ׳׳¡׳™׳™׳ ׳”׳•׳¡׳₪׳× ׳©׳•׳¨׳•׳×. ׳‘׳¡׳•׳’ ׳₪׳¢׳™׳׳•׳× ׳–׳” ׳ ׳“׳¨׳©׳•׳× ׳׳₪׳—׳•׳× ${minRows} ׳©׳•׳¨׳•׳× ׳‘׳׳•"׳–.`);
      setIsRowsLocked(!isRowsLocked);
  };

  const executeSubmission = async (status: 'pending' | 'draft') => {
    setLoading(true);
    try {
        const tripData = {
            user_id: user.id,
            coordinator_name: generalInfo.coordName,
            branch: user.user_metadata.branch, 
            department: user.user_metadata.department,
            name: generalInfo.name || (status === 'draft' ? '׳˜׳™׳•׳˜׳” ׳׳׳ ׳©׳' : ''), 
            start_date: generalInfo.startDate || new Date().toISOString(), 
            status: status, 
            details: { ...generalInfo, timeline }
        };

        let error;
        let newId = editId;

        if (editId) {
            const { error: err } = await supabase.from('trips').update(tripData).eq('id', editId);
            error = err;
        } else {
            const { data, error: err } = await supabase.from('trips').insert([tripData]).select().single();
            error = err;
            if (data) newId = data.id;
        }

        if (error) throw error;
        
        if (status === 'draft') return newId;
        else showModal('success', '׳”׳˜׳™׳•׳ ׳ ׳©׳׳—', '׳”׳˜׳™׳•׳ ׳ ׳©׳׳— ׳‘׳”׳¦׳׳—׳”! ׳×׳•׳ 48 ׳©׳¢׳•׳× ׳×׳×׳§׳‘׳ ׳×׳©׳•׳‘׳”.');

    } catch(e: any) { 
        showModal('error', '׳©׳’׳™׳׳”', '׳©׳’׳™׳׳”: ' + e.message); 
        throw e;
    } finally { 
        setLoading(false); 
    }
  };

  const handleSubmit = async () => {
    if (isUrgentError) return;
    
    // 4. ׳•׳׳™׳“׳¦׳™׳” ׳¢׳ Zod (׳₪׳¨׳˜׳™׳ ׳›׳׳׳™׳™׳)
    const validation = tripGeneralSchema.safeParse(generalInfo);
    if (!validation.success) {
        return showModal('error', '׳₪׳¨׳˜׳™׳ ׳—׳¡׳¨׳™׳/׳©׳’׳•׳™׳™׳', validation.error.issues[0].message);
    }

    if (timeline.length === 0) return showModal('error', '׳׳•"׳– ׳¨׳™׳§', '׳™׳© ׳׳”׳•׳¡׳™׳£ ׳׳₪׳—׳•׳× ׳©׳•׳¨׳” ׳׳—׳× ׳‘׳₪׳™׳¨׳•׳˜ ׳”׳˜׳™׳•׳');
    
    const config = TRIP_LOGIC[generalInfo.tripType] || TRIP_LOGIC['׳׳—׳¨'];
    const minRows = config.minRows || 2;
    if (timeline.length < minRows) return showModal('error', '׳׳•"׳– ׳§׳¦׳¨', `׳ ׳“׳¨׳©׳•׳× ׳׳₪׳—׳•׳× ${minRows} ׳©׳•׳¨׳•׳× ׳‘׳׳•"׳–.`);
    
    if (timeline.some(item => item.requiresLicense && (!item.licenseFile || !item.insuranceFile))) {
        showModal('confirm', '׳—׳¡׳¨׳™׳ ׳׳¡׳׳›׳™׳', '׳™׳© ׳₪׳¢׳™׳׳•׳™׳•׳× ׳”׳“׳•׳¨׳©׳•׳× ׳׳™׳©׳•׳¨׳™׳ ׳©׳—׳¡׳¨׳™׳ ׳׳”׳ ׳׳¡׳׳›׳™׳. ׳׳©׳׳•׳— ׳‘׳›׳ ׳–׳׳×?', () => executeSubmission('pending'));
        return;
    }
    executeSubmission('pending');
  };

  const handleSaveDraft = async () => {
      if (!generalInfo.tripType) return showModal('error', '׳©׳’׳™׳׳”', '׳›׳“׳™ ׳׳©׳׳•׳¨ ׳˜׳™׳•׳˜׳” ׳—׳•׳‘׳” ׳׳‘׳—׳•׳¨ ׳׳₪׳—׳•׳× ׳׳× ׳¡׳•׳’ ׳”׳˜׳™׳•׳');
      const res = await executeSubmission('draft');
      if (res) showModal('success', '׳ ׳©׳׳¨', '׳”׳˜׳™׳•׳˜׳” ׳ ׳©׳׳¨׳” ׳‘׳”׳¦׳׳—׳”!');
  };

  const handleGoToProfile = async () => {
      if (!generalInfo.tripType) return showModal('error', '׳©׳’׳™׳׳”', '׳›׳“׳™ ׳׳©׳׳•׳¨ ׳˜׳™׳•׳˜׳” ׳•׳׳¢׳‘׳•׳¨ ׳׳₪׳¨׳•׳₪׳™׳, ׳‘׳—׳¨ ׳§׳•׳“׳ ׳¡׳•׳’ ׳₪׳¢׳™׳׳•׳×.');
      const newId = await executeSubmission('draft');
      if (newId) {
          showModal('info', '׳”׳¢׳‘׳¨׳” ׳׳₪׳¨׳•׳₪׳™׳', '׳”׳˜׳™׳•׳ ׳ ׳©׳׳¨ ׳›׳˜׳™׳•׳˜׳”.\n׳׳¢׳‘׳™׳¨ ׳׳•׳×׳ ׳׳¢׳“׳›׳•׳ ׳₪׳¨׳˜׳™׳ ׳‘׳₪׳¨׳•׳₪׳™׳...', () => {
              router.push(`/dashboard/profile?returnUrl=/dashboard/new-trip?id=${newId}`);
          });
      }
  };

  const currentLineNeedsLicense = isLicenseRequired(currentLine.category, currentLine.subCategory);
  const currentLogic = TRIP_LOGIC[generalInfo.tripType] || TRIP_LOGIC['׳׳—׳¨'];

  const getStaffTitle = (type: 'title' | 'additional') => {
      const isTrip = generalInfo.tripType === '׳˜׳™׳•׳ ׳׳—׳•׳¥ ׳׳¡׳ ׳™׳£';
      const isFemale = userGender === 'female';

      if (type === 'title') {
          if (isTrip) return isFemale ? '׳׳—׳¨׳׳™׳× ׳”׳˜׳™׳•׳' : '׳׳—׳¨׳׳™ ׳”׳˜׳™׳•׳'; 
          return isFemale ? '׳׳—׳¨׳׳™׳× ׳”׳₪׳¢׳™׳׳•׳×' : '׳׳—׳¨׳׳™ ׳”׳₪׳¢׳™׳׳•׳×';
      }
      
      if (type === 'additional') {
          return isFemale ? '׳׳—׳¨׳׳™׳× ׳ ׳•׳¡׳₪׳×' : '׳׳—׳¨׳׳™ ׳ ׳•׳¡׳£';
      }
      return '';
  };

  if (userLoading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-[#00BCD4]" size={40}/></div>;

  return (
    <>
      <Header title={step === 0 ? t('select_type') : (editId ? "׳¢׳¨׳™׳›׳× ׳˜׳™׳•׳" : "׳”׳’׳©׳× ׳˜׳™׳•׳ ׳—׳“׳©")} />

      <Modal 
        isOpen={modal.isOpen} 
        onClose={() => setModal({ ...modal, isOpen: false })} 
        type={modal.type} 
        title={modal.title}
        message={modal.message} 
        onConfirm={modal.onConfirm}
      />

      <div className="p-4 md:p-8 animate-fadeIn pb-32 max-w-[100vw] overflow-x-hidden">
        
        {step === 0 && (
            <div className="max-w-md mx-auto">
                <div className="text-center mb-8">
                    <h2 className="text-2xl font-black text-gray-800 mb-2">׳׳™׳–׳• ׳₪׳¢׳™׳׳•׳× ׳׳×׳›׳ ׳ ׳™׳?</h2>
                    <p className="text-gray-500">׳‘׳—׳¨׳• ׳׳× ׳¡׳•׳’ ׳”׳₪׳¢׳™׳׳•׳× ׳׳”׳×׳—׳׳× ׳”׳×׳”׳׳™׳</p>
                </div>
                <div className="flex flex-col gap-3">
                    {TRIP_TYPES_CONFIG.map(type => {
                        const Icon = type.icon;
                        if (type.id === "׳׳—׳¨" && isOtherSelected) {
                            return (
                                <div key="other-input" className="bg-gray-50 p-4 rounded-2xl border border-gray-200 animate-fadeIn shadow-inner">
                                    <div className="flex gap-2">
                                        <Input 
                                            value={tempOtherType}
                                            onChange={(e: any) => setTempOtherType(e.target.value)}
                                            placeholder="׳ ׳ ׳׳₪׳¨׳˜..." 
                                            autoFocus
                                            className="focus:!border-[#E91E63] focus:!ring-0"
                                        />
                                        <button onClick={submitOtherType} className="bg-[#E91E63] text-white px-4 rounded-xl font-bold text-sm shadow-sm hover:bg-pink-600 transition-colors">׳”׳׳©׳</button>
                                    </div>
                                    <button onClick={() => setIsOtherSelected(false)} className="text-xs text-gray-400 mt-2 hover:text-gray-600 underline">׳‘׳™׳˜׳•׳ ׳•׳—׳–׳¨׳”</button>
                                </div>
                            );
                        }
                        return (
                            <button key={type.id} onClick={() => handleTypeSelect(type.id)} className={`w-full p-4 rounded-2xl border ${type.border} ${type.bg} shadow-sm hover:shadow-md transition-all group flex flex-col items-center justify-center gap-2 hover:scale-[1.02]`}>
                                <Icon size={24} className={type.text} />
                                <div className={`text-base font-black ${type.text}`}>{type.label}</div>
                            </button>
                        )
                    })}
                </div>
            </div>
        )}

        {step === 1 && (
            <>
                <button onClick={() => setStep(0)} className="flex items-center gap-1 text-gray-400 hover:text-[#00BCD4] mb-4 text-xs font-bold transition-colors">
                    <ArrowRight size={16} /> ׳—׳–׳¨׳” ׳׳‘׳—׳™׳¨׳× ׳¡׳•׳’
                </button>

                <div className="mb-6 bg-white p-4 rounded-2xl border border-gray-100 flex items-center justify-between shadow-sm">
                    <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center shadow-sm ${TRIP_TYPES_CONFIG.find(t => t.id === generalInfo.tripType)?.bg || 'bg-gray-50'}`}>
                            {React.createElement(TRIP_TYPES_CONFIG.find(t => t.id === generalInfo.tripType)?.icon || Flag, { size: 20, className: TRIP_TYPES_CONFIG.find(t => t.id === generalInfo.tripType)?.text })}
                        </div>
                        <div>
                            <div className="text-xs text-gray-400 font-bold">׳¡׳•׳’ ׳₪׳¢׳™׳׳•׳× ׳ ׳‘׳—׳¨</div>
                            <div className="font-black text-gray-800 text-lg leading-tight">{generalInfo.tripType === '׳׳—׳¨' ? generalInfo.tripTypeOther : generalInfo.tripType}</div>
                        </div>
                    </div>
                    <button onClick={() => setStep(0)} className="text-xs font-bold text-[#00BCD4] bg-cyan-50 px-3 py-1.5 rounded-lg hover:bg-cyan-100 transition-colors">׳©׳ ׳”</button>
                </div>

                {/* --- ׳₪׳¨׳˜׳™׳ ׳›׳׳׳™׳™׳ --- */}
                <section className="bg-white rounded-[32px] shadow-sm border border-gray-100 overflow-visible relative z-20 mb-8 animate-fadeIn">
                  <div className="bg-[#00BCD4] text-white h-12 flex items-center px-6 font-bold text-lg shadow-sm gap-2 rounded-t-3xl">
                        <Flag size={20} />
                        <span>׳₪׳¨׳˜׳™׳ ׳›׳׳׳™׳™׳</span>
                  </div>
                  
                  <div className="p-6 space-y-8">
                    <div className="grid grid-cols-1 md:grid-cols-12 gap-4 items-start">
                        <div className="md:col-span-12 flex flex-col md:flex-row gap-4 w-full">
                            <div className="flex-1 w-full">
                                  <Input 
                                      label={currentLogic.nameLabel}
                                      value={generalInfo.name} 
                                      onChange={(e: any) => setGeneralInfo({...generalInfo, name: e.target.value})} 
                                      placeholder={currentLogic.namePlaceholder} 
                                      autoFocus 
                                      className="focus:!border-[#E91E63] focus:!ring-0"
                                  />
                            </div>

                            <div className="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4 w-full">
                                <div>
                                    <label className="block text-[10px] md:text-xs font-bold text-gray-500 mb-1.5 mr-1">׳”׳×׳—׳׳”</label>
                                    <div className="bg-gray-50 rounded-xl border border-gray-200 flex items-center h-[52px] focus-within:!border-[#E91E63] focus-within:!ring-0 transition-all overflow-hidden cursor-pointer" onClick={() => startDateRef.current?.showPicker()}>
                                         <div className="flex-1 px-3 border-l border-gray-200 relative h-full flex flex-col justify-center">
                                             <input ref={startDateRef} type="date" className="w-full bg-transparent text-xs font-bold text-gray-800 outline-none z-10 relative" 
                                                 value={generalInfo.startDate} onChange={(e) => setGeneralInfo({...generalInfo, startDate: e.target.value})} onClick={(e) => e.stopPropagation()} />
                                             <div className="text-[9px] text-[#00BCD4] font-bold leading-none mt-0.5 truncate">{startHebrewDate || '-'}</div>
                                         </div>
                                         <div className="w-20 h-full flex items-center justify-center bg-gray-100 relative z-20 hover:bg-gray-200 transition-colors" onClick={(e) => { e.stopPropagation(); startTimeRef.current?.showPicker(); }}>
                                             <input ref={startTimeRef} type="time" step="900" className="w-full h-full bg-transparent text-xs font-bold text-gray-800 outline-none text-center cursor-pointer" 
                                                 value={generalInfo.startTime} onChange={(e) => setGeneralInfo({...generalInfo, startTime: e.target.value})} />
                                         </div>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-[10px] md:text-xs font-bold text-gray-500 mb-1.5 mr-1">׳¡׳™׳•׳</label>
                                    <div className="bg-gray-50 rounded-xl border border-gray-200 flex items-center h-[52px] focus-within:!border-[#E91E63] focus-within:!ring-0 transition-all overflow-hidden cursor-pointer" onClick={() => endDateRef.current?.showPicker()}>
                                         <div className="flex-1 px-3 border-l border-gray-200 relative h-full flex flex-col justify-center">
                                             <input ref={endDateRef} type="date" className="w-full bg-transparent text-xs font-bold text-gray-800 outline-none z-10 relative" 
                                                 value={generalInfo.endDate} onChange={handleEndDateChange} onClick={(e) => e.stopPropagation()}/>
                                             <div className="text-[9px] text-[#00BCD4] font-bold leading-none mt-0.5 truncate">{endHebrewDate || '-'}</div>
                                         </div>
                                         <div className="w-20 h-full flex items-center justify-center bg-gray-100 relative z-20 hover:bg-gray-200 transition-colors" onClick={(e) => { e.stopPropagation(); endTimeRef.current?.showPicker(); }}>
                                             <input ref={endTimeRef} type="time" step="900" className="w-full h-full bg-transparent text-xs font-bold text-gray-800 outline-none text-center cursor-pointer" 
                                                 value={generalInfo.endTime} onChange={(e) => setGeneralInfo({...generalInfo, endTime: e.target.value})} />
                                         </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {isUrgentError && (
                        <div className="bg-red-50 border border-red-200 text-red-700 p-2 rounded-lg flex items-center gap-2 text-xs font-bold animate-fadeIn mt-2">
                            <AlertTriangle size={14} className="shrink-0"/>
                            <div>׳©׳’׳™׳׳”: ׳׳ ׳ ׳™׳×׳ ׳׳”׳’׳™׳© ׳˜׳™׳•׳ ׳₪׳—׳•׳× ׳-48 ׳©׳¢׳•׳× ׳׳₪׳ ׳™ ׳”׳™׳¦׳™׳׳”.</div>
                        </div>
                    )}

                    <div className="h-px bg-gray-100"></div>

                    <div className="grid grid-cols-1 md:grid-cols-12 gap-4 items-start">
                        <div className="md:col-span-3 w-full">
                            <label className="text-xs font-bold text-gray-500 block mb-1.5 mr-1">׳©׳›׳‘׳•׳× ׳’׳™׳</label>
                            <div className="flex gap-2">
                                {/* ׳©׳™׳׳•׳© ׳‘׳׳™׳›׳ ׳©׳“׳•׳׳” ׳׳§׳•׳׳₪׳•׳ ׳ ׳˜׳× Input */}
                                <div className="relative w-full">
                                    <select 
                                        className="w-full bg-gray-50 text-gray-800 text-sm font-bold border border-gray-200 rounded-xl px-4 py-3.5 outline-none appearance-none focus:bg-white focus:!border-[#E91E63] focus:!ring-0 cursor-pointer"
                                        value={generalInfo.gradeFrom} 
                                        onChange={(e) => setGeneralInfo({...generalInfo, gradeFrom: e.target.value})}
                                    >
                                        <option value="">׳׳›׳™׳×׳”...</option>{GRADES.map(g => <option key={g} value={g}>׳›׳™׳×׳” {g}</option>)}
                                    </select>
                                    <ChevronDown size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"/>
                                </div>
                                <div className="relative w-full">
                                    <select 
                                        className="w-full bg-gray-50 text-gray-800 text-sm font-bold border border-gray-200 rounded-xl px-4 py-3.5 outline-none appearance-none focus:bg-white focus:!border-[#E91E63] focus:!ring-0 cursor-pointer"
                                        value={generalInfo.gradeTo} 
                                        onChange={(e) => setGeneralInfo({...generalInfo, gradeTo: e.target.value})}
                                    >
                                        <option value="">׳¢׳“ ׳›׳™׳×׳”...</option>{GRADES.map(g => <option key={g} value={g}>׳›׳™׳×׳” {g}</option>)}
                                    </select>
                                    <ChevronDown size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"/>
                                </div>
                            </div>
                        </div>

                        <div className="md:col-span-2 w-full">
                            <Input 
                                label='׳¡"׳” ׳›׳׳•׳× ׳—׳ ׳™׳›׳™׳' 
                                type="number" 
                                value={generalInfo.chanichimCount} 
                                onChange={(e: any) => setGeneralInfo({...generalInfo, chanichimCount: e.target.value})} 
                                className="focus:!border-[#E91E63] focus:!ring-0"
                            />
                        </div>

                        <div className="md:col-span-5 w-full bg-white rounded-xl border border-gray-200 p-2 flex flex-col justify-center group hover:!border-[#E91E63] transition-all min-h-[74px]">
                            <div className="flex items-center gap-2 px-1 mb-1">
                                <label className="text-xs font-bold text-gray-500 group-hover:!text-[#E91E63] transition-colors">
                                    {currentLogic.staffLabel}
                                </label>
                                <span className="text-[10px] text-gray-400 font-normal">(׳ ׳™׳×׳ ׳׳‘׳—׳•׳¨ ׳׳¡' ׳׳₪׳©׳¨׳•׳™׳•׳×)</span>
                            </div>
                            
                            <div className="flex flex-wrap gap-1 items-center">
                                {STAFF_AGES.map(age => (
                                    <button key={age} onClick={() => toggleStaffAge(age)} 
                                        className={`px-2 py-1 rounded-full text-[10px] font-bold border transition-all flex items-center gap-1
                                        ${generalInfo.staffAges.includes(age) ? 'bg-[#E91E63] text-white border-[#E91E63] shadow-sm' : 'bg-white text-gray-500 border-gray-100 hover:bg-gray-100'}`}>
                                        {generalInfo.staffAges.includes(age) && <Check size={8}/>}
                                        {age}
                                    </button>
                                ))} 
                            </div>

                            {generalInfo.staffAges.includes('׳׳—׳¨') && (
                                <div className="mt-2 w-full animate-fadeIn border-t border-gray-100 pt-2">
                                    <input 
                                        type="text" 
                                        placeholder="׳ ׳ ׳׳₪׳¨׳˜ ׳›׳׳..." 
                                        className="w-full p-2 text-xs border border-gray-200 focus:!border-[#E91E63] outline-none bg-gray-50 rounded-lg" 
                                        value={generalInfo.staffOther} 
                                        onChange={(e) => setGeneralInfo({...generalInfo, staffOther: e.target.value})} 
                                        autoFocus 
                                    />
                                </div>
                            )}
                        </div>

                        <div className="md:col-span-2 w-full">
                            <Input 
                                label='׳¡"׳” ׳׳©׳×׳×׳₪׳™׳' 
                                type="number" 
                                className="bg-[#E0F7FA] font-bold text-[#00BCD4] focus:!border-[#E91E63] focus:!ring-0"
                                placeholder="׳—׳ ׳™׳›׳™׳ + ׳¦׳•׳•׳×" 
                                value={generalInfo.totalTravelers} 
                                onChange={(e: any) => setGeneralInfo({...generalInfo, totalTravelers: e.target.value})} 
                            />
                        </div>
                    </div>
                  </div>
                </section>

                <section className="bg-white rounded-[32px] shadow-sm border border-gray-100 overflow-visible relative z-30 mb-8 animate-fadeIn">
                   <div className="bg-[#00BCD4] text-white h-12 flex items-center px-6 font-bold text-lg shadow-sm justify-between rounded-t-3xl">
                       <div className="flex items-center gap-2"><MapPin size={20}/> <span>{currentLogic.timelineTitle}</span></div>
                       <span className="text-xs bg-white/20 px-3 py-1 rounded-full">{timeline.length} ׳©׳•׳¨׳•׳×</span>
                   </div>
                   
                   <div className="p-6 space-y-4 bg-gray-50 rounded-b-3xl">
                      {timeline.map((item) => {
                          const catConfig = CATEGORIES[item.category];
                          const CatIcon = catConfig?.icon || Flag;
                          const isExpanded = expandedItem === item.id;
                          const colorClass = getColorHex(catConfig?.color);
                          const isMissingLicense = item.requiresLicense && (!item.licenseFile || !item.insuranceFile);

                          return (
                            <div key={item.id} className={`border rounded-xl overflow-hidden bg-white transition-all group shadow-sm hover:shadow-md ${isMissingLicense ? 'border-red-300 ring-1 ring-red-100' : 'border-gray-200 hover:!border-[#E91E63]'}`}>
                                <div className="flex flex-col md:flex-row items-start md:items-center gap-4 p-4 cursor-pointer" onClick={() => setExpandedItem(isExpanded ? null : item.id)}>
                                    <div className="flex items-center gap-4 w-full md:w-auto">
                                        <div className={`p-3 rounded-xl text-white shadow-sm`} style={{backgroundColor: colorClass}}><CatIcon size={20} /></div>
                                        <div className="text-xs font-bold w-24 text-gray-500 bg-gray-50 border px-2 py-1.5 rounded-lg text-center flex flex-col justify-center">
                                            <span className="text-[10px] text-gray-400">׳×׳׳¨׳™׳</span>
                                            {item.date ? `${item.date.split('-')[2]}/${item.date.split('-')[1]}` : '-'}
                                        </div>
                                        <div className="md:hidden text-gray-300 ml-auto">
                                            {isExpanded ? <ChevronUp size={20}/> : <ChevronDown size={20}/>}
                                        </div>
                                    </div>

                                    <div className="flex-1 w-full pl-8 md:pl-0">
                                        <div className="text-sm font-black text-gray-800">{item.finalSubCategory}</div>
                                        <div className="text-xs text-gray-500 flex items-center gap-1 mt-0.5"><MapPin size={12} className="text-[#E91E63]"/> {item.finalLocation}</div>
                                    </div>
                                    
                                    {item.requiresLicense && (
                                     <div className={`text-xs px-3 py-1 rounded-full border items-center gap-1.5 font-bold flex w-fit
                                        ${(item.licenseFile && item.insuranceFile) ? 'bg-green-50 text-green-700 border-green-200' : 'bg-red-50 text-red-700 border-red-200'}`}>
                                        {(item.licenseFile && item.insuranceFile) ? <CheckCircle size={12}/> : <AlertTriangle size={12}/>}
                                        <span>{(item.licenseFile && item.insuranceFile) ? '׳™׳© ׳׳™׳©׳•׳¨׳™׳' : '׳—׳¡׳¨׳™׳ ׳׳™׳©׳•׳¨׳™׳'}</span>
                                     </div>
                                    )}
                                    <div className="hidden md:block text-gray-300 group-hover:!text-[#E91E63] transition-colors">{isExpanded ? <ChevronUp size={20}/> : <ChevronDown size={20}/>}</div>
                                </div>

                                {isExpanded && (
                                    <div className="p-5 border-t border-gray-100 bg-white animate-fadeIn">
                                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm mb-4">
                                        <div><span className="block text-xs font-bold text-gray-400 mb-1">׳׳™׳§׳•׳ ׳׳“׳•׳™׳§</span><div className="p-3 bg-white rounded-xl border border-gray-200 shadow-sm">{item.finalLocation}</div></div>
                                        <div><span className="block text-xs font-bold text-gray-400 mb-1">׳₪׳¨׳˜׳™׳ ׳ ׳•׳¡׳₪׳™׳</span><div className="p-3 bg-white rounded-xl border border-gray-200 shadow-sm min-h-[46px]">{item.details || '-'}</div></div>
                                      </div>
                                      
                                      {item.requiresLicense && (
                                        <div className="bg-orange-50 border border-orange-200 rounded-xl p-4">
                                            <div className="flex items-center gap-2 text-orange-900 text-xs font-bold mb-3">
                                                 <AlertTriangle size={16} className="text-orange-600"/>
                                                 <span>׳׳¡׳׳›׳™׳ ׳׳¦׳•׳¨׳₪׳™׳ ׳׳₪׳¢׳™׳׳•׳× ׳–׳•:</span>
                                            </div>
                                            
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                 <div className={`p-3 rounded-xl border flex items-center justify-between gap-2 ${item.licenseFile ? 'bg-green-50 border-green-200' : 'bg-white border-orange-200'}`}>
                                                     <div className="text-xs truncate flex-1">
                                                         <span className="block font-bold text-gray-500 mb-0.5">׳¨׳™׳©׳•׳™ ׳¢׳¡׳§:</span>
                                                         {item.licenseFile ? <a href={item.licenseFile.url} target="_blank" rel="noreferrer" className="text-green-700 font-bold hover:underline flex items-center gap-1"><LinkIcon size={12}/> {item.licenseFile.name}</a> : <span className="text-red-500 font-bold">׳—׳¡׳¨ ׳§׳•׳‘׳¥!</span>}
                                                     </div>
                                                     <label className="cursor-pointer p-2 bg-white border border-gray-200 rounded-lg hover:!border-[#E91E63] text-gray-400 hover:!text-[#E91E63] transition-colors shadow-sm">
                                                         {uploadingFileId === `${item.id}_license` ? <Loader2 size={16} className="animate-spin"/> : <FileUp size={16}/>}
                                                         <input type="file" className="hidden" accept=".pdf,.jpg,.jpeg,.png" onChange={(e) => handleExistingLineDualUpload(e, item.id, 'license')} disabled={!!uploadingFileId} />
                                                     </label>
                                                 </div>

                                                 <div className={`p-3 rounded-xl border flex items-center justify-between gap-2 ${item.insuranceFile ? 'bg-green-50 border-green-200' : 'bg-white border-orange-200'}`}>
                                                     <div className="text-xs truncate flex-1">
                                                         <span className="block font-bold text-gray-500 mb-0.5">׳‘׳™׳˜׳•׳—:</span>
                                                         {item.insuranceFile ? <a href={item.insuranceFile.url} target="_blank" rel="noreferrer" className="text-green-700 font-bold hover:underline flex items-center gap-1"><LinkIcon size={12}/> {item.insuranceFile.name}</a> : <span className="text-red-500 font-bold">׳—׳¡׳¨ ׳§׳•׳‘׳¥!</span>}
                                                     </div>
                                                     <label className="cursor-pointer p-2 bg-white border border-gray-200 rounded-lg hover:!border-[#E91E63] text-gray-400 hover:!text-[#E91E63] transition-colors shadow-sm">
                                                         {isUploadingInsurance ? <Loader2 size={16} className="animate-spin" /> : <FileUp size={16}/>}
                                                         <input type="file" className="hidden" accept=".pdf,.jpg,.jpeg,.png" onChange={(e) => handleUpload(e.target.files![0], 'insurance')} disabled={isUploadingInsurance} />
                                                     </label>
                                                 </div>
                                            </div>
                                        </div>
                                      )}
                                      <div className="mt-4 flex justify-end"><button onClick={(e) => handleRemoveLine(item.id, e)} className="text-red-500 text-xs font-bold flex items-center gap-1 hover:bg-red-50 px-3 py-1.5 rounded-lg transition-colors border border-transparent hover:border-red-100"><Trash2 size={16} /> ׳”׳¡׳¨ ׳©׳•׳¨׳”</button></div>
                                    </div>
                                )}
                            </div>
                          )
                      })}

                      {!isRowsLocked && (
                        <div className="bg-white p-5 rounded-2xl border-2 !border-[#E91E63] border-dashed shadow-sm animate-fadeIn mt-4 relative z-20">
                            <div className="absolute -top-3 right-4 bg-white px-2 text-xs font-bold !text-[#E91E63]">׳”׳•׳¡׳₪׳× ׳©׳•׳¨׳” ׳—׳“׳©׳”</div>
                            <div className="grid grid-cols-1 md:grid-cols-12 gap-2 items-end">
                                <div className="md:col-span-1 w-full">
                                    <label className="text-xs font-bold text-gray-400 mb-1 block">׳×׳׳¨׳™׳</label>
                                    <div className="w-full text-xs p-2 rounded-lg border border-gray-200 bg-gray-50 text-gray-500 h-[52px] flex items-center justify-center font-bold select-none cursor-default whitespace-nowrap overflow-hidden text-ellipsis">
                                        {currentLine.date ? `${currentLine.date.split('-')[2]}/${currentLine.date.split('-')[1]}/${currentLine.date.split('-')[0]}` : '-'}
                                    </div>
                                </div>
                                <div className="md:col-span-2 relative w-full">
                                    <Input 
                                        label="׳׳™׳§׳•׳"
                                        placeholder="׳”׳–׳ ׳׳™׳§׳•׳"
                                        value={currentLine.locationValue}
                                        readOnly={currentLine.locationType === 'branch'}
                                        onFocus={() => { if (currentLine.locationType !== 'branch') setShowLocationSuggestions(true); }}
                                        onChange={(e: any) => { setCurrentLine({...currentLine, locationValue: e.target.value, locationType: 'custom'}); setShowLocationSuggestions(true); }}
                                        onBlur={() => setTimeout(() => setShowLocationSuggestions(false), 200)}
                                        className="focus:!border-[#E91E63] focus:!ring-0"
                                    />
                                    {currentLine.locationType === 'branch' && (
                                        <div onClick={() => setCurrentLine({...currentLine, locationValue: '', locationType: 'custom'})} className="absolute top-full right-0 mt-1 text-[10px] text-red-400 font-bold cursor-pointer hover:text-red-600 hover:underline z-10 w-full text-center">׳׳—׳¥ ׳׳”׳–׳ ׳× ׳׳™׳§׳•׳ ׳׳—׳¨</div>
                                    )}
                                    {showLocationSuggestions && currentLine.locationType !== 'branch' && (
                                        <div className="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-xl z-50 max-h-48 overflow-y-auto">
                                            <div className="p-2 text-xs font-bold text-[#E91E63] hover:bg-pink-50 cursor-pointer border-b border-gray-100 flex items-center gap-2" onClick={() => setCurrentLine({...currentLine, locationValue: '׳‘׳¡׳ ׳™׳£ ׳”׳§׳‘׳•׳¢', locationType: 'branch'})}><Home size={14} />׳”׳¡׳ ׳™׳£ ׳”׳§׳‘׳•׳¢</div>
                                            {currentLine.locationValue.length >= 1 && ISRAEL_CITIES.filter(city => city.includes(currentLine.locationValue) && city !== currentLine.locationValue).map(city => (<div key={city} className="p-2 text-xs text-gray-700 hover:bg-gray-50 cursor-pointer border-b border-gray-50" onClick={() => setCurrentLine({...currentLine, locationValue: city, locationType: 'city'})}>{city}</div>))}
                                        </div>
                                    )}
                                </div>
                                <div className="md:col-span-5 flex flex-col md:flex-row gap-2 w-full">
                                    <div className="flex-1 relative">
                                        <label className="text-xs font-bold text-gray-400 mb-1.5 block">׳”׳×׳¨׳—׳©׳•׳×</label>
                                        <div className="w-full text-xs p-2 rounded-lg border border-gray-200 hover:!border-[#E91E63] bg-white cursor-pointer h-[52px] flex items-center justify-between px-3 transition-all" onClick={() => setShowCategoryDropdown(!showCategoryDropdown)}>
                                            <span className={`font-bold ${currentLine.category ? 'text-gray-800' : 'text-gray-400'}`}>{CATEGORIES[currentLine.category]?.label || '׳‘׳—׳¨...'}</span><ChevronDown size={16} className="text-gray-400" />
                                        </div>
                                        {showCategoryDropdown && (
                                            <div className="absolute top-full right-0 w-48 mt-1 bg-white border border-gray-200 rounded-xl shadow-2xl z-[100] overflow-hidden">
                                                {Object.entries(CATEGORIES).map(([key, val]: any, index) => {
                                                    const Icon = val.icon; const colors = ['text-[#00BCD4]', 'text-[#8BC34A]', 'text-[#E91E63]']; const bgs = ['hover:bg-cyan-50', 'hover:bg-green-50', 'hover:bg-pink-50'];
                                                    return (<div key={key} className={`p-3 text-xs text-gray-700 ${bgs[index % 3]} cursor-pointer border-b border-gray-50 flex items-center gap-3 transition-colors`} onClick={() => { setCurrentLine({...currentLine, category: key, subCategory: '', otherDetail: ''}); setShowCategoryDropdown(false); }}><Icon size={16} className={colors[index % 3]} /><span className="font-bold">{val.label}</span></div>)
                                                })}
                                            </div>
                                        )}
                                        {showCategoryDropdown && <div className="fixed inset-0 z-[90] cursor-default" onClick={() => setShowCategoryDropdown(false)}></div>}
                                    </div>
                                    <div className="flex-[1.5] relative">
                                        <label className="text-xs font-bold text-gray-400 mb-1.5 block">׳₪׳™׳¨׳•׳˜ ׳”׳”׳×׳¨׳—׳©׳•׳×</label>
                                        {currentLine.subCategory === '׳׳—׳¨' ? (
                                            <div className="relative"><Input placeholder="׳₪׳¨׳˜..." autoFocus value={currentLine.otherDetail} onChange={(e: any) => setCurrentLine({...currentLine, otherDetail: e.target.value})} className="focus:!border-[#E91E63] focus:!ring-0" /><div className="absolute left-2 top-1/2 -translate-y-1/2 text-xs text-gray-400 cursor-pointer font-bold" onClick={() => setCurrentLine({...currentLine, subCategory: ''})}>X</div></div>
                                        ) : (
                                            <><div className={`w-full text-xs p-2 rounded-lg border border-gray-200 h-[52px] flex items-center justify-between px-3 transition-all ${!currentLine.category ? 'bg-gray-100 cursor-not-allowed opacity-50' : 'hover:!border-[#E91E63] bg-white cursor-pointer'}`} onClick={() => { if(currentLine.category) setShowSubCategoryDropdown(!showSubCategoryDropdown) }}><span className={`font-bold ${currentLine.subCategory ? 'text-gray-800' : 'text-gray-400'}`}>{currentLine.subCategory || (currentLine.category ? '׳‘׳—׳¨ ׳₪׳™׳¨׳•׳˜...' : '-')}</span><ChevronDown size={16} className="text-gray-400" /></div>
                                            {showSubCategoryDropdown && currentLine.category && (
                                                <div className="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-2xl z-[100] overflow-hidden max-h-48 overflow-y-auto">{CATEGORIES[currentLine.category]?.options.map((opt: any) => (<div key={opt.label} className="p-3 text-xs text-gray-700 hover:bg-pink-50 hover:text-[#E91E63] cursor-pointer border-b border-gray-50 font-bold transition-colors" onClick={() => { setCurrentLine({...currentLine, subCategory: opt.label}); setShowSubCategoryDropdown(false); }}>{opt.label}</div>))}</div>
                                            )}
                                            {showSubCategoryDropdown && <div className="fixed inset-0 z-[90] cursor-default" onClick={() => setShowSubCategoryDropdown(false)}></div>}</>
                                        )}
                                    </div>
                                </div>
                                <div className="md:col-span-4 flex gap-2 items-end w-full">
                                    {currentLine.subCategory === '׳׳™׳ ׳× ׳׳‘׳ ׳”' ? (
                                        <div className="flex-grow flex flex-col md:flex-row gap-2">
                                            <div className="flex-1"><Input label="׳©׳ ׳”׳׳§׳•׳/׳›׳×׳•׳‘׳× (׳—׳•׳‘׳”)" placeholder="׳©׳ ׳”׳׳§׳•׳/׳›׳×׳•׳‘׳×" value={currentLine.otherDetail} onChange={(e: any) => setCurrentLine({...currentLine, otherDetail: e.target.value})} className="focus:!border-[#E91E63] focus:!ring-0" /></div>
                                            <div className="flex-1"><Input label="׳₪׳¨׳˜׳™׳ ׳ ׳•׳¡׳₪׳™׳" placeholder="׳”׳¢׳¨׳•׳×..." value={currentLine.details} onChange={(e: any) => setCurrentLine({...currentLine, details: e.target.value})} className="focus:!border-[#E91E63] focus:!ring-0" /></div>
                                        </div>
                                    ) : (
                                        <div className="flex-grow relative w-full">
                                            <div className="flex justify-between items-end mb-1.5"><label className="text-xs font-bold text-gray-400 block">{currentLine.category === 'hiking' ? '׳₪׳™׳¨׳•׳˜ ׳”׳׳¡׳׳•׳' : '׳₪׳¨׳˜׳™׳ ׳ ׳•׳¡׳₪׳™׳'}</label>{currentLine.category === 'hiking' && (<a href="https://mokedteva.co.il/InfoCenter/TrackWizard" target="_blank" rel="noreferrer" className="text-[10px] font-bold text-[#E91E63] flex items-center gap-1 hover:underline"><LinkIcon size={10} />׳׳›׳ ׳™׳¡׳” ׳׳׳©׳£ ׳”׳׳¡׳׳•׳׳™׳ ׳©׳ ׳׳•׳§׳“ ׳˜׳‘׳¢</a>)}</div>
                                            <Input placeholder={currentLine.category === 'hiking' ? '׳׳¡\' ׳”׳׳¡׳׳•׳ ׳•׳›׳•\'' : '׳₪׳¨׳˜׳™׳ ׳ ׳•׳¡׳₪׳™׳...'} value={currentLine.details} onChange={(e: any) => setCurrentLine({...currentLine, details: e.target.value})} className="focus:!border-[#E91E63] focus:!ring-0" />
                                        </div>
                                    )}
                                    <div className="w-full md:w-auto mt-2 md:mt-0">
                                        <button onClick={handleAddLine} className="bg-[#8BC34A] hover:bg-[#7CB342] text-white h-[52px] w-full md:w-[60px] rounded-lg flex items-center justify-center shadow-lg transition-all active:scale-95 flex-shrink-0 mb-[1px]" title="׳׳׳™׳©׳•׳¨ ׳”׳©׳•׳¨׳” ׳•׳₪׳×׳™׳—׳× ׳©׳•׳¨׳” ׳—׳“׳©׳”">
                                            <Check size={28} strokeWidth={3} />
                                            <span className="md:hidden mr-2 font-bold">׳”׳•׳¡׳£ ׳©׳•׳¨׳” ׳׳׳•"׳–</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {currentLineNeedsLicense && (
                                <div className="mt-3 bg-orange-50 border border-orange-200 rounded-xl p-3 flex flex-col gap-3 animate-fadeIn">
                                    <div className="flex items-center gap-2 text-orange-900 text-xs font-bold">
                                        <AlertTriangle size={18} className="text-orange-600"/>
                                        <span>׳₪׳¢׳™׳׳•׳× ׳–׳• ׳“׳•׳¨׳©׳× ׳׳™׳©׳•׳¨׳™׳. ׳—׳•׳‘׳” ׳׳”׳¢׳׳•׳× ׳׳× ׳©׳ ׳™ ׳”׳׳¡׳׳›׳™׳ ׳”׳‘׳׳™׳:</span>
                                    </div>
                                    <div className="flex flex-col sm:flex-row gap-3">
                                        <label className={`flex-1 cursor-pointer bg-white border px-4 py-3 rounded-xl text-xs font-bold hover:shadow-md transition-all flex items-center justify-center gap-2 shadow-sm ${currentLine.licenseFile ? 'border-green-300 text-green-700 bg-green-50' : 'border-orange-200 text-orange-700 hover:bg-orange-100'}`}>
                                            {isUploadingLicense ? <Loader2 size={16} className="animate-spin" /> : currentLine.licenseFile ? <CheckCircle size={16}/> : <FileUp size={16} />} 
                                            {isUploadingLicense ? '׳׳¢׳׳”...' : currentLine.licenseFile ? `׳¨׳™׳©׳•׳™: ${currentLine.licenseFile?.name}` : '׳”׳¢׳׳׳× ׳¨׳™׳©׳•׳™ ׳¢׳¡׳§ (׳—׳•׳‘׳”)'}
                                            <input type="file" className="hidden" accept=".pdf,.jpg,.jpeg,.png" onChange={(e) => handleUpload(e.target.files![0], 'license')} disabled={isUploadingLicense} />
                                        </label>
                                        <label className={`flex-1 cursor-pointer bg-white border px-4 py-3 rounded-xl text-xs font-bold hover:shadow-md transition-all flex items-center justify-center gap-2 shadow-sm ${currentLine.insuranceFile ? 'border-green-300 text-green-700 bg-green-50' : 'border-orange-200 text-orange-700 hover:bg-orange-100'}`}>
                                            {isUploadingInsurance ? <Loader2 size={16} className="animate-spin" /> : currentLine.insuranceFile ? <CheckCircle size={16}/> : <FileUp size={16} />} 
                                            {isUploadingInsurance ? '׳׳¢׳׳”...' : currentLine.insuranceFile ? `׳‘׳™׳˜׳•׳—: ${currentLine.insuranceFile?.name}` : '׳”׳¢׳׳׳× ׳‘׳™׳˜׳•׳— (׳—׳•׳‘׳”)'}
                                            <input type="file" className="hidden" accept=".pdf,.jpg,.jpeg,.png" onChange={(e) => handleUpload(e.target.files![0], 'insurance')} disabled={isUploadingInsurance} />
                                        </label>
                                    </div>
                                </div>
                            )}
                        </div>
                      )}
                      
                      <div className="flex justify-center pt-4 pb-6">
                          <button onClick={handleLockToggle} className={`text-xs flex items-center gap-2 px-6 py-2 rounded-full border transition-all font-bold ${isRowsLocked ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-[#E91E63] border-[#E91E63] hover:bg-[#E91E63] hover:text-white'}`}>
                              {isRowsLocked ? <><Lock size={14}/> ׳׳¦׳‘ ׳¦׳₪׳™׳™׳” (׳׳—׳¥ ׳׳¢׳¨׳™׳›׳”)</> : <><Unlock size={14}/> ׳¡׳™׳•׳ ׳”׳•׳¡׳₪׳× ׳©׳•׳¨׳•׳×</>}
                          </button>
                      </div>
                   </div>
                </section>

                <section className="bg-white rounded-[32px] shadow-sm border border-gray-100 overflow-visible relative z-10 mb-8 animate-fadeIn">
                    <div className="bg-[#00BCD4] text-white h-12 flex items-center px-6 font-bold text-lg shadow-sm gap-2 rounded-t-3xl">
                       <UserPlus size={20} />
                       <span>{getStaffTitle('title')}</span>
                    </div>
                    <div className="p-6">
                        
                        <div className="mb-6">
                            <div className="flex items-center justify-between mb-3">
                                <div className="text-xs text-gray-400 font-bold">׳”׳₪׳¨׳˜׳™׳ ׳ ׳©׳׳‘׳™׳ ׳׳”׳₪׳¨׳•׳₪׳™׳ ׳”׳׳™׳©׳™</div>
                                <button 
                                    onClick={handleGoToProfile} 
                                    className="text-[10px] font-bold text-[#E91E63] hover:underline flex items-center gap-1"
                                >
                                    <Edit2 size={12}/> ׳׳¢׳“׳›׳•׳ ׳₪׳¨׳˜׳™׳ ׳‘׳₪׳¨׳•׳₪׳™׳
                                </button>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-5 gap-3">
                                <Input label="׳©׳ ׳׳׳" value={generalInfo.coordName} readOnly icon={<User size={14}/>} className="!bg-gray-100 !text-gray-500 !border-gray-200 focus:ring-0 cursor-default" />
                                <Input label="׳×׳¢׳•׳“׳× ׳–׳”׳•׳×" value={generalInfo.coordId} readOnly icon={<CreditCard size={14}/>} className="!bg-gray-100 !text-gray-500 !border-gray-200 focus:ring-0 cursor-default" />
                                <Input label="׳×׳׳¨׳™׳ ׳׳™׳“׳”" type="date" value={generalInfo.coordDob} readOnly className="!bg-gray-100 !text-gray-500 !border-gray-200 focus:ring-0 cursor-default" />
                                <Input label="׳˜׳׳₪׳•׳" type="tel" value={generalInfo.coordPhone} readOnly icon={<Phone size={14}/>} className="!bg-gray-100 !text-gray-500 !border-gray-200 focus:ring-0 cursor-default" />
                                <Input label="׳׳™׳׳™׳™׳" type="email" value={generalInfo.coordEmail} readOnly icon={<Mail size={14}/>} className="!bg-gray-100 !text-gray-500 !border-gray-200 focus:ring-0 cursor-default text-left" dir="ltr" />
                            </div>
                        </div>

                        <div className="h-px bg-gray-100 my-6"></div>

                        {generalInfo.secondaryStaffObj ? (
                            <div className="bg-green-50 p-4 rounded-xl border border-green-100 flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    <div className="w-10 h-10 rounded-full bg-green-200 text-green-700 flex items-center justify-center font-bold text-lg">
                                        {generalInfo.secondaryStaffObj.name.charAt(0)}
                                    </div>
                                    <div>
                                        <div className="font-bold text-gray-800 text-sm">{generalInfo.secondaryStaffObj.name} <span className="text-xs font-normal text-gray-500">({generalInfo.secondaryStaffObj.role})</span></div>
                                        <div className="text-xs text-gray-400 mt-0.5 flex gap-2">
                                            <span>{generalInfo.secondaryStaffObj.phone}</span> ג€¢ 
                                            <span>{generalInfo.secondaryStaffObj.idNumber}</span>
                                        </div>
                                    </div>
                                </div>
                                <button onClick={handleRemoveStaff} className="text-red-500 hover:bg-red-50 p-2 rounded-lg transition-colors" title="׳”׳¡׳¨ ׳׳—׳¨׳׳™">
                                    <Trash2 size={18}/>
                                </button>
                            </div>
                        ) : (
                            !showAddStaffForm ? (
                                <div className="flex justify-center">
                                    <button onClick={() => setShowAddStaffForm(true)} className="text-xs flex items-center gap-2 px-6 py-2 rounded-full border transition-all font-bold bg-white text-[#E91E63] border-[#E91E63] hover:bg-[#E91E63] hover:text-white">
                                        <Plus size={14}/> {getStaffTitle('additional')} (׳׳•׳₪׳¦׳™׳•׳ ׳׳™)
                                    </button>
                                </div>
                            ) : (
                                <div className="bg-gray-50 p-5 rounded-xl border border-gray-200 animate-fadeIn">
                                    <div className="flex justify-between items-center mb-4">
                                        <span className="text-xs font-bold text-gray-500">׳₪׳¨׳˜׳™ {getStaffTitle('additional')} (׳›׳ ׳”׳©׳“׳•׳× ׳—׳•׳‘׳”)</span>
                                        <button onClick={() => setShowAddStaffForm(false)}><X size={18} className="text-gray-400"/></button>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 md:grid-cols-6 gap-3 mb-4">
                                        <Input label="׳©׳ ׳׳׳" icon={<User size={14}/>} value={newStaffData.name} onChange={(e: any) => setNewStaffData({...newStaffData, name: e.target.value})} className="focus:!border-[#E91E63] focus:!ring-0" />
                                        <Input label="׳×׳₪׳§׳™׳“ ׳‘׳׳¨׳’׳•׳" icon={<Briefcase size={14}/>} value={newStaffData.role} onChange={(e: any) => setNewStaffData({...newStaffData, role: e.target.value})} className="focus:!border-[#E91E63] focus:!ring-0" />
                                        <Input label="׳×׳¢׳•׳“׳× ׳–׳”׳•׳×" icon={<CreditCard size={14}/>} value={newStaffData.idNumber} onChange={(e: any) => setNewStaffData({...newStaffData, idNumber: e.target.value})} className="focus:!border-[#E91E63] focus:!ring-0" />
                                        <Input label="׳×׳׳¨׳™׳ ׳׳™׳“׳”" type="date" value={newStaffData.dob} onChange={(e: any) => setNewStaffData({...newStaffData, dob: e.target.value})} className="focus:!border-[#E91E63] focus:!ring-0" />
                                        <Input label="׳˜׳׳₪׳•׳" icon={<Phone size={14}/>} type="tel" value={newStaffData.phone} onChange={(e: any) => setNewStaffData({...newStaffData, phone: e.target.value})} className="focus:!border-[#E91E63] focus:!ring-0" />
                                        <Input label="׳׳™׳׳™׳™׳" icon={<Mail size={14}/>} type="email" value={newStaffData.email} onChange={(e: any) => setNewStaffData({...newStaffData, email: e.target.value})} className="text-left focus:!border-[#E91E63] focus:!ring-0" dir="ltr"/>
                                    </div>
                                    <div className="flex justify-end">
                                        <button onClick={handleSaveStaff} disabled={isVerifyingStaff} className="bg-[#E91E63] text-white px-6 py-3 rounded-lg font-bold hover:bg-pink-600 transition-colors shadow-md text-xs flex items-center gap-2 h-[52px]">
                                            {isVerifyingStaff ? <Loader2 size={16} className="animate-spin"/> : <CheckCircle size={16}/>}
                                            {isVerifyingStaff ? '׳‘׳•׳“׳§...' : '׳©׳׳•׳¨ ׳׳—׳¨׳׳™'}
                                        </button>
                                    </div>
                                </div>
                            )
                        )}
                    </div>
                </section>

                <section className="bg-white rounded-[32px] shadow-sm border border-gray-100 overflow-hidden mb-24 animate-fadeIn relative z-10">
                    <div className="bg-[#00BCD4] text-white h-12 flex items-center px-6 font-bold text-lg shadow-sm gap-2">
                       <MessageSquare size={20} />
                       <span>׳”׳¢׳¨׳•׳×</span>
                    </div>
                    <div className="p-6">
                         <label className="block text-sm font-bold text-gray-700 mb-2">׳׳©׳”׳• ׳©׳—׳©׳•׳‘ ׳׳ ׳©׳ ׳“׳¢</label>
                         <textarea className="w-full p-4 rounded-xl bg-white border border-gray-200 outline-none focus:!border-[#E91E63] focus:!ring-0 min-h-[100px] resize-y" placeholder="׳“׳’׳©׳™׳ ׳׳™׳•׳—׳“׳™׳, ׳‘׳§׳©׳•׳× ׳•׳›׳•'..." value={generalInfo.generalComments} onChange={(e) => setGeneralInfo({...generalInfo, generalComments: e.target.value})}></textarea>
                    </div>
                </section>
                
                <div className="fixed bottom-0 left-0 right-0 md:right-56 bg-white/90 backdrop-blur-md border-t border-gray-100 p-4 z-40 transition-all">
                    <div className="max-w-6xl mx-auto flex flex-col md:flex-row justify-end gap-3">
                        {isUrgentError && <div className="bg-red-50 text-red-600 px-4 py-3 rounded-2xl text-xs font-bold flex items-center justify-center gap-2"><AlertTriangle size={16}/> ׳×׳׳¨׳™׳ ׳”׳™׳¦׳™׳׳” ׳§׳¨׳•׳‘ ׳׳“׳™!</div>}
                        <button onClick={handleSaveDraft} disabled={loading} className="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3.5 rounded-2xl font-bold text-base shadow-sm transition-all flex items-center justify-center gap-2 transform hover:-translate-y-1">
                            {loading ? <Loader2 size={20} className="animate-spin" /> : <FileEdit size={20} />}
                            <span>{t('save_draft')}</span>
                        </button>
                        <button onClick={handleSubmit} disabled={loading || isUrgentError} className={`bg-[#8BC34A] hover:bg-[#7CB342] text-white px-8 py-3.5 rounded-2xl font-bold text-lg shadow-lg hover:shadow-green-200 transition-all flex items-center justify-center gap-3 transform hover:-translate-y-1 ${loading || isUrgentError ? 'opacity-50 cursor-not-allowed grayscale' : ''}`}>
                            {loading ? '׳©׳•׳׳—...' : (<><span>{t('submit')}</span><Save size={20} /></>)}
                        </button>
                    </div>
                </div>
            </>
        )}
      </div>
      <style jsx>{`@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } .animate-fadeIn { animation: fadeIn 0.3s ease-out; }`}</style>
    </>
  )
}

// 2. Export the wrapper
export default function NewTripPage() {
  return (
    <Suspense fallback={<div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-[#00BCD4]" size={40}/></div>}>
       <NewTripContent />
    </Suspense>
  )
}


================================================================
FILE PATH: C:\Users\User\chabad-trips\app\dashboard\profile\page.tsx
================================================================
"use client"

import React, { useState, useEffect, Suspense } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { Header } from '@/components/layout/Header'
import { Button } from '@/components/ui/Button'
import { Input } from '@/components/ui/Input'
import { Modal } from '@/components/ui/Modal'
import { 
  User, Mail, Building2, Save, Loader2, Camera, 
  ShieldCheck, Lock, Trash2, Calendar, ArrowRight, Info, MapPin, ExternalLink, Briefcase
} from 'lucide-react'
import { useRouter, useSearchParams } from 'next/navigation'

// ׳™׳™׳‘׳•׳ Hook ׳•-Zod
import { useUser } from '@/hooks/useUser'
import { profileSchema } from '@/lib/schemas'

const formatDisplayDate = (dateStr: string) => {
    if (!dateStr) return '-';
    return dateStr.split('-').reverse().join('/');
};

function ProfileContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const returnUrl = searchParams.get('returnUrl');

  // 1. ׳©׳™׳׳•׳© ׳‘-Hook
  const { user, profile, loading: userLoading, refresh } = useUser('/');

  const [saving, setSaving] = useState(false);
  const [uploading, setUploading] = useState(false);
  
  const [modal, setModal] = useState({
      isOpen: false,
      type: 'info' as 'success' | 'error' | 'info' | 'confirm',
      title: '',
      message: '',
      onConfirm: undefined as (() => void) | undefined
  });

  const showModal = (type: 'success' | 'error' | 'info' | 'confirm', title: string, msg: string, onConfirm?: () => void) => 
      setModal({ isOpen: true, type, title, message: msg, onConfirm });

  const [formData, setFormData] = useState({
    officialName: '', 
    lastName: '',
    idNumber: '', 
    birthDate: '',
    nickname: '', 
    fullNameAndMother: '',
    contactEmail: '',
    phone: '',
    branchAddress: '',
    zipCode: '', 
    startYear: '', 
    studentCount: '',
    staffCount: '',
    additionalStaff: '',
    profileImage: null as string | null
  });

  // ׳”׳’׳“׳¨׳•׳× ׳×׳₪׳§׳™׳“ ׳•׳׳—׳׳§׳”
  const role = user?.user_metadata?.role;
  const isHQ = role === 'dept_staff' || role === 'safety_admin' || role === 'admin';
  const branchName = user?.user_metadata?.branch_name || user?.user_metadata?.branch || '';
  const department = user?.user_metadata?.department || '';

  // ׳₪׳•׳ ׳§׳¦׳™׳” ׳׳§׳‘׳™׳¢׳× ׳×׳•׳׳¨ ׳׳’׳“׳¨׳™ ׳׳¨׳›׳– - ׳×׳•׳§׳ ׳” ׳׳–׳™׳”׳•׳™ ׳׳“׳•׳™׳§ ׳™׳•׳×׳¨
  const getRoleTitle = () => {
      let title = '׳¨׳›׳–/׳× ׳¡׳ ׳™׳£'; // ׳‘׳¨׳™׳¨׳× ׳׳—׳“׳ (׳׳•׳¢׳“׳•׳ ׳™׳ ׳•׳›׳•')
      
      const deptName = department.trim();

      // ׳‘׳“׳™׳§׳× ׳׳—׳׳§׳•׳× ׳’׳‘׳¨׳™׳•׳× (׳”׳•׳¡׳₪׳ ׳• ׳’׳ '׳×׳׳™׳' ׳•׳’׳ '׳”׳×׳׳™׳')
      const maleKeywords = ['׳”׳₪׳ ׳¡׳׳™׳', '׳₪׳ ׳¡׳׳™׳', '׳”׳×׳׳™׳', '׳×׳׳™׳', '׳‘׳ ׳™ ׳—׳‘"׳“', '׳‘׳ ׳™ ׳—׳‘׳´׳“'];
      
      // ׳‘׳“׳™׳§׳× ׳׳—׳׳§׳•׳× ׳ ׳©׳™׳•׳×
      const femaleKeywords = ['׳‘׳× ׳׳׳', '׳‘׳ ׳•׳× ׳—׳‘"׳“', '׳‘׳ ׳•׳× ׳—׳‘׳´׳“'];

      if (maleKeywords.some(d => deptName.includes(d))) {
          title = '׳¨׳›׳– ׳¡׳ ׳™׳£';
      } 
      else if (femaleKeywords.some(d => deptName.includes(d))) {
          title = '׳¨׳›׳–׳× ׳¡׳ ׳™׳£';
      }

      return title;
  };

  // ׳‘׳ ׳™׳™׳× ׳”׳›׳•׳×׳¨׳× ׳”׳׳׳׳” (׳׳׳¢׳׳”)
  const fullRoleString = isHQ 
    ? `׳¦׳•׳•׳× ׳׳˜׳” | ${department}` 
    : `${department} | ${getRoleTitle()} ${branchName}`;

  // ׳‘׳ ׳™׳™׳× ׳×׳™׳׳•׳¨ ׳”׳×׳₪׳§׳™׳“ (׳¢׳‘׳•׳¨ ׳”׳ ׳×׳•׳ ׳™׳ ׳”׳׳¢׳¨׳›׳×׳™׳™׳)
  const systemRoleDescription = isHQ 
    ? (role === 'safety_admin' ? '׳׳ ׳”׳ ׳‘׳˜׳™׳—׳•׳× ׳•׳׳₪׳¢׳׳™׳' : `׳׳˜׳” ${department}`)
    : `${getRoleTitle()} ${branchName}`;

  useEffect(() => {
    if (user && !userLoading) {
        const meta = user.user_metadata || {};
        
        setFormData({
            officialName: profile?.official_name || meta.official_name || '',
            lastName: profile?.last_name || meta.last_name || '',
            idNumber: profile?.identity_number || meta.identity_number || '', 
            birthDate: profile?.birth_date || meta.birth_date || '',
            nickname: meta.nickname || '', 
            fullNameAndMother: meta.full_name_mother || '',
            contactEmail: profile?.email || meta.contact_email || user.email || '', 
            phone: profile?.phone || meta.phone || '',
            branchAddress: meta.branch_address || '',
            zipCode: meta.zip_code || '', 
            startYear: profile?.start_year || meta.start_year || '', 
            studentCount: meta.student_count || '',
            staffCount: meta.staff_count || '',
            additionalStaff: meta.additional_staff || '',
            profileImage: profile?.avatar_url || meta.avatar_url || null
        });
    }
  }, [user, profile, userLoading]);

  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    if (!e.target.files || !e.target.files[0]) return;
    const file = e.target.files[0];
    setUploading(true);
    try {
        if (!user) throw new Error("User not found");
        const fileExt = file.name.split('.').pop();
        const fileName = `avatars/${user.id}_${Date.now()}.${fileExt}`;
        const { error: uploadError } = await supabase.storage.from('trip-files').upload(fileName, file, { upsert: true });
        if (uploadError) throw uploadError;
        const { data: { publicUrl } } = supabase.storage.from('trip-files').getPublicUrl(fileName);
        setFormData(prev => ({ ...prev, profileImage: publicUrl }));
    } catch (error: any) { showModal('error', '׳©׳’׳™׳׳”', '׳©׳’׳™׳׳” ׳‘׳”׳¢׳׳׳× ׳×׳׳•׳ ׳”: ' + error.message); } 
    finally { setUploading(false); }
  };

  const handleRemoveImageClick = (e: React.MouseEvent) => { 
      e.preventDefault(); 
      showModal('confirm', '׳׳—׳™׳§׳× ׳×׳׳•׳ ׳”', '׳”׳׳ ׳׳×/׳” ׳‘׳˜׳•׳—/׳” ׳©׳‘׳¨׳¦׳•׳ ׳ ׳׳”׳¡׳™׳¨ ׳׳× ׳”׳×׳׳•׳ ׳”?\n׳׳ ׳ ׳™׳×׳ ׳׳©׳—׳–׳¨ ׳׳× ׳”׳₪׳¢׳•׳׳” ׳׳׳—׳¨ ׳”׳©׳׳™׳¨׳”.', () => {
          setFormData(prev => ({ ...prev, profileImage: null }));
      });
  };

  const handleSave = async () => {
    const validation = profileSchema.safeParse({
        officialName: formData.officialName,
        lastName: formData.lastName,
        idNumber: formData.idNumber,
        phone: formData.phone,
        email: formData.contactEmail,
        birthDate: formData.birthDate,
        nickname: formData.nickname,
        fullNameAndMother: formData.fullNameAndMother,
        branchAddress: formData.branchAddress,
        zipCode: formData.zipCode,
        startYear: formData.startYear,
        studentCount: formData.studentCount,
        staffCount: formData.staffCount,
        additionalStaff: formData.additionalStaff,
    });

    if (!validation.success) {
        showModal('error', '׳©׳’׳™׳׳” ׳‘׳˜׳•׳₪׳¡', validation.error.issues[0].message);
        return;
    }

    setSaving(true);
    try {
      await supabase.auth.updateUser({
        data: {
          official_name: formData.officialName,
          last_name: formData.lastName,
          identity_number: formData.idNumber,
          birth_date: formData.birthDate,
          nickname: formData.nickname,
          phone: formData.phone,
          avatar_url: formData.profileImage, 
          start_year: formData.startYear, 
          full_name_mother: formData.fullNameAndMother,
          contact_email: formData.contactEmail,
          branch_address: formData.branchAddress,
          zip_code: formData.zipCode,
          student_count: formData.studentCount,
          staff_count: formData.staffCount,
          additional_staff: formData.additionalStaff,
        }
      });
      
      if (user) {
          const updates = {
              id: user.id,
              official_name: formData.officialName,
              last_name: formData.lastName,
              identity_number: formData.idNumber,
              birth_date: formData.birthDate,
              phone: formData.phone,
              email: formData.contactEmail,
              full_name: `${formData.officialName} ${formData.lastName}`.trim(),
              avatar_url: formData.profileImage,
              start_year: formData.startYear, 
              zip_code: formData.zipCode,
              updated_at: new Date()
          };
          await supabase.from('profiles').upsert(updates);
      }

      refresh();
      showModal('success', '׳”׳₪׳¨׳˜׳™׳ ׳ ׳©׳׳¨׳•', '׳”׳¢׳“׳›׳•׳ ׳‘׳•׳¦׳¢ ׳‘׳”׳¦׳׳—׳”!');
      
      if (returnUrl) {
          setTimeout(() => { router.push(returnUrl); }, 1500);
      }

    } catch (e: any) { showModal('error', '׳©׳’׳™׳׳”', '׳©׳’׳™׳׳” ׳‘׳©׳׳™׳¨׳”: ' + e.message); } 
    finally { setSaving(false); }
  };

  if (userLoading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-[#00BCD4]" size={40}/></div>;

  return (
    <>
      <Header title="׳₪׳¨׳•׳₪׳™׳ ׳׳™׳©׳™" />
      <Modal isOpen={modal.isOpen} onClose={() => setModal({...modal, isOpen: false})} type={modal.type} title={modal.title} message={modal.message} onConfirm={modal.onConfirm} />

      <div className="max-w-5xl mx-auto p-8 space-y-8 animate-fadeIn pb-32">
        
        {returnUrl && (
            <div className="bg-blue-50 border border-blue-200 p-4 rounded-2xl flex items-center justify-between animate-fadeIn shadow-sm">
                <div className="flex items-center gap-3">
                    <div className="bg-blue-100 p-2 rounded-full text-blue-600"><Info size={20}/></div>
                    <div>
                        <span className="block text-sm font-bold text-blue-900">׳”׳’׳¢׳× ׳׳›׳׳ ׳׳×׳•׳ ׳˜׳•׳₪׳¡ ׳”׳˜׳™׳•׳</span>
                        <span className="text-xs text-blue-700">׳׳׳—׳¨ ׳¢׳“׳›׳•׳ ׳”׳₪׳¨׳˜׳™׳ ׳׳—׳¥ ׳¢׳ ׳©׳׳™׳¨׳” ׳›׳“׳™ ׳׳—׳–׳•׳¨ ׳׳˜׳•׳₪׳¡.</span>
                    </div>
                </div>
                <button 
                    onClick={() => router.push(returnUrl)} 
                    className="flex items-center gap-2 text-xs font-bold text-blue-600 hover:text-blue-800 bg-white border border-blue-200 hover:bg-blue-50 px-4 py-2 rounded-xl transition-colors"
                >
                    <ArrowRight size={14}/> ׳—׳–׳¨׳” ׳׳׳ ׳©׳׳™׳¨׳”
                </button>
            </div>
        )}

        <section className="bg-white rounded-[32px] border border-gray-200 p-8 shadow-sm flex flex-col md:flex-row items-center gap-10 relative overflow-hidden">
            <div className="absolute top-0 left-0 right-0 h-2 bg-gradient-to-r from-[#00BCD4] to-[#8BC34A]"></div>
            
            <div className="relative group">
                <div className="w-32 h-32 rounded-[30px] bg-gradient-to-tr from-[#00BCD4] to-cyan-100 flex items-center justify-center text-white font-bold text-5xl shadow-xl shadow-cyan-100 border-[5px] border-white ring-1 ring-gray-100 overflow-hidden cursor-pointer relative">
                    {uploading ? <Loader2 className="animate-spin text-[#00BCD4]" size={32}/> : formData.profileImage ? <img src={formData.profileImage} alt="Profile" className="w-full h-full object-cover"/> : (formData.officialName?.[0] || <User size={48}/>)}
                    <label className="absolute inset-0 bg-black/40 flex flex-col items-center justify-center text-white opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer z-10">
                        <Camera size={24}/>
                        <span className="text-xs font-bold mt-1">׳©׳ ׳” ׳×׳׳•׳ ׳”</span>
                        <input type="file" className="hidden" accept="image/*" onChange={handleImageUpload} disabled={uploading}/>
                    </label>
                </div>
                {formData.profileImage && (
                    <button onClick={handleRemoveImageClick} className="absolute -bottom-2 -right-2 bg-white text-red-500 p-2 rounded-full shadow-md border border-gray-100 hover:bg-red-50 transition-colors z-20" title="׳”׳¡׳¨ ׳×׳׳•׳ ׳”"><Trash2 size={16}/></button>
                )}
            </div>

            <div className="text-center md:text-right flex-1 space-y-3">
                <div className="flex flex-col md:items-start items-center">
                    <h2 className="text-3xl font-black text-gray-800">{formData.officialName} {formData.lastName}</h2>
                    {formData.nickname && <span className="text-lg text-gray-400 font-bold">({formData.nickname})</span>}
                </div>
                <div className="flex flex-wrap justify-center md:justify-start gap-3 mt-2">
                    <span className="bg-cyan-50 text-[#00BCD4] border border-cyan-100 px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2">
                        <Building2 size={16}/> {fullRoleString}
                    </span>
                </div>
            </div>
        </section>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <section className="bg-[#F1F8E9] rounded-[32px] border border-green-100 p-8 shadow-inner lg:col-span-1 h-fit">
                <div className="flex items-center gap-2 mb-6 text-[#8BC34A] font-bold text-sm uppercase tracking-wider"><Lock size={14}/> ׳ ׳×׳•׳ ׳™׳ ׳׳¢׳¨׳›׳×׳™׳™׳ (׳×׳¦׳•׳’׳”)</div>
                <div className="space-y-6">
                    <div><label className="text-xs font-bold text-gray-400 block mb-1">׳×׳₪׳§׳™׳“</label><div className="font-bold text-gray-800 text-base border-b border-green-200/50 pb-2">{systemRoleDescription}</div></div>
                    <div><label className="text-xs font-bold text-gray-400 block mb-1">׳©׳ (׳׳₪׳™ ׳×"׳–)</label><div className="font-bold text-gray-800 text-lg border-b border-green-200/50 pb-2">{formData.officialName || '-'}</div></div>
                    <div><label className="text-xs font-bold text-gray-400 block mb-1">׳©׳ ׳׳©׳₪׳—׳”</label><div className="font-bold text-gray-800 text-lg border-b border-green-200/50 pb-2">{formData.lastName || '-'}</div></div>
                    <div><label className="text-xs font-bold text-gray-400 block mb-1">׳×׳¢׳•׳“׳× ׳–׳”׳•׳×</label><div className="font-bold text-gray-800 text-lg border-b border-green-200/50 pb-2 tracking-wider">{formData.idNumber || '-'}</div></div>
                    <div><label className="text-xs font-bold text-gray-400 block mb-1">׳×׳׳¨׳™׳ ׳׳™׳“׳”</label><div className="font-bold text-gray-800 text-lg border-b border-green-200/50 pb-2">{formatDisplayDate(formData.birthDate)}</div></div>
                </div>
            </section>

            <section className="bg-white rounded-[32px] border border-gray-200 p-8 shadow-sm lg:col-span-2">
                <div className="flex items-center gap-3 mb-8 border-b border-gray-100 pb-4"><ShieldCheck size={24} className="text-[#00BCD4]"/><h3 className="text-xl font-bold text-gray-800">׳¢׳“׳›׳•׳ ׳₪׳¨׳˜׳™׳ ׳׳™׳©׳™׳™׳</h3></div>
                <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <Input label="׳©׳ ׳₪׳¨׳˜׳™ (׳›׳₪׳™ ׳©׳׳•׳₪׳™׳¢ ׳‘׳×׳¢׳•׳“׳× ׳”׳–׳”׳•׳×)" value={formData.officialName} onChange={(e: any) => setFormData({...formData, officialName: e.target.value})} placeholder="׳׳“׳•׳’׳׳”: ׳™׳•׳¡׳£ ׳—׳™׳™׳"/>
                        <Input label="׳›׳™׳ ׳•׳™ / ׳©׳ ׳—׳™׳‘׳”" value={formData.nickname} onChange={(e: any) => setFormData({...formData, nickname: e.target.value})} placeholder="׳׳“׳•׳’׳׳”: ׳™׳•׳¡׳™"/>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <Input label="׳©׳ ׳׳©׳₪׳—׳”" value={formData.lastName} onChange={(e: any) => setFormData({...formData, lastName: e.target.value})}/>
                        <Input label="׳©׳ ׳׳׳ + ׳©׳ ׳”׳׳" value={formData.fullNameAndMother} onChange={(e: any) => setFormData({...formData, fullNameAndMother: e.target.value})}/>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <Input label="׳×׳¢׳•׳“׳× ׳–׳”׳•׳×" value={formData.idNumber} onChange={(e: any) => setFormData({...formData, idNumber: e.target.value})}/>
                        <Input label="׳×׳׳¨׳™׳ ׳׳™׳“׳”" type="date" value={formData.birthDate} onChange={(e: any) => setFormData({...formData, birthDate: e.target.value})}/>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <Input label="׳˜׳׳₪׳•׳ ׳ ׳™׳™׳“" value={formData.phone} onChange={(e: any) => setFormData({...formData, phone: e.target.value})}/>
                        <Input label="׳׳™׳׳™׳™׳ ׳׳™׳¦׳™׳¨׳× ׳§׳©׳¨" value={formData.contactEmail} onChange={(e: any) => setFormData({...formData, contactEmail: e.target.value})} icon={<Mail size={18}/>} placeholder="example@gmail.com"/>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                        <div className="md:col-span-2">
                            <Input label={isHQ ? "׳›׳×׳•׳‘׳× ׳׳’׳•׳¨׳™׳" : "׳›׳×׳•׳‘׳× ׳”׳¡׳ ׳™׳£"} value={formData.branchAddress} onChange={(e: any) => setFormData({...formData, branchAddress: e.target.value})} placeholder="׳¨׳—׳•׳‘, ׳׳¡׳₪׳¨, ׳¢׳™׳¨..."/>
                        </div>
                        <div>
                            <div className="flex justify-between items-end mb-1.5">
                                <label className="text-xs font-bold text-gray-500">׳׳™׳§׳•׳“</label>
                                <a href="https://doar.israelpost.co.il/locatezip" target="_blank" rel="noreferrer" className="text-[10px] font-bold text-[#E91E63] flex items-center gap-1 hover:underline">
                                    <ExternalLink size={10} /> ׳׳™׳×׳•׳¨ ׳׳™׳§׳•׳“
                                </a>
                            </div>
                            <Input value={formData.zipCode} onChange={(e: any) => setFormData({...formData, zipCode: e.target.value})} placeholder="1234567" icon={<MapPin size={16}/>}/>
                        </div>
                    </div>

                    <div className="h-px bg-gray-100 my-2"></div>
                    
                    {!isHQ && (
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 animate-fadeIn">
                            <Input label="׳©׳ ׳× ׳”׳¦׳˜׳¨׳₪׳•׳× ׳׳׳¨׳’׳•׳" type="number" value={formData.startYear} onChange={(e: any) => setFormData({...formData, startYear: e.target.value})} placeholder="2020"/>
                            <Input label="׳›׳׳•׳× ׳—׳ ׳™׳›׳™׳ ׳‘׳¡׳ ׳™׳£" type="number" value={formData.studentCount} onChange={(e: any) => setFormData({...formData, studentCount: e.target.value})}/>
                            <Input label="׳›׳׳•׳× ׳׳ ׳©׳™ ׳¦׳•׳•׳× ׳‘׳¡׳ ׳™׳£" type="number" value={formData.staffCount} onChange={(e: any) => setFormData({...formData, staffCount: e.target.value})}/>
                        </div>
                    )}
                    
                    {isHQ && (
                         <Input label="׳©׳ ׳× ׳”׳¦׳˜׳¨׳₪׳•׳× ׳׳¦׳•׳•׳×" type="number" value={formData.startYear} onChange={(e: any) => setFormData({...formData, startYear: e.target.value})} placeholder="2020"/>
                    )}
                    
                    <div className="bg-cyan-50/50 p-6 rounded-2xl border border-cyan-100">
                        <label className="text-sm font-bold text-gray-600 block mb-2">{isHQ ? '׳©׳׳•׳× ׳—׳‘׳¨׳™ ׳׳˜׳” ׳ ׳•׳¡׳₪׳™׳' : '׳©׳׳•׳× ׳¨׳›׳–׳™׳ ׳ ׳•׳¡׳₪׳™׳ ׳‘׳¡׳ ׳™׳£'}</label>
                        <textarea className="w-full p-4 rounded-xl bg-white border border-gray-200 outline-none focus:border-[#00BCD4] min-h-[80px] resize-none text-sm font-medium" placeholder="׳”׳–׳ ׳©׳׳•׳× ׳׳•׳₪׳¨׳“׳™׳ ׳‘׳₪׳¡׳™׳§׳™׳..." value={formData.additionalStaff} onChange={e => setFormData({...formData, additionalStaff: e.target.value})}></textarea>
                    </div>
                </div>
                <div className="mt-10 flex items-center justify-end gap-4">
                    <Button onClick={handleSave} isLoading={saving} variant="secondary" className="w-full md:w-auto px-12 shadow-xl shadow-green-100" icon={<Save size={20}/>}>
                        {returnUrl ? '׳©׳׳™׳¨׳” ׳•׳—׳–׳¨׳” ׳׳˜׳™׳•׳' : '׳©׳׳™׳¨׳× ׳©׳™׳ ׳•׳™׳™׳'}
                    </Button>
                </div>
            </section>
        </div>
      </div>
    </>
  )
}

export default function ProfilePage() {
  return (
    <Suspense fallback={<div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-[#00BCD4]" size={40}/></div>}>
       <ProfileContent />
    </Suspense>
  )
}


================================================================
FILE PATH: C:\Users\User\chabad-trips\app\dashboard\layout.tsx
================================================================
"use client"

import React, { useState, useEffect } from 'react';
import { Sidebar } from '@/components/layout/Sidebar';
import { Menu, Bell, X, Mail } from 'lucide-react';
import Image from 'next/image';
import { supabase } from '@/lib/supabaseClient';
import Link from 'next/link';
import { useUser } from '@/hooks/useUser';

const DEPT_LOGOS: any = {
    '׳‘׳× ׳׳׳': '/logos/bat-melech.png',
    '׳‘׳ ׳•׳× ׳—׳‘׳´׳“': '/logos/bnos-chabad.png',
    '׳”׳₪׳ ׳¡׳׳™׳': '/logos/hapanasim.png',
    '׳×׳׳™׳': '/logos/temimim.png',
    '׳׳•׳¢׳“׳•׳ ׳™ ׳”׳׳¢׳©׳™׳ ׳”׳˜׳•׳‘׳™׳': '/logos/clubs.png',
};

export default function DashboardLayout({ children }: { children: React.ReactNode }) {
  // 1. ׳©׳™׳׳•׳© ׳‘-Hook
  const { user } = useUser();
  
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
  const [unreadNotifications, setUnreadNotifications] = useState<any[]>([]);
  const [isBellOpen, setIsBellOpen] = useState(false);

  // ׳ ׳×׳•׳ ׳™׳ ׳ ׳’׳–׳¨׳™׳
  const deptLogo = user ? (DEPT_LOGOS[user.user_metadata?.department] || '/logo.png') : '/logo.png';
  const fullName = user?.user_metadata?.full_name || '';
  const avatarUrl = user?.user_metadata?.avatar_url || null;

  // 2. ׳ ׳™׳”׳•׳ ׳”׳×׳¨׳׳•׳×
  useEffect(() => {
    if (!user) return;

    const fetchNotifications = async () => {
        const { data } = await supabase.from('notifications')
            .select('id, title, is_read')
            .eq('user_id', user.id)
            .eq('is_read', false)
            .order('created_at', { ascending: false })
            .limit(5);
        setUnreadNotifications(data || []);
    };

    fetchNotifications();

    const channel = supabase.channel('layout_notifications')
        .on('postgres_changes', { 
            event: 'INSERT', 
            schema: 'public', 
            table: 'notifications',
            filter: `user_id=eq.${user.id}` 
        }, () => {
            fetchNotifications();
        })
        .subscribe();

    return () => { supabase.removeChannel(channel); }
  }, [user]);

  return (
    <div className="min-h-screen bg-[#F8F9FA] dir-rtl text-right font-sans">
      
      {/* Mobile Header */}
      <div className="md:hidden flex items-center justify-between p-3 bg-white/95 backdrop-blur-md border-b border-gray-200 sticky top-0 z-40 shadow-sm h-16">
          <div className="flex items-center gap-3">
              <button 
                onClick={() => setIsMobileMenuOpen(true)}
                className="p-2 rounded-xl bg-gray-50 text-gray-600 hover:bg-gray-100 active:scale-95 border border-gray-200"
              >
                  <Menu size={20} />
              </button>
              <div className="w-8 h-8 relative">
                 <Image src="/logo.png" alt="Logo" fill className="object-contain"/>
              </div>
              <div className="h-5 w-px bg-gray-200"></div>
              <div className="w-8 h-8 relative">
                 <Image 
                    src={deptLogo} 
                    alt="Dept" 
                    fill 
                    className="object-contain"
                    onError={(e) => { (e.target as HTMLImageElement).src = '/logo.png'; }}
                 />
              </div>
          </div>
          
          <Link href="/dashboard/profile" className="flex items-center gap-2 bg-gray-50 p-1 pl-1 pr-3 rounded-full border border-gray-100 shadow-sm">
              <div className="flex flex-col items-end">
                  <span className="text-xs font-bold text-gray-800 leading-none truncate max-w-[80px]">
                      {fullName.split(' ')[0]}
                  </span>
                  <span className="text-[9px] text-gray-500 leading-none truncate max-w-[80px] mt-0.5">
                      {user?.user_metadata?.branch || '׳׳˜׳”'}
                  </span>
              </div>
              <div className="w-8 h-8 rounded-full bg-cyan-100 border border-white overflow-hidden relative">
                  {avatarUrl ? (
                      <Image src={avatarUrl} alt="User" fill className="object-cover" />
                  ) : (
                      <div className="w-full h-full flex items-center justify-center text-cyan-600 font-bold text-xs">
                          {fullName?.[0]}
                      </div>
                  )}
              </div>
          </Link>
      </div>

      <Sidebar isOpen={isMobileMenuOpen} onClose={() => setIsMobileMenuOpen(false)} />
      
      <div className="transition-all duration-300 md:mr-56 mr-0 min-h-screen">
        {children}
      </div>

      {/* Mobile Floating Action Button (Notifications) */}
      <div className="fixed bottom-6 left-6 z-50 flex flex-col items-end gap-2 md:hidden">
          {isBellOpen && (
              <div className="bg-white rounded-2xl shadow-2xl border border-gray-100 w-72 mb-2 overflow-hidden animate-fadeIn">
                  <div className="bg-[#00BCD4] p-3 flex justify-between items-center text-white">
                      <span className="text-sm font-bold">׳”׳•׳“׳¢׳•׳× ׳—׳“׳©׳•׳×</span>
                      <button onClick={() => setIsBellOpen(false)}><X size={16}/></button>
                  </div>
                  <div className="max-h-60 overflow-y-auto">
                      {unreadNotifications.length === 0 ? (
                          <div className="p-6 text-center text-gray-400 text-xs">׳׳™׳ ׳”׳•׳“׳¢׳•׳× ׳—׳“׳©׳•׳× ׳¢׳‘׳•׳¨׳</div>
                      ) : (
                          unreadNotifications.map(n => (
                              <Link key={n.id} href="/dashboard/inbox" onClick={() => setIsBellOpen(false)} className="block p-3 border-b border-gray-50 hover:bg-gray-50 transition-colors">
                                  <div className="flex gap-2">
                                      <Mail size={14} className="text-[#00BCD4] mt-0.5 shrink-0"/>
                                      <span className="text-xs font-bold text-gray-700 line-clamp-2">{n.title}</span>
                                  </div>
                              </Link>
                          ))
                      )}
                  </div>
                  <Link href="/dashboard/inbox" onClick={() => setIsBellOpen(false)} className="block p-2 text-center text-xs font-bold text-[#00BCD4] bg-gray-50 hover:underline">
                      ׳׳›׳ ׳”׳”׳•׳“׳¢׳•׳×
                  </Link>
              </div>
          )}

          <button 
            onClick={() => setIsBellOpen(!isBellOpen)}
            className="w-12 h-12 bg-white rounded-full shadow-lg shadow-gray-300 border border-gray-100 flex items-center justify-center text-gray-600 hover:text-[#00BCD4] transition-all hover:scale-110 active:scale-95 relative"
          >
              <Bell size={22} />
              {unreadNotifications.length > 0 && (
                  <span className="absolute top-0 right-0 w-4 h-4 bg-[#E91E63] text-white text-[10px] font-bold rounded-full flex items-center justify-center border border-white animate-pulse">
                      {unreadNotifications.length}
                  </span>
              )}
          </button>
      </div>

    </div>
  );
}


================================================================
FILE PATH: C:\Users\User\chabad-trips\app\dashboard\page.tsx
================================================================
"use client"

import React, { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { Header } from '@/components/layout/Header'
import { 
  Loader2, Search, MapPin, ShieldAlert, Sun, Trash2, Calendar
} from 'lucide-react'
import { useRouter } from 'next/navigation'
import { TripCard } from '@/components/TripCard' 
import { formatHebrewDate } from '@/lib/dateUtils'
import { MultiSelectFilter } from '@/components/ui/MultiSelectFilter'
import { Modal } from '@/components/ui/Modal'

// ׳™׳™׳‘׳•׳ Hook ׳•-Zod
import { useUser } from '@/hooks/useUser'
import { cancellationSchema } from '@/lib/schemas'

export default function DashboardPage() {
  const router = useRouter();
  const { user, loading: userLoading } = useUser('/');

  const [tripsLoading, setTripsLoading] = useState(true);
  const [trips, setTrips] = useState<any[]>([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [activeFilter, setActiveFilter] = useState('all');
  const [selectedTypes, setSelectedTypes] = useState<string[]>([]);
  
  const [modal, setModal] = useState({
      isOpen: false,
      type: 'info' as 'success' | 'error' | 'info' | 'confirm',
      title: '',
      message: '',
      onConfirm: undefined as (() => void) | undefined,
      confirmText: '׳׳™׳©׳•׳¨',
      cancelText: '׳‘׳™׳˜׳•׳'
  });

  const [showCancelModal, setShowCancelModal] = useState(false);
  const [cancelTripId, setCancelTripId] = useState<string | null>(null);
  const [cancelReason, setCancelReason] = useState('');

  const filterOptions = [
      { id: "׳˜׳™׳•׳ ׳׳—׳•׳¥ ׳׳¡׳ ׳™׳£", label: "׳˜׳™׳•׳ ׳׳—׳•׳¥ ׳׳¡׳ ׳™׳£", color: "bg-[#4DD0E1]" },
      { id: "׳›׳ ׳¡/׳׳™׳¨׳•׳¢ ׳׳—׳•׳¥ ׳׳¡׳ ׳™׳£", label: "׳›׳ ׳¡/׳׳™׳¨׳•׳¢ ׳—׳•׳¥", color: "bg-[#BA68C8]" },
      { id: "׳₪׳¢׳™׳׳•׳× ׳׳ ׳©׳’׳¨׳×׳™׳× ׳‘׳¡׳ ׳™׳£", label: "׳₪׳¢׳™׳׳•׳× ׳‘׳¡׳ ׳™׳£", color: "bg-[#81C784]" },
      { id: "׳™׳¦׳™׳׳” ׳¨׳’׳׳™׳× ׳‘׳׳–׳•׳¨ ׳”׳¡׳ ׳™׳£", label: "׳™׳¦׳™׳׳” ׳¨׳’׳׳™׳×", color: "bg-[#FFB74D]" },
      { id: "׳׳—׳¨", label: "׳׳—׳¨", color: "bg-slate-400" }
  ];

  useEffect(() => {
    const fetchTrips = async () => {
        if (!user) return;
        try {
            const { data, error } = await supabase
                .from('trips')
                .select('*')
                .eq('user_id', user.id)
                .order('start_date', { ascending: false });
            
            if (error) throw error;
            setTrips(data || []);
        } catch (e) { 
            console.error('Error fetching trips:', e); 
        } finally { 
            setTripsLoading(false); 
        }
    };

    if (!userLoading && user) fetchTrips();
  }, [user, userLoading]);

  const handleDeleteDraftClick = (id: string) => {
      setModal({
          isOpen: true,
          type: 'confirm',
          title: '׳׳—׳™׳§׳× ׳˜׳™׳•׳˜׳”',
          message: '׳”׳׳ ׳׳׳—׳•׳§ ׳׳× ׳”׳˜׳™׳•׳˜׳” ׳׳¦׳׳™׳×׳•׳×?\n׳׳ ׳ ׳™׳×׳ ׳׳©׳—׳–׳¨ ׳₪׳¢׳•׳׳” ׳–׳•.',
          confirmText: '׳׳—׳§ ׳˜׳™׳•׳˜׳”',
          cancelText: '׳‘׳™׳˜׳•׳',
          onConfirm: () => executeDeleteDraft(id)
      });
  };

  const executeDeleteDraft = async (id: string) => {
      const { error } = await supabase.from('trips').delete().eq('id', id);
      if (!error) {
          setTrips(prev => prev.filter(t => t.id !== id));
          setModal(prev => ({...prev, isOpen: false}));
      } else {
          setModal({
              isOpen: true,
              type: 'error',
              title: '׳©׳’׳™׳׳”',
              message: '׳©׳’׳™׳׳” ׳‘׳׳—׳™׳§׳”: ' + error.message,
              confirmText: '׳¡׳’׳•׳¨',
              cancelText: '',
              onConfirm: undefined
          });
      }
  };

  const handleCancelClick = (id: string) => {
      setCancelTripId(id);
      setCancelReason('');
      setShowCancelModal(true);
  };

  const handleCancelTrip = async () => {
      if (!cancelTripId) return;
      const validation = cancellationSchema.safeParse({ reason: cancelReason });
      
      if (!validation.success) {
          setModal({
              isOpen: true,
              type: 'error',
              title: '׳—׳¡׳¨ ׳₪׳™׳¨׳•׳˜',
              message: validation.error.issues[0].message,
              confirmText: '׳”׳‘׳ ׳×׳™',
              cancelText: '',
              onConfirm: undefined
          });
          return;
      }

      try {
          const trip = trips.find(t => t.id === cancelTripId);
          const updatedDetails = { ...trip.details, cancellationReason: cancelReason };
          const { error } = await supabase.from('trips').update({
              status: 'cancelled',
              cancellation_reason: cancelReason, 
              details: updatedDetails
          }).eq('id', cancelTripId);
          
          if (error) throw error;
          
          setTrips(prev => prev.map(t => t.id === cancelTripId ? {...t, status: 'cancelled', cancellation_reason: cancelReason, details: updatedDetails} : t));
          setShowCancelModal(false);
          
          setModal({
              isOpen: true,
              type: 'success',
              title: '׳”׳₪׳¢׳™׳׳•׳× ׳‘׳•׳˜׳׳”',
              message: '׳”׳¡׳˜׳˜׳•׳¡ ׳¢׳•׳“׳›׳ ׳•׳”׳•׳“׳¢׳” ׳ ׳©׳׳—׳” ׳׳’׳•׳¨׳׳™׳ ׳”׳¨׳׳•׳•׳ ׳˜׳™׳™׳.',
              confirmText: '׳׳™׳©׳•׳¨',
              cancelText: '',
              onConfirm: undefined
          });

      } catch (e: any) { 
          setModal({
              isOpen: true,
              type: 'error',
              title: '׳©׳’׳™׳׳”',
              message: '׳©׳’׳™׳׳” ׳‘׳‘׳™׳˜׳•׳: ' + e.message,
              confirmText: '׳¡׳’׳•׳¨',
              cancelText: '',
              onConfirm: undefined
          });
      }
  };

  if (userLoading || tripsLoading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-[#00BCD4]" size={40}/></div>;

  const today = new Date().toISOString().split('T')[0];
  const upcomingTrip = trips
    .filter(t => t.start_date >= today && t.status !== 'rejected' && t.status !== 'cancelled' && t.status !== 'draft')
    .sort((a,b) => a.start_date.localeCompare(b.start_date))[0];

  const displayTrips = trips.filter(t => {
      if (t.status === 'cancelled') return false; 
      
      const matchesStatus = activeFilter === 'all' ? true : t.status === activeFilter;
      const matchesType = selectedTypes.length === 0 ? true : selectedTypes.includes(t.details?.tripType);
      const matchesSearch = t.name.toLowerCase().includes(searchTerm.toLowerCase());
      
      return matchesStatus && matchesType && matchesSearch;
  });

  const SafetyCard = () => (
      <div className="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm flex flex-col justify-center relative overflow-hidden h-full">
          <div className="absolute top-0 left-0 bg-red-500 text-white text-[9px] px-2 py-1 rounded-br-lg z-20 font-bold shadow-sm">׳׳•׳₪׳¦׳™׳•׳ ׳׳™ - ׳“׳•׳¨׳© ׳×׳›׳ ׳•׳×</div>
          <div className="flex items-center gap-3 mb-3 relative z-10 pt-2">
              <div className="w-10 h-10 bg-green-50 rounded-2xl flex items-center justify-center text-green-600 shrink-0 shadow-sm"><ShieldAlert size={20}/></div>
              <h3 className="text-base font-bold text-gray-800">׳—׳“׳¨ ׳׳¦׳‘</h3>
          </div>
          <p className="text-sm text-gray-500 leading-relaxed relative z-10">׳׳™׳ ׳”׳×׳¨׳׳•׳× ׳—׳¨׳™׳’׳•׳× ׳׳”׳™׳•׳.<br/><span className="text-green-600 font-bold">׳ ׳™׳×׳ ׳׳§׳™׳™׳ ׳₪׳¢׳™׳׳•׳× ׳›׳¡׳“׳¨׳”.</span></p>
          <div className="absolute top-0 right-0 w-1 h-full bg-green-500"></div>
      </div>
  );

  const WeatherCard = () => (
      <div className="bg-gradient-to-br from-[#00BCD4] to-cyan-600 p-6 rounded-3xl text-white shadow-lg shadow-cyan-100/50 flex flex-col justify-between relative overflow-hidden h-full min-h-[140px]">
          <div className="absolute top-0 left-0 bg-red-500 text-white text-[9px] px-2 py-1 rounded-br-lg z-20 font-bold shadow-sm">׳׳•׳₪׳¦׳™׳•׳ ׳׳™ - ׳“׳•׳¨׳© ׳×׳›׳ ׳•׳×</div>
          <div className="relative z-10 pt-2">
              <div className="flex justify-between items-start"><div className="text-xs font-bold opacity-80 mb-1">׳×׳—׳–׳™׳× ׳׳”׳™׳•׳</div><MapPin size={16} className="opacity-60"/></div>
              <div className="flex items-end gap-2 mt-2"><div className="text-4xl font-black">24ֲ°</div><div className="text-sm font-medium opacity-90 mb-1.5">׳™׳¨׳•׳©׳׳™׳</div></div>
              <div className="text-sm opacity-80 mt-1">׳©׳׳©׳™ ׳•׳ ׳¢׳™׳</div>
          </div>
          <Sun size={100} className="absolute -bottom-6 -left-6 text-white opacity-10 rotate-12"/>
      </div>
  );

  return (
    <>
      <Header title="׳׳¡׳ ׳¨׳׳©׳™" />
      <Modal 
        isOpen={modal.isOpen} 
        onClose={() => setModal({...modal, isOpen: false})} 
        type={modal.type} 
        title={modal.title} 
        message={modal.message} 
        onConfirm={modal.onConfirm}
        confirmText={modal.confirmText}
        cancelText={modal.cancelText} 
      />

      {showCancelModal && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fadeIn">
              <div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm text-center">
                  <div className="w-14 h-14 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4"><Trash2 size={28}/></div>
                  <h3 className="text-lg font-black text-gray-800 mb-2">׳‘׳™׳˜׳•׳ ׳₪׳¢׳™׳׳•׳×</h3>
                  <p className="text-sm text-gray-500 mb-4 font-medium leading-relaxed">׳”׳׳ ׳׳×/׳” ׳‘׳˜׳•׳—/׳” ׳©׳‘׳¨׳¦׳•׳ ׳ ׳׳‘׳˜׳ ׳׳× ׳”׳₪׳¢׳™׳׳•׳×? <br/>׳₪׳¢׳•׳׳” ׳–׳• ׳×׳¢׳“׳›׳ ׳׳× ׳׳—׳׳§׳× ׳”׳׳₪׳¢׳׳™׳ ׳•׳”׳‘׳˜׳™׳—׳•׳×.</p>
                  <textarea className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm mb-4 outline-none focus:border-red-400 min-h-[80px]" placeholder="׳ ׳ ׳׳₪׳¨׳˜ ׳׳× ׳¡׳™׳‘׳× ׳”׳‘׳™׳˜׳•׳..." value={cancelReason} onChange={e => setCancelReason(e.target.value)}></textarea>
                  <div className="flex gap-2"><button onClick={() => setShowCancelModal(false)} className="flex-1 py-2 bg-gray-100 text-gray-700 font-bold rounded-xl text-sm">׳—׳–׳¨׳”</button><button onClick={handleCancelTrip} className="flex-1 py-2 bg-red-500 text-white font-bold rounded-xl text-sm hover:bg-red-600 transition-colors">׳׳©׳¨ ׳‘׳™׳˜׳•׳</button></div>
              </div>
          </div>
      )}

      {/* ׳×׳™׳§׳•׳: min-h-screen ׳׳‘׳˜׳™׳— ׳’׳•׳‘׳” ׳׳׳ ׳›׳“׳™ ׳©׳™׳”׳™׳” ׳׳§׳•׳ ׳׳₪׳•׳₪׳׳₪ */}
      <div className="p-4 md:p-8 space-y-6 animate-fadeIn pb-32 max-w-[100vw] overflow-x-hidden md:max-w-7xl md:mx-auto min-h-screen">
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div className="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm relative overflow-hidden group hover:shadow-md transition-all h-full md:col-span-1">
                  <div className="relative z-10">
                      <div className="flex justify-between items-start mb-2"><div className="text-xs font-bold text-gray-400 uppercase tracking-widest">׳”׳₪׳¢׳™׳׳•׳× ׳”׳‘׳׳”</div>{upcomingTrip && <div className="bg-cyan-50 text-[#00BCD4] px-2 py-1 rounded-lg text-[10px] font-bold">׳‘׳§׳¨׳•׳‘</div>}</div>
                      {upcomingTrip ? (<><h3 className="text-xl font-black text-gray-800 truncate mb-1 leading-tight">{upcomingTrip.name}</h3><div className="flex items-center gap-2 text-sm text-gray-500 font-bold mt-2"><Calendar size={16} className="text-[#E91E63]"/><span>{formatHebrewDate(upcomingTrip.start_date)}</span></div></>) : (<div className="flex flex-col items-center justify-center py-4 text-center"><span className="text-gray-300 mb-2">--</span><div className="text-gray-400 font-medium text-sm">׳׳™׳ ׳₪׳¢׳™׳׳•׳™׳•׳× ׳׳×׳•׳›׳ ׳ ׳•׳× ׳‘׳§׳¨׳•׳‘</div></div>)}
                  </div>
                  <div className="w-32 h-32 bg-gradient-to-tr from-[#E91E63]/10 to-transparent rounded-full absolute -bottom-10 -left-10 transition-transform group-hover:scale-110"></div>
              </div>
              <div className="hidden md:block h-full"><SafetyCard /></div>
              <div className="hidden md:block h-full"><WeatherCard /></div>
          </div>

          <div className="space-y-4 pt-2">
              <div className="flex flex-col md:flex-row justify-between items-end gap-4">
                  <div className="flex gap-2 bg-white p-1.5 rounded-2xl border border-gray-100 w-full md:w-auto overflow-x-auto no-scrollbar shadow-sm">
                      {['all', 'approved', 'pending', 'rejected', 'draft'].map(f => {
                          const labels: any = { all: '׳”׳›׳', approved: '׳׳•׳©׳¨', pending: '׳‘׳‘׳“׳™׳§׳”', rejected: '׳ ׳“׳—׳”', draft: '׳˜׳™׳•׳˜׳•׳×' };
                          const isActive = activeFilter === f;
                          return (<button key={f} onClick={() => setActiveFilter(f)} className={`px-4 py-2 rounded-xl text-xs font-bold transition-all whitespace-nowrap flex-1 md:flex-none ${isActive ? 'bg-[#00BCD4] text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'}`}>{labels[f]}</button>)
                      })}
                  </div>

                  <div className="flex flex-col-reverse md:flex-row gap-2 w-full md:w-auto z-50">
                      <MultiSelectFilter 
                        options={filterOptions}
                        selected={selectedTypes}
                        onChange={setSelectedTypes}
                      />
                      <div className="relative flex-1 md:w-64">
                          <input type="text" placeholder="׳—׳™׳₪׳•׳© ׳׳₪׳™ ׳©׳..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full pl-4 pr-10 py-3 bg-white border border-gray-200 rounded-2xl text-sm font-bold focus:border-[#00BCD4] outline-none transition-all shadow-sm focus:ring-4 focus:ring-cyan-50"/>
                          <Search className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400" size={18}/>
                      </div>
                  </div>
              </div>

              <div className="grid grid-cols-1 gap-4">
                  {displayTrips.length === 0 ? (
                      <div className="py-20 text-center bg-white rounded-3xl border border-dashed border-gray-200 flex flex-col items-center"><div className="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-3"><Search size={24} className="text-gray-300"/></div><span className="text-gray-400 font-bold">׳׳ ׳ ׳׳¦׳׳• ׳₪׳¢׳™׳׳•׳™׳•׳× ׳×׳•׳׳׳•׳×</span></div>
                  ) : displayTrips.map(trip => (
                      <TripCard 
                          key={trip.id} 
                          trip={trip} 
                          onDeleteDraft={() => handleDeleteDraftClick(trip.id)}
                          onCancelTrip={() => handleCancelClick(trip.id)}
                      />
                  ))}
              </div>
          </div>
          <div className="grid grid-cols-1 gap-4 md:hidden mt-8 border-t border-gray-100 pt-8"><div className="h-[140px]"><SafetyCard /></div><div className="h-[160px]"><WeatherCard /></div></div>
      </div>
    </>
  )
}


================================================================
FILE PATH: C:\Users\User\chabad-trips\app\manager\approvals\page.tsx
================================================================
"use client"

import React, { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { ManagerHeader } from '@/components/layout/ManagerHeader'
import { Loader2, MapPin, Search, Eye, Calendar, User, Clock, CheckCircle, XCircle } from 'lucide-react'
import Link from 'next/link'
import { Input } from '@/components/ui/Input'

// ׳™׳™׳‘׳•׳ Hook ׳׳ ׳™׳”׳•׳ ׳׳©׳×׳׳© (׳׳•׳•׳“׳ ׳©׳׳ ׳—׳ ׳• ׳׳—׳•׳‘׳¨׳™׳)
import { useUser } from '@/hooks/useUser'

export default function ApprovalsPage() {
  // 1. ׳©׳™׳׳•׳© ׳‘-Hook
  const { user, loading: userLoading } = useUser('/');

  const [loadingTrips, setLoadingTrips] = useState(true);
  const [trips, setTrips] = useState<any[]>([]);
  const [filter, setFilter] = useState('pending');
  const [searchTerm, setSearchTerm] = useState('');

  // 2. ׳˜׳¢׳™׳ ׳× ׳ ׳×׳•׳ ׳™׳
  useEffect(() => {
    const fetchTrips = async () => {
        if (!user) return;

        const { data, error } = await supabase
            .from('trips')
            .select('*')
            .order('created_at', { ascending: false });

        if (data) setTrips(data);
        setLoadingTrips(false);
    };

    if (!userLoading && user) {
        fetchTrips();
    }
  }, [user, userLoading]);

  const filteredTrips = trips.filter(trip => {
      const matchesStatus = filter === 'all' ? true : trip.status === filter;
      const matchesSearch = trip.name?.includes(searchTerm) || 
                            trip.branch?.includes(searchTerm) || 
                            trip.coordinator_name?.includes(searchTerm);
      return matchesStatus && matchesSearch;
  });

  const getStatusBadge = (status: string) => {
      const styles: any = {
          approved: "bg-green-100 text-green-700 border-green-200",
          pending: "bg-orange-100 text-orange-700 border-orange-200",
          rejected: "bg-red-100 text-red-700 border-red-200"
      };
      const labels: any = { approved: '׳׳•׳©׳¨', pending: '׳׳׳×׳™׳', rejected: '׳ ׳“׳—׳”' };
      const icons: any = { approved: CheckCircle, pending: Clock, rejected: XCircle };
      const Icon = icons[status] || Clock;

      return (
          <span className={`px-3 py-1 rounded-full text-xs font-bold border w-fit flex items-center gap-1.5 ${styles[status] || styles.pending}`}>
              <Icon size={12}/>
              {labels[status]}
          </span>
      );
  };

  // ׳‘׳“׳™׳§׳× ׳˜׳¢׳™׳ ׳” ׳׳©׳•׳׳‘׳×
  if (userLoading || loadingTrips) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-[#00BCD4]" size={40}/></div>;

  return (
    <>
        <ManagerHeader title="׳׳™׳©׳•׳¨ ׳•׳‘׳§׳¨׳× ׳˜׳™׳•׳׳™׳" />

        <div className="p-4 md:p-8 animate-fadeIn pb-32 max-w-[100vw] overflow-x-hidden">
            
            {/* ׳¡׳¨׳’׳ ׳›׳׳™׳ ׳•׳—׳™׳₪׳•׳© */}
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                
                {/* ׳₪׳™׳׳˜׳¨׳™׳ */}
                <div className="flex bg-white p-1 rounded-xl border border-gray-200 shadow-sm w-full md:w-auto overflow-x-auto">
                    {['pending', 'approved', 'rejected', 'all'].map((f) => (
                        <button
                            key={f}
                            onClick={() => setFilter(f)}
                            className={`px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap flex-1 md:flex-none
                            ${filter === f ? 'bg-gray-800 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'}`}
                        >
                            {f === 'pending' ? '׳׳׳×׳™׳ ׳™׳' : f === 'approved' ? '׳׳•׳©׳¨׳•' : f === 'rejected' ? '׳ ׳“׳—׳•' : '׳”׳›׳'}
                        </button>
                    ))}
                </div>

                <div className="relative w-full md:w-80">
                    <Input 
                        placeholder="׳—׳™׳₪׳•׳©..." 
                        value={searchTerm}
                        onChange={(e: any) => setSearchTerm(e.target.value)}
                        icon={<Search size={18}/>}
                    />
                </div>
            </div>

            {/* --- ׳×׳¦׳•׳’׳” 1: ׳˜׳‘׳׳” (׳¨׳§ ׳׳׳—׳©׳‘) --- */}
            <div className="hidden md:block bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-sm">
                <div className="overflow-x-auto">
                    <table className="w-full text-right">
                        <thead className="bg-gray-50 border-b border-gray-100 text-gray-500 text-xs font-bold uppercase">
                            <tr>
                                <th className="p-5">׳©׳ ׳”׳˜׳™׳•׳</th>
                                <th className="p-5">׳¨׳›׳– / ׳¡׳ ׳™׳£</th>
                                <th className="p-5">׳×׳׳¨׳™׳›׳™׳</th>
                                <th className="p-5">׳¡׳˜׳˜׳•׳¡</th>
                                <th className="p-5 text-left">׳₪׳¢׳•׳׳•׳×</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-50">
                            {filteredTrips.map((trip) => (
                                <tr key={trip.id} className="hover:bg-gray-50 transition-colors">
                                    <td className="p-5">
                                        <div className="font-bold text-gray-800">{trip.name}</div>
                                        <div className="text-xs text-gray-400 flex items-center gap-1 mt-1">
                                            <MapPin size={12}/> {trip.details?.timeline?.[0]?.finalLocation || '׳׳ ׳¦׳•׳™׳ ׳׳™׳§׳•׳'}
                                        </div>
                                    </td>
                                    <td className="p-5">
                                        <div className="flex items-center gap-2">
                                            <div className="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 font-bold text-xs shrink-0">
                                                {trip.coordinator_name?.[0]}
                                            </div>
                                            <div>
                                                <div className="font-bold text-gray-700 text-sm">{trip.coordinator_name}</div>
                                                <div className="text-xs text-gray-400">{trip.branch}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td className="p-5 text-sm font-medium text-gray-600">
                                        {new Date(trip.start_date).toLocaleDateString('he-IL')}
                                    </td>
                                    <td className="p-5">
                                        {getStatusBadge(trip.status)}
                                    </td>
                                    <td className="p-5 text-left">
                                        <Link href={`/manager/approvals/${trip.id}`}>
                                            <button className="bg-[#00BCD4] hover:bg-cyan-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md shadow-cyan-100 transition-all flex items-center gap-2 ml-auto">
                                                <Eye size={16}/> ׳¦׳₪׳” ׳•׳˜׳₪׳
                                            </button>
                                        </Link>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>

            {/* --- ׳×׳¦׳•׳’׳” 2: ׳›׳¨׳˜׳™׳¡׳™׳ (׳¨׳§ ׳׳˜׳׳₪׳•׳) --- */}
            <div className="md:hidden space-y-4">
                {filteredTrips.map((trip) => (
                    <div key={trip.id} className="bg-white p-5 rounded-2xl border border-gray-200 shadow-sm">
                        
                        {/* ׳›׳•׳×׳¨׳× ׳•׳¡׳˜׳˜׳•׳¡ */}
                        <div className="flex justify-between items-start mb-3">
                            <div>
                                <h3 className="font-black text-gray-800 text-lg">{trip.name}</h3>
                                <div className="text-xs text-gray-500 flex items-center gap-1 mt-1">
                                    <MapPin size={12}/> {trip.details?.timeline?.[0]?.finalLocation || '׳׳ ׳¦׳•׳™׳'}
                                </div>
                            </div>
                            {getStatusBadge(trip.status)}
                        </div>

                        {/* ׳₪׳¨׳˜׳™׳ ׳ ׳•׳¡׳₪׳™׳ */}
                        <div className="bg-gray-50 rounded-xl p-3 mb-4 space-y-2 text-sm text-gray-600">
                            <div className="flex items-center gap-2">
                                <User size={14} className="text-gray-400"/>
                                <span className="font-bold">{trip.coordinator_name}</span> 
                                <span className="text-gray-400">|</span> 
                                <span>{trip.branch}</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <Calendar size={14} className="text-gray-400"/>
                                <span>{new Date(trip.start_date).toLocaleDateString('he-IL')}</span>
                            </div>
                        </div>

                        {/* ׳›׳₪׳×׳•׳¨ ׳₪׳¢׳•׳׳” */}
                        <Link href={`/manager/approvals/${trip.id}`} className="block">
                            <button className="w-full bg-[#00BCD4] text-white py-3 rounded-xl font-bold shadow-md shadow-cyan-100 flex items-center justify-center gap-2 active:scale-95 transition-all">
                                <Eye size={18}/> ׳›׳ ׳¡ ׳׳˜׳™׳₪׳•׳ ׳‘׳‘׳§׳©׳”
                            </button>
                        </Link>
                    </div>
                ))}
            </div>

            {filteredTrips.length === 0 && <div className="p-12 text-center text-gray-400 font-medium">׳׳ ׳ ׳׳¦׳׳• ׳˜׳™׳•׳׳™׳</div>}
        </div>
    </>
  )
}


================================================================
FILE PATH: C:\Users\User\chabad-trips\app\manager\inbox\page.tsx
================================================================
"use client"

import React, { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { ManagerHeader } from '@/components/layout/ManagerHeader'
import { Button } from '@/components/ui/Button'
import { Modal } from '@/components/ui/Modal'
import { Loader2, HelpCircle, Bug, Reply, Send, X, User, CheckCircle } from 'lucide-react'

// ׳™׳™׳‘׳•׳ Hook ׳•-Zod
import { useUser } from '@/hooks/useUser'
import { managerReplySchema } from '@/lib/schemas'

const SUPER_ADMIN_EMAIL = 'avremihalperin@gmail.com';

export default function ManagerInbox() {
  // 1. ׳©׳™׳׳•׳© ׳‘-Hook
  const { user, loading: userLoading } = useUser('/');

  const [messagesLoading, setMessagesLoading] = useState(true);
  const [messages, setMessages] = useState<any[]>([]);
  
  // ׳׳•׳“׳ ׳’׳׳•׳‘׳׳™
  const [modal, setModal] = useState({
      isOpen: false,
      type: 'info' as 'success' | 'error' | 'info' | 'confirm',
      title: '',
      message: '',
      onConfirm: undefined as (() => void) | undefined
  });

  const showModal = (type: 'success' | 'error' | 'info' | 'confirm', title: string, msg: string) => 
      setModal({ isOpen: true, type, title, message: msg, onConfirm: undefined });

  // ׳ ׳™׳”׳•׳ ׳×׳’׳•׳‘׳”
  const [replyingTo, setReplyingTo] = useState<string | null>(null);
  const [replyText, setReplyText] = useState('');
  const [sendingReply, setSendingReply] = useState(false);

  // 2. ׳˜׳¢׳™׳ ׳× ׳”׳•׳“׳¢׳•׳×
  useEffect(() => {
    const fetchMessages = async () => {
        if (!user) return;

        const { data } = await supabase
            .from('contact_messages')
            .select('*, user:user_id ( email, raw_user_meta_data )') 
            .order('created_at', { ascending: false });
        
        if (data) setMessages(data);
        setMessagesLoading(false);
    };

    if (!userLoading && user) {
        fetchMessages();
    }
  }, [user, userLoading]);

  // ׳—׳™׳©׳•׳‘ ׳”׳¨׳©׳׳•׳× (׳׳‘׳•׳¡׳¡ ׳¢׳ ׳”-User ׳׳”-Hook)
  const isSuperAdmin = user?.email === SUPER_ADMIN_EMAIL || user?.user_metadata?.contact_email === SUPER_ADMIN_EMAIL;

  const refreshMessages = async () => {
      const { data } = await supabase
          .from('contact_messages')
          .select('*, user:user_id ( email, raw_user_meta_data )') 
          .order('created_at', { ascending: false });
      if (data) setMessages(data);
  };

  const markAsTreated = async (id: string) => {
      await supabase.from('contact_messages').update({ status: 'treated' }).eq('id', id);
      refreshMessages();
  };

  const sendReply = async (originalMsg: any) => {
      // 3. ׳•׳׳™׳“׳¦׳™׳” ׳¢׳ Zod
      const validation = managerReplySchema.safeParse({ replyText });
      if (!validation.success) {
          showModal('error', '׳©׳’׳™׳׳”', validation.error.issues[0].message);
          return;
      }

      setSendingReply(true);

      try {
          // ׳©׳׳™׳—׳× ׳”׳×׳¨׳׳” ׳׳׳©׳×׳׳©
          await supabase.from('notifications').insert([{
              user_id: originalMsg.user_id,
              title: `׳×׳©׳•׳‘׳” ׳׳₪׳ ׳™׳™׳×׳: ${originalMsg.subject}`,
              message: `׳׳˜׳” ׳‘׳˜׳™׳—׳•׳× ׳¢׳ ׳”:\n"${replyText}"`,
              type: 'info',
              link: '/dashboard/inbox' // ׳׳₪׳ ׳” ׳׳“׳•׳׳¨ ׳”׳ ׳›׳ ׳¡ ׳©׳ ׳”׳׳©׳×׳׳©
          }]);

          // ׳¢׳“׳›׳•׳ ׳”׳•׳“׳¢׳” ׳׳§׳•׳¨׳™׳× ׳¢׳ ׳”׳×׳©׳•׳‘׳” ׳•׳©׳™׳ ׳•׳™ ׳¡׳˜׳˜׳•׳¡
          await supabase.from('contact_messages').update({ 
              status: 'treated',
              admin_reply: replyText 
          }).eq('id', originalMsg.id);
          
          await refreshMessages();
          
          setReplyingTo(null);
          setReplyText('');
          showModal('success', '׳ ׳©׳׳—', '׳”׳×׳©׳•׳‘׳” ׳ ׳©׳׳—׳” ׳‘׳”׳¦׳׳—׳” ׳•׳”׳׳©׳×׳׳© ׳§׳™׳‘׳ ׳”׳×׳¨׳׳”.');

      } catch (e) {
          showModal('error', '׳©׳’׳™׳׳”', '׳©׳’׳™׳׳” ׳‘׳©׳׳™׳—׳”');
      } finally {
          setSendingReply(false);
      }
  };

  if (userLoading || messagesLoading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-[#00BCD4]" size={40}/></div>;

  return (
    <>
      <ManagerHeader title="׳“׳•׳׳¨ ׳ ׳›׳ ׳¡ ׳•׳”׳•׳“׳¢׳•׳×" />
      
      <Modal 
        isOpen={modal.isOpen} 
        onClose={() => setModal({...modal, isOpen: false})} 
        type={modal.type} 
        title={modal.title} 
        message={modal.message} 
      />

      <div className="p-4 md:p-8 animate-fadeIn max-w-[100vw] overflow-x-hidden pb-32">
          
          <div className="bg-white rounded-3xl border border-gray-200 shadow-sm overflow-hidden">
              <div className="overflow-x-auto">
                <table className="w-full text-right hidden md:table">
                    <thead className="bg-gray-50 text-gray-500 text-xs font-bold uppercase border-b border-gray-100">
                        <tr>
                            <th className="p-5">׳ ׳•׳©׳</th>
                            <th className="p-5">׳׳׳×</th>
                            <th className="p-5">׳×׳•׳›׳</th>
                            <th className="p-5">׳¡׳˜׳˜׳•׳¡</th>
                            <th className="p-5 text-left">׳₪׳¢׳•׳׳•׳×</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-50">
                        {messages.map((msg) => {
                            const isBug = msg.subject?.includes('׳×׳§׳׳”') || msg.subject?.includes('׳‘׳׳’');
                            // ׳¡׳™׳ ׳•׳ ׳‘׳׳’׳™׳ ׳׳ ׳׳ ׳¡׳•׳₪׳¨-׳׳“׳׳™׳
                            if (isBug && !isSuperAdmin) return null;
                            
                            const isReplying = replyingTo === msg.id;
                            const senderName = msg.user?.raw_user_meta_data?.full_name || '׳׳©׳×׳׳© ׳׳ ׳™׳“׳•׳¢';

                            return (
                                <React.Fragment key={msg.id}>
                                    <tr className={`transition-colors ${isReplying ? 'bg-blue-50' : 'hover:bg-gray-50'}`}>
                                        <td className="p-5 font-bold text-gray-800 flex items-center gap-2">
                                            {isBug ? <Bug size={16} className="text-red-500"/> : <HelpCircle size={16} className="text-blue-500"/>}
                                            {msg.subject}
                                        </td>
                                        <td className="p-5 text-sm text-gray-600">
                                            <div className="font-bold">{senderName}</div>
                                            <div className="text-xs text-gray-400">{new Date(msg.created_at).toLocaleDateString('he-IL')}</div>
                                        </td>
                                        <td className="p-5 text-sm text-gray-600 max-w-xs truncate cursor-pointer" title={msg.message} onClick={() => showModal('info', '׳×׳•׳›׳ ׳”׳”׳•׳“׳¢׳”', msg.message)}>
                                            {msg.message}
                                        </td>
                                        <td className="p-5">
                                            {msg.status === 'treated' 
                                                ? <span className="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold border border-green-200">׳˜׳•׳₪׳</span>
                                                : <span className="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-xs font-bold border border-yellow-200">׳—׳“׳©</span>
                                            }
                                        </td>
                                        <td className="p-5 text-left flex justify-end gap-2">
                                            {msg.status !== 'treated' && !isReplying && (
                                                <>
                                                    <Button variant="primary" onClick={() => setReplyingTo(msg.id)} className="h-8 px-4 text-xs" icon={<Reply size={14}/>}>׳¢׳ ׳”</Button>
                                                    <Button variant="ghost" onClick={() => markAsTreated(msg.id)} className="h-8 px-2 text-green-600 hover:bg-green-50"><CheckCircle size={18}/></Button>
                                                </>
                                            )}
                                        </td>
                                    </tr>
                                    {isReplying && (
                                        <tr className="bg-blue-50/50 animate-fadeIn">
                                            <td colSpan={5} className="p-5">
                                                <div className="bg-white border border-blue-100 rounded-xl p-4 shadow-sm max-w-2xl mr-auto">
                                                    <p className="text-xs font-bold text-blue-600 mb-2">׳×׳’׳•׳‘׳” ׳: {senderName}</p>
                                                    <textarea 
                                                        className="w-full p-3 border border-gray-200 rounded-lg text-sm focus:border-blue-500 outline-none"
                                                        placeholder="׳›׳×׳•׳‘ ׳׳× ׳×׳©׳•׳‘׳×׳ ׳›׳׳..."
                                                        rows={3}
                                                        value={replyText}
                                                        onChange={e => setReplyText(e.target.value)}
                                                    ></textarea>
                                                    <div className="flex justify-end gap-2 mt-2">
                                                        <Button variant="secondary" onClick={() => setReplyingTo(null)} className="bg-gray-200 text-gray-600 h-8 px-4"><X size={14}/></Button>
                                                        <Button onClick={() => sendReply(msg)} isLoading={sendingReply} icon={<Send size={14}/>} className="bg-blue-600 h-8 px-6 text-xs">׳©׳׳— ׳×׳©׳•׳‘׳” ׳•׳¡׳’׳•׳¨</Button>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    )}
                                </React.Fragment>
                            )
                        })}
                    </tbody>
                </table>
              </div>

              {/* ׳׳•׳‘׳™׳™׳ ׳§׳׳¨׳“׳¡ */}
              <div className="md:hidden space-y-4 p-4">
                  {messages.map((msg) => {
                       const isBug = msg.subject?.includes('׳×׳§׳׳”') || msg.subject?.includes('׳‘׳׳’');
                       if (isBug && !isSuperAdmin) return null;
                       const isReplying = replyingTo === msg.id;
                       const senderName = msg.user?.raw_user_meta_data?.full_name || '׳׳©׳×׳׳© ׳׳ ׳™׳“׳•׳¢';

                       return (
                           <div key={msg.id} className={`bg-white p-5 rounded-2xl border shadow-sm ${isReplying ? 'border-blue-300 ring-2 ring-blue-50' : 'border-gray-200'}`}>
                               <div className="flex justify-between items-start mb-3">
                                   <div className="flex items-start gap-2">
                                       {isBug ? <Bug size={18} className="text-red-500 mt-1"/> : <HelpCircle size={18} className="text-blue-500 mt-1"/>}
                                       <div>
                                           <h3 className="font-bold text-gray-800 text-sm leading-tight">{msg.subject}</h3>
                                           <div className="flex items-center gap-2 mt-1">
                                               <span className="text-xs text-gray-500 flex items-center gap-1"><User size={12}/> {senderName}</span>
                                           </div>
                                       </div>
                                   </div>
                               </div>
                               <div className="bg-gray-50 p-3 rounded-xl text-sm text-gray-700 mb-4 border border-gray-100">{msg.message}</div>
                               {msg.status !== 'treated' && !isReplying && (
                                   <div className="flex gap-2">
                                       <Button onClick={() => setReplyingTo(msg.id)} className="flex-1 h-10 text-sm" icon={<Reply size={16}/>}>׳”׳©׳‘</Button>
                                       <Button variant="secondary" onClick={() => markAsTreated(msg.id)} className="h-10 w-12 flex justify-center"><CheckCircle size={18}/></Button>
                                   </div>
                               )}
                               {isReplying && (
                                   <div className="animate-fadeIn mt-2 pt-2 border-t border-blue-100">
                                       <textarea className="w-full p-3 border border-gray-200 rounded-xl text-sm focus:border-blue-500 outline-none bg-blue-50/30" placeholder="׳”׳§׳׳“ ׳×׳©׳•׳‘׳”..." rows={3} value={replyText} onChange={e => setReplyText(e.target.value)}></textarea>
                                       <div className="flex gap-2 mt-3">
                                           <Button variant="secondary" onClick={() => setReplyingTo(null)} className="bg-gray-100 text-gray-500 h-10 px-0 w-12 flex items-center justify-center"><X size={18}/></Button>
                                           <Button onClick={() => sendReply(msg)} isLoading={sendingReply} icon={<Send size={16}/>} className="bg-blue-600 h-10 text-sm flex-1">׳©׳׳—</Button>
                                       </div>
                                   </div>
                               )}
                           </div>
                       )
                  })}
              </div>
          </div>
      </div>
    </>
  )
}


================================================================
FILE PATH: C:\Users\User\chabad-trips\app\manager\profile\page.tsx
================================================================
"use client"

import React, { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { ManagerHeader } from '@/components/layout/ManagerHeader'
import { Button } from '@/components/ui/Button'
import { Input } from '@/components/ui/Input'
import { Modal } from '@/components/ui/Modal'
import { Save, User, Mail, Lock, ShieldCheck, Camera, Loader2 } from 'lucide-react'

// ׳™׳™׳‘׳•׳ Hook ׳•-Zod
import { useUser } from '@/hooks/useUser'
import { profileSchema } from '@/lib/schemas'

export default function ManagerProfile() {
  // 1. ׳©׳™׳׳•׳© ׳‘-Hook
  const { user, profile, loading: userLoading, refresh } = useUser('/');

  const [saving, setSaving] = useState(false);
  const [uploading, setUploading] = useState(false);

  // ׳׳•׳“׳ ׳’׳׳•׳‘׳׳™
  const [modal, setModal] = useState({
      isOpen: false,
      type: 'info' as 'success' | 'error' | 'info' | 'confirm',
      title: '',
      message: '',
      onConfirm: undefined as (() => void) | undefined
  });

  const showModal = (type: 'success' | 'error' | 'info' | 'confirm', title: string, msg: string) => 
      setModal({ isOpen: true, type, title, message: msg, onConfirm: undefined });

  const [formData, setFormData] = useState({
    officialName: '', 
    lastName: '',
    idNumber: '', 
    birthDate: '',
    nickname: '',
    fullNameAndMother: '', 
    email: '',
    phone: '',
    profileImage: null as string | null
  });

  // 2. ׳˜׳¢׳™׳ ׳× ׳ ׳×׳•׳ ׳™׳
  useEffect(() => {
    if (user && !userLoading) {
        const meta = user.user_metadata || {};
        
        let extractedId = profile?.identity_number || meta.id_number || '';
        if (!extractedId && user.email?.includes('@')) {
            const possibleId = user.email.split('@')[0];
            if (/^\d+$/.test(possibleId)) extractedId = possibleId;
        }

        const fallbackFirstName = meta.full_name?.split(' ')[0] || '';
        const fallbackLastName = meta.full_name?.split(' ').slice(1).join(' ') || '';

        setFormData({
            officialName: profile?.official_name || meta.official_name || meta.first_name || fallbackFirstName,
            lastName: profile?.last_name || meta.last_name || fallbackLastName,
            idNumber: extractedId,
            birthDate: profile?.birth_date || meta.birth_date || '', 
            nickname: meta.nickname || '',
            fullNameAndMother: meta.full_name_mother || '', 
            email: profile?.email || meta.contact_email || user.email || '',
            phone: profile?.phone || meta.phone || '',
            profileImage: profile?.avatar_url || meta.avatar_url || null
        });
    }
  }, [user, profile, userLoading]);

  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    if (!e.target.files || !e.target.files[0]) return;
    const file = e.target.files[0];
    setUploading(true);

    try {
      const fileExt = file.name.split('.').pop();
      const fileName = `avatars/${user.id}_${Date.now()}.${fileExt}`;
      const { error } = await supabase.storage.from('trip-files').upload(fileName, file, { upsert: true });
      if (error) throw error;
      const { data } = supabase.storage.from('trip-files').getPublicUrl(fileName);
      setFormData(prev => ({ ...prev, profileImage: data.publicUrl }));
    } catch (error: any) {
      showModal('error', '׳©׳’׳™׳׳”', error.message);
    } finally {
      setUploading(false);
    }
  };

  const handleSave = async () => {
      // 3. ׳•׳׳™׳“׳¦׳™׳” ׳¢׳ Zod
      const validation = profileSchema.safeParse({
          officialName: formData.officialName,
          lastName: formData.lastName,
          idNumber: formData.idNumber,
          phone: formData.phone,
          email: formData.email,
          birthDate: formData.birthDate,
          nickname: formData.nickname,
          fullNameAndMother: formData.fullNameAndMother,
      });

      if (!validation.success) {
          showModal('error', '׳©׳’׳™׳׳” ׳‘׳˜׳•׳₪׳¡', validation.error.issues[0].message);
          return;
      }

      setSaving(true);
      
      const { error } = await supabase.auth.updateUser({
          data: { 
              official_name: formData.officialName,
              first_name: formData.officialName, 
              last_name: formData.lastName,
              nickname: formData.nickname,
              birth_date: formData.birthDate,
              full_name_mother: formData.fullNameAndMother, 
              phone: formData.phone,
              contact_email: formData.email,
              avatar_url: formData.profileImage,
              full_name: `${formData.officialName} ${formData.lastName}`
          }
      });

      // ׳¢׳“׳›׳•׳ ׳’׳ ׳‘׳˜׳‘׳׳× ׳₪׳¨׳•׳₪׳™׳׳™׳ ׳׳ ׳¦׳¨׳™׳
      if (!error && user) {
          await supabase.from('profiles').upsert({
              id: user.id,
              official_name: formData.officialName,
              last_name: formData.lastName,
              identity_number: formData.idNumber,
              birth_date: formData.birthDate,
              phone: formData.phone,
              email: formData.email,
              full_name: `${formData.officialName} ${formData.lastName}`.trim(),
              avatar_url: formData.profileImage,
              updated_at: new Date()
          });
      }

      setSaving(false);
      
      if (error) {
          showModal('error', '׳©׳’׳™׳׳”', error.message);
      } else {
          refresh(); // ׳¨׳¢׳ ׳•׳ ׳”׳ ׳×׳•׳ ׳™׳ ׳”׳’׳׳•׳‘׳׳™׳™׳
          showModal('success', '׳ ׳©׳׳¨', '׳”׳₪׳¨׳•׳₪׳™׳ ׳¢׳•׳“׳›׳ ׳‘׳”׳¦׳׳—׳”');
      }
  };

  if (userLoading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-gray-400"/></div>;

  return (
    <>
      <ManagerHeader title="׳₪׳¨׳•׳₪׳™׳ ׳׳™׳©׳™ - ׳׳ ׳”׳" />
      <Modal isOpen={modal.isOpen} onClose={() => setModal({...modal, isOpen: false})} type={modal.type} title={modal.title} message={modal.message} />
      
      <div className="p-8 max-w-5xl mx-auto pb-32 animate-fadeIn">
          
          <div className="bg-white rounded-[32px] p-8 border border-gray-200 shadow-sm flex items-center gap-8 mb-8">
               <div className="relative group w-24 h-24">
                   <div className="w-full h-full bg-gray-800 rounded-3xl flex items-center justify-center text-white text-3xl font-bold overflow-hidden border-4 border-white shadow-lg">
                      {formData.profileImage ? (
                          <img src={formData.profileImage} className="w-full h-full object-cover"/>
                      ) : (
                          formData.officialName?.[0] || <User/>
                      )}
                   </div>
                   <label className="absolute inset-0 bg-black/50 rounded-3xl flex items-center justify-center opacity-0 group-hover:opacity-100 cursor-pointer transition-all text-white">
                       <Camera size={24}/>
                       <input type="file" className="hidden" onChange={handleImageUpload} disabled={uploading} />
                   </label>
               </div>
               <div>
                   <h2 className="text-3xl font-black text-gray-800">{formData.officialName} {formData.lastName}</h2>
                   <div className="flex items-center gap-2 text-gray-500 font-bold mt-1">
                       <ShieldCheck size={18} className="text-[#00BCD4]"/> ׳׳ ׳”׳ ׳׳¢׳¨׳›׳× ׳¨׳׳©׳™
                   </div>
               </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
              
              <div className="bg-[#F1F8E9] p-6 rounded-3xl border border-green-100 h-fit">
                  <div className="flex items-center gap-2 mb-6 text-[#8BC34A] font-bold text-sm uppercase tracking-wider">
                      <Lock size={14}/> ׳₪׳¨׳˜׳™ ׳׳¢׳¨׳›׳×
                  </div>
                  <div className="space-y-4">
                      <div>
                          <label className="text-xs font-bold text-gray-400">׳©׳ ׳₪׳¨׳˜׳™ (׳¨׳©׳׳™)</label>
                          <div className="font-bold text-gray-800 text-lg border-b border-green-200/50 pb-1">{formData.officialName || '-'}</div>
                      </div>
                      <div>
                          <label className="text-xs font-bold text-gray-400">׳©׳ ׳׳©׳₪׳—׳”</label>
                          <div className="font-bold text-gray-800 text-lg border-b border-green-200/50 pb-1">{formData.lastName || '-'}</div>
                      </div>
                      <div>
                          <label className="text-xs font-bold text-gray-400">׳×׳¢׳•׳“׳× ׳–׳”׳•׳×</label>
                          <div className="font-bold text-gray-800 text-lg border-b border-green-200/50 pb-1 tracking-wider">{formData.idNumber || '-'}</div>
                      </div>
                      <div>
                          <label className="text-xs font-bold text-gray-400">׳×׳׳¨׳™׳ ׳׳™׳“׳”</label>
                          <div className="font-bold text-gray-800 text-lg border-b border-green-200/50 pb-1">{formData.birthDate || '-'}</div>
                      </div>
                  </div>
              </div>

              <div className="md:col-span-2 bg-white p-8 rounded-3xl border border-gray-200 shadow-sm">
                  <h3 className="text-xl font-bold text-gray-800 mb-6">׳¢׳“׳›׳•׳ ׳₪׳¨׳˜׳™׳</h3>
                  <div className="space-y-6">
                      
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <Input label="׳©׳ ׳₪׳¨׳˜׳™ (׳›׳₪׳™ ׳©׳׳•׳₪׳™׳¢ ׳‘׳×׳¢׳•׳“׳× ׳–׳”׳•׳×)" value={formData.officialName} onChange={(e: any) => setFormData({...formData, officialName: e.target.value})} />
                          <Input label="׳›׳™׳ ׳•׳™ / ׳©׳ ׳—׳™׳‘׳”" value={formData.nickname} onChange={(e: any) => setFormData({...formData, nickname: e.target.value})} />
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <Input label="׳©׳ ׳׳©׳₪׳—׳”" value={formData.lastName} onChange={(e: any) => setFormData({...formData, lastName: e.target.value})} />
                          <Input label="׳˜׳׳₪׳•׳ ׳ ׳™׳™׳“" value={formData.phone} onChange={(e: any) => setFormData({...formData, phone: e.target.value})} />
                      </div>

                      <Input label="׳©׳ ׳׳׳ + ׳©׳ ׳”׳׳ (׳׳×׳₪׳™׳׳”)" value={formData.fullNameAndMother} onChange={(e: any) => setFormData({...formData, fullNameAndMother: e.target.value})} placeholder="׳׳“׳•׳’׳׳”: ׳™׳•׳¡׳£ ׳‘׳ ׳©׳¨׳”" />

                      <Input label="׳׳™׳׳™׳™׳ ׳׳™׳¦׳™׳¨׳× ׳§׳©׳¨" value={formData.email} onChange={(e: any) => setFormData({...formData, email: e.target.value})} icon={<Mail size={18}/>} />
                      
                      <div className="pt-6 flex justify-end border-t border-gray-100 mt-6">
                          <Button onClick={handleSave} isLoading={saving} icon={<Save size={18}/>} className="bg-gray-800 hover:bg-gray-900 px-10 shadow-lg shadow-gray-200">
                              ׳©׳׳•׳¨ ׳©׳™׳ ׳•׳™׳™׳
                          </Button>
                      </div>
                  </div>
              </div>
          </div>
      </div>
    </>
  )
}


================================================================
FILE PATH: C:\Users\User\chabad-trips\app\manager\users\page.tsx
================================================================
"use client"

import React, { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { ManagerHeader } from '@/components/layout/ManagerHeader'
import { Loader2, Shield, User, MapPin, CheckCircle, XCircle, ChevronDown, ChevronUp } from 'lucide-react'
import { Modal } from '@/components/ui/Modal'
import { Button } from '@/components/ui/Button'
import { useRouter } from 'next/navigation'

// ׳™׳™׳‘׳•׳ Hook
import { useUser } from '@/hooks/useUser'

export default function UsersManagement() {
  const router = useRouter();
  
  // 1. ׳©׳™׳׳•׳© ׳‘-Hook
  const { user, profile, loading: userLoading } = useUser('/');

  const [loadingUsers, setLoadingUsers] = useState(true);
  const [users, setUsers] = useState<any[]>([]);
  const [filter, setFilter] = useState('pending');
  const [expandedUser, setExpandedUser] = useState<string | null>(null);

  // ׳׳•׳“׳ ׳’׳׳•׳‘׳׳™
  const [modal, setModal] = useState({
      isOpen: false,
      type: 'info' as 'success' | 'error' | 'info' | 'confirm',
      title: '',
      message: '',
      onConfirm: undefined as (() => void) | undefined
  });

  const showModal = (type: 'success' | 'error' | 'info' | 'confirm', title: string, msg: string, onConfirm?: () => void) => 
      setModal({ isOpen: true, type, title, message: msg, onConfirm });

  // 2. ׳˜׳¢׳™׳ ׳× ׳ ׳×׳•׳ ׳™׳ ׳•׳‘׳“׳™׳§׳× ׳”׳¨׳©׳׳•׳×
  useEffect(() => {
    const fetchUsers = async () => {
        if (!user) return;

        // ׳‘׳“׳™׳§׳× ׳”׳¨׳©׳׳•׳× (׳¨׳§ ׳׳׳ ׳”׳׳™׳ ׳׳•׳¨׳©׳™׳)
        // ׳׳₪׳©׳¨ ׳׳”׳•׳¡׳™׳£ ׳›׳׳ ׳׳•׳’׳™׳§׳” ׳™׳•׳×׳¨ ׳׳—׳׳™׳¨׳” ׳׳ ׳¦׳¨׳™׳
        const isManager = profile?.role === 'admin' || profile?.role === 'safety_admin' || user.user_metadata?.department === '׳‘׳˜׳™׳—׳•׳× ׳•׳׳₪׳¢׳׳™׳';
        
        if (profile && !isManager) {
             router.push('/dashboard');
             return;
        }

        const { data } = await supabase.from('users_management_view').select('*');
        if (data) setUsers(data);
        setLoadingUsers(false);
    };

    if (!userLoading && user) {
        fetchUsers();
    }
  }, [user, userLoading, profile, router]);

  const updateUserStatus = (userId: string, newStatus: string) => {
      showModal('confirm', '׳©׳™׳ ׳•׳™ ׳¡׳˜׳˜׳•׳¡ ׳׳©׳×׳׳©', `׳”׳׳ ׳׳×׳” ׳‘׳˜׳•׳— ׳©׳‘׳¨׳¦׳•׳ ׳ ׳׳©׳ ׳•׳× ׳׳× ׳”׳¡׳˜׳˜׳•׳¡ ׳-${newStatus === 'approved' ? '׳₪׳¢׳™׳' : '׳—׳¡׳•׳'}?`, async () => {
          const { error } = await supabase.rpc('update_user_status', { 
              user_id: userId, 
              new_status: newStatus 
          });
          
          if (error) {
              showModal('error', '׳©׳’׳™׳׳”', '׳©׳’׳™׳׳” ׳‘׳¢׳“׳›׳•׳: ' + error.message);
          } else {
              setUsers(prev => prev.map(u => {
                  if (u.id === userId) {
                      const newMeta = { ...u.raw_user_meta_data, status: newStatus };
                      return { ...u, raw_user_meta_data: newMeta };
                  }
                  return u;
              }));
              showModal('success', '׳¢׳•׳“׳›׳ ׳‘׳”׳¦׳׳—׳”', '׳¡׳˜׳˜׳•׳¡ ׳”׳׳©׳×׳׳© ׳¢׳•׳“׳›׳.');
          }
      });
  };

  const filteredUsers = users.filter(u => {
      const status = u.raw_user_meta_data.status || 'pending';
      return status === filter;
  });

  // ׳‘׳“׳™׳§׳× ׳˜׳¢׳™׳ ׳” ׳׳©׳•׳׳‘׳×
  if (userLoading || loadingUsers) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-[#00BCD4]" size={40}/></div>;

  return (
    <>
      <ManagerHeader title="׳ ׳™׳”׳•׳ ׳׳©׳×׳׳©׳™׳ ׳•׳¨׳›׳–׳™׳" />
      <Modal isOpen={modal.isOpen} onClose={() => setModal({...modal, isOpen: false})} type={modal.type} title={modal.title} message={modal.message} onConfirm={modal.onConfirm} />
      
      <div className="p-4 md:p-8 animate-fadeIn max-w-[100vw] overflow-x-hidden pb-32">
          
          {/* ׳¡׳¨׳’׳ ׳¡׳™׳ ׳•׳ */}
          <div className="flex gap-2 md:gap-4 mb-8 overflow-x-auto pb-2">
              {['pending', 'approved', 'rejected'].map(f => (
                  <button 
                    key={f} 
                    onClick={() => setFilter(f)}
                    className={`px-4 md:px-6 py-2 rounded-xl font-bold text-sm transition-all whitespace-nowrap flex items-center
                    ${filter === f ? 'bg-gray-800 text-white shadow-lg' : 'bg-white text-gray-500 border border-gray-200'}`}
                  >
                      {f === 'pending' ? '׳׳׳×׳™׳ ׳™׳' : f === 'approved' ? '׳₪׳¢׳™׳׳™׳' : '׳—׳¡׳•׳׳™׳'}
                      <span className="mr-2 bg-white/20 px-2 py-0.5 rounded-full text-xs">
                          {users.filter(u => (u.raw_user_meta_data.status || 'pending') === f).length}
                      </span>
                  </button>
              ))}
          </div>

          <div className="space-y-4">
              {filteredUsers.map((u) => {
                  const meta = u.raw_user_meta_data || {};
                  const isExpanded = expandedUser === u.id;
                  const isHQ = meta.branch === '׳׳˜׳”';

                  return (
                    <div key={u.id} className="bg-white rounded-3xl border border-gray-200 shadow-sm overflow-hidden transition-all">
                        {/* ׳©׳•׳¨׳” ׳¨׳׳©׳™׳× */}
                        <div className="p-4 md:p-6 flex flex-col md:flex-row items-start md:items-center gap-4 cursor-pointer hover:bg-gray-50 relative" onClick={() => setExpandedUser(isExpanded ? null : u.id)}>
                            
                            <div className="flex items-center gap-4 w-full md:w-auto">
                                <div className={`w-12 h-12 rounded-2xl flex items-center justify-center text-white font-bold text-xl shrink-0 ${isHQ ? 'bg-gray-800' : 'bg-[#00BCD4]'}`}>
                                    {meta.full_name?.[0] || <User/>}
                                </div>
                                <div className="flex-1">
                                    <h3 className="font-bold text-gray-800">{meta.full_name || '׳׳׳ ׳©׳'}</h3>
                                    <div className="text-xs text-gray-500">{u.email}</div>
                                </div>
                                <div className="md:hidden text-gray-400">
                                    {isExpanded ? <ChevronUp/> : <ChevronDown/>}
                                </div>
                            </div>
                            
                            <div className="flex-1 grid grid-cols-2 md:grid-cols-3 gap-2 w-full md:w-auto pl-8 md:pl-0">
                                <div className="flex items-center gap-2">
                                    <span className={`px-2 py-1 rounded-lg text-xs font-bold flex items-center gap-1 w-fit ${isHQ ? 'bg-gray-100 text-gray-700' : 'bg-cyan-50 text-cyan-700'}`}>
                                        {isHQ ? <Shield size={12}/> : <User size={12}/>}
                                        {isHQ ? '׳׳ ׳”׳ ׳׳˜׳”' : '׳¨׳›׳– ׳¡׳ ׳™׳£'}
                                    </span>
                                </div>
                                <div className="text-sm font-medium text-gray-600 flex items-center gap-1 col-span-2 md:col-span-1">
                                    <MapPin size={14}/> {meta.branch || '-'} ג€¢ {meta.department || '-'}
                                </div>
                            </div>

                            <button className="hidden md:block text-gray-400 ml-auto">
                                {isExpanded ? <ChevronUp/> : <ChevronDown/>}
                            </button>
                        </div>

                        {/* ׳”׳¨׳—׳‘׳” */}
                        {isExpanded && (
                            <div className="p-6 bg-gray-50 border-t border-gray-100 animate-fadeIn">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 mb-6">
                                    <div className="space-y-2">
                                        <p className="text-xs font-bold text-gray-400">׳×׳¢׳•׳“׳× ׳–׳”׳•׳×</p>
                                        <p className="font-medium text-gray-800 bg-white p-2 rounded border border-gray-100">{meta.id_number || '-'}</p>
                                    </div>
                                    <div className="space-y-2">
                                        <p className="text-xs font-bold text-gray-400">׳˜׳׳₪׳•׳</p>
                                        <p className="font-medium text-gray-800 bg-white p-2 rounded border border-gray-100">{meta.phone || '-'}</p>
                                    </div>
                                </div>

                                <div className="flex flex-col md:flex-row justify-end gap-3 pt-4 border-t border-gray-200">
                                    {filter !== 'approved' && (
                                        <Button variant="secondary" onClick={() => updateUserStatus(u.id, 'approved')} icon={<CheckCircle size={18}/>} className="h-10 text-sm">
                                            ׳׳©׳¨ ׳׳©׳×׳׳©
                                        </Button>
                                    )}
                                    {filter !== 'rejected' && (
                                        <Button variant="outline" onClick={() => updateUserStatus(u.id, 'rejected')} icon={<XCircle size={18}/>} className="h-10 text-sm border-red-200 text-red-600 hover:bg-red-50">
                                            ׳—׳¡׳•׳ / ׳“׳—׳”
                                        </Button>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                  )
              })}
              {filteredUsers.length === 0 && <div className="text-center p-10 text-gray-400">׳׳ ׳ ׳׳¦׳׳• ׳׳©׳×׳׳©׳™׳ ׳‘׳¡׳˜׳˜׳•׳¡ ׳–׳”</div>}
          </div>
      </div>
    </>
  )
}


================================================================
FILE PATH: C:\Users\User\chabad-trips\app\manager\layout.tsx
================================================================
"use client"

import React, { useState } from 'react';
import { ManagerSidebar } from '@/components/layout/ManagerSidebar'; 
import { Menu } from 'lucide-react';
import Image from 'next/image';

export default function ManagerLayout({ children }: { children: React.ReactNode }) {
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

  return (
    <div className="min-h-screen bg-[#F8F9FA] dir-rtl font-sans text-right relative">
      
      {/* --- ׳›׳₪׳×׳•׳¨ ׳”׳׳‘׳•׳¨׳’׳¨ ׳׳׳•׳‘׳™׳™׳ (Header) --- */}
      <div className="md:hidden flex items-center justify-between p-3 bg-white/95 backdrop-blur-md border-b border-gray-200 sticky top-0 z-40 shadow-sm h-16">
          <div className="flex items-center gap-3">
              <button 
                onClick={() => setIsMobileMenuOpen(true)} 
                className="p-2 rounded-xl bg-gray-50 text-gray-600 hover:bg-gray-100 active:scale-95 border border-gray-200 transition-all"
              >
                  <Menu size={20}/>
              </button>
              
              <div className="flex items-center gap-3">
                  <div className="w-8 h-8 relative">
                     <Image src="/logo.png" alt="Logo" fill className="object-contain"/>
                  </div>
                  <div className="h-5 w-px bg-gray-200"></div>
                  <span className="font-bold text-gray-700 text-sm">׳׳׳©׳§ ׳ ׳™׳”׳•׳</span>
              </div>
          </div>
      </div>

      {/* --- ׳”׳¡׳¨׳’׳ (Sidebar) --- */}
      <ManagerSidebar 
          isOpen={isMobileMenuOpen} 
          onClose={() => setIsMobileMenuOpen(false)} 
      />
      
      {/* --- ׳”׳×׳•׳›׳ ׳”׳¨׳׳©׳™ --- */}
      {/* ׳‘׳׳—׳©׳‘: ׳–׳– ׳©׳׳׳׳” 256 ׳₪׳™׳§׳¡׳׳™׳ (׳¨׳•׳—׳‘ ׳”׳¡׳¨׳’׳) ׳›׳“׳™ ׳׳₪׳ ׳•׳× ׳׳§׳•׳ ׳‘׳¦׳“ ׳™׳׳™׳ */}
      <div className="md:mr-64 mr-0 transition-all duration-300 min-h-screen">
        {children}
      </div>
      
    </div>
  );
}


================================================================
FILE PATH: C:\Users\User\chabad-trips\app\manager\page.tsx
================================================================
"use client"

import React, { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { ManagerHeader } from '@/components/layout/ManagerHeader'
import { Loader2, AlertCircle, CheckCircle, UserPlus, FileText, Clock, ArrowLeft, Shield } from 'lucide-react'
import Link from 'next/link'
import { useRouter } from 'next/navigation'

// ׳™׳™׳‘׳•׳ Hook
import { useUser } from '@/hooks/useUser'

export default function ManagerHomePage() {
  const router = useRouter();
  
  // 1. ׳©׳™׳׳•׳© ׳‘-Hook
  const { user, profile, loading: userLoading } = useUser('/');

  const [stats, setStats] = useState({ pendingTrips: 0, approvedTrips: 0, totalTrips: 0, pendingUsers: 0 });
  const [statsLoading, setStatsLoading] = useState(true);

  // 2. ׳˜׳¢׳™׳ ׳× ׳ ׳×׳•׳ ׳™׳
  useEffect(() => {
    const fetchStats = async () => {
        if (!user) return;

        // ׳‘׳“׳™׳§׳× ׳”׳¨׳©׳׳•׳× ׳‘׳¡׳™׳¡׳™׳×
        const isManager = profile?.role === 'admin' || profile?.role === 'safety_admin' || user.user_metadata?.department === '׳‘׳˜׳™׳—׳•׳× ׳•׳׳₪׳¢׳׳™׳' || profile?.role === 'dept_staff'; // ׳”׳•׳¡׳₪׳×׳™ dept_staff ׳›׳™ ׳’׳ ׳׳”׳ ׳™׳© ׳’׳™׳©׳”
        
        if (profile && !isManager) {
             router.push('/dashboard');
             return;
        }

        try {
            // ׳‘׳™׳¦׳•׳¢ ׳›׳ ׳”׳©׳׳™׳׳×׳•׳× ׳‘׳׳§׳‘׳™׳ ׳׳©׳™׳₪׳•׳¨ ׳‘׳™׳¦׳•׳¢׳™׳
            const [pendingTripsRes, approvedTripsRes, totalTripsRes, usersRes] = await Promise.all([
                supabase.from('trips').select('*', { count: 'exact', head: true }).eq('status', 'pending'),
                supabase.from('trips').select('*', { count: 'exact', head: true }).eq('status', 'approved'),
                supabase.from('trips').select('*', { count: 'exact', head: true }),
                supabase.from('users_management_view').select('raw_user_meta_data')
            ]);

            const pendingUsersCount = usersRes.data?.filter((u: any) => {
                const status = u.raw_user_meta_data?.status;
                return !status || status === 'pending';
            }).length || 0;

            setStats({
                pendingTrips: pendingTripsRes.count || 0,
                approvedTrips: approvedTripsRes.count || 0,
                totalTrips: totalTripsRes.count || 0,
                pendingUsers: pendingUsersCount
            });

        } catch (error) {
            console.error('Error fetching stats:', error);
        } finally {
            setStatsLoading(false);
        }
    };

    if (!userLoading && user) {
        fetchStats();
    }
  }, [user, userLoading, profile, router]);

  if (userLoading || statsLoading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-[#00BCD4]" size={40}/></div>;

  return (
    <>
      <ManagerHeader title="׳׳¨׳›׳– ׳©׳׳™׳˜׳”" />
      
      <div className="p-4 md:p-8 animate-fadeIn pb-32 max-w-[100vw] overflow-x-hidden md:max-w-7xl md:mx-auto">
        
        <div className="flex items-center gap-2 mb-4 opacity-60">
            <Shield size={16} />
            <span className="text-xs font-bold uppercase tracking-wider">׳×׳׳•׳ ׳× ׳׳¦׳‘ ׳™׳•׳׳™׳×</span>
        </div>

        {/* --- ׳’׳¨׳™׳“ ׳¡׳˜׳˜׳™׳¡׳˜׳™׳§׳” --- */}
        <div className="bg-white rounded-3xl border border-gray-100 shadow-sm overflow-hidden mb-8">
            <div className="grid grid-cols-2 md:grid-cols-4 divide-x divide-y md:divide-y-0 divide-gray-100 dir-ltr">
                
                {/* 1. ׳׳׳×׳™׳ ׳™׳ ׳׳׳™׳©׳•׳¨ */}
                <Link href="/manager/approvals" className="group p-4 md:p-6 flex flex-col items-center justify-center hover:bg-orange-50/50 transition-colors cursor-pointer text-center relative dir-rtl">
                    <div className="text-orange-500 bg-orange-50 p-2 rounded-xl mb-2 group-hover:scale-110 transition-transform"><Clock size={20}/></div>
                    <div className="text-2xl md:text-3xl font-black text-gray-800 leading-none mb-1">{stats.pendingTrips}</div>
                    <div className="text-xs font-bold text-gray-400 group-hover:text-orange-500">׳׳׳×׳™׳ ׳™׳ ׳׳׳™׳©׳•׳¨</div>
                    {stats.pendingTrips > 0 && <span className="absolute top-3 right-3 flex h-2.5 w-2.5 rounded-full bg-orange-500 animate-pulse"></span>}
                </Link>

                {/* 2. ׳¨׳›׳–׳™׳ ׳—׳“׳©׳™׳ */}
                <Link href="/manager/users" className="group p-4 md:p-6 flex flex-col items-center justify-center hover:bg-purple-50/50 transition-colors cursor-pointer text-center relative dir-rtl">
                    <div className="text-purple-500 bg-purple-50 p-2 rounded-xl mb-2 group-hover:scale-110 transition-transform"><UserPlus size={20}/></div>
                    <div className="text-2xl md:text-3xl font-black text-gray-800 leading-none mb-1">{stats.pendingUsers}</div>
                    <div className="text-xs font-bold text-gray-400 group-hover:text-purple-500">׳¨׳›׳–׳™׳ ׳—׳“׳©׳™׳</div>
                    {stats.pendingUsers > 0 && <span className="absolute top-3 right-3 flex h-2.5 w-2.5 rounded-full bg-purple-500"></span>}
                </Link>

                {/* 3. ׳׳•׳©׳¨׳• */}
                <Link href="/manager/approvals?filter=approved" className="group p-4 md:p-6 flex flex-col items-center justify-center hover:bg-green-50/50 transition-colors cursor-pointer text-center dir-rtl">
                    <div className="text-green-600 bg-green-50 p-2 rounded-xl mb-2 group-hover:scale-110 transition-transform"><CheckCircle size={20}/></div>
                    <div className="text-2xl md:text-3xl font-black text-gray-800 leading-none mb-1">{stats.approvedTrips}</div>
                    <div className="text-xs font-bold text-gray-400 group-hover:text-green-600">׳˜׳™׳•׳׳™׳ ׳©׳׳•׳©׳¨׳•</div>
                </Link>

                {/* 4. ׳¡׳”"׳› */}
                <div className="group p-4 md:p-6 flex flex-col items-center justify-center hover:bg-gray-50 transition-colors text-center dir-rtl">
                    <div className="text-gray-400 bg-gray-50 p-2 rounded-xl mb-2"><FileText size={20}/></div>
                    <div className="text-2xl md:text-3xl font-black text-gray-800 leading-none mb-1">{stats.totalTrips}</div>
                    <div className="text-xs font-bold text-gray-400">׳¡׳”"׳› ׳₪׳¢׳™׳׳•׳™׳•׳×</div>
                </div>

            </div>
        </div>

        {/* ׳§׳™׳©׳•׳¨׳™׳ ׳׳”׳™׳¨׳™׳ */}
        <h3 className="text-lg font-bold text-gray-800 mb-4">׳’׳™׳©׳” ׳׳”׳™׳¨׳”</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            
            <Link href="/manager/inbox" className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex items-center justify-between hover:border-[#00BCD4] hover:shadow-md transition-all group">
                <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-full bg-cyan-50 flex items-center justify-center text-[#00BCD4]">
                        <Clock size={20} />
                    </div>
                    <div>
                        <div className="font-bold text-gray-800 text-sm">׳₪׳ ׳™׳•׳× ׳•׳”׳•׳“׳¢׳•׳×</div>
                        <div className="text-[10px] text-gray-400">׳¦׳₪׳™׳™׳” ׳‘׳“׳™׳•׳•׳—׳™׳ ׳•׳˜׳™׳₪׳•׳ ׳‘׳₪׳ ׳™׳•׳×</div>
                    </div>
                </div>
                <div className="bg-gray-50 p-2 rounded-full text-gray-400 group-hover:bg-[#00BCD4] group-hover:text-white transition-colors">
                    <ArrowLeft size={16} />
                </div>
            </Link>

            <Link href="/manager/approvals" className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex items-center justify-between hover:border-orange-400 hover:shadow-md transition-all group">
                <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center text-orange-600">
                        <AlertCircle size={20} />
                    </div>
                    <div>
                        <div className="font-bold text-gray-800 text-sm">׳׳™׳©׳•׳¨ ׳˜׳™׳•׳׳™׳</div>
                        <div className="text-[10px] text-gray-400">׳¦׳₪׳™׳™׳” ׳‘׳‘׳§׳©׳•׳× ׳׳˜׳™׳•׳׳™׳ ׳—׳“׳©׳™׳</div>
                    </div>
                </div>
                <div className="bg-gray-50 p-2 rounded-full text-gray-400 group-hover:bg-orange-600 group-hover:text-white transition-colors">
                    <ArrowLeft size={16} />
                </div>
            </Link>

        </div>

      </div>
    </>
  )
}


================================================================
FILE PATH: C:\Users\User\chabad-trips\app\globals.css
================================================================
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --brand-cyan: #00BCD4;
  --brand-green: #8BC34A;
  --brand-pink: #E91E63;
  --brand-yellow: #FFC107;
  --brand-dark: #263238;
  --bg-light: #F8F9FA;
  
  /* ׳׳©׳×׳ ׳™ ׳”׳₪׳•׳ ׳˜ ׳׳•׳’׳“׳¨׳™׳ ׳‘-Layout */
}

body {
  @apply bg-[#F4F6F8] text-brand-dark font-sans; /* ׳¨׳§׳¢ ׳˜׳™׳₪׳” ׳™׳•׳×׳¨ ׳׳₪׳¨׳₪׳¨-׳›׳—׳׳—׳ ׳׳•׳“׳¨׳ ׳™ */
  direction: rtl;
}

/* ׳׳₪׳§׳˜ ׳–׳›׳•׳›׳™׳× ׳™׳•׳§׳¨׳×׳™ */
.glass {
  @apply bg-white/80 backdrop-blur-xl border-b border-white/20;
}

/* ׳›׳¨׳˜׳™׳¡ ׳™׳•׳§׳¨׳×׳™ - ׳¨׳, ׳¢׳’׳•׳, ׳¢׳ ׳¦׳ ׳¢׳“׳™׳ */
.card-premium {
  @apply bg-white rounded-[32px] shadow-[0_8px_30px_rgba(0,0,0,0.04)] border border-gray-100/50 hover:shadow-[0_8px_30px_rgba(0,188,212,0.1)] transition-all duration-300;
}


================================================================
FILE PATH: C:\Users\User\chabad-trips\app\layout.tsx
================================================================
import type { Metadata, Viewport } from "next";
import { Rubik } from "next/font/google";
import "./globals.css";

const rubik = Rubik({
  subsets: ["hebrew", "latin"],
  weight: ["300", "400", "500", "700", "900"],
  variable: "--font-rubik",
});

export const metadata: Metadata = {
  title: '׳‘׳˜׳™׳—׳•׳× ׳•׳׳₪׳¢׳׳™׳ | ׳ ׳•׳¢׳¨ ׳—׳‘"׳“',
  description: '׳׳¢׳¨׳›׳× ׳׳ ׳™׳”׳•׳, ׳×׳›׳ ׳•׳ ׳•׳׳™׳©׳•׳¨ ׳˜׳™׳•׳׳™׳ ׳•׳׳™׳¨׳•׳¢׳™׳',
  manifest: '/manifest.json',
  icons: {
    icon: '/icon.png',
    apple: '/icon.png',
  },
};

// ׳”׳’׳“׳¨׳•׳× ׳×׳¦׳•׳’׳” ׳׳׳•׳‘׳™׳™׳ (PWA) ׳‘׳ ׳₪׳¨׳“ - ׳׳₪׳™ ׳”׳×׳§׳ ׳”׳—׳“׳©
export const viewport: Viewport = {
  themeColor: '#00BCD4',
  width: 'device-width',
  initialScale: 1,
  maximumScale: 1, // ׳׳•׳ ׳¢ ׳–׳•׳ ׳׳•׳˜׳•׳׳˜׳™ ׳׳¢׳¦׳‘׳ ׳‘׳©׳“׳•׳× ׳§׳׳˜ ׳‘׳˜׳׳₪׳•׳
  userScalable: false,
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="he" dir="rtl">
      <body className={`${rubik.variable} bg-[#F8F9FA] text-[#263238] font-sans antialiased`}>
        <main className="min-h-screen flex flex-col">
           {children}
        </main>
      </body>
    </html>
  );
}


================================================================
FILE PATH: C:\Users\User\chabad-trips\app\page.tsx
================================================================
"use client";

import React, { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabaseClient';
import { ArrowLeft, UserPlus, ShieldCheck, Users, Briefcase, Eye, EyeOff } from 'lucide-react';
import { Button } from '@/components/ui/Button';
import { Input } from '@/components/ui/Input'; 
import { Modal } from '@/components/ui/Modal'; 
import { useRouter } from 'next/navigation';
import Image from 'next/image'; 

// ׳™׳™׳‘׳•׳ ׳”׳¡׳›׳׳•׳× ׳”׳—׳“׳©׳•׳×
import { loginSchema, registerSchema } from '@/lib/schemas';
import { DEPARTMENTS_CONFIG } from '@/lib/constants'; 

const SUPER_ADMIN_EMAIL = process.env.NEXT_PUBLIC_SUPER_ADMIN_EMAIL;

export default function Home() {
  const router = useRouter();
  const [view, setView] = useState<'landing' | 'login' | 'dept_selection' | 'role_selection' | 'register_form'>('landing');
  const [loading, setLoading] = useState(false);
  
  // ׳ ׳™׳”׳•׳ ׳”׳¦׳’׳× ׳¡׳™׳¡׳׳”
  const [showPassword, setShowPassword] = useState(false);

  // ׳ ׳™׳”׳•׳ ׳׳•׳“׳
  const [modal, setModal] = useState({
      isOpen: false,
      type: 'info' as 'success' | 'error' | 'info' | 'confirm',
      title: '',
      message: '',
      onConfirm: undefined as (() => void) | undefined
  });

  const showModal = (type: 'success' | 'error' | 'info' | 'confirm', title: string, msg: string) => 
      setModal({ isOpen: true, type, title, message: msg, onConfirm: undefined });

  // ׳“׳׳˜׳”
  const [selectedDept, setSelectedDept] = useState(''); 
  const [selectedRoleType, setSelectedRoleType] = useState(''); 
  const [formData, setFormData] = useState({
    idNumber: '', password: '', fullName: '', phone: '', email: '', birthDate: '', branch: '', role: ''
  });

  const getRoleLabel = (roleType: 'coordinator' | 'hq') => {
    const config = DEPARTMENTS_CONFIG[selectedDept] || { gender: 'mixed' };
    const gender = config.gender;

    if (roleType === 'coordinator') {
        if (gender === 'female') return '׳¨׳›׳–׳× ׳¡׳ ׳™׳£';
        if (gender === 'male') return '׳¨׳›׳– ׳¡׳ ׳™׳£';
        return '׳¨׳›׳–/׳× ׳¡׳ ׳™׳£';
    } else { // HQ
        return '׳¦׳•׳•׳× ׳׳˜׳”';
    }
  };

  useEffect(() => {
    const autoLogin = async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        setLoading(true);
        try {
          await checkRoleAndRedirect(session.user);
        } catch (error) {
          console.log("Auto-login failed:", error);
          await supabase.auth.signOut();
          setLoading(false);
        }
      }
    };
    autoLogin();
  }, []);

  const checkRoleAndRedirect = async (user: any) => {
    const meta = user.user_metadata || {};
    const status = meta.status || 'pending';

    if (user.email !== SUPER_ADMIN_EMAIL && status !== 'approved') {
        await supabase.auth.signOut();
        throw new Error(status === 'pending' ? '׳”׳”׳¨׳©׳׳” ׳ ׳§׳׳˜׳” ׳׳ ׳˜׳¨׳ ׳׳•׳©׳¨׳”.' : '׳”׳’׳™׳©׳” ׳׳׳¢׳¨׳›׳× ׳ ׳—׳¡׳׳”.');
    }

    router.refresh(); 
    await new Promise(resolve => setTimeout(resolve, 500));

    if (meta.department === '׳‘׳˜׳™׳—׳•׳× ׳•׳׳₪׳¢׳׳™׳' || meta.role === 'safety_admin') {
        router.push('/manager');
    } else {
        router.push('/dashboard');
    }
  };

  const handleInputChange = (e: any) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  const handleLogin = async (e: any) => {
    e.preventDefault();
    
    // 1. ׳•׳׳™׳“׳¦׳™׳” ׳¢׳ Zod
    const validation = loginSchema.safeParse({
        idNumber: formData.idNumber,
        password: formData.password
    });

    if (!validation.success) {
        showModal('error', '׳ ׳×׳•׳ ׳™׳ ׳©׳’׳•׳™׳™׳', validation.error.issues[0].message);
        return;
    }

    setLoading(true);

    try {
        const email = formData.idNumber.includes('@') ? formData.idNumber : `${formData.idNumber}@noar.chabad.co.il`; 
        const { data, error } = await supabase.auth.signInWithPassword({ email: email, password: formData.password });

        if (error) {
          showModal('error', '׳©׳’׳™׳׳” ׳‘׳”׳×׳—׳‘׳¨׳•׳×', '׳₪׳¨׳˜׳™ ׳”׳–׳™׳”׳•׳™ ׳©׳’׳•׳™׳™׳, ׳׳• ׳©׳”׳׳©׳×׳׳© ׳˜׳¨׳ ׳׳•׳©׳¨.');
          setLoading(false);
          return;
        }
        await checkRoleAndRedirect(data.user);
    } catch (err: any) {
        console.error(err);
        showModal('error', '׳©׳’׳™׳׳”', err.message || '׳©׳’׳™׳׳” ׳›׳׳׳™׳× ׳‘׳׳¢׳¨׳›׳×');
        setLoading(false);
    }
  };

  const handleRegister = async (e: any) => {
    e.preventDefault();

    // 1. ׳•׳׳™׳“׳¦׳™׳” ׳¢׳ Zod
    const validation = registerSchema.safeParse({
        branch: selectedRoleType === 'coordinator' ? formData.branch : undefined,
        fullName: formData.fullName,
        phone: formData.phone,
        idNumber: formData.idNumber,
        email: formData.email,
        birthDate: formData.birthDate,
        password: formData.password
    });

    if (!validation.success) {
        showModal('error', '׳©׳’׳™׳׳” ׳‘׳˜׳•׳₪׳¡', validation.error.issues[0].message);
        return;
    }

    setLoading(true);

    try {
        const email = `${formData.idNumber}@noar.chabad.co.il`;
        const { error } = await supabase.auth.signUp({
          email: email,
          password: formData.password,
          options: {
            data: {
              full_name: formData.fullName,
              identity_number: formData.idNumber,
              department: selectedDept, 
              role: selectedRoleType,   
              branch_name: selectedRoleType === 'coordinator' ? formData.branch : null,
              phone: formData.phone,
              contact_email: formData.email,
              birth_date: formData.birthDate,
              status: 'pending'
            },
          },
        });

        if (error) {
          showModal('error', '׳©׳’׳™׳׳” ׳‘׳”׳¨׳©׳׳”', error.message);
          setLoading(false);
        } else {
          showModal('success', '׳”׳”׳¨׳©׳׳” ׳ ׳§׳׳˜׳”!', '׳”׳₪׳¨׳˜׳™׳ ׳ ׳©׳׳—׳• ׳׳׳™׳©׳•׳¨ ׳׳ ׳”׳.\n׳×׳§׳‘׳ ׳”׳•׳“׳¢׳” ׳›׳©׳”׳—׳©׳‘׳•׳ ׳™׳׳•׳©׳¨.');
          setTimeout(() => {
              setModal(prev => ({...prev, isOpen: false}));
              setView('login');
              setLoading(false);
          }, 3000);
        }
    } catch (err) {
        console.error(err);
        setLoading(false);
    }
  };

  // --- View: Landing (׳“׳£ ׳›׳ ׳™׳¡׳”) ---
  if (view === 'landing') {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-[#F8F9FA] p-4 relative overflow-hidden">
        <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-[#00BCD4] via-[#4CAF50] to-[#E91E63]"></div>
        
        <main className="max-w-md w-full text-center space-y-8 relative z-10 animate-fadeIn">
          
          <div className="relative mx-auto w-32 h-20 bg-white p-3 rounded-2xl shadow-lg flex items-center justify-center mb-6 border border-gray-50 transform hover:scale-105 transition-transform duration-500">
            <Image 
                src="/logo.png" 
                alt="׳׳•׳’׳• ׳ ׳•׳¢׳¨ ׳—׳‘׳´׳“" 
                fill
                className="object-contain p-1"
                priority
            />
          </div>

          <div className="space-y-3">
            <h1 className="text-4xl md:text-4xl font-black text-[#00BCD4] leading-tight drop-shadow-sm">
                ׳׳¢׳¨׳›׳× ׳”׳˜׳™׳•׳׳™׳ ׳•׳”׳׳™׳¨׳•׳¢׳™׳
                <span className="block text-2xl md:text-3xl text-gray-800 mt-1">׳©׳ ׳׳¨׳’׳•׳ ׳ ׳•׳¢׳¨ ׳—׳‘"׳“</span>
            </h1>
            
            <p className="text-gray-500 font-medium text-lg px-4">
                  ׳₪׳׳˜׳₪׳•׳¨׳׳× ׳”׳ ׳™׳”׳•׳ ׳׳×׳›׳ ׳•׳, ׳׳™׳©׳•׳¨ ׳•׳‘׳§׳¨׳” ׳©׳ ׳₪׳¢׳™׳׳•׳™׳•׳× ׳©׳•׳‘׳¨׳•׳× ׳©׳’׳¨׳”
            </p>
          </div>

          <div className="space-y-4 pt-4 px-6">
            <Button 
                onClick={() => setView('login')} 
                className="w-full !bg-[#F1F8E9] border-2 !border-[#8BC34A] !text-[#558B2F] py-4 rounded-2xl shadow-lg transition-all font-bold justify-center hover:!bg-[#8BC34A] hover:!text-white"
            >
              ׳›׳ ׳™׳¡׳” ׳׳׳¢׳¨׳›׳×
            </Button>

            <div className="pt-2 space-y-3">
                <div className="relative flex py-2 items-center">
                    <div className="flex-grow border-t border-gray-200"></div>
                    <span className="flex-shrink-0 mx-4 text-gray-400 text-xs font-bold">׳׳©׳×׳׳©/׳× ׳—׳“׳©/׳”?</span>
                    <div className="flex-grow border-t border-gray-200"></div>
                </div>

                <Button 
                    onClick={() => setView('dept_selection')} 
                    variant="outline" 
                    className="w-full bg-white border-2 !border-[#E91E63] !text-[#E91E63] hover:!bg-pink-50 py-4 rounded-2xl transition-all font-bold justify-center flex items-center gap-2 shadow-sm hover:shadow-pink-100"
                >
                    <UserPlus size={20} className="text-[#E91E63]" />
                    <span className="text-[#E91E63]">׳׳”׳¨׳©׳׳”</span>
                </Button>
            </div>
          </div>

          <div className="mt-16 text-xs text-gray-300 font-medium">ֲ© ׳׳¨׳’׳•׳ ׳ ׳•׳¢׳¨ ׳—׳‘"׳“</div>
        </main>
      </div>
    );
  }

  // --- View: Login ---
  if (view === 'login') {
    return (
      <div className="min-h-screen bg-white flex flex-col items-center justify-center p-6">
        <Modal isOpen={modal.isOpen} onClose={() => setModal({...modal, isOpen: false})} type={modal.type} title={modal.title} message={modal.message} />
        
        <button onClick={() => setView('landing')} className="absolute top-6 right-6 text-gray-400 hover:text-[#E91E63] transition-colors">
            <ArrowLeft size={24} className="rotate-180" />
        </button>

        <div className="w-full max-w-sm animate-fadeIn">
            <div className="text-center mb-8">
               <h2 className="text-4xl font-black text-[#00BCD4]">׳”׳×׳—׳‘׳¨׳•׳×</h2>
              <p className="text-gray-400 text-sm mt-1">׳”׳–׳ ׳׳× ׳₪׳¨׳˜׳™׳ ׳׳›׳ ׳™׳¡׳” ׳׳׳¢׳¨׳›׳×</p>
            </div>

            <form onSubmit={handleLogin} className="space-y-5">
              <Input 
                label="׳×׳¢׳•׳“׳× ׳–׳”׳•׳×" 
                name="idNumber" 
                required 
                onChange={handleInputChange} 
                autoFocus 
                className="focus:!border-[#E91E63] focus:!ring-[#E91E63]/20"
              />
              
              <div className="relative">
                  <Input 
                    label="׳¡׳™׳¡׳׳”" 
                    type={showPassword ? "text" : "password"} 
                    name="password" 
                    required 
                    onChange={handleInputChange} 
                    className="pl-10 focus:!border-[#E91E63] focus:!ring-[#E91E63]/20"
                  />
                  <button 
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    className="absolute left-3 top-[38px] z-10 text-gray-400 hover:text-[#E91E63] transition-colors"
                  >
                    {showPassword ? <EyeOff size={18}/> : <Eye size={18}/>}
                  </button>
              </div>

              <Button 
  type="submit" 
  isLoading={loading} 
  // ׳©׳™׳ ׳™׳×׳™ ׳׳× ׳”׳¦׳‘׳¢ ׳-#8BC34A (׳”׳™׳¨׳•׳§ ׳©׳ ׳”׳׳•׳×׳’) ׳•׳׳× ׳”-Hover ׳-#7CB342
  className="w-full mt-4 bg-[#8BC34A] hover:bg-[#7CB342] shadow-lg shadow-green-100 border border-transparent text-white"
>
  ׳›׳ ׳™׳¡׳”
</Button>
            </form>
        </div>
      </div>
    );
  }

  // --- View: Dept Selection ---
  if (view === 'dept_selection') {
    return (
      <div className="min-h-screen bg-[#F8F9FA] p-6 flex flex-col items-center">
        <header className="w-full max-w-md flex justify-between items-center mb-8 mt-4">
            <button onClick={() => setView('landing')} className="text-gray-400 hover:text-[#00BCD4]"><ArrowLeft className="rotate-180"/></button>
            <div className="text-xs font-bold text-gray-300">׳©׳׳‘ 1 ׳׳×׳•׳ 3</div>
        </header>

        <main className="w-full max-w-md animate-fadeIn">
          <h2 className="text-2xl font-black text-gray-800 mb-2 text-center">׳׳׳™׳–׳• ׳׳—׳׳§׳” ׳׳×/׳” ׳©׳™׳™׳/׳×?</h2>
          <p className="text-center text-gray-400 mb-8 text-sm">׳‘׳—׳¨/׳™ ׳׳× ׳”׳׳—׳׳§׳” ׳”׳¨׳׳•׳•׳ ׳˜׳™׳× ׳׳”׳׳©׳ ׳”׳”׳¨׳©׳׳”</p>
          
          <div className="grid grid-cols-1 gap-3">
            {Object.keys(DEPARTMENTS_CONFIG).map((dept) => {
                const config = DEPARTMENTS_CONFIG[dept];
                return (
                    <button 
                        key={dept} 
                        onClick={() => { setSelectedDept(dept); setView('role_selection'); }}
                        className={`p-4 rounded-2xl border-2 transition-all flex flex-row items-center justify-between gap-4 relative bg-white
                        ${config.color} hover:shadow-md group`}
                    >
                        <div className="flex items-center gap-4">
                            <div className="relative w-12 h-12 shrink-0">
                                <Image 
                                    src={config.logo} 
                                    alt={dept} 
                                    fill 
                                    className="object-contain"
                                    onError={(e) => {
                                        (e.target as HTMLImageElement).src = '/logo.png'; 
                                    }}
                                />
                            </div>
                            <span className="font-bold text-lg">{dept}</span>
                        </div>
                        <ArrowLeft size={20} className="opacity-0 group-hover:opacity-100 transition-opacity" />
                    </button>
                )
            })}
          </div>

          <div className="mt-10 border-t border-gray-200 pt-6">
             <Button variant="dark" onClick={() => { setSelectedDept('׳‘׳˜׳™׳—׳•׳× ׳•׳׳₪׳¢׳׳™׳'); setSelectedRoleType('safety_admin'); setView('register_form'); }} className="w-full justify-center" icon={<ShieldCheck size={20} className="text-[#8BC34A]" />}>
                ׳”׳¨׳©׳׳” ׳׳׳—׳׳§׳× ׳‘׳˜׳™׳—׳•׳× ׳•׳׳₪׳¢׳׳™׳
             </Button>
          </div>
        </main>
      </div>
    );
  }

  // --- View: Role Selection ---
  if (view === 'role_selection') {
    return (
      <div className="min-h-screen bg-[#F8F9FA] p-6 flex flex-col items-center">
        <header className="w-full max-w-md flex justify-between items-center mb-8 mt-4">
            <button onClick={() => setView('dept_selection')} className="text-gray-400 hover:text-[#00BCD4]"><ArrowLeft className="rotate-180"/></button>
            <div className="text-xs font-bold text-gray-300">׳©׳׳‘ 2 ׳׳×׳•׳ 3</div>
        </header>

        <main className="w-full max-w-md animate-fadeIn">
          <h2 className="text-2xl font-black text-gray-800 mb-2 text-center">׳”׳’׳“׳¨׳× ׳×׳₪׳§׳™׳“</h2>
          <p className="text-center text-gray-400 mb-8">׳׳—׳׳§׳” ׳ ׳‘׳—׳¨׳×: <span className="font-bold text-[#00BCD4]">{selectedDept}</span></p>
          
          <div className="space-y-4">
            <button onClick={() => { setSelectedRoleType('coordinator'); setView('register_form'); }}
              className="w-full bg-white p-6 rounded-2xl shadow-sm border-2 border-transparent hover:border-pink-400 hover:bg-pink-50 text-right group relative overflow-hidden transition-all">
              <div className="flex items-center justify-between relative z-10">
                  <div>
                    <h3 className="font-black text-lg text-gray-800 group-hover:text-pink-600">{getRoleLabel('coordinator')}</h3>
                    <p className="text-sm text-gray-400 mt-1">׳ ׳™׳”׳•׳ ׳₪׳¢׳™׳׳•׳× ׳¡׳ ׳™׳₪׳™׳× ׳•׳”׳’׳©׳× ׳˜׳™׳•׳׳™׳</p>
                  </div>
                  <Users className="text-gray-200 group-hover:text-pink-300 transition-colors" size={32} />
              </div>
            </button>

            <button onClick={() => { setSelectedRoleType('dept_staff'); setView('register_form'); }}
              className="w-full bg-white p-6 rounded-2xl shadow-sm border-2 border-transparent hover:border-[#00BCD4] hover:bg-cyan-50 text-right group relative overflow-hidden transition-all">
              <div className="flex items-center justify-between relative z-10">
                  <div>
                    <h3 className="font-black text-lg text-gray-800 group-hover:text-[#00BCD4]">{getRoleLabel('hq')}</h3>
                    <p className="text-sm text-gray-400 mt-1">׳׳˜׳” {selectedDept}</p>
                  </div>
                  <Briefcase className="text-gray-200 group-hover:text-[#00BCD4] transition-colors" size={32} />
              </div>
            </button>
          </div>
        </main>
      </div>
    );
  }

  // --- View: Register Form ---
  if (view === 'register_form') {
    const isSafety = selectedRoleType === 'safety_admin';

    return (
      <div className="min-h-screen bg-[#F8F9FA] p-6 flex flex-col items-center">
        <Modal isOpen={modal.isOpen} onClose={() => setModal({...modal, isOpen: false})} type={modal.type} title={modal.title} message={modal.message} />
        
        <header className="w-full max-w-md flex justify-between items-center mb-6 mt-4">
            <button onClick={() => isSafety ? setView('dept_selection') : setView('role_selection')} className="text-gray-400 hover:text-[#00BCD4]"><ArrowLeft className="rotate-180"/></button>
            <div className="text-xs font-bold text-gray-300">׳©׳׳‘ 3 ׳׳×׳•׳ 3</div>
        </header>

        <main className="w-full max-w-md bg-white p-5 md:p-8 rounded-[32px] shadow-sm border border-gray-100 animate-fadeIn">
            
            <h2 className="text-2xl font-black text-gray-800 mb-2">׳™׳¦׳™׳¨׳× ׳—׳©׳‘׳•׳</h2>
            <div className="flex items-center gap-2 mb-6">
                <span className={`h-2 w-2 rounded-full ${isSafety ? 'bg-[#8BC34A]' : 'bg-[#00BCD4]'}`}></span>
                <p className="text-sm text-gray-500 font-bold">
                    {isSafety ? '׳׳—׳׳§׳× ׳‘׳˜׳™׳—׳•׳× ׳•׳׳₪׳¢׳׳™׳' : `${selectedDept} - ${getRoleLabel(selectedRoleType === 'coordinator' ? 'coordinator' : 'hq')}`}
                </p>
            </div>

            <form onSubmit={handleRegister} className="space-y-4">
              
              {selectedRoleType === 'coordinator' && (
                <Input label="׳©׳ ׳”׳¡׳ ׳™׳£" name="branch" required onChange={handleInputChange} className="focus:!border-[#E91E63] focus:!ring-[#E91E63]/20" />
              )}

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <Input label="׳©׳ ׳׳׳" name="fullName" required onChange={handleInputChange} className="focus:!border-[#E91E63] focus:!ring-[#E91E63]/20" />
                <Input label="׳˜׳׳₪׳•׳ ׳ ׳™׳™׳“" name="phone" type="tel" required onChange={handleInputChange} className="focus:!border-[#E91E63] focus:!ring-[#E91E63]/20" />
              </div>

              <Input label="׳×׳¢׳•׳“׳× ׳–׳”׳•׳×" name="idNumber" required maxLength={9} onChange={handleInputChange} className="focus:!border-[#E91E63] focus:!ring-[#E91E63]/20" />

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <Input label="׳׳™׳׳™׳™׳" name="email" type="email" required onChange={handleInputChange} className="focus:!border-[#E91E63] focus:!ring-[#E91E63]/20" />
                  <Input label="׳×׳׳¨׳™׳ ׳׳™׳“׳”" name="birthDate" type="date" required onChange={handleInputChange} className="focus:!border-[#E91E63] focus:!ring-[#E91E63]/20" />
              </div>

              <div className="relative">
                  <Input 
                    label="׳¡׳™׳¡׳׳”" 
                    name="password" 
                    type={showPassword ? "text" : "password"} 
                    required 
                    minLength={6} 
                    placeholder="׳׳₪׳—׳•׳× 6 ׳×׳•׳•׳™׳" 
                    onChange={handleInputChange} 
                    className="pl-10 focus:!border-[#E91E63] focus:!ring-[#E91E63]/20"
                  />
                  <button 
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    className="absolute left-3 top-[38px] z-10 text-gray-400 hover:text-[#E91E63] transition-colors"
                  >
                    {showPassword ? <EyeOff size={18}/> : <Eye size={18}/>}
                  </button>
              </div>

              <Button type="submit" isLoading={loading} className="w-full mt-6 bg-[#8BC34A] hover:bg-green-600 shadow-green-200 border border-transparent">
                ׳¡׳™׳•׳ ׳”׳¨׳©׳׳”
              </Button>
            </form>
        </main>
      </div>
    );
  }

  return null;
}


================================================================
FILE PATH: C:\Users\User\chabad-trips\components\layout\Header.tsx
================================================================
"use client";

import React, { useEffect, useState, useMemo } from 'react';
import { supabase } from '@/lib/supabaseClient';
import Image from 'next/image';
import Link from 'next/link';
import { Bell, X, Mail } from 'lucide-react';
import { useUser } from '@/hooks/useUser';

const DEPT_LOGOS: any = {
    '׳‘׳× ׳׳׳': '/logos/bat-melech.png',
    '׳‘׳ ׳•׳× ׳—׳‘׳´׳“': '/logos/bnos-chabad.png',
    '׳”׳₪׳ ׳¡׳׳™׳': '/logos/hapanasim.png',
    '׳×׳׳™׳': '/logos/temimim.png',
    '׳׳•׳¢׳“׳•׳ ׳™ ׳”׳׳¢׳©׳™׳ ׳”׳˜׳•׳‘׳™׳': '/logos/clubs.png',
};

const getSimpleGreeting = (name: string) => {
    const firstName = name?.split(' ')[0] || '';
    return `׳©׳׳•׳, ${firstName}`; 
};

export const Header = ({ title }: { title: string }) => {
  const { user } = useUser();
  
  const [unreadNotifications, setUnreadNotifications] = useState<any[]>([]);
  const [isBellOpen, setIsBellOpen] = useState(false);

  // ׳—׳™׳©׳•׳‘ ׳×׳¦׳•׳’׳× ׳”׳×׳₪׳§׳™׳“ ׳•׳”׳¡׳ ׳™׳£
  // ׳—׳™׳©׳•׳‘ ׳×׳¦׳•׳’׳× ׳”׳×׳₪׳§׳™׳“ ׳•׳”׳¡׳ ׳™׳£
  const userDisplayInfo = useMemo(() => {
      // ׳×׳™׳§׳•׳: ׳”׳—׳–׳¨׳× ׳׳•׳’׳• ׳‘׳¨׳™׳¨׳× ׳׳—׳“׳ ׳’׳ ׳›׳©׳׳™׳ ׳¢׳“׳™׳™׳ ׳׳©׳×׳׳©
      if (!user) return { 
          fullName: '', 
          department: '', 
          avatarUrl: null, 
          displayRole: '', 
          logo: '/logo.png' 
      };

      const meta = user.user_metadata || {};
      const fullName = meta.full_name || '';
      const department = meta.department || '';
      const role = meta.role;
      const branchName = meta.branch || meta.branch_name || '';

      // ׳׳•׳’׳™׳§׳” ׳׳§׳‘׳™׳¢׳× ׳×׳•׳׳¨ ׳”׳¨׳›׳–/׳×
      let roleTitle = '׳¨׳›׳–/׳× ׳¡׳ ׳™׳£';
      const deptCheck = department.trim();
      
      const maleDepts = ['׳”׳₪׳ ׳¡׳׳™׳', '׳₪׳ ׳¡׳׳™׳', '׳”׳×׳׳™׳', '׳×׳׳™׳', '׳‘׳ ׳™ ׳—׳‘"׳“', '׳‘׳ ׳™ ׳—׳‘׳´׳“'];
      const femaleDepts = ['׳‘׳× ׳׳׳', '׳‘׳ ׳•׳× ׳—׳‘"׳“', '׳‘׳ ׳•׳× ׳—׳‘׳´׳“'];

      if (maleDepts.some(d => deptCheck.includes(d))) roleTitle = '׳¨׳›׳– ׳¡׳ ׳™׳£';
      else if (femaleDepts.some(d => deptCheck.includes(d))) roleTitle = '׳¨׳›׳–׳× ׳¡׳ ׳™׳£';

      // ׳‘׳ ׳™׳™׳× ׳”׳˜׳§׳¡׳˜ ׳©׳™׳•׳¦׳’
      let displayRole = '';
      
      if (role === 'coordinator') {
          displayRole = `${roleTitle} ${branchName} | ${department}`;
      } else {
          displayRole = department ? `׳¦׳•׳•׳× ׳׳˜׳” | ${department}` : '׳¦׳•׳•׳× ׳׳˜׳”';
      }

      return {
          fullName,
          department,
          avatarUrl: meta.avatar_url,
          displayRole,
          // ׳׳•׳•׳“׳ ׳©׳×׳׳™׳“ ׳™׳© ׳¢׳¨׳, ׳’׳ ׳׳ ׳”׳׳—׳׳§׳” ׳׳ ׳ ׳׳¦׳׳× ׳‘׳׳•׳’׳•׳׳™׳
          logo: DEPT_LOGOS[department] || '/logo.png'
      };
  }, [user]);

  useEffect(() => {
    if (!user) return;

    const fetchNotifications = async () => {
        const { data } = await supabase.from('notifications')
            .select('id, title, is_read')
            .eq('user_id', user.id)
            .eq('is_read', false)
            .order('created_at', { ascending: false })
            .limit(5);
        setUnreadNotifications(data || []);
    };

    fetchNotifications();

    const channel = supabase.channel('header_notifications')
      .on('postgres_changes', { 
          event: 'INSERT', 
          schema: 'public', 
          table: 'notifications',
          filter: `user_id=eq.${user.id}` 
      }, () => {
          fetchNotifications(); 
      })
      .subscribe();

    return () => { supabase.removeChannel(channel); };
  }, [user]);

  return (
    <header className="hidden md:flex h-24 sticky top-0 z-50 px-8 items-center justify-between transition-all bg-[#F8F9FA]/90 backdrop-blur-md border-b border-gray-200">
      
      {/* ׳¦׳“ ׳™׳׳™׳: ׳›׳•׳×׳¨׳× + ׳׳•׳’׳• */}
      <div className="flex items-center gap-4">
        <div className="relative w-12 h-12 bg-white rounded-xl shadow-sm border border-gray-100 p-1 hidden md:block">
            <Image 
                src={userDisplayInfo.logo} 
                alt="Department Logo" 
                fill 
                className="object-contain p-1" 
                onError={(e) => { (e.target as HTMLImageElement).src = '/logo.png'; }}
            />
        </div>
        
        <div>
            <h1 className="text-3xl font-bold text-gray-800 tracking-tight leading-none">
                {title}
            </h1>
            {user && (
                <p className="text-sm text-gray-500 font-medium mt-1">
                    {getSimpleGreeting(userDisplayInfo.fullName)}
                </p>
            )}
        </div>
      </div>
      
      {/* ׳¦׳“ ׳©׳׳׳: ׳₪׳¨׳•׳₪׳™׳ + ׳₪׳¢׳׳•׳ */}
      <div className="flex items-center gap-6 relative">
            
            {/* ׳₪׳¢׳׳•׳ ׳“׳¡׳§׳˜׳•׳₪ */}
            <div className="relative">
                <button 
                    onClick={() => setIsBellOpen(!isBellOpen)}
                    className="text-gray-400 hover:text-[#00BCD4] transition-colors relative p-3 bg-white rounded-2xl shadow-sm border border-gray-100 hover:border-[#00BCD4] group"
                >
                    <Bell size={22} className="group-hover:rotate-12 transition-transform" />
                    {unreadNotifications.length > 0 && (
                        <span className="absolute top-2 right-2 w-2.5 h-2.5 bg-[#E91E63] rounded-full border-2 border-white animate-pulse"></span>
                    )}
                </button>

                {isBellOpen && (
                    <div className="absolute top-full left-0 mt-4 bg-white rounded-2xl shadow-2xl border border-gray-100 w-80 overflow-hidden animate-fadeIn z-50">
                        <div className="bg-[#00BCD4] p-3 flex justify-between items-center text-white">
                            <span className="text-sm font-bold">׳”׳•׳“׳¢׳•׳× ׳—׳“׳©׳•׳×</span>
                            <button onClick={() => setIsBellOpen(false)}><X size={16}/></button>
                        </div>
                        <div className="max-h-60 overflow-y-auto">
                            {unreadNotifications.length === 0 ? (
                                <div className="p-6 text-center text-gray-400 text-xs">׳׳™׳ ׳”׳•׳“׳¢׳•׳× ׳—׳“׳©׳•׳× ׳¢׳‘׳•׳¨׳</div>
                            ) : (
                                unreadNotifications.map(n => (
                                    <Link key={n.id} href="/dashboard/inbox" onClick={() => setIsBellOpen(false)} className="block p-3 border-b border-gray-50 hover:bg-gray-50 transition-colors">
                                        <div className="flex gap-2">
                                            <Mail size={14} className="text-[#00BCD4] mt-0.5 shrink-0"/>
                                            <span className="text-xs font-bold text-gray-700 line-clamp-2">{n.title}</span>
                                        </div>
                                    </Link>
                                ))
                            )}
                        </div>
                        <Link href="/dashboard/inbox" onClick={() => setIsBellOpen(false)} className="block p-2 text-center text-xs font-bold text-[#00BCD4] bg-gray-50 hover:underline">
                            ׳׳›׳ ׳”׳”׳•׳“׳¢׳•׳×
                        </Link>
                    </div>
                )}
            </div>

            <div className="h-10 w-px bg-gray-300 opacity-50"></div>

            <div className="flex items-center gap-4">
                <div className="text-left hidden lg:block">
                    <div className="text-lg font-bold text-gray-800 leading-none mb-1">
                        {userDisplayInfo.fullName} 
                    </div>
                    {/* ׳›׳׳ ׳׳•׳₪׳™׳¢ ׳”׳×׳™׳׳•׳¨ ׳”׳׳×׳•׳§׳ */}
                    <div className="text-sm text-gray-500 font-medium">
                        {userDisplayInfo.displayRole}
                    </div>
                </div>
                
                <div className="w-14 h-14 rounded-2xl bg-gradient-to-tr from-[#00BCD4] to-cyan-400 flex items-center justify-center text-white font-bold text-2xl shadow-lg shadow-cyan-100 border-[3px] border-white ring-1 ring-gray-100 shrink-0 overflow-hidden relative">
                {userDisplayInfo.avatarUrl ? (
                    <img src={userDisplayInfo.avatarUrl} alt="Profile" className="w-full h-full object-cover" />
                ) : (
                    userDisplayInfo.fullName?.[0]
                )}
                </div>
            </div>
      </div>
    </header>
  );
};


================================================================
FILE PATH: C:\Users\User\chabad-trips\components\layout\ManagerHeader.tsx
================================================================
"use client";

import React, { useEffect, useState } from 'react';
import { supabase } from '@/lib/supabaseClient';
import { Bell, X, UserPlus, Users } from 'lucide-react';
import Link from 'next/link';
import { useUser } from '@/hooks/useUser';

export const ManagerHeader = ({ title }: { title: string }) => {
  // 1. ׳©׳™׳׳•׳© ׳‘-Hook
  const { user } = useUser();
  
  const [counts, setCounts] = useState({ newUsers: 0, newMessages: 0 });
  const [isBellOpen, setIsBellOpen] = useState(false);
  const [isUsersOpen, setIsUsersOpen] = useState(false);

  // 2. ׳˜׳¢׳™׳ ׳× ׳ ׳×׳•׳ ׳™׳ ׳•׳”׳׳–׳ ׳” ׳׳©׳™׳ ׳•׳™׳™׳
  useEffect(() => {
    const fetchCounts = async () => {
        // ׳¡׳₪׳™׳¨׳× ׳׳©׳×׳׳©׳™׳ ׳—׳“׳©׳™׳
        const { count: pendingUsersCount } = await supabase
            .from('profiles') // ׳‘׳•׳“׳§׳™׳ ׳‘׳˜׳‘׳׳× ׳₪׳¨׳•׳₪׳™׳׳™׳ ׳׳ ׳™׳© ׳›׳׳׳” ׳‘׳¡׳˜׳˜׳•׳¡ pending
            .select('*', { count: 'exact', head: true })
            // ׳”׳¢׳¨׳”: ׳”׳׳•׳’׳™׳§׳” ׳©׳ 'pending' ׳‘׳׳©׳×׳׳©׳™׳ ׳×׳׳•׳™׳” ׳‘׳׳™׳ ׳©׳•׳׳¨׳™׳ ׳׳× ׳–׳”.
            // ׳׳ ׳–׳” ׳‘-metadata, ׳¦׳¨׳™׳ ׳׳”׳©׳×׳׳© ׳‘-rpc ׳׳• view.
            // ׳›׳׳ ׳׳ ׳™ ׳׳ ׳™׳— ׳©׳™׳¦׳¨׳ ׳• view ׳›׳׳• ׳‘׳§׳•׳“ ׳”׳׳§׳•׳¨׳™, ׳׳• ׳©׳ ׳©׳×׳׳© ׳‘׳©׳׳™׳׳×׳” ׳₪׳©׳•׳˜׳” ׳׳ ׳׳₪׳©׳¨.
            // ׳׳‘׳™׳ ׳×׳™׳™׳, ׳ ׳©׳—׳–׳¨ ׳׳× ׳”׳׳•׳’׳™׳§׳” ׳”׳׳§׳•׳¨׳™׳× ׳©׳¢׳‘׳“׳” ׳¢׳ users_management_view
            .eq('status', 'pending'); // ׳”׳ ׳—׳”: ׳™׳© ׳¢׳׳•׳“׳× status ׳‘-profiles ׳׳• ׳‘-view

        // ׳¡׳₪׳™׳¨׳× ׳”׳•׳“׳¢׳•׳× ׳—׳“׳©׳•׳×
        const { count: pendingMessagesCount } = await supabase
            .from('contact_messages')
            .select('*', { count: 'exact', head: true })
            .neq('status', 'treated');

        // ׳׳ ׳׳™׳ View, ׳ ׳©׳×׳׳© ׳‘׳₪׳×׳¨׳•׳ ׳”׳§׳•׳“׳ (׳₪׳—׳•׳× ׳™׳¢׳™׳ ׳׳‘׳ ׳¢׳•׳‘׳“)
        let finalUsersCount = 0;
        const { data: usersData } = await supabase.from('users_management_view').select('raw_user_meta_data');
        if (usersData) {
             finalUsersCount = usersData.filter((u: any) => {
                const status = u.raw_user_meta_data?.status;
                return !status || status === 'pending';
            }).length;
        }

        setCounts({
            newUsers: finalUsersCount,
            newMessages: pendingMessagesCount || 0
        });
    };

    fetchCounts();

    // ׳”׳׳–׳ ׳” ׳׳©׳™׳ ׳•׳™׳™׳ ׳‘׳–׳׳ ׳׳׳× (׳¨׳§ ׳׳”׳•׳“׳¢׳•׳× ׳›׳¨׳’׳¢, ׳׳©׳×׳׳©׳™׳ ׳–׳” ׳׳•׳¨׳›׳‘ ׳™׳•׳×׳¨ ׳‘׳’׳׳ auth)
    const channel = supabase.channel('manager_header')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'contact_messages' }, () => {
            fetchCounts();
        })
        .subscribe();

    return () => { supabase.removeChannel(channel); };
  }, []);

  return (
    <header className="hidden md:flex h-24 sticky top-0 z-40 px-8 items-center justify-between transition-all bg-[#F8F9FA]/90 backdrop-blur-md border-b border-gray-200">
      
      {/* ׳¦׳“ ׳™׳׳™׳: ׳›׳•׳×׳¨׳× ׳‘׳׳‘׳“ */}
      <div>
          <h1 className="text-3xl font-bold text-gray-800 tracking-tight leading-none">
              {title}
          </h1>
          <p className="text-sm text-gray-500 font-medium mt-1">
              ׳׳׳©׳§ ׳ ׳™׳”׳•׳ ׳•׳‘׳§׳¨׳”
          </p>
      </div>
      
      {/* ׳¦׳“ ׳©׳׳׳: ׳›׳׳™׳ ׳•׳₪׳¨׳•׳₪׳™׳ */}
      <div className="flex items-center gap-6 relative">
        
        {/* ׳›׳₪׳×׳•׳¨ ׳׳™׳©׳•׳¨ ׳׳©׳×׳׳©׳™׳ - ׳¢׳ ׳—׳׳•׳ ׳™׳× ׳§׳•׳₪׳¦׳× */}
        <div className="relative">
            <button 
                onClick={() => setIsUsersOpen(!isUsersOpen)}
                className="text-gray-400 hover:text-purple-600 transition-colors relative p-3 bg-white rounded-2xl shadow-sm border border-gray-100 hover:border-purple-200 group" 
                title="׳׳™׳©׳•׳¨ ׳׳©׳×׳׳©׳™׳"
            >
                <UserPlus size={22} className="group-hover:scale-110 transition-transform"/>
                {counts.newUsers > 0 && (
                    <span className="absolute top-2 right-2 w-2.5 h-2.5 bg-orange-500 rounded-full border-2 border-white animate-pulse"></span>
                )}
            </button>

            {/* ׳—׳׳•׳ ׳™׳× ׳ ׳¨׳©׳׳™׳ */}
            {isUsersOpen && (
                <div className="absolute top-full left-0 mt-4 bg-white rounded-2xl shadow-2xl border border-gray-100 w-80 overflow-hidden animate-fadeIn z-50">
                    <div className="bg-purple-600 p-3 flex justify-between items-center text-white">
                        <span className="text-sm font-bold flex items-center gap-2"><Users size={16}/> ׳ ׳¨׳©׳׳™׳ ׳—׳“׳©׳™׳</span>
                        <button onClick={() => setIsUsersOpen(false)}><X size={16}/></button>
                    </div>
                    <div className="p-4 text-center">
                        {counts.newUsers > 0 ? (
                            <Link href="/manager/users" className="block p-3 bg-orange-50 rounded-xl mb-2 text-orange-800 font-bold hover:bg-orange-100 transition-colors border border-orange-100">
                                {counts.newUsers} ׳׳©׳×׳׳©׳™׳ ׳׳׳×׳™׳ ׳™׳ ׳׳׳™׳©׳•׳¨
                            </Link>
                        ) : (
                            <p className="text-gray-400 text-sm">׳׳™׳ ׳ ׳¨׳©׳׳™׳ ׳—׳“׳©׳™׳ ׳›׳¨׳’׳¢</p>
                        )}
                        <Link href="/manager/users" className="block text-xs font-bold text-gray-500 hover:text-purple-600 mt-4 underline">
                            ׳׳ ׳™׳”׳•׳ ׳”׳׳©׳×׳׳©׳™׳
                        </Link>
                    </div>
                </div>
            )}
        </div>

        {/* ׳₪׳¢׳׳•׳ ׳”׳×׳¨׳׳•׳× (׳”׳•׳“׳¢׳•׳×) */}
        <div className="relative">
            <button 
                onClick={() => setIsBellOpen(!isBellOpen)}
                className="text-gray-400 hover:text-[#00BCD4] transition-colors relative p-3 bg-white rounded-2xl shadow-sm border border-gray-100 hover:border-[#00BCD4] group"
            >
                <Bell size={22} className="group-hover:rotate-12 transition-transform" />
                {counts.newMessages > 0 && (
                    <span className="absolute top-2 right-2 w-2.5 h-2.5 bg-[#E91E63] rounded-full border-2 border-white animate-pulse"></span>
                )}
            </button>

            {/* ׳—׳׳•׳ ׳™׳× ׳”׳”׳×׳¨׳׳•׳× */}
            {isBellOpen && (
                <div className="absolute top-full left-0 mt-4 bg-white rounded-2xl shadow-2xl border border-gray-100 w-80 overflow-hidden animate-fadeIn z-50">
                    <div className="bg-[#00BCD4] p-3 flex justify-between items-center text-white">
                        <span className="text-sm font-bold">׳”׳•׳“׳¢׳•׳× ׳׳¢׳¨׳›׳×</span>
                        <button onClick={() => setIsBellOpen(false)}><X size={16}/></button>
                    </div>
                    <div className="p-4 text-center">
                        {counts.newMessages > 0 ? (
                            <Link href="/manager/inbox" className="block p-3 bg-cyan-50 rounded-xl mb-2 text-cyan-800 font-bold hover:bg-cyan-100 transition-colors">
                                ׳™׳©׳ ׳ {counts.newMessages} ׳₪׳ ׳™׳•׳× ׳”׳׳׳×׳™׳ ׳•׳× ׳׳˜׳™׳₪׳•׳
                            </Link>
                        ) : (
                            <p className="text-gray-400 text-sm">׳׳™׳ ׳”׳•׳“׳¢׳•׳× ׳—׳“׳©׳•׳×</p>
                        )}
                        <Link href="/manager/inbox" className="block text-xs font-bold text-gray-500 hover:text-[#00BCD4] mt-4 underline">
                            ׳׳›׳ ׳”׳”׳•׳“׳¢׳•׳×
                        </Link>
                    </div>
                </div>
            )}
        </div>

        <div className="h-10 w-px bg-gray-300 opacity-50 mx-2"></div>

        {/* ׳₪׳¨׳•׳₪׳™׳ ׳׳ ׳”׳ */}
        <Link href="/manager/profile">
            <div className="flex items-center gap-3 cursor-pointer group">
                <div className="text-left hidden md:block">
                    <div className="text-sm font-bold text-gray-800 leading-none mb-1 group-hover:text-[#00BCD4] transition-colors">
                        {user?.user_metadata?.full_name || '׳׳ ׳”׳ ׳׳¢׳¨׳›׳×'}
                    </div>
                    <div className="text-xs text-gray-500 font-medium">
                        ׳׳—׳׳§׳× ׳‘׳˜׳™׳—׳•׳× ׳•׳׳₪׳¢׳׳™׳
                    </div>
                </div>
                
                <div className="w-12 h-12 rounded-2xl bg-gradient-to-tr from-gray-700 to-gray-900 flex items-center justify-center text-white font-bold text-xl shadow-lg border-[3px] border-white ring-1 ring-gray-100 shrink-0 overflow-hidden relative group-hover:scale-105 transition-transform">
                    {user?.user_metadata?.avatar_url ? (
                        <img src={user.user_metadata.avatar_url} alt="Profile" className="w-full h-full object-cover" />
                    ) : (
                        user?.user_metadata?.full_name?.[0] || 'M'
                    )}
                </div>
            </div>
        </Link>
      </div>
    </header>
  );
};


================================================================
FILE PATH: C:\Users\User\chabad-trips\components\layout\ManagerSidebar.tsx
================================================================
"use client"

import React, { useEffect, useState } from 'react'
import Link from 'next/link'
import Image from 'next/image'
import { usePathname } from 'next/navigation'
import { supabase } from '@/lib/supabaseClient'
import { 
  LayoutDashboard, CheckSquare, Users, FileBarChart, Settings, LogOut, Mail, UserCircle, X
} from 'lucide-react'

const ADMIN_EMAIL = process.env.NEXT_PUBLIC_SUPER_ADMIN_EMAIL || 'avremihalperin@gmail.com';

interface SidebarProps {
    isOpen?: boolean;
    onClose?: () => void;
}

export const ManagerSidebar = ({ isOpen = true, onClose }: SidebarProps) => {
  const pathname = usePathname();
  const [isSuperAdmin, setIsSuperAdmin] = useState(false);
  
  // ׳‘׳“׳™׳§׳” ׳׳”׳™׳¨׳” ׳©׳ ׳×׳₪׳§׳™׳“ ׳›׳“׳™ ׳׳”׳¦׳™׳’ ׳׳× ׳”׳×׳₪׳¨׳™׳˜ ׳”׳ ׳›׳•׳
  useEffect(() => {
    const checkRole = async () => {
        const { data: { user } } = await supabase.auth.getUser();
        if (user?.email === ADMIN_EMAIL || user?.user_metadata?.contact_email === ADMIN_EMAIL) {
            setIsSuperAdmin(true);
        }
    };
    checkRole();
  }, []);

  const baseItems = [
    { label: '׳׳•׳— ׳‘׳§׳¨׳” ׳¨׳׳©׳™', href: '/manager', icon: LayoutDashboard, exact: true },
    { label: '׳“׳•׳׳¨ ׳ ׳›׳ ׳¡ ׳•׳”׳•׳“׳¢׳•׳×', href: '/manager/inbox', icon: Mail },
    { label: '׳׳™׳©׳•׳¨ ׳˜׳™׳•׳׳™׳', href: '/manager/approvals', icon: CheckSquare },
    { label: '׳ ׳™׳”׳•׳ ׳׳©׳×׳׳©׳™׳', href: '/manager/users', icon: Users },
    { label: '׳“׳•׳—׳•׳× ׳•׳ ׳×׳•׳ ׳™׳', href: '/manager/reports', icon: FileBarChart },
    { label: '׳₪׳¨׳•׳₪׳™׳ ׳׳™׳©׳™', href: '/manager/profile', icon: UserCircle },
  ];

  const menuItems = isSuperAdmin 
    ? [...baseItems, { label: '׳”׳’׳“׳¨׳•׳× ׳׳¢׳¨׳›׳×', href: '/manager/settings', icon: Settings }]
    : baseItems;

  const handleLogout = async () => {
    await supabase.auth.signOut();
    window.location.href = '/';
  };

  return (
    <>
        {/* Overlay ׳׳׳•׳‘׳™׳™׳ */}
        <div 
            className={`fixed inset-0 bg-black/40 z-[90] transition-opacity duration-300 md:hidden backdrop-blur-sm
            ${isOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`}
            onClick={onClose}
        ></div>

        {/* ׳¡׳¨׳’׳ ׳¦׳“ ׳׳‘׳ ׳•׳ ׳§׳™ */}
        <aside className={`w-64 bg-white h-screen fixed right-0 top-0 z-[100] flex flex-col shadow-2xl md:shadow-none border-l border-gray-200 transition-transform duration-300
            ${isOpen ? 'translate-x-0' : 'translate-x-full'} 
            md:translate-x-0 md:z-40`}
        >
          
          {/* Header - ׳׳‘׳ ׳•׳ ׳§׳™ */}
          <div className="h-32 flex flex-col items-center justify-center p-6 relative border-b border-gray-100">
              
              <button 
                onClick={onClose} 
                className="absolute top-4 left-4 md:hidden text-gray-400 hover:text-gray-600 p-2 rounded-full transition-colors z-50"
              >
                  <X size={24} />
              </button>

              {/* ׳”׳׳•׳’׳• ׳׳©׳×׳׳‘ ׳˜׳‘׳¢׳™׳× ׳¢׳ ׳”׳¨׳§׳¢ ׳”׳׳‘׳ */}
              <div className="relative w-full h-16 flex items-center justify-center mb-2">
                 <Image 
                    src="/logo.png" 
                    alt="Logo" 
                    fill
                    className="object-contain"
                    priority
                 />
              </div>
              
              <div className="text-[10px] text-gray-400 font-bold uppercase tracking-wider bg-gray-50 px-3 py-1 rounded-full border border-gray-100">
                  ׳׳׳©׳§ ׳ ׳™׳”׳•׳
              </div>
          </div>

          {/* ׳×׳₪׳¨׳™׳˜ */}
          <nav className="flex-1 px-4 py-6 space-y-1.5 overflow-y-auto">
            {menuItems.map((item) => {
              const isActive = item.exact ? pathname === item.href : pathname?.startsWith(item.href);
              const Icon = item.icon;
              return (
                <Link 
                    key={item.href} 
                    href={item.href} 
                    onClick={() => { if(onClose) onClose() }}
                    className={`flex items-center gap-3 px-4 py-3.5 rounded-xl transition-all duration-200 font-bold text-sm 
                    ${isActive 
                        ? 'bg-[#00BCD4] text-white shadow-lg shadow-cyan-100' // ׳₪׳¢׳™׳: ׳×׳›׳׳× ׳׳•׳×׳’ ׳¢׳ ׳¦׳
                        : 'text-gray-500 hover:bg-gray-50 hover:text-gray-900' // ׳׳ ׳₪׳¢׳™׳: ׳׳₪׳•׳¨ ׳ ׳§׳™
                    }`}
                >
                  <Icon size={20} strokeWidth={isActive ? 2.5 : 2} />
                  {item.label}
                </Link>
              )
            })}
          </nav>

          {/* Footer */}
          <div className="p-4 border-t border-gray-100 bg-gray-50/50">
            <button onClick={handleLogout} className="flex items-center justify-center gap-3 px-4 py-3 rounded-xl w-full text-red-500 hover:bg-red-50 transition-all font-bold text-sm group">
              <LogOut size={20} className="group-hover:-translate-x-1 transition-transform"/> ׳™׳¦׳™׳׳” ׳׳׳•׳‘׳˜׳—׳×
            </button>
          </div>
        </aside>
    </>
  )
}


================================================================
FILE PATH: C:\Users\User\chabad-trips\components\layout\Sidebar.tsx
================================================================
"use client"

import React from 'react'
import Link from 'next/link'
import Image from 'next/image'
import { usePathname } from 'next/navigation'
import { supabase } from '@/lib/supabaseClient'
import { 
  Home, PlusCircle, FileText, User, MessageSquare, LogOut, Bell, X
} from 'lucide-react'

interface SidebarProps {
    isOpen?: boolean;
    onClose?: () => void;
}

export const Sidebar = ({ isOpen = true, onClose }: SidebarProps) => {
  const pathname = usePathname();

  const menuItems = [
    { label: '׳¨׳׳©׳™', href: '/dashboard', icon: Home, exact: true },
    { label: '׳”׳•׳“׳¢׳•׳× ׳•׳¢׳“׳›׳•׳ ׳™׳', href: '/dashboard/inbox', icon: Bell },
    { label: '׳‘׳§׳©׳× ׳₪׳©"׳© ׳—׳“׳©׳”', href: '/dashboard/new-trip', icon: PlusCircle },
    { label: '׳”׳˜׳™׳•׳׳™׳ ׳©׳׳™', href: '/dashboard/my-trips', icon: FileText },
    { label: '׳₪׳¨׳•׳₪׳™׳ ׳׳™׳©׳™', href: '/dashboard/profile', icon: User },
    { label: '׳¢׳–׳¨׳” ׳•׳×׳׳™׳›׳”', href: '/dashboard/contact', icon: MessageSquare }
  ];

  const handleLogout = async () => {
    await supabase.auth.signOut();
    window.location.href = '/';
  };

  return (
    <>
        {/* Overlay */}
        <div 
            className={`fixed inset-0 bg-black/60 z-[90] transition-opacity duration-300 md:hidden backdrop-blur-sm
            ${isOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`}
            onClick={onClose}
        ></div>

        <aside className={`w-56 bg-white border-l border-gray-200 h-screen fixed right-0 top-0 z-[100] flex flex-col shadow-2xl transition-transform duration-300
            ${isOpen ? 'translate-x-0' : 'translate-x-full'} 
            md:translate-x-0 md:z-40 md:shadow-none`}
        >
          
          <div className="h-24 flex flex-col items-center justify-center border-b border-gray-100 p-4 relative">
              <button 
                onClick={(e) => {
                    e.stopPropagation();
                    if (onClose) onClose();
                }}
                className="absolute top-3 left-3 md:hidden text-gray-400 hover:text-red-500 p-1.5 bg-gray-50 rounded-lg hover:bg-red-50 transition-all z-50 cursor-pointer active:scale-90"
              >
                  <X size={20} />
              </button>

              <div className="relative w-full h-10 md:h-12 flex items-center justify-center mt-1">
                 <Image 
                    src="/logo.png" 
                    alt="׳ ׳•׳¢׳¨ ׳—׳‘׳´׳“" 
                    fill 
                    className="object-contain" 
                    priority 
                 />
              </div>
          </div>

          <nav className="flex-1 p-3 space-y-1.5 overflow-y-auto custom-scrollbar">
            {menuItems.map((item) => {
              const isActive = item.exact 
                ? pathname === item.href
                : pathname?.startsWith(item.href);
              const Icon = item.icon;

              return (
                <Link 
                  key={item.href} 
                  href={item.href}
                  onClick={() => { if(onClose) onClose() }} 
                  className={`flex items-center gap-3 px-3 py-3 rounded-xl transition-all duration-200 font-bold text-sm whitespace-nowrap
                    ${isActive 
                      ? 'bg-cyan-50 text-[#00BCD4] shadow-sm' 
                      : 'text-gray-500 hover:bg-gray-50 hover:text-gray-900'
                    }`}
                >
                  <Icon size={18} strokeWidth={isActive ? 2.5 : 2} />
                  {item.label}
                </Link>
              )
            })}
          </nav>

          <div className="p-3 border-t border-gray-100">
            <button onClick={handleLogout} className="flex items-center justify-center gap-3 px-3 py-3 rounded-xl w-full text-red-500 hover:bg-red-50 transition-all font-bold text-sm group">
              <LogOut size={18} className="group-hover:-translate-x-1 transition-transform"/>
              ׳™׳¦׳™׳׳”
            </button>
          </div>
        </aside>
    </>
  )
}


================================================================
FILE PATH: C:\Users\User\chabad-trips\components\ui\Button.tsx
================================================================
import React from 'react';
import { Loader2 } from 'lucide-react';

interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary' | 'outline' | 'ghost' | 'danger' | 'dark';
  isLoading?: boolean;
  icon?: React.ReactNode;
}

export const Button: React.FC<ButtonProps> = ({ 
  children, 
  className = '', 
  variant = 'primary', 
  isLoading = false, 
  icon,
  disabled,
  ...props 
}) => {
  
  const baseStyles = "relative flex items-center justify-center gap-2 px-6 py-3 rounded-xl font-bold transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:active:scale-100";
  
  const variants = {
    primary: "bg-[#00BCD4] hover:bg-cyan-600 text-white shadow-lg shadow-cyan-100 hover:shadow-cyan-200",
    secondary: "bg-[#8BC34A] hover:bg-[#7CB342] text-white shadow-lg shadow-green-100 hover:shadow-green-200",
    dark: "bg-gray-800 hover:bg-gray-900 text-white shadow-lg",
    danger: "bg-red-50 text-red-600 border border-red-100 hover:bg-red-100",
    outline: "bg-transparent border-2 border-gray-200 text-gray-500 hover:border-gray-300 hover:bg-gray-50",
    ghost: "bg-transparent text-gray-500 hover:bg-gray-50 hover:text-gray-700 p-2",
  };

  return (
    <button 
      className={`${baseStyles} ${variants[variant]} ${className}`}
      disabled={isLoading || disabled}
      {...props}
    >
      {isLoading && <Loader2 size={18} className="animate-spin absolute" />}
      <span className={`flex items-center gap-2 ${isLoading ? 'opacity-0' : 'opacity-100'}`}>
        {icon}
        {children}
      </span>
    </button>
  );
};


================================================================
FILE PATH: C:\Users\User\chabad-trips\components\ui\Input.tsx
================================================================
import React from 'react';

interface InputProps extends React.InputHTMLAttributes<HTMLInputElement> {
  label?: string;
  icon?: React.ReactNode;
  error?: string;
}

export const Input = React.forwardRef<HTMLInputElement, InputProps>(
  ({ label, icon, className = '', error, ...props }, ref) => {
    return (
      <div className="w-full">
        {label && (
          <label className="block text-xs font-bold text-gray-500 mb-1.5 mr-1">
            {label}
          </label>
        )}
        <div className="relative group">
          <input
            ref={ref}
            dir="rtl" // ׳׳›׳¨׳™׳— ׳›׳™׳•׳•׳ ׳¢׳‘׳¨׳™׳×
            className={`
              w-full bg-gray-50 text-gray-800 text-sm font-bold placeholder:text-gray-300 placeholder:font-normal
              border border-gray-200 rounded-xl py-3.5 outline-none transition-all
              focus:bg-white focus:border-[#E91E63] focus:ring-4 focus:ring-pink-50
              disabled:opacity-60 disabled:cursor-not-allowed disabled:bg-gray-100 disabled:text-gray-500
              ${icon ? 'pr-10 pl-4' : 'px-4'} 
              ${error ? '!border-red-300 !bg-red-50 focus:!ring-red-50' : ''}
              ${className}
            `}
            {...props}
          />
          {icon && (
            <div className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-[#E91E63] transition-colors pointer-events-none">
              {icon}
            </div>
          )}
        </div>
        {error && <p className="text-xs text-red-500 mt-1 mr-1 font-bold">{error}</p>}
      </div>
    );
  }
);

Input.displayName = "Input";


================================================================
FILE PATH: C:\Users\User\chabad-trips\components\ui\Modal.tsx
================================================================
"use client";

import React, { useEffect, useState } from 'react';
import { X, CheckCircle, AlertTriangle, Info, AlertCircle } from 'lucide-react';
import { Button } from './Button';

type ModalType = 'success' | 'error' | 'info' | 'confirm';

interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
  type?: ModalType;
  title: string;
  message: string;
  onConfirm?: () => void;
  confirmText?: string;
  cancelText?: string;
}

export const Modal: React.FC<ModalProps> = ({ 
  isOpen, onClose, type = 'info', title, message, onConfirm, 
  confirmText = '׳׳™׳©׳•׳¨', cancelText = '׳‘׳™׳˜׳•׳' 
}) => {
  const [show, setShow] = useState(false);

  useEffect(() => {
    if (isOpen) {
        setShow(true);
        document.body.style.overflow = 'hidden';
    } else {
        const timer = setTimeout(() => setShow(false), 300);
        document.body.style.overflow = 'unset';
        return () => clearTimeout(timer);
    }
  }, [isOpen]);

  if (!show && !isOpen) return null;

  const config = {
    success: { icon: CheckCircle, color: 'text-green-500', bg: 'bg-green-50' },
    error:   { icon: AlertCircle, color: 'text-red-500',   bg: 'bg-red-50' },
    confirm: { icon: AlertTriangle, color: 'text-orange-500', bg: 'bg-orange-50' },
    info:    { icon: Info,        color: 'text-[#00BCD4]', bg: 'bg-cyan-50' },
  }[type];

  const Icon = config.icon;

  return (
    <div className={`fixed inset-0 z-[100] flex items-center justify-center p-4 transition-all duration-300 ${isOpen ? 'opacity-100' : 'opacity-0'}`}>
      
      {/* Backdrop */}
      <div 
        className="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" 
        onClick={onClose}
      ></div>

      {/* Content */}
      <div className={`relative bg-white w-full max-w-sm rounded-[32px] shadow-2xl p-6 transform transition-all duration-300 ${isOpen ? 'scale-100 translate-y-0' : 'scale-95 translate-y-4'}`}>
        
        <button onClick={onClose} className="absolute top-4 left-4 p-2 bg-gray-50 rounded-full text-gray-400 hover:bg-gray-100 hover:text-gray-600 transition-colors">
            <X size={18} />
        </button>

        <div className="flex flex-col items-center text-center">
            <div className={`w-16 h-16 rounded-full flex items-center justify-center mb-4 ${config.bg} ${config.color}`}>
                <Icon size={32} strokeWidth={2.5} />
            </div>

            <h3 className="text-xl font-black text-gray-800 mb-2">
                {title}
            </h3>
            
            <p className="text-gray-500 text-sm font-medium leading-relaxed mb-6 whitespace-pre-line">
                {message}
            </p>

            <div className="flex gap-3 w-full">
                {onConfirm ? (
                    <>
                        <Button variant="outline" onClick={onClose} className="flex-1">
                            {cancelText}
                        </Button>
                        <Button 
                            variant={type === 'error' || type === 'confirm' ? 'danger' : 'primary'} 
                            onClick={() => { onConfirm(); onClose(); }} 
                            className="flex-1"
                        >
                            {confirmText}
                        </Button>
                    </>
                ) : (
                    <Button variant="primary" onClick={onClose} className="w-full">
                        {confirmText || '׳¡׳’׳•׳¨'}
                    </Button>
                )}
            </div>
        </div>
      </div>
    </div>
  );
};


================================================================
FILE PATH: C:\Users\User\chabad-trips\components\ui\MultiSelectFilter.tsx
================================================================
"use client";

import React, { useState, useRef, useEffect } from 'react';
import { Filter, Check } from 'lucide-react';

interface Option {
  id: string;
  label: string;
  color?: string;
}

interface MultiSelectFilterProps {
  options: Option[];
  selected: string[];
  onChange: (selected: string[]) => void;
}

export const MultiSelectFilter = ({ options, selected, onChange }: MultiSelectFilterProps) => {
  const [isOpen, setIsOpen] = useState(false);
  const containerRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (containerRef.current && !containerRef.current.contains(event.target as Node)) {
        setIsOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const toggleOption = (id: string) => {
    if (selected.includes(id)) {
      onChange(selected.filter(item => item !== id));
    } else {
      onChange([...selected, id]);
    }
  };

  const clearSelection = () => {
    onChange([]); 
    setIsOpen(false);
  };

  const getDisplayText = () => {
    if (selected.length === 0) return '׳”׳›׳';
    if (selected.length === 1) {
        const item = options.find(o => o.id === selected[0]);
        // ׳‘׳˜׳׳₪׳•׳ ׳ ׳§׳¦׳¨ ׳˜׳§׳¡׳˜ ׳׳ ׳”׳•׳ ׳׳¨׳•׳ ׳׳™׳“׳™
        return item ? (item.label.length > 15 ? item.label.substring(0,12)+'...' : item.label) : '1 ׳ ׳‘׳—׳¨';
    }
    return `${selected.length} ׳ ׳‘׳—׳¨׳•`;
  };

  return (
    <div className="relative w-full md:w-auto md:min-w-[160px]" ref={containerRef}>
      <button
        onClick={() => setIsOpen(!isOpen)}
        className={`w-full flex items-center justify-between pl-3 pr-4 py-3 bg-white border rounded-2xl text-sm font-bold outline-none transition-all shadow-sm
        ${isOpen ? 'border-[#00BCD4] ring-4 ring-cyan-50' : 'border-gray-200 hover:border-gray-300'}
        `}
      >
        <span className="text-gray-600 truncate">{getDisplayText()}</span>
        <Filter size={16} className={`text-gray-400 shrink-0 ${selected.length > 0 ? 'text-[#00BCD4]' : ''}`} />
      </button>

      {isOpen && (
        <div className="absolute top-full mt-2 left-0 w-full md:w-64 bg-white border border-gray-100 rounded-2xl shadow-xl z-50 overflow-hidden animate-fadeIn p-2 md:left-auto md:right-0">
          
          <div 
            onClick={clearSelection}
            className="flex items-center gap-3 p-2.5 rounded-xl hover:bg-gray-50 cursor-pointer transition-colors"
          >
            <div className={`w-5 h-5 rounded-md border flex items-center justify-center ${selected.length === 0 ? 'bg-[#00BCD4] border-[#00BCD4]' : 'border-gray-300'}`}>
                {selected.length === 0 && <Check size={14} className="text-white" />}
            </div>
            <span className="text-sm font-bold text-gray-700">׳”׳›׳</span>
          </div>

          <div className="h-px bg-gray-100 my-1 mx-2"></div>

          <div className="max-h-60 overflow-y-auto scrollbar-hide">
            {options.map((option) => {
               const isSelected = selected.includes(option.id);
               return (
                <div 
                    key={option.id}
                    onClick={() => toggleOption(option.id)}
                    className="flex items-center gap-3 p-2.5 rounded-xl hover:bg-gray-50 cursor-pointer transition-colors"
                >
                    <div className={`w-5 h-5 rounded-md border flex items-center justify-center shrink-0 ${isSelected ? 'bg-[#00BCD4] border-[#00BCD4]' : 'border-gray-300'}`}>
                        {isSelected && <Check size={14} className="text-white" />}
                    </div>
                    
                    <div className="flex items-center gap-2 overflow-hidden">
                        {option.color && <div className={`w-2 h-2 rounded-full shrink-0 ${option.color}`}></div>}
                        <span className={`text-sm font-bold truncate ${isSelected ? 'text-gray-800' : 'text-gray-500'}`}>
                            {option.label}
                        </span>
                    </div>
                </div>
               );
            })}
          </div>
        </div>
      )}
    </div>
  );
};


================================================================
FILE PATH: C:\Users\User\chabad-trips\components\TripCard.tsx
================================================================
"use client"

import React from 'react';
import { useRouter } from 'next/navigation';
import { 
  CheckCircle, Clock, AlertTriangle, FileEdit, 
  MapPin, ArrowRight, Trash2, ChevronLeft
} from 'lucide-react';
import { CATEGORY_STYLES } from '@/lib/constants';
import { formatHebrewDateRange } from '@/lib/dateUtils';

interface TripCardProps {
    trip: any;
    onDeleteDraft?: (id: string) => void;
    onCancelTrip?: (id: string) => void;
}

const getStatusConfig = (status: string) => {
    const config: any = {
        approved: { text: '׳׳׳•׳©׳¨', bg: 'bg-green-100', textCol: 'text-green-700', icon: CheckCircle },
        pending: { text: '׳׳׳×׳™׳', bg: 'bg-amber-100', textCol: 'text-amber-700', icon: Clock },
        rejected: { text: '׳׳ ׳׳•׳©׳¨', bg: 'bg-red-100', textCol: 'text-red-700', icon: AlertTriangle },
        draft: { text: '׳˜׳™׳•׳˜׳”', bg: 'bg-gray-100', textCol: 'text-gray-600', icon: FileEdit },
        cancelled: { text: '׳‘׳•׳˜׳', bg: 'bg-stone-100', textCol: 'text-stone-500', icon: Trash2 }
    };
    return config[status] || config.pending;
};

const getRibbonColor = (type: string) => {
    if (!type) return 'bg-slate-400'; 
    if (type === "׳˜׳™׳•׳ ׳׳—׳•׳¥ ׳׳¡׳ ׳™׳£") return 'bg-[#4DD0E1]'; 
    if (type === "׳›׳ ׳¡/׳׳™׳¨׳•׳¢ ׳׳—׳•׳¥ ׳׳¡׳ ׳™׳£") return 'bg-[#BA68C8]';
    if (type === "׳₪׳¢׳™׳׳•׳× ׳׳ ׳©׳’׳¨׳×׳™׳× ׳‘׳¡׳ ׳™׳£") return 'bg-[#81C784]';
    if (type === "׳™׳¦׳™׳׳” ׳¨׳’׳׳™׳× ׳‘׳׳–׳•׳¨ ׳”׳¡׳ ׳™׳£") return 'bg-[#FFB74D]';
    return 'bg-slate-400';
};

// ׳׳•׳’׳™׳§׳” ׳׳×׳¦׳•׳’׳× ׳“׳¡׳§׳˜׳•׳₪ (׳¨׳™׳‘׳•׳¢ ׳¦׳“ ׳©׳׳׳)
const getSmartDateDisplay = (startStr: string, endStr: string) => {
    const start = new Date(startStr);
    const end = new Date(endStr || startStr);
    
    const sDay = start.getDate();
    const sMonth = start.getMonth() + 1;
    const sYear = start.getFullYear();
    
    const eDay = end.getDate();
    const eMonth = end.getMonth() + 1;
    const eYear = end.getFullYear();

    if (start.getTime() === end.getTime()) {
        return { top: `${sDay}`, bottom: `${sMonth < 10 ? '0'+sMonth : sMonth}/${sYear}` };
    }
    if (sMonth === eMonth && sYear === eYear) {
        return { top: `${sDay}-${eDay}`, bottom: `${sMonth < 10 ? '0'+sMonth : sMonth}/${sYear}` };
    }
    return { top: `${sDay}/${sMonth}-${eDay}/${eMonth}`, bottom: `${sYear}` };
};

// --- ׳₪׳•׳ ׳§׳¦׳™׳” ׳—׳“׳©׳” ׳׳×׳¦׳•׳’׳× ׳׳•׳‘׳™׳™׳ ׳×׳§׳ ׳™׳× (DD/MM/YYYY) ---
const getMobileDateString = (startStr: string, endStr: string) => {
    const start = new Date(startStr);
    const end = new Date(endStr || startStr);

    const sDay = start.getDate();
    const sMonth = (start.getMonth() + 1).toString().padStart(2, '0');
    const sYear = start.getFullYear();

    const eDay = end.getDate();
    const eMonth = (end.getMonth() + 1).toString().padStart(2, '0');
    const eYear = end.getFullYear();

    // ׳׳•׳×׳• ׳™׳•׳
    if (start.getTime() === end.getTime()) {
        return `${sDay}/${sMonth}/${sYear}`;
    }
    // ׳׳•׳×׳• ׳—׳•׳“׳© ׳•׳׳•׳×׳” ׳©׳ ׳”: 18-19/02/2026
    if (sMonth === eMonth && sYear === eYear) {
        return `${sDay}-${eDay}/${sMonth}/${sYear}`;
    }
    // ׳׳•׳×׳” ׳©׳ ׳”, ׳—׳•׳“׳©׳™׳ ׳©׳•׳ ׳™׳
    if (sYear === eYear) {
        return `${sDay}/${sMonth} - ${eDay}/${eMonth}/${sYear}`;
    }
    // ׳©׳ ׳™׳ ׳©׳•׳ ׳•׳×
    return `${sDay}/${sMonth}/${sYear.toString().slice(-2)} - ${eDay}/${eMonth}/${eYear.toString().slice(-2)}`;
};

export const TripCard = ({ trip, onDeleteDraft, onCancelTrip }: TripCardProps) => {
    const router = useRouter();
    const d = trip.details || {};
    const timeline = d.timeline || [];
    const status = getStatusConfig(trip.status);
    const StatusIcon = status.icon;
    const isDraft = trip.status === 'draft';
    const isPast = new Date(trip.start_date) < new Date(new Date().setHours(0,0,0,0));
    const isCancelled = trip.status === 'cancelled';
    
    const smartDate = getSmartDateDisplay(trip.start_date, d.endDate);
    const mobileDateString = getMobileDateString(trip.start_date, d.endDate);
    const dateRangeHeb = formatHebrewDateRange(trip.start_date, d.endDate);

    const deptName = trip.department || ''; 
    const isFemale = deptName.includes('׳‘׳× ׳׳׳') || deptName.includes('׳‘׳ ׳•׳× ׳—׳‘"׳“') || deptName.includes('׳‘׳ ׳•׳× ׳—׳‘׳´׳“');
    const participantsLabel = isFemale ? '׳׳©׳×׳×׳₪׳•׳×' : '׳׳©׳×׳×׳₪׳™׳';

    const handleCardClick = () => {
        router.push(`/dashboard/trip/${trip.id}`);
    };

    return (
        <div 
            onClick={handleCardClick}
            className={`bg-white border border-gray-200 rounded-2xl md:rounded-l-2xl md:rounded-r-none shadow-sm hover:shadow-md transition-all relative overflow-hidden flex flex-col md:flex-row min-h-[140px] cursor-pointer
            ${isDraft ? 'border-dashed bg-gray-50/50' : ''}
            ${isPast || isCancelled ? 'opacity-75 grayscale-[0.1]' : ''}
        `}>
            
            {/* === MOBILE ONLY: Header === */}
            <div className="md:hidden flex flex-col w-full">
                <div className={`w-full py-1.5 px-3 flex items-center justify-center text-white text-xs font-bold ${getRibbonColor(d.tripType)}`}>
                    {d.tripType}
                </div>
                <div className="flex justify-between items-center p-3 bg-slate-50 border-b border-gray-100">
                      {/* ׳¡׳˜׳˜׳•׳¡ ׳׳™׳׳™׳ */}
                      <div className={`px-2.5 py-1 rounded-lg text-[10px] font-bold flex items-center gap-1.5 ${status.bg} ${status.textCol}`}>
                         <StatusIcon size={12}/> {status.text}
                      </div>
                      
                      {/* ׳×׳׳¨׳™׳ ׳׳©׳׳׳ - ׳׳¡׳•׳“׳¨ ׳•׳ ׳§׳™ */}
                      <div className="text-left flex flex-col items-end gap-0.5">
                          <span className="text-sm font-black text-gray-800 leading-none">
                              {mobileDateString}
                          </span>
                          <span className="text-[10px] text-gray-400 font-bold">
                              {dateRangeHeb}
                          </span>
                      </div>
                </div>
            </div>

            {/* === DESKTOP ONLY: Left Side Elements === */}
            <div className={`hidden md:flex absolute top-0 left-0 px-3 py-1.5 items-center gap-1.5 text-xs font-bold rounded-br-xl z-20 ${status.bg} ${status.textCol}`}>
                <StatusIcon size={14}/>
                {status.text}
            </div>

            <div className={`hidden md:flex w-9 shrink-0 items-center justify-center text-white text-[11px] font-bold z-10 ${getRibbonColor(d.tripType)}`}>
                <span className="rotate-90 whitespace-nowrap tracking-wider drop-shadow-sm">{d.tripType}</span>
            </div>

            <div className="hidden md:flex w-32 shrink-0 flex-col justify-center items-center text-center p-2 border-l border-dashed border-gray-200 bg-gradient-to-b from-white to-gray-50/50">
                <div className="transform transition-transform duration-300 hover:-translate-y-1 cursor-default">
                    <div className="text-2xl font-black text-gray-800 leading-none dir-ltr tracking-tight">
                        {smartDate.top}
                    </div>
                    <div className="text-sm font-bold text-gray-500 dir-ltr mt-1">
                        {smartDate.bottom}
                    </div>
                    <div className="w-8 h-[2px] bg-gray-100 mx-auto my-2 rounded-full"></div>
                    <div className="text-[10px] text-gray-400 font-bold leading-tight px-1">
                        {dateRangeHeb}
                    </div>
                </div>
            </div>

            {/* === ׳’׳•׳£ ׳”׳›׳¨׳˜׳™׳¡ === */}
            <div className="flex-1 p-4 pb-2 md:p-4 flex flex-col justify-center min-w-0 overflow-hidden relative">
                
                <div className="flex flex-col md:flex-row md:items-center gap-2 md:gap-3 mb-4 mt-1 md:mt-0">
                    <h3 className="text-lg md:text-xl font-black text-gray-800 truncate leading-none" title={trip.name}>
                        {trip.name || '׳׳׳ ׳©׳'}
                    </h3>
                    
                    <div className="flex flex-wrap items-center gap-2">
                        <span className="bg-gray-50 text-gray-600 px-2 py-0.5 rounded text-[10px] font-bold border border-gray-200 whitespace-nowrap">
                            {d.totalTravelers || 0} {participantsLabel}
                        </span>
                        {(d.gradeFrom || d.gradeTo) && (
                            <span className="bg-gray-50 text-gray-600 px-2 py-0.5 rounded text-[10px] font-bold border border-gray-200 whitespace-nowrap">
                                ׳›׳™׳×׳•׳× {d.gradeFrom}-{d.gradeTo}
                            </span>
                        )}
                    </div>
                </div>

                {/* ׳¨׳›׳‘׳× */}
                <div className="relative w-full">
                    <div className="absolute left-0 top-0 bottom-4 w-6 bg-gradient-to-r from-white to-transparent z-10 pointer-events-none"></div>

                    <div className="flex gap-2 overflow-x-auto pb-4 scrollbar-hide px-1 md:px-0 w-full items-stretch">
                        {timeline.length === 0 ? (
                            <div className="text-xs text-gray-400 italic p-2 w-full">׳˜׳¨׳ ׳”׳•׳–׳ ׳׳•"׳–</div>
                        ) : (
                            timeline.map((item: any, i: number) => {
                                const catStyle = CATEGORY_STYLES[item.category] || CATEGORY_STYLES.other;
                                const Icon = catStyle.icon;
                                
                                let titleText = item.finalSubCategory || catStyle.label;
                                let subText = item.finalLocation;

                                if (item.category === 'sleeping') {
                                    if (item.subCategory === '׳׳™׳ ׳× ׳׳‘׳ ׳”' || titleText === '׳׳™׳ ׳× ׳׳‘׳ ׳”') {
                                        titleText = '׳׳™׳ ׳× ׳׳‘׳ ׳”';
                                        const placeName = item.otherDetail || '';
                                        const placeCity = item.finalLocation || '';
                                        if (placeName && placeCity) subText = `${placeName} - ${placeCity}`;
                                        else subText = placeName || placeCity;
                                    } else {
                                         titleText = item.subCategory || '׳׳™׳ ׳”';
                                         subText = item.finalLocation;
                                    }
                                }
                                
                                return (
                                    <div key={i} className="flex items-center shrink-0 group relative">
                                        <div className={`w-24 md:w-26 shrink-0 border rounded-xl p-1.5 flex flex-col gap-1 transition-all hover:shadow-md ${catStyle.pastelBg} ${catStyle.border}`}>
                                            <div className="flex items-center gap-1.5">
                                                <div className={`w-4 h-4 md:w-5 md:h-5 rounded-full flex items-center justify-center bg-white shadow-sm ${catStyle.darkText} shrink-0`}>
                                                    <Icon size={10} />
                                                </div>
                                                <span className={`text-[9px] md:text-[10px] font-black leading-tight truncate ${catStyle.darkText}`}>{catStyle.label}</span>
                                            </div>
                                            <div className="pr-0.5">
                                                <div className="text-[10px] md:text-[11px] font-bold text-gray-800 leading-tight truncate" title={titleText}>
                                                    {titleText || '-'}
                                                </div>
                                                {subText && (
                                                    <div className="text-[9px] text-gray-500 truncate flex items-center gap-0.5 mt-0.5" title={subText}>
                                                        <MapPin size={8} className="shrink-0"/>
                                                        {subText}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        {i < timeline.length - 1 && (
                                            <div className="shrink-0 px-0.5 text-gray-300 group-hover:text-[#00BCD4] transition-colors -ml-0.5 z-10 relative">
                                                <ChevronLeft size={16} strokeWidth={2} />
                                            </div>
                                        )}
                                    </div>
                                );
                            })
                        )}
                    </div>
                </div>
            </div>

            {/* === ׳›׳₪׳×׳•׳¨׳™׳ === */}
            <div className="flex flex-row md:flex-col justify-end p-3 gap-2 w-full md:w-32 shrink-0 bg-white border-t md:border-t-0 border-gray-100">
                {isDraft ? (
                    <>
                        <button 
                            onClick={(e) => { e.stopPropagation(); router.push(`/dashboard/new-trip?id=${trip.id}`); }} 
                            className="w-full py-2 bg-[#00BCD4] text-white rounded-lg text-xs font-bold hover:bg-cyan-600 transition-colors flex items-center justify-center gap-1 shadow-sm"
                        >
                            <FileEdit size={14}/> ׳¢׳¨׳™׳›׳”
                        </button>
                        {onDeleteDraft && (
                            <button onClick={(e) => { e.stopPropagation(); onDeleteDraft(trip.id); }} className="w-full py-2 bg-white border border-red-100 text-red-500 rounded-lg text-xs font-bold hover:bg-red-50 hover:border-red-200 transition-colors flex items-center justify-center gap-1">
                                <Trash2 size={14}/> ׳׳—׳§
                            </button>
                        )}
                    </>
                ) : (
                    <>
                        <button 
                            onClick={(e) => { e.stopPropagation(); router.push(`/dashboard/trip/${trip.id}`); }}
                            className="w-full py-2 bg-white border border-gray-200 text-gray-500 hover:border-gray-300 hover:text-gray-700 rounded-lg text-xs font-bold transition-colors flex items-center justify-center gap-1"
                        >
                            <ArrowRight size={14}/> ׳׳₪׳¨׳˜׳™׳ 
                        </button>

                        {onCancelTrip && !isPast && !isCancelled && (
                            <button onClick={(e) => { e.stopPropagation(); onCancelTrip(trip.id); }} className="w-full py-2 bg-red-50 border border-red-100 text-red-600 rounded-lg text-xs font-bold hover:bg-red-100 transition-colors flex items-center justify-center gap-1">
                                <Trash2 size={14}/> ׳׳‘׳™׳˜׳•׳
                            </button>
                        )}
                    </>
                )}
            </div>
        </div>
    );
};


================================================================
FILE PATH: C:\Users\User\chabad-trips\components\TripDetailsView.tsx
================================================================
"use client"

import React from 'react'
import { 
  CheckCircle, Clock, AlertTriangle, FileText, 
  Printer, Share2, Users, MapPin, Tent, Info, 
  User, CreditCard, Hash, Phone, Mail, 
  Briefcase, Edit2, Trash2, Plus, X, Paperclip, ShieldCheck,
  ArrowRight
} from 'lucide-react'
import { TRIP_TYPES_CONFIG, CATEGORY_STYLES } from '@/lib/constants'
import { formatHebrewDateRange, formatHebrewDate } from '@/lib/dateUtils'
import { Button } from '@/components/ui/Button' // ׳”׳ ׳—׳” ׳©׳§׳™׳™׳, ׳׳ ׳׳ ׳ ׳©׳×׳׳© ׳‘-HTML ׳¨׳’׳™׳

// --- ׳₪׳•׳ ׳§׳¦׳™׳•׳× ׳¢׳–׳¨ ---
const formatDateShortYear = (dateStr: string) => {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const d = date.getDate().toString().padStart(2, '0');
    const m = (date.getMonth() + 1).toString().padStart(2, '0');
    const y = date.getFullYear().toString().slice(-2);
    return `${d}.${m}.${y}`;
};

const calculateDuration = (startStr: string, endStr: string) => {
    if (!startStr || !endStr) return 1;
    const start = new Date(startStr);
    const end = new Date(endStr);
    const diffTime = Math.abs(end.getTime() - start.getTime());
    return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
};

const getCategoryBorder = (category: string) => {
    switch (category) {
        case 'transport': return 'border-blue-500';
        case 'activity': return 'border-pink-500';
        case 'food': return 'border-orange-500';
        case 'sleeping': return 'border-purple-500';
        case 'security': return 'border-green-500';
        case 'ceremony': return 'border-yellow-500';
        case 'hiking': return 'border-green-600';
        case 'attraction': return 'border-pink-600';
        case 'settlement': return 'border-indigo-500';
        default: return 'border-cyan-500';
    }
};

const DateBox = ({ dateStr }: { dateStr: string }) => {
    if (!dateStr) return null;
    const date = new Date(dateStr);
    return (
        <div className="flex flex-col items-center justify-center bg-gray-50 border border-gray-100 rounded-xl px-2 py-2 min-w-[60px] md:min-w-[75px] text-center h-full shadow-inner shrink-0">
            <div className="text-base md:text-lg font-black text-gray-800 leading-none mb-0.5">{date.getDate()}.{date.getMonth() + 1}</div>
            <div className="text-[9px] md:text-[10px] font-bold text-gray-400">{date.getFullYear()}</div>
            <div className="w-full h-px bg-gray-200 my-1.5"></div>
            <div className="text-[9px] md:text-[10px] font-bold text-gray-500 leading-tight">{formatHebrewDate(dateStr)}</div>
        </div>
    );
};

// --- Props ---
interface TripDetailsViewProps {
    trip: any;
    profile?: any;
    isEditable: boolean;
    isPublic: boolean;
    onBack?: () => void;
    onEditTrip?: () => void;
    onCancelTrip?: () => void; 
    onEditStaff?: () => void;
    onDeleteStaff?: () => void;
    onSaveStaff?: () => void;
    isAddingStaff?: boolean;
    setIsAddingStaff?: (val: boolean) => void;
    newStaffData?: any;
    setNewStaffData?: (data: any) => void;
    isVerifying?: boolean;
}

export const TripDetailsView: React.FC<TripDetailsViewProps> = ({
    trip, profile, isEditable, isPublic,
    onBack, onEditTrip, onCancelTrip, onEditStaff, onDeleteStaff, onSaveStaff,
    isAddingStaff, setIsAddingStaff, newStaffData, setNewStaffData, isVerifying
}) => {
    
    const d = trip.details || {};
    const timeline = d.timeline || [];
    const typeConfig = TRIP_TYPES_CONFIG.find(t => t.id === d.tripType) || TRIP_TYPES_CONFIG[4];
    
    // ׳—׳™׳©׳•׳‘׳™׳ ׳׳‘׳™׳˜׳•׳
    const isPast = new Date(trip.start_date) < new Date(new Date().setHours(0,0,0,0));
    const isCancelled = trip.status === 'cancelled';

    // ׳–׳™׳”׳•׳™ ׳׳’׳“׳¨ ׳•׳׳—׳׳§׳•׳×
    const deptName = trip.department || '';
    const isFemale = deptName.includes('׳‘׳× ׳׳׳') || deptName.includes('׳‘׳ ׳•׳× ׳—׳‘"׳“') || deptName.includes('׳‘׳ ׳•׳× ׳—׳‘׳´׳“');
    
    const participantsTitle = isFemale ? '׳¡׳”"׳› ׳׳©׳×׳×׳₪׳•׳×' : '׳¡׳”"׳› ׳׳©׳×׳×׳₪׳™׳'; 
    const traineesLabel = isFemale ? '׳—׳ ׳™׳›׳•׳×' : '׳—׳ ׳™׳›׳™׳';
    const boxTitle = isFemale ? '׳׳—׳¨׳׳™׳× ׳”׳₪׳¢׳™׳׳•׳×' : '׳׳—׳¨׳׳™ ׳”׳₪׳¢׳™׳׳•׳×';
    const addStaffBtnLabel = isFemale ? '׳”׳•׳¡׳₪׳× ׳׳—׳¨׳׳™׳× ׳˜׳™׳•׳' : '׳”׳•׳¡׳₪׳× ׳׳—׳¨׳׳™ ׳˜׳™׳•׳';
    const secondStaffTitle = isFemale ? '׳׳—׳¨׳׳™׳× ׳ ׳•׳¡׳₪׳×' : '׳׳—׳¨׳׳™ ׳ ׳•׳¡׳£';
    const namePlaceholder = "׳©׳ ׳׳׳ ׳›׳₪׳™ ׳©׳׳•׳₪׳™׳¢ ׳‘׳×׳¢׳•׳“׳× ׳–׳”׳•׳×";

    // --- ׳׳•׳’׳™׳§׳” ׳׳©׳•׳₪׳¨׳× ׳׳×׳¦׳•׳’׳× ׳×׳₪׳§׳™׳“ (Role Display) ---
    let subRoleDisplay = '';
    const isBranchHQ = trip.branch === '׳׳˜׳”' || (trip.branch || '').includes('׳”׳ ׳”׳׳”');
    const isProfileHQ = profile?.role === 'admin' || profile?.role === 'dept_staff' || profile?.role === 'safety_admin';

    if (isBranchHQ || isProfileHQ) {
        subRoleDisplay = `׳¦׳•׳•׳× ׳׳˜׳” ג€¢ ${trip.department || ''}`;
    } else {
        const roleBase = isFemale ? '׳¨׳›׳–׳× ׳¡׳ ׳™׳£' : '׳¨׳›׳– ׳¡׳ ׳™׳£';
        const branchName = trip.branch || '';
        // ׳”׳•׳¡׳₪׳× ׳©׳ ׳”׳׳—׳׳§׳” ׳׳×׳¦׳•׳’׳”
        subRoleDisplay = `${roleBase} ${branchName} | ${trip.department || ''}`;
    }

    // --- ׳˜׳§׳¡׳˜׳™׳ ׳׳›׳₪׳×׳•׳¨׳™׳ ---
    const isTripType = d.tripType === '׳˜׳™׳•׳ ׳׳—׳•׳¥ ׳׳¡׳ ׳™׳£';
    const editButtonText = isTripType ? '׳¢׳¨׳™׳›׳× ׳₪׳¨׳˜׳™ ׳”׳˜׳™׳•׳' : '׳¢׳¨׳™׳›׳× ׳₪׳¨׳˜׳™ ׳”׳₪׳¢׳™׳׳•׳×';
    const cancelButtonText = isTripType ? '׳‘׳™׳˜׳•׳ ׳”׳˜׳™׳•׳' : '׳‘׳™׳˜׳•׳ ׳”׳₪׳¢׳™׳׳•׳×';

    const missingDocsCount = timeline.filter((t: any) => t.requiresLicense && (!t.licenseFile || !t.insuranceFile)).length;
    const durationDays = calculateDuration(trip.start_date, d.endDate);

    const getStatusBadge = (status: string) => {
        const styles: any = {
            approved: { text: '׳׳׳•׳©׳¨', bg: 'bg-green-100', textCol: 'text-green-700', icon: CheckCircle },
            pending: { text: '׳׳׳×׳™׳ ׳׳׳™׳©׳•׳¨', bg: 'bg-orange-100', textCol: 'text-orange-700', icon: Clock },
            rejected: { text: '׳׳ ׳׳•׳©׳¨', bg: 'bg-red-100', textCol: 'text-red-700', icon: AlertTriangle },
            draft: { text: '׳˜׳™׳•׳˜׳”', bg: 'bg-gray-100', textCol: 'text-gray-600', icon: FileText },
            cancelled: { text: '׳‘׳•׳˜׳', bg: 'bg-stone-100', textCol: 'text-stone-500', icon: AlertTriangle }
        };
        const conf = styles[status] || styles.pending;
        const Icon = conf.icon;
        return (
            <div className={`flex items-center gap-1.5 px-3 py-1 md:px-4 md:py-2 rounded-full text-xs md:text-sm font-bold ${conf.bg} ${conf.textCol} shadow-sm border border-white/20 shrink-0`}>
                <Icon size={14} className="md:w-4 md:h-4"/> {conf.text}
            </div>
        );
    };

    const handlePrint = () => window.print();
    const handleShare = async () => {
        const origin = typeof window !== 'undefined' && window.location.origin ? window.location.origin : '';
        const publicUrl = `${origin}/share/trip/${trip.id}`;
        if (navigator.share) {
            try { await navigator.share({ title: trip.name, text: trip.name, url: publicUrl }); } catch (err) {}
        } else {
            navigator.clipboard.writeText(publicUrl);
            alert('׳”׳§׳™׳©׳•׳¨ ׳”׳¦׳™׳‘׳•׳¨׳™ ׳”׳•׳¢׳×׳§ ׳׳׳•׳—!');
        }
    };

    const showSecondaryStaffCard = d.secondaryStaffObj && !isAddingStaff;
    const showAddStaffForm = isEditable && !isPublic && isAddingStaff && setNewStaffData && setIsAddingStaff;
    const showAddButton = isEditable && !isPublic && !isAddingStaff && !d.secondaryStaffObj && setIsAddingStaff;

    return (
        <div className="animate-fadeIn pb-32 max-w-[1600px] mx-auto print:p-0">
            
            {!isPublic && onBack && (
                <button onClick={onBack} className="inline-flex items-center gap-2 text-gray-400 hover:text-gray-600 mb-6 transition-colors font-bold text-sm print:hidden">
                    <ArrowRight size={18}/> ׳—׳–׳¨׳”
                </button>
            )}

            {/* --- Hero --- */}
            <div className="bg-white rounded-[32px] border border-gray-200 shadow-sm overflow-hidden mb-8 print:shadow-none print:border-none">
                <div className={`h-auto py-6 md:h-32 ${typeConfig.bg} relative overflow-hidden flex items-center px-4 md:px-8`}>
                    <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
                    <div className="relative z-10 w-full flex flex-row justify-between items-start md:items-center gap-4">
                        <div className="flex items-start md:items-center gap-4">
                            <div className="bg-white p-3 md:p-4 rounded-2xl shadow-lg text-gray-700 hidden md:block">
                                {React.createElement(typeConfig.icon, { size: 36, className: typeConfig.text })}
                            </div>
                            <div>
                                <div className={`text-sm md:text-xl font-black uppercase tracking-wider mb-1 ${typeConfig.text} opacity-90 drop-shadow-sm`}>{d.tripType}</div>
                                <h1 className="text-xl md:text-4xl font-black text-gray-900 leading-none">{trip.name}</h1>
                            </div>
                        </div>
                        {getStatusBadge(trip.status)}
                    </div>
                </div>

                <div className="p-4 md:p-6 grid grid-cols-2 md:grid-cols-7 gap-4 md:gap-6 divide-y md:divide-y-0 md:divide-x divide-x-reverse divide-gray-100">
                    <div className="col-span-2 md:col-span-2 text-center md:text-right pl-0 md:pl-2 flex flex-col justify-center">
                        <div className="bg-gray-50 border border-gray-200 rounded-2xl p-3 flex flex-col gap-3">
                            <div className="flex justify-between items-center w-full gap-1">
                                <div className="flex flex-col items-center flex-1">
                                    <span className="text-[10px] text-gray-400 font-bold mb-1 uppercase tracking-wide">׳”׳×׳—׳׳”</span>
                                    <span className="text-base md:text-lg font-black text-gray-800 leading-none mb-1">{formatDateShortYear(trip.start_date)}</span>
                                    <span className="text-[10px] md:text-[11px] font-bold text-green-700 bg-green-100 px-2 py-0.5 rounded-full">{d.startTime || '--:--'}</span>
                                </div>
                                <div className="w-px h-10 bg-gray-300 mx-1 md:mx-2"></div>
                                <div className="flex flex-col items-center flex-1">
                                    <span className="text-[10px] text-gray-400 font-bold mb-1 uppercase tracking-wide">׳¡׳™׳•׳</span>
                                    <span className="text-base md:text-lg font-black text-gray-800 leading-none mb-1">{formatDateShortYear(d.endDate)}</span>
                                    <span className="text-[10px] md:text-[11px] font-bold text-red-700 bg-red-100 px-2 py-0.5 rounded-full">{d.endTime || '--:--'}</span>
                                </div>
                            </div>
                            <div className="border-t border-gray-200 pt-2 flex items-center justify-center gap-2">
                                <span className="text-[10px] md:text-[11px] text-gray-500 font-bold">{formatHebrewDateRange(trip.start_date, d.endDate)}</span>
                                <span className="text-[10px] md:text-[11px] font-black text-gray-800 border-r border-gray-300 pr-2">׳¡׳”"׳› {durationDays} ׳™׳׳™׳</span>
                            </div>
                        </div>
                    </div>
                    <div className="text-center md:text-right px-2 flex flex-col justify-center pt-2 md:pt-0"><span className="text-xs font-bold text-gray-400 block mb-1">׳©׳›׳‘׳•׳×</span><div className="font-black text-gray-800 text-lg md:text-xl">׳›׳™׳×׳•׳× {d.gradeFrom}-{d.gradeTo}</div></div>
                    <div className="text-center md:text-right px-2 flex flex-col justify-center pt-2 md:pt-0"><span className="text-xs font-bold text-gray-400 block mb-1">׳¡׳”"׳› {traineesLabel}</span><div className="font-black text-gray-800 text-lg md:text-xl flex items-center gap-2 justify-center md:justify-start"><Users size={18} className="text-[#00BCD4] shrink-0"/>{d.chanichimCount || '0'}</div></div>
                    <div className="text-center md:text-right px-2 md:col-span-1 flex flex-col justify-center pt-2 md:pt-0"><span className="text-xs font-bold text-gray-400 block mb-1">׳”׳¨׳›׳‘ ׳¦׳•׳•׳×</span><div className="flex flex-wrap gap-1 justify-center md:justify-start">{d.staffAges?.map((s: string, i: number) => (<span key={i} className="text-[10px] font-bold bg-gray-50 text-gray-500 px-1.5 py-0.5 rounded border border-gray-100 truncate max-w-full">{s}</span>))}</div></div>
                    <div className="text-center md:text-right px-2 flex flex-col justify-center pt-2 md:pt-0"><span className="text-xs font-bold text-gray-400 block mb-1">{participantsTitle}</span><div className="font-black text-gray-800 text-lg md:text-xl flex items-center gap-2 justify-center md:justify-start"><Users size={18} className="text-[#00BCD4] shrink-0"/>{d.totalTravelers}</div><div className="text-[10px] text-gray-400 mt-0.5">׳›׳•׳׳ ׳¦׳•׳•׳×</div></div>
                    
                    <div className="col-span-2 md:col-span-1 text-center md:text-right pr-0 md:pr-4 flex flex-row md:flex-col justify-center gap-2 print:hidden pt-2 md:pt-0">
                         <button onClick={handlePrint} className="flex-1 md:w-full bg-gray-50 hover:bg-gray-100 text-gray-600 py-2 md:py-1.5 rounded-xl text-xs font-bold transition-colors flex items-center justify-center gap-2"><Printer size={14}/> ׳”׳“׳₪׳¡׳”</button>
                         <button onClick={handleShare} className="flex-1 md:w-full bg-gray-50 hover:bg-gray-100 text-gray-600 py-2 md:py-1.5 rounded-xl text-xs font-bold transition-colors flex items-center justify-center gap-2"><Share2 size={14}/> ׳©׳™׳×׳•׳£</button>
                    </div>
                </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                {/* --- Timeline --- */}
                <div className="lg:col-span-2 space-y-6">
                    <div className="flex items-center gap-2 mb-2"><Clock className="text-gray-400" size={20}/><h2 className="text-xl font-bold text-gray-800">׳׳•"׳– ׳”׳₪׳¢׳™׳׳•׳×</h2></div>
                    <div className="relative">
                        <div className="absolute top-4 bottom-4 right-[27px] w-[2px] bg-gray-200 z-0"></div>
                        <div className="space-y-4 relative z-10">
                            {timeline.map((item: any, i: number) => {
                                const catStyle = CATEGORY_STYLES[item.category] || CATEGORY_STYLES.other;
                                const Icon = catStyle.icon;
                                const borderClass = getCategoryBorder(item.category);
                                return (
                                    <div key={i} className="flex gap-3 md:gap-4 items-stretch">
                                        <div className="shrink-0 flex flex-col items-center w-14 pt-1 gap-1">
                                            <div className={`w-12 h-12 md:w-14 md:h-14 rounded-full flex items-center justify-center shadow-sm border-4 border-white ${catStyle.pastelBg} ${catStyle.darkText} z-10`}><Icon size={20} className="md:w-6 md:h-6" /></div>
                                            <span className={`text-[8px] md:text-[9px] font-black px-1.5 py-0.5 rounded-md text-center leading-tight w-full break-words ${catStyle.pastelBg} ${catStyle.darkText}`}>{catStyle.label}</span>
                                        </div>
                                        <div className={`flex-1 bg-white rounded-xl p-3 shadow-sm border-2 ${borderClass} flex gap-3 md:gap-4`}>
                                            <div className="shrink-0">{item.date ? <DateBox dateStr={item.date} /> : <div className="w-[60px] md:w-[75px] h-full bg-gray-50 rounded-xl border border-gray-100 flex items-center justify-center text-xs text-gray-300">-</div>}</div>
                                            <div className="flex-1 flex flex-col justify-center">
                                                <h3 className="text-sm md:text-base font-black text-gray-800 leading-tight mb-2">{item.finalSubCategory}</h3>
                                                <div className="space-y-2">
                                                    <div className="flex items-start gap-2 text-xs text-gray-700 font-medium"><MapPin size={14} className="text-[#E91E63] shrink-0 mt-0.5"/><span>{item.finalLocation}</span></div>
                                                    {item.otherDetail && item.finalSubCategory !== item.otherDetail && (
                                                        <div className="flex items-start gap-2 text-xs text-gray-800 bg-slate-50 p-2 rounded border border-gray-100">
                                                            <div className="shrink-0 mt-0.5">{item.category === 'sleeping' ? <Tent size={14} className="text-purple-500"/> : <Info size={14} className="text-gray-400"/>}</div>
                                                            <div><span className="font-bold text-gray-500 ml-1">{item.category === 'sleeping' ? '׳׳§׳•׳ ׳”׳׳™׳ ׳”:' : '׳₪׳¨׳˜׳™׳:'}</span><span className="font-bold">{item.otherDetail}</span></div>
                                                        </div>
                                                    )}
                                                    {item.details && <div className="text-xs text-gray-500 leading-relaxed pl-2 border-r-2 border-gray-100 pr-2">{item.details}</div>}
                                                </div>
                                                {item.requiresLicense && (
                                                    <div className="flex flex-wrap gap-2 mt-2 pt-2 border-t border-gray-100">
                                                        {item.licenseFile ? <a href={item.licenseFile.url} target="_blank" rel="noreferrer" className="flex items-center gap-1 text-[10px] font-bold text-green-700 bg-green-50 px-2 py-1 rounded border border-green-200 hover:bg-green-100"><ShieldCheck size={12}/> ׳¨׳™׳©׳•׳™ ׳¢׳¡׳§</a> : <span className="flex items-center gap-1 text-[10px] font-bold text-red-600 bg-red-50 px-2 py-1 rounded border border-red-200"><AlertTriangle size={12}/> ׳—׳¡׳¨ ׳¨׳™׳©׳•׳™</span>}
                                                        {item.insuranceFile ? <a href={item.insuranceFile.url} target="_blank" rel="noreferrer" className="flex items-center gap-1 text-[10px] font-bold text-green-700 bg-green-50 px-2 py-1 rounded border border-green-200 hover:bg-green-100"><ShieldCheck size={12}/> ׳‘׳™׳˜׳•׳—</a> : <span className="flex items-center gap-1 text-[10px] font-bold text-red-600 bg-red-50 px-2 py-1 rounded border border-red-200"><AlertTriangle size={12}/> ׳—׳¡׳¨ ׳‘׳™׳˜׳•׳—</span>}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>

                {/* --- Sidebar --- */}
                <div className="space-y-6">
                    <div className="bg-white rounded-3xl border border-gray-200 p-6 shadow-sm">
                        <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2 border-b border-gray-100 pb-2"><Briefcase size={18} className="text-[#00BCD4] shrink-0"/>{boxTitle}</h3>
                        <div className="flex flex-col gap-0 text-sm">
                            <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-t-xl border-b border-white">
                                <User size={16} className="text-gray-400"/>
                                <div><span className="block font-black text-[#00BCD4] text-lg">{trip.coordinator_name}</span><span className="text-xs font-bold text-gray-500">{subRoleDisplay}</span></div>
                            </div>
                            
                            {(!isPublic && profile?.official_name) && (<div className="flex items-center gap-3 p-3 bg-gray-50 border-b border-white"><CreditCard size={16} className="text-gray-400"/><div><span className="text-[10px] text-gray-400 block font-bold">׳©׳ ׳׳׳ (׳×.׳–)</span><span className="block font-bold text-gray-700">{profile.official_name} {profile.last_name}</span></div></div>)}
                            {(!isPublic && profile?.identity_number) && (<div className="flex items-center gap-3 p-3 bg-gray-50 border-b border-white"><Hash size={16} className="text-gray-400"/><div><span className="text-[10px] text-gray-400 block font-bold">׳×׳¢׳•׳“׳× ׳–׳”׳•׳×</span><span className="block font-bold text-gray-800">{profile.identity_number}</span></div></div>)}
                            
                            <div className="flex items-center gap-3 p-3 bg-gray-50 border-b border-white"><Phone size={16} className="text-gray-400"/><div><span className="text-[10px] text-gray-400 block font-bold">׳˜׳׳₪׳•׳</span><span className="block font-bold text-gray-800">{d.phone || profile?.phone || '-'}</span></div></div>
                            
                            {!isPublic && (
                                <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-b-xl overflow-hidden"><Mail size={16} className="text-gray-400 shrink-0"/><div className="overflow-hidden"><span className="text-[10px] text-gray-400 block font-bold">׳׳™׳׳™׳™׳</span><span className="block font-bold text-gray-800 truncate">{profile?.email || '-'}</span></div></div>
                            )}
                        </div>

                        {showSecondaryStaffCard && (
                            <div className="mt-4 pt-4 border-t border-gray-100 group">
                                <div className="flex justify-between items-center mb-2">
                                    <div className="text-[10px] font-bold text-purple-600 uppercase">{secondStaffTitle}</div>
                                    {isEditable && !isPublic && (
                                        <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button onClick={onEditStaff} className="p-1 hover:bg-gray-100 rounded text-gray-500 hover:text-blue-500" title="׳¢׳¨׳™׳›׳”"><Edit2 size={12}/></button>
                                            <button onClick={onDeleteStaff} className="p-1 hover:bg-gray-100 rounded text-gray-500 hover:text-red-500" title="׳׳—׳™׳§׳”"><Trash2 size={12}/></button>
                                        </div>
                                    )}
                                </div>
                                <div className="bg-purple-50 p-3 rounded-xl border border-purple-100 text-sm">
                                    <div className="font-bold text-purple-900 mb-1 flex justify-between">{d.secondaryStaffObj.name}<span className="text-[10px] bg-white/50 px-2 py-0.5 rounded text-purple-500">{d.secondaryStaffObj.role}</span></div>
                                    <div className="mt-2 text-xs text-purple-600 flex flex-col gap-1">
                                        {!isPublic && <div className="flex items-center gap-1"><Hash size={10}/> {d.secondaryStaffObj.idNumber}</div>}
                                        <div className="flex items-center gap-1"><Phone size={10}/> {d.secondaryStaffObj.phone}</div>
                                        {!isPublic && <div className="flex items-center gap-1"><Mail size={10}/> {d.secondaryStaffObj.email}</div>}
                                    </div>
                                </div>
                            </div>
                        )}

                        {showAddStaffForm && (
                            <div className="mt-4 pt-4 border-t border-gray-100">
                                <div className="animate-fadeIn bg-gray-50 p-3 rounded-xl border border-gray-200">
                                    <div className="flex justify-between items-center mb-2"><span className="text-xs font-bold text-gray-500">{addStaffBtnLabel}</span><button onClick={() => setIsAddingStaff && setIsAddingStaff(false)}><X size={14} className="text-gray-400"/></button></div>
                                    <div className="space-y-2">
                                        <input type="text" className="w-full p-2 text-xs border rounded-lg bg-white" placeholder={namePlaceholder} value={newStaffData.name} onChange={e => setNewStaffData && setNewStaffData({...newStaffData, name: e.target.value})}/>
                                        <input type="text" className="w-full p-2 text-xs border rounded-lg bg-white" placeholder="׳×׳₪׳§׳™׳“ ׳‘׳׳¨׳’׳•׳" value={newStaffData.role} onChange={e => setNewStaffData && setNewStaffData({...newStaffData, role: e.target.value})}/>
                                        <input type="text" className="w-full p-2 text-xs border rounded-lg bg-white" placeholder="׳×׳¢׳•׳“׳× ׳–׳”׳•׳×" value={newStaffData.idNumber} onChange={e => setNewStaffData && setNewStaffData({...newStaffData, idNumber: e.target.value})}/>
                                        <input type="tel" dir="rtl" className="w-full p-2 text-xs border rounded-lg bg-white text-right" placeholder="׳˜׳׳₪׳•׳" value={newStaffData.phone} onChange={e => setNewStaffData && setNewStaffData({...newStaffData, phone: e.target.value})}/>
                                        <input type="email" className="w-full p-2 text-xs border rounded-lg bg-white text-right" placeholder="׳׳™׳׳™׳™׳" value={newStaffData.email} onChange={e => setNewStaffData && setNewStaffData({...newStaffData, email: e.target.value})}/>
                                        <button onClick={onSaveStaff} disabled={isVerifying} className="w-full bg-[#00BCD4] text-white text-xs font-bold py-2 rounded-lg hover:bg-cyan-600 transition-colors mt-1 disabled:opacity-50">{isVerifying ? '׳‘׳•׳“׳§ ׳‘׳׳¢׳¨׳›׳×...' : '׳׳™׳׳•׳× ׳•׳©׳׳™׳¨׳”'}</button>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {showAddButton && (
                             <div className="mt-4 pt-4 border-t border-gray-100">
                                <button onClick={() => setIsAddingStaff && setIsAddingStaff(true)} className="w-full py-2 border border-dashed border-gray-300 rounded-xl text-xs font-bold text-gray-500 hover:text-[#00BCD4] flex items-center justify-center gap-1"><Plus size={14}/> {addStaffBtnLabel}</button>
                             </div>
                        )}
                    </div>

                    <div className="bg-white rounded-3xl border border-gray-200 p-6 shadow-sm">
                        <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2 border-b border-gray-100 pb-2"><Paperclip size={18} className="text-[#E91E63]"/>׳§׳‘׳¦׳™׳ ׳•׳׳¡׳׳›׳™׳</h3>
                        {missingDocsCount > 0 ? (
                            // ׳×׳™׳§׳•׳: ׳©׳™׳ ׳•׳™ ׳”׳˜׳§׳¡׳˜ ׳-"׳—׳¡׳¨׳™׳ ׳׳¡׳׳›׳™׳" ׳-"׳—׳¡׳¨ ׳¨׳™׳©׳•׳™ ׳¢׳¡׳§ ׳•׳‘׳™׳˜׳•׳—"
                            <div className="bg-red-50 border border-red-100 rounded-xl p-4 flex gap-3 items-start"><AlertTriangle size={20} className="text-red-500 mt-0.5 shrink-0"/><div><span className="block text-sm font-bold text-red-700">׳—׳¡׳¨ ׳¨׳™׳©׳•׳™ ׳¢׳¡׳§ ׳•׳‘׳™׳˜׳•׳—</span><span className="text-xs text-red-600 block mt-1">׳™׳© ׳׳”׳©׳׳™׳ {missingDocsCount} ׳׳™׳©׳•׳¨׳™׳.</span></div></div>
                        ) : (
                            <div className="bg-green-50 border border-green-100 rounded-xl p-4 flex gap-3 items-center"><CheckCircle size={20} className="text-green-600 shrink-0"/><div><span className="block text-sm font-bold text-green-700">׳”׳›׳ ׳×׳§׳™׳</span><span className="text-xs text-green-600">׳›׳ ׳”׳׳™׳©׳•׳¨׳™׳ ׳”׳ ׳“׳¨׳©׳™׳ ׳”׳•׳¢׳׳•.</span></div></div>
                        )}
                    </div>

                    {d.generalComments && (
                        <div className="bg-yellow-50 rounded-3xl p-6 border border-yellow-100">
                            <h3 className="font-bold text-yellow-800 mb-2 flex items-center gap-2"><FileText size={18}/> ׳”׳¢׳¨׳•׳× ׳•׳‘׳§׳©׳•׳×</h3>
                            <p className="text-sm text-yellow-700 leading-relaxed whitespace-pre-wrap">{d.generalComments}</p>
                        </div>
                    )}

                    <div className="flex flex-row gap-2">
                        {isEditable && onEditTrip && (
                            <button 
                                onClick={onEditTrip}
                                className="flex-1 h-12 bg-[#00BCD4] hover:bg-cyan-600 text-white rounded-2xl font-bold shadow-lg shadow-cyan-100 transition-all active:scale-95 flex items-center justify-center gap-2 text-sm"
                            >
                                <Edit2 size={16} />
                                {editButtonText}
                            </button>
                        )}
                        
                        {isEditable && onCancelTrip && !isPast && !isCancelled && (
                            <button 
                                onClick={onCancelTrip}
                                className="flex-1 h-12 bg-red-50 border border-red-100 text-red-600 hover:bg-red-100 rounded-2xl font-bold transition-all active:scale-95 flex items-center justify-center gap-2 text-sm"
                            >
                                <Trash2 size={16} />
                                {cancelButtonText}
                            </button>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};


================================================================
FILE PATH: C:\Users\User\chabad-trips\lib\constants.ts
================================================================
import { Bus, Navigation, Ticket, Utensils, Home, Tent, HelpCircle } from 'lucide-react';

// --- ׳¨׳©׳™׳׳•׳× ׳‘׳¡׳™׳¡׳™׳•׳× ---
export const ISRAEL_CITIES = [
    "׳™׳¨׳•׳©׳׳™׳", "׳×׳ ׳׳‘׳™׳‘", "׳—׳™׳₪׳”", "׳¨׳—׳•׳‘׳•׳×", "׳›׳₪׳¨ ׳—׳‘׳´׳“", "׳¦׳₪׳×", "׳׳™׳׳×", "׳˜׳‘׳¨׳™׳”", "׳ ׳×׳ ׳™׳”", 
    "׳׳©׳“׳•׳“", "׳‘׳׳¨ ׳©׳‘׳¢", "׳׳•׳“", "׳§׳¨׳™׳™׳× ׳׳׳׳›׳™", "׳ ׳—׳׳× ׳”׳¨ ׳—׳‘׳´׳“", "׳ ׳•׳£ ׳”׳’׳׳™׳", "׳‘׳™׳× ׳©׳׳©", 
    "׳‘׳™׳×׳¨ ׳¢׳™׳׳™׳×", "׳׳׳¢׳“", "׳׳•׳“׳™׳¢׳™׳ ׳¢׳™׳׳™׳×", "׳‘׳ ׳™ ׳‘׳¨׳§", "׳₪׳×׳— ׳×׳§׳•׳•׳”", "׳¨׳׳©׳•׳ ׳׳¦׳™׳•׳", 
    "׳—׳•׳׳•׳", "׳¨׳׳× ׳’׳", "׳‘׳× ׳™׳", "׳׳©׳§׳׳•׳"
].sort();

export const GRADES = ['׳׳³', '׳‘׳³', '׳’׳³', '׳“׳³', '׳”׳³', '׳•׳³', '׳–׳³', '׳—׳³', '׳˜׳³', '׳™׳³', '׳™׳´׳', '׳™׳´׳‘'];

export const STAFF_AGES = ['׳’׳™׳ 13-18 (׳׳“"׳¦׳™׳)', '׳׳¢׳ ׳’׳™׳ 18', '׳”׳•׳¨׳™׳ ׳׳׳•׳•׳™׳', '׳׳—׳¨'];

// --- ׳”׳’׳“׳¨׳•׳× ׳׳—׳׳§׳•׳× ---
export const DEPARTMENTS_CONFIG: Record<string, { color: string; gender: 'male' | 'female' | 'mixed'; logo: string }> = {
  "׳‘׳× ׳׳׳": { 
      color: "border-[#E91E63] text-[#E91E63] bg-pink-50 hover:bg-pink-100", 
      gender: "female", 
      logo: "/logos/bat-melech.png" 
  },
  "׳‘׳ ׳•׳× ׳—׳‘\"׳“": { 
      color: "border-[#E91E63] text-[#E91E63] bg-pink-50 hover:bg-pink-100", 
      gender: "female", 
      logo: "/logos/bnos-chabad.png" 
  },
  "׳”׳₪׳ ׳¡׳׳™׳": { 
      color: "border-[#00BCD4] text-[#00BCD4] bg-cyan-50 hover:bg-cyan-100", 
      gender: "male", 
      logo: "/logos/hapanasim.png" 
  },
  "׳×׳׳™׳": { 
      color: "border-[#00BCD4] text-[#00BCD4] bg-cyan-50 hover:bg-cyan-100", 
      gender: "male", 
      logo: "/logos/temimim.png" 
  },
  "׳׳•׳¢׳“׳•׳ ׳™ ׳”׳׳¢׳©׳™׳ ׳”׳˜׳•׳‘׳™׳": { 
      color: "border-[#8BC34A] text-[#558B2F] bg-[#F1F8E9] hover:bg-[#DCEDC8]", 
      gender: "mixed", 
      logo: "/logos/clubs.png" 
  }
};

// --- ׳׳•׳’׳™׳§׳” ׳•׳”׳’׳“׳¨׳•׳× ׳¡׳•׳’׳™ ׳˜׳™׳•׳׳™׳ ---
export const TRIP_LOGIC: any = {
    "׳˜׳™׳•׳ ׳׳—׳•׳¥ ׳׳¡׳ ׳™׳£": { nameLabel: "׳©׳ ׳”׳˜׳™׳•׳", namePlaceholder: "׳׳“׳•׳’׳׳”: ׳˜׳™׳•׳ ׳׳¦׳₪׳•׳", timelineTitle: "׳₪׳™׳¨׳•׳˜ ׳”׳˜׳™׳•׳", staffLabel: "׳¦׳•׳•׳× ׳׳©׳×׳×׳£ ׳‘׳˜׳™׳•׳", minRows: 2 },
    "׳›׳ ׳¡/׳׳™׳¨׳•׳¢ ׳׳—׳•׳¥ ׳׳¡׳ ׳™׳£": { nameLabel: "׳©׳ ׳”׳₪׳¢׳™׳׳•׳×", namePlaceholder: "׳׳“׳•׳’׳׳”: ׳›׳ ׳¡ ׳¡׳™׳•׳ ׳©׳ ׳”", timelineTitle: "׳₪׳™׳¨׳•׳˜ ׳”׳׳™׳¨׳•׳¢", staffLabel: "׳¦׳•׳•׳× ׳׳©׳×׳×׳£ ׳‘׳₪׳¢׳™׳׳•׳×", minRows: 2 },
    "׳₪׳¢׳™׳׳•׳× ׳׳ ׳©׳’׳¨׳×׳™׳× ׳‘׳¡׳ ׳™׳£": { nameLabel: "׳©׳ ׳”׳₪׳¢׳™׳׳•׳×", namePlaceholder: '׳׳“׳•׳’׳׳”: ׳”׳×׳•׳•׳¢׳“׳•׳× ׳™׳•"׳“ ׳©׳‘׳˜', timelineTitle: "׳₪׳™׳¨׳•׳˜ ׳”׳₪׳¢׳™׳׳•׳×", staffLabel: "׳¦׳•׳•׳× ׳׳©׳×׳×׳£ ׳‘׳₪׳¢׳™׳׳•׳×", minRows: 1 },
    "׳™׳¦׳™׳׳” ׳¨׳’׳׳™׳× ׳‘׳׳–׳•׳¨ ׳”׳¡׳ ׳™׳£": { nameLabel: "׳©׳ ׳”׳₪׳¢׳™׳׳•׳×", namePlaceholder: "׳׳“׳•׳’׳׳”: ׳™׳¦׳™׳׳” ׳׳׳‘׳¦׳¢׳™׳", timelineTitle: "׳₪׳™׳¨׳•׳˜ ׳”׳₪׳¢׳™׳׳•׳×", staffLabel: "׳¦׳•׳•׳× ׳׳©׳×׳×׳£ ׳‘׳₪׳¢׳™׳׳•׳×", minRows: 2 },
    "׳׳—׳¨": { nameLabel: "׳©׳ ׳”׳₪׳¢׳™׳׳•׳×", namePlaceholder: '׳׳“׳•׳’׳׳”: ׳˜׳™׳¡׳” ׳׳¨׳‘׳™', timelineTitle: "׳₪׳™׳¨׳•׳˜ ׳”׳₪׳¢׳™׳׳•׳×", staffLabel: "׳¦׳•׳•׳× ׳׳©׳×׳×׳£ ׳‘׳₪׳¢׳™׳׳•׳×", minRows: 1 }
};

export const TRIP_TYPES_CONFIG = [
    { id: "׳˜׳™׳•׳ ׳׳—׳•׳¥ ׳׳¡׳ ׳™׳£", label: "׳˜׳™׳•׳ ׳׳—׳•׳¥ ׳׳¡׳ ׳™׳£", icon: Bus, bg: "bg-blue-100", text: "text-blue-700", border: "border-blue-200" },
    { id: "׳›׳ ׳¡/׳׳™׳¨׳•׳¢ ׳׳—׳•׳¥ ׳׳¡׳ ׳™׳£", label: "׳›׳ ׳¡/׳׳™׳¨׳•׳¢ ׳—׳•׳¥", icon: Ticket, bg: "bg-purple-100", text: "text-purple-700", border: "border-purple-200" },
    { id: "׳₪׳¢׳™׳׳•׳× ׳׳ ׳©׳’׳¨׳×׳™׳× ׳‘׳¡׳ ׳™׳£", label: "׳₪׳¢׳™׳׳•׳× ׳׳ ׳©׳’׳¨׳×׳™׳× ׳‘׳¡׳ ׳™׳£", icon: Home, bg: "bg-green-100", text: "text-green-700", border: "border-green-200" },
    { id: "׳™׳¦׳™׳׳” ׳¨׳’׳׳™׳× ׳‘׳׳–׳•׳¨ ׳”׳¡׳ ׳™׳£", label: "׳™׳¦׳™׳׳” ׳¨׳’׳׳™׳× ׳‘׳׳–׳•׳¨ ׳”׳¡׳ ׳™׳£", icon: Navigation, bg: "bg-orange-100", text: "text-orange-700", border: "border-orange-200" },
    { id: "׳׳—׳¨", label: "׳׳—׳¨...", icon: HelpCircle, bg: "bg-gray-100", text: "text-gray-700", border: "border-gray-200" }
];

// --- ׳§׳˜׳’׳•׳¨׳™׳•׳× ׳׳₪׳¢׳™׳׳•׳™׳•׳× ---
export const CATEGORIES: any = { 
  transport: { label: '׳”׳×׳ ׳™׳™׳“׳•׳×', icon: Bus, options: [{ label: '׳”׳׳™׳›׳” ׳‘׳™׳•׳', license: false }, { label: '׳”׳׳™׳›׳” ׳‘׳׳™׳׳”', license: false }, { label: '׳ ׳¡׳™׳¢׳” ׳׳׳•׳¨׳’׳ ׳×', license: false }, { label: '׳×׳—׳‘׳•׳¨׳” ׳¦׳™׳‘׳•׳¨׳™׳×', license: false }, { label: '׳¨׳›׳‘׳×', license: false }, { label: '׳¨׳›׳‘׳™׳ ׳₪׳¨׳˜׳™׳™׳', license: false }, { label: '׳׳•׳₪׳ ׳™׳™׳', license: true }, { label: '׳’׳³׳™׳₪׳™׳', license: true }, { label: '׳׳—׳¨', license: false }] }, 
  hiking: { label: '׳׳¡׳׳•׳ ׳‘׳˜׳‘׳¢', icon: Navigation, options: [{ label: '׳׳¡׳׳•׳ ׳™׳•׳', license: false }, { label: '׳׳¡׳׳•׳ ׳׳™׳׳”', license: false }, { label: '׳˜׳™׳•׳ ׳’׳³׳™׳₪׳™׳', license: true }, { label: '׳׳—׳¨', license: false }] }, 
  attraction: { label: '׳׳˜׳¨׳§׳¦׳™׳”', icon: Ticket, options: [{ label: '׳₪׳׳¨׳§ ׳׳™׳', license: true }, { label: '׳§׳™׳׳§׳™׳/׳¨׳₪׳˜׳™׳ ׳’', license: true }, { label: '׳©׳™׳™׳˜', license: true }, { label: '׳‘׳¨׳™׳›׳”', license: true }, { label: '׳’׳׳™׳©׳”/׳¡׳׳₪', license: true }, { label: '׳₪׳׳¨׳§ ׳—׳‘׳׳™׳', license: true }, { label: '׳§׳™׳¨ ׳˜׳™׳₪׳•׳¡', license: true }, { label: '׳˜׳¨׳§׳˜׳•׳¨׳•׳ ׳™׳', license: true }, { label: '׳₪׳™׳™׳ ׳˜׳‘׳•׳', license: true }, { label: '׳׳•׳ ׳” ׳₪׳׳¨׳§', license: true }, { label: '׳§׳׳¨׳˜׳™׳ ׳’', license: true }, { label: '׳׳×׳§׳ ׳™׳ ׳׳×׳ ׳₪׳—׳™׳', license: true }, { label: '׳׳™׳™ ׳’\'׳׳׳₪', license: true }, { label: '׳׳™׳™׳–׳¨ ׳˜׳׳’', license: true }, { label: '׳©׳™׳™׳˜ ׳˜׳•׳¨׳ ׳“׳•', license: true }, { label: '׳׳•׳–׳™׳׳•׳', license: false }, { label: '׳׳¨׳›׳– ׳׳‘׳§׳¨׳™׳', license: false }, { label: '׳׳×׳¨ ׳׳•׳¨׳©׳×', license: false }, { label: '׳§׳‘׳¨ ׳¦׳“׳™׳§', license: false }, { label: '׳׳—׳¨', license: false }] }, 
  food: { label: '׳׳•׳›׳', icon: Utensils, options: [{ label: '׳”׳›׳ ׳” ׳¢׳¦׳׳™׳×', license: false }, { label: '׳׳•׳›׳ ׳§׳ ׳•׳™', license: false }, { label: '׳׳׳¨׳–׳™׳ ׳¡׳’׳•׳¨׳™׳ ׳§׳ ׳•׳™׳™׳', license: false }, { label: '׳׳•׳›׳ ׳‘׳™׳×׳™ ׳׳‘׳•׳©׳', license: false }, { label: '׳§׳™׳™׳˜׳¨׳™׳ ׳’', license: false }, { label: '׳¢׳ ׳”׳׳©', license: false }, { label: '׳׳—׳¨', license: false }] }, 
  settlement: { label: '׳₪׳¢׳™׳׳•׳× ׳‘׳™׳™׳©׳•׳‘/׳׳‘׳ ׳”', icon: Home, options: [{ label: '׳₪׳¢׳™׳׳•׳× ׳‘׳¡׳ ׳™׳£', license: false }, { label: '׳׳™׳¨׳•׳¢ ׳‘׳׳•׳׳', license: false }, { label: '׳₪׳¢׳™׳׳•׳× ׳‘׳‘׳™׳× ׳›׳ ׳¡׳×', license: false }, { label: '׳₪׳¢׳™׳׳•׳× ׳‘׳‘׳™׳× ׳—׳‘׳´׳“', license: false }, { label: '׳₪׳¢׳™׳׳•׳× ׳‘׳׳×׳ ׳´׳¡', license: false }, { label: '׳₪׳¢׳™׳׳•׳× ׳‘׳‘׳™׳× ׳₪׳¨׳˜׳™', license: false }, { label: '׳₪׳¢׳™׳׳•׳× ׳‘׳©׳˜׳— ׳₪׳×׳•׳—', license: false }, { label: '׳₪׳¢׳™׳׳•׳× ׳‘׳©׳˜׳— ׳׳’׳•׳“׳¨ ׳×׳—׳× ׳›׳™׳₪׳× ׳”׳©׳׳™׳™׳', license: false }, { label: '׳₪׳׳¨׳§/׳’׳™׳ ׳”', license: false }, { label: '׳›׳ ׳¡', license: false }, { label: '׳׳—׳¨', license: false }] },
  sleeping: { label: '׳׳™׳ ׳”', icon: Tent, options: [{ label: '׳׳™׳ ׳× ׳׳‘׳ ׳”', license: false }, { label: '׳׳™׳ ׳× ׳©׳˜׳—', license: true }, { label: '׳׳—׳¨', license: false }] }, 
  other: { label: '׳׳—׳¨', icon: HelpCircle, options: [{ label: '׳₪׳¢׳™׳׳•׳× ׳›׳׳׳™׳×', license: false }, { label: '׳˜׳§׳¡ / ׳”׳×׳›׳ ׳¡׳•׳×', license: false }, { label: '׳–׳׳ ׳—׳•׳₪׳©׳™', license: false }, { label: '׳׳—׳¨', license: false }] } 
};

export const DEFAULT_STYLE = { icon: HelpCircle, label: '׳›׳׳׳™', pastelBg: 'bg-gray-100', darkText: 'text-gray-600', border: 'border-gray-200' };

export const CATEGORY_STYLES: any = { 
    transport: { icon: Bus, label: '׳”׳×׳ ׳™׳™׳“׳•׳×', pastelBg: 'bg-[#E3F2FD]', darkText: 'text-[#1565C0]', border: 'border-[#BBDEFB]' }, 
    hiking: { icon: Navigation, label: '׳׳¡׳׳•׳ ׳‘׳˜׳‘׳¢', pastelBg: 'bg-[#E8F5E9]', darkText: 'text-[#2E7D32]', border: 'border-[#C8E6C9]' }, 
    attraction: { icon: Ticket, label: '׳׳˜׳¨׳§׳¦׳™׳”', pastelBg: 'bg-[#FCE4EC]', darkText: 'text-[#C2185B]', border: 'border-[#F8BBD0]' }, 
    food: { icon: Utensils, label: '׳׳•׳›׳', pastelBg: 'bg-[#FFF3E0]', darkText: 'text-[#EF6C00]', border: 'border-[#FFE0B2]' }, 
    settlement: { icon: Home, label: '׳₪׳¢׳™׳׳•׳× ׳‘׳׳‘׳ ׳”', pastelBg: 'bg-[#E8EAF6]', darkText: 'text-[#283593]', border: 'border-[#C5CAE9]' }, 
    sleeping: { icon: Tent, label: '׳׳™׳ ׳”', pastelBg: 'bg-[#F3E5F5]', darkText: 'text-[#6A1B9A]', border: 'border-[#E1BEE7]' }, 
    other: DEFAULT_STYLE 
};

// ׳₪׳•׳ ׳§׳¦׳™׳™׳× ׳¢׳–׳¨ ׳׳”׳׳¨׳× ׳©׳׳•׳× ׳¦׳‘׳¢׳™׳ ׳׳§׳•׳“ Hex (׳¢׳‘׳•׳¨ ׳’׳¨׳₪׳™׳ ׳׳• ׳¢׳™׳¦׳•׳‘ ׳“׳™׳ ׳׳™)
export const getColorHex = (colorName: string) => {
    if (!colorName) return '#00BCD4';
    
    // ׳׳ ׳›׳‘׳¨ ׳§׳™׳‘׳׳ ׳• ׳§׳•׳“ ׳¦׳‘׳¢
    if (colorName.startsWith('#')) return colorName;

    const map: any = { 
        blue: '#00BCD4', 
        emerald: '#8BC34A', 
        pink: '#E91E63', 
        yellow: '#FFC107', 
        indigo: '#3F51B5', 
        purple: '#9C27B0', 
        gray: '#9E9E9E', 
        cyan: '#00BCD4', 
        green: '#8BC34A' 
    };
    return map[colorName] || '#00BCD4';
};


================================================================
FILE PATH: C:\Users\User\chabad-trips\lib\dateUtils.ts
================================================================
import { HDate, gematriya } from '@hebcal/core';

// ׳₪׳•׳ ׳§׳¦׳™׳™׳× ׳¢׳–׳¨ ׳׳”׳¡׳¨׳× ׳ ׳™׳§׳•׳“ (׳׳׳§׳¨׳” ׳©-Hebcal ׳׳—׳–׳™׳¨ ׳˜׳§׳¡׳˜ ׳׳ ׳•׳§׳“)
const stripNikud = (str: string) => {
    return str.replace(/[\u0591-\u05C7]/g, '');
};

export const formatHebrewDate = (dateString: string) => {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        const hDate = new HDate(date);
        // ׳׳ ׳§׳” ׳ ׳™׳§׳•׳“ ׳׳”׳×׳•׳¦׳׳”
        return stripNikud(hDate.renderGematriya());
    } catch (e) {
        console.error("Error formatting Hebrew date:", e);
        return '';
    }
};

export const formatHebrewDateRange = (startStr: string, endStr: string) => {
    if (!startStr) return '';
    const endDate = endStr ? endStr : startStr;

    try {
        const startH = new HDate(new Date(startStr));
        const endH = new HDate(new Date(endDate));

        // ׳׳ ׳–׳” ׳׳•׳×׳• ׳™׳•׳ ׳‘׳“׳™׳•׳§
        if (startH.isSameDate(endH)) {
            return stripNikud(startH.renderGematriya());
        }

        const startDay = gematriya(startH.getDate());
        const endDay = gematriya(endH.getDate());
        
        const startFull = stripNikud(startH.renderGematriya());
        const endFull = stripNikud(endH.renderGematriya());

        // ׳׳ ׳–׳” ׳׳•׳×׳• ׳—׳•׳“׳© ׳•׳׳•׳×׳” ׳©׳ ׳”: "׳—' ג€“ ׳˜' ׳׳“׳¨ ׳×׳©׳₪׳“"
        if (startH.getMonth() === endH.getMonth() && startH.getFullYear() === endH.getFullYear()) {
            // ׳—׳™׳×׳•׳ ׳©׳ ׳”׳—׳•׳“׳© ׳•׳”׳©׳ ׳” ׳׳×׳•׳ ׳”׳׳—׳¨׳•׳–׳× ׳”׳׳׳׳”
            const monthAndYear = startFull.substring(startFull.indexOf(' ') + 1);
            return `${startDay} ג€“ ${endDay} ${monthAndYear}`;
        }

        // ׳׳—׳¨׳×: "׳—' ׳©׳‘׳˜ ג€“ ׳’' ׳׳“׳¨ ׳×׳©׳₪׳“" (׳₪׳•׳¨׳׳˜ ׳׳׳)
        return `${startFull} ג€“ ${endFull}`;

    } catch (e) {
        return '';
    }
};

export const getMonthNameHebrew = (dateString: string) => {
     if (!dateString) return '';
    try {
        const date = new Date(dateString);
        const hDate = new HDate(date);
        const full = stripNikud(hDate.renderGematriya());
        const parts = full.split(' ');
        if (parts.length >= 2) {
            return parts[1]; // ׳”׳—׳׳§ ׳”׳©׳ ׳™ ׳”׳•׳ ׳‘׳“׳¨׳ ׳›׳׳ ׳”׳—׳•׳“׳© (׳׳׳©׳ "׳’' ׳׳“׳¨ ׳×׳©׳₪׳“")
        }
        return '';
    } catch (e) {
        return '';
    }
};

// --- ׳©׳׳¨ ׳”׳₪׳•׳ ׳§׳¦׳™׳•׳× ---

export const getHebrewDateString = (dateString: string) => formatHebrewDate(dateString);

export const toHebrewDay = (dateString: string) => {
    const full = formatHebrewDate(dateString);
    return full.split(' ').slice(0, 2).join(' '); // ׳׳—׳–׳™׳¨ ׳¨׳§ ׳™׳•׳ ׳•׳—׳•׳“׳© (׳׳׳ ׳©׳ ׳”)
};

export const getHebrewDateRange = (start: string, end: string) => formatHebrewDateRange(start, end);

export const formatDate = (dateString: string) => {
    if (!dateString) return '';
    const d = new Date(dateString);
    return `${d.getDate()}.${d.getMonth() + 1}.${d.getFullYear()}`;
};

export const getShortDate = (dateString: string) => {
    if (!dateString) return '';
    const d = new Date(dateString);
    return `${d.getDate()}/${d.getMonth() + 1}`;
};

export const getDayName = (dateString: string) => {
    if (!dateString) return '';
    const days = ['׳¨׳׳©׳•׳', '׳©׳ ׳™', '׳©׳׳™׳©׳™', '׳¨׳‘׳™׳¢׳™', '׳—׳׳™׳©׳™', '׳©׳™׳©׳™', '׳©׳‘׳×'];
    return days[new Date(dateString).getDay()];
};

export const calculateAge = (birthDate: string) => {
    if (!birthDate) return null;
    const today = new Date();
    const birth = new Date(birthDate);
    let age = today.getFullYear() - birth.getFullYear();
    const m = today.getMonth() - birth.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
        age--;
    }
    return age;
};

export const formatFullGregorianDate = (dateString: string) => {
    if (!dateString) return '';
    const d = new Date(dateString);
    return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
};

export const formatHebrewYear = (dateString: string) => {
     if (!dateString) return '';
    try {
        const date = new Date(dateString);
        const hDate = new HDate(date);
        return gematriya(hDate.getFullYear());
    } catch (e) {
        return '';
    }
};


================================================================
FILE PATH: C:\Users\User\chabad-trips\lib\schemas.ts
================================================================
import { z } from 'zod';

// --- ׳¢׳–׳¨׳™׳ ׳׳©׳™׳׳•׳© ׳—׳•׳–׳¨ (Re-usable validators) ---
const idValidator = z.string().regex(/^\d{9}$/, "׳×׳¢׳•׳“׳× ׳–׳”׳•׳× ׳—׳™׳™׳‘׳× ׳׳”׳›׳™׳ 9 ׳¡׳₪׳¨׳•׳× ׳‘׳“׳™׳•׳§");
const phoneValidator = z.string().min(9, "׳׳¡׳₪׳¨ ׳˜׳׳₪׳•׳ ׳׳ ׳×׳§׳™׳ (׳׳™׳ ׳™׳׳•׳ 9 ׳¡׳₪׳¨׳•׳×)");
const requiredString = (msg: string) => z.string().min(1, msg);

// ---------------------------------------------------------
// 1. ׳—׳•׳§׳™׳ ׳׳“׳£ ׳›׳ ׳™׳¡׳” ׳•׳”׳¨׳©׳׳” (Login / Register)
// ---------------------------------------------------------
export const loginSchema = z.object({
    idNumber: z.string().min(1, "׳—׳•׳‘׳” ׳׳”׳–׳™׳ ׳×׳¢׳•׳“׳× ׳–׳”׳•׳×"),
    password: z.string().min(1, "׳—׳•׳‘׳” ׳׳”׳–׳™׳ ׳¡׳™׳¡׳׳”"),
});

export const registerSchema = z.object({
    branch: z.string().optional(), // ׳׳•׳₪׳¦׳™׳•׳ ׳׳™ ׳›׳™ ׳׳ ׳¨׳׳•׳•׳ ׳˜׳™ ׳׳׳˜׳”
    fullName: requiredString("׳—׳•׳‘׳” ׳׳”׳–׳™׳ ׳©׳ ׳׳׳"),
    phone: phoneValidator,
    idNumber: idValidator,
    email: z.string().email("׳›׳×׳•׳‘׳× ׳׳™׳׳™׳™׳ ׳׳ ׳×׳§׳™׳ ׳”"),
    birthDate: requiredString("׳—׳•׳‘׳” ׳׳‘׳—׳•׳¨ ׳×׳׳¨׳™׳ ׳׳™׳“׳”"),
    password: z.string().min(6, "׳”׳¡׳™׳¡׳׳” ׳—׳™׳™׳‘׳× ׳׳”׳›׳™׳ ׳׳₪׳—׳•׳× 6 ׳×׳•׳•׳™׳"),
});

// ---------------------------------------------------------
// 2. ׳—׳•׳§׳™׳ ׳׳˜׳•׳₪׳¡ ׳™׳¦׳™׳¨׳× ׳§׳©׳¨ (Contact)
// ---------------------------------------------------------
export const contactSchema = z.object({
    subject: z.string().min(3, "׳”׳ ׳•׳©׳ ׳—׳™׳™׳‘ ׳׳”׳›׳™׳ ׳׳₪׳—׳•׳× 3 ׳×׳•׳•׳™׳"),
    message: z.string().min(10, "׳×׳•׳›׳ ׳”׳”׳•׳“׳¢׳” ׳—׳™׳™׳‘ ׳׳”׳›׳™׳ ׳׳₪׳—׳•׳× 10 ׳×׳•׳•׳™׳"),
});

// ---------------------------------------------------------
// 3. ׳—׳•׳§׳™׳ ׳׳₪׳¨׳•׳₪׳™׳ ׳׳™׳©׳™ (Profile)
// ---------------------------------------------------------
export const profileSchema = z.object({
    officialName: z.string().min(2, "׳©׳ ׳₪׳¨׳˜׳™ ׳—׳™׳™׳‘ ׳׳”׳›׳™׳ ׳׳₪׳—׳•׳× 2 ׳×׳•׳•׳™׳"),
    lastName: z.string().min(2, "׳©׳ ׳׳©׳₪׳—׳” ׳—׳™׳™׳‘ ׳׳”׳›׳™׳ ׳׳₪׳—׳•׳× 2 ׳×׳•׳•׳™׳"),
    idNumber: idValidator,
    phone: phoneValidator,
    email: z.string().email("׳›׳×׳•׳‘׳× ׳׳™׳׳™׳™׳ ׳׳ ׳×׳§׳™׳ ׳”"),
    birthDate: requiredString("׳—׳•׳‘׳” ׳׳”׳–׳™׳ ׳×׳׳¨׳™׳ ׳׳™׳“׳”"),
    // ׳©׳“׳•׳× ׳׳•׳₪׳¦׳™׳•׳ ׳׳™׳™׳
    nickname: z.string().optional(),
    fullNameAndMother: z.string().optional(),
    branchAddress: z.string().optional(),
    startYear: z.any().optional(), // ׳׳§׳‘׳ ׳׳¡׳₪׳¨ ׳׳• ׳׳—׳¨׳•׳–׳×
    studentCount: z.any().optional(),
    staffCount: z.any().optional(),
    additionalStaff: z.string().optional(),
});

// ---------------------------------------------------------
// 4. ׳—׳•׳§׳™׳ ׳׳˜׳™׳•׳ ׳—׳“׳© - ׳₪׳¨׳˜׳™׳ ׳›׳׳׳™׳™׳ (New Trip - General)
// ---------------------------------------------------------
export const tripGeneralSchema = z.object({
    name: z.string().min(3, "׳©׳ ׳”׳˜׳™׳•׳ ׳—׳™׳™׳‘ ׳׳”׳›׳™׳ ׳׳₪׳—׳•׳× 3 ׳×׳•׳•׳™׳"),
    tripType: z.string().min(1, "׳—׳•׳‘׳” ׳׳‘׳—׳•׳¨ ׳¡׳•׳’ ׳₪׳¢׳™׳׳•׳×"),
    
    // ׳×׳׳¨׳™׳›׳™׳
    startDate: requiredString("׳—׳•׳‘׳” ׳׳‘׳—׳•׳¨ ׳×׳׳¨׳™׳ ׳”׳×׳—׳׳”"),
    endDate: requiredString("׳—׳•׳‘׳” ׳׳‘׳—׳•׳¨ ׳×׳׳¨׳™׳ ׳¡׳™׳•׳"),
    startTime: z.string().optional(),
    endTime: z.string().optional(),
    
    // ׳›׳׳•׳™׳•׳× (coerce ׳”׳•׳₪׳ ׳׳—׳¨׳•׳–׳× ׳׳׳¡׳₪׳¨ ׳׳•׳˜׳•׳׳˜׳™׳×)
    chanichimCount: z.coerce.number().min(1, "׳›׳׳•׳× ׳—׳ ׳™׳›׳™׳ ׳—׳™׳™׳‘׳× ׳׳”׳™׳•׳× ׳׳₪׳—׳•׳× 1"),
    totalTravelers: z.coerce.number().min(1, "׳›׳׳•׳× ׳׳©׳×׳×׳₪׳™׳ ׳—׳™׳™׳‘׳× ׳׳”׳™׳•׳× ׳׳₪׳—׳•׳× 1"),
    
    // ׳©׳“׳•׳× ׳—׳•׳‘׳” ׳ ׳•׳¡׳₪׳™׳
    gradeFrom: z.string().min(1, "׳—׳•׳‘׳” ׳׳‘׳—׳•׳¨ ׳©׳›׳‘׳× ׳’׳™׳"),
    gradeTo: z.string().min(1, "׳—׳•׳‘׳” ׳׳‘׳—׳•׳¨ ׳©׳›׳‘׳× ׳’׳™׳"),
    
    // ׳₪׳¨׳˜׳™ ׳׳—׳¨׳׳™ (׳ ׳‘׳“׳§׳™׳ ׳׳•׳•׳“׳ ׳©׳׳ ׳ ׳׳—׳§׳•)
    coordName: z.string().min(2, "׳—׳¡׳¨ ׳©׳ ׳׳—׳¨׳׳™ ׳˜׳™׳•׳"),
    coordId: z.string().min(8, "׳—׳¡׳¨׳” ׳×.׳–. ׳©׳ ׳׳—׳¨׳׳™ ׳˜׳™׳•׳"),
    
    // ׳׳•׳₪׳¦׳™׳•׳ ׳׳™
    staffOther: z.string().optional(),
    generalComments: z.string().optional(),
}).refine((data) => new Date(data.endDate) >= new Date(data.startDate), {
    message: "׳×׳׳¨׳™׳ ׳¡׳™׳•׳ ׳׳ ׳™׳›׳•׳ ׳׳”׳™׳•׳× ׳׳₪׳ ׳™ ׳×׳׳¨׳™׳ ׳”׳×׳—׳׳”",
    path: ["endDate"], // ׳׳™׳₪׳” ׳׳”׳¦׳™׳’ ׳׳× ׳”׳©׳’׳™׳׳”
}).refine((data) => data.totalTravelers >= data.chanichimCount, {
    message: '׳¡׳”"׳› ׳׳©׳×׳×׳₪׳™׳ ׳—׳™׳™׳‘ ׳׳”׳™׳•׳× ׳’׳“׳•׳ ׳׳• ׳©׳•׳•׳” ׳׳›׳׳•׳× ׳”׳—׳ ׳™׳›׳™׳',
    path: ["totalTravelers"],
});

// ---------------------------------------------------------
// 5. ׳—׳•׳§׳™׳ ׳׳”׳•׳¡׳₪׳× ׳©׳•׳¨׳” ׳‘׳׳•"׳– (Timeline Line)
// ---------------------------------------------------------
export const tripLineSchema = z.object({
    date: requiredString("׳—׳•׳‘׳” ׳׳‘׳—׳•׳¨ ׳×׳׳¨׳™׳ ׳׳₪׳¢׳™׳׳•׳×"),
    category: requiredString("׳—׳•׳‘׳” ׳׳‘׳—׳•׳¨ ׳§׳˜׳’׳•׳¨׳™׳”"),
    subCategory: requiredString("׳—׳•׳‘׳” ׳׳‘׳—׳•׳¨ ׳¡׳•׳’ ׳₪׳¢׳™׳׳•׳×"),
    locationValue: requiredString("׳—׳•׳‘׳” ׳׳”׳–׳™׳ ׳׳™׳§׳•׳"),
    // ׳•׳׳™׳“׳¦׳™׳” ׳׳•׳×׳ ׳™׳×: ׳׳ ׳‘׳—׳¨ '׳׳—׳¨' ׳׳• '׳׳™׳ ׳× ׳׳‘׳ ׳”', ׳—׳™׳™׳‘ ׳׳₪׳¨׳˜
    otherDetail: z.string().optional(),
}).refine((data) => {
    if (data.subCategory === '׳׳—׳¨' || data.subCategory === '׳׳™׳ ׳× ׳׳‘׳ ׳”') {
        return data.otherDetail && data.otherDetail.length > 2;
    }
    return true;
}, {
    message: "׳—׳•׳‘׳” ׳׳₪׳¨׳˜ ׳‘׳©׳“׳” ׳–׳” (׳׳™׳ ׳™׳׳•׳ 2 ׳×׳•׳•׳™׳)",
    path: ["otherDetail"],
});

// ---------------------------------------------------------
// 6. ׳—׳•׳§׳™׳ ׳׳”׳•׳¡׳₪׳× ׳׳™׳© ׳¦׳•׳•׳× ׳ ׳•׳¡׳£ (Secondary Staff)
// ---------------------------------------------------------
export const staffSchema = z.object({
    name: z.string().min(2, "׳©׳ ׳׳׳ ׳—׳™׳™׳‘ ׳׳”׳›׳™׳ ׳׳₪׳—׳•׳× 2 ׳×׳•׳•׳™׳"),
    role: z.string().min(2, "׳—׳•׳‘׳” ׳׳”׳’׳“׳™׳¨ ׳×׳₪׳§׳™׳“"),
    idNumber: idValidator,
    phone: phoneValidator,
    email: z.string().email("׳›׳×׳•׳‘׳× ׳׳™׳׳™׳™׳ ׳׳ ׳×׳§׳™׳ ׳”"),
});

// ---------------------------------------------------------
// 7. ׳—׳•׳§׳™׳ ׳׳‘׳™׳˜׳•׳ ׳˜׳™׳•׳ (Cancellation)
// ---------------------------------------------------------
export const cancellationSchema = z.object({
    reason: z.string().min(5, "׳—׳•׳‘׳” ׳׳₪׳¨׳˜ ׳׳× ׳¡׳™׳‘׳× ׳”׳‘׳™׳˜׳•׳ (׳׳₪׳—׳•׳× 5 ׳×׳•׳•׳™׳)"),
});

// ---------------------------------------------------------
// 8. ׳—׳•׳§׳™׳ ׳׳׳¢׳ ׳” ׳׳ ׳”׳ (Manager Reply)
// ---------------------------------------------------------
export const managerReplySchema = z.object({
    replyText: z.string().min(2, "׳×׳•׳›׳ ׳”׳×׳©׳•׳‘׳” ׳—׳™׳™׳‘ ׳׳”׳›׳™׳ ׳׳₪׳—׳•׳× 2 ׳×׳•׳•׳™׳"),
});


================================================================
FILE PATH: C:\Users\User\chabad-trips\lib\supabaseClient.ts
================================================================
import { createBrowserClient } from '@supabase/ssr';

// 1. ׳§׳¨׳™׳׳” ׳׳׳©׳×׳ ׳™ ׳”׳¡׳‘׳™׳‘׳”
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

// ׳‘׳“׳™׳§׳× ׳‘׳˜׳™׳—׳•׳× (׳”׳©׳׳¨׳×׳™ ׳׳× ׳–׳” ׳›׳™ ׳–׳” ׳¨׳¢׳™׳•׳ ׳˜׳•׳‘)
if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error('Missing Supabase Environment Variables!');
}

// 2. ׳™׳¦׳™׳¨׳× ׳”׳§׳׳™׳™׳ ׳˜ ׳”׳—׳“׳© - ׳©׳™׳ ׳׳‘ ׳׳©׳™׳ ׳•׳™ ׳›׳׳!
// ׳׳ ׳—׳ ׳• ׳׳©׳×׳׳©׳™׳ ׳‘-createBrowserClient ׳‘׳׳§׳•׳ createClient ׳”׳¨׳’׳™׳
export const supabase = createBrowserClient(supabaseUrl, supabaseAnonKey);

// 3. ׳₪׳•׳ ׳§׳¦׳™׳™׳× ׳”׳¢׳–׳¨ (׳©׳׳¨׳ ׳• ׳׳•׳×׳” ׳›׳“׳™ ׳׳ ׳׳©׳‘׳•׳¨ ׳§׳‘׳¦׳™׳ ׳׳—׳¨׳™׳ ׳©׳׳©׳×׳׳©׳™׳ ׳‘׳”)
export const getIdAsEmail = (idNumber: string) => {
  return `${idNumber}@noar.chabad.co.il`;
};


================================================================
FILE PATH: C:\Users\User\chabad-trips\hooks\useUser.ts
================================================================
"use client";

import { useState, useEffect, useCallback } from 'react';
import { supabase } from '@/lib/supabaseClient';
import { useRouter } from 'next/navigation';

export const useUser = (redirectTo: string | null = null) => {
    const router = useRouter();
    const [user, setUser] = useState<any>(null);
    const [profile, setProfile] = useState<any>(null);
    const [loading, setLoading] = useState(true);

    const fetchUserData = useCallback(async () => {
        try {
            setLoading(true);
            
            // 1. ׳©׳׳™׳₪׳× ׳”׳׳©׳×׳׳© ׳”׳׳—׳•׳‘׳¨
            const { data: { user: authUser }, error: authError } = await supabase.auth.getUser();
            
            if (authError || !authUser) {
                if (redirectTo) {
                    router.push(redirectTo);
                }
                setLoading(false);
                return;
            }

            setUser(authUser);

            // 2. ׳©׳׳™׳₪׳× ׳”׳₪׳¨׳•׳₪׳™׳ ׳׳”׳“׳׳˜׳”׳‘׳™׳™׳¡
            const { data: profileData, error: profileError } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', authUser.id)
                .single();

            if (!profileError && profileData) {
                setProfile(profileData);
            }

        } catch (error) {
            console.error('Error in useUser:', error);
        } finally {
            setLoading(false);
        }
    }, [redirectTo, router]);

    useEffect(() => {
        fetchUserData();
    }, [fetchUserData]);

    return { 
        user,      // ׳ ׳×׳•׳ ׳™ ׳׳™׳׳•׳× (Email, Metadata)
        profile,   // ׳ ׳×׳•׳ ׳™׳ ׳׳”׳˜׳‘׳׳” (׳©׳ ׳¨׳©׳׳™, ׳×"׳–, ׳˜׳׳₪׳•׳)
        loading,   // ׳”׳׳ ׳¢׳“׳™׳™׳ ׳˜׳•׳¢׳?
        refresh: fetchUserData // ׳₪׳•׳ ׳§׳¦׳™׳” ׳׳¨׳¢׳ ׳•׳ ׳”׳ ׳×׳•׳ ׳™׳ ׳™׳“׳ ׳™׳×
    };
};
