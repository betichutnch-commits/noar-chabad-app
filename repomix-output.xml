This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
app/dashboard/contact/page.tsx
app/dashboard/inbox/page.tsx
app/dashboard/layout.tsx
app/dashboard/my-trips/page.tsx
app/dashboard/new-trip/page.tsx
app/dashboard/page.tsx
app/dashboard/profile/page.tsx
app/dashboard/trip/[id]/page.tsx
app/globals.css
app/icon.png
app/layout.tsx
app/manager/approvals/[id]/page.tsx
app/manager/approvals/page.tsx
app/manager/inbox/page.tsx
app/manager/layout.tsx
app/manager/page.tsx
app/manager/profile/page.tsx
app/manager/trip/[id]/page.tsx
app/manager/users/page.tsx
app/manifest.json
app/page.tsx
components/layout/Header.tsx
components/layout/ManagerHeader.tsx
components/layout/ManagerSidebar.tsx
components/layout/Sidebar.tsx
components/ui/Button.tsx
components/ui/Input.tsx
eslint.config.mjs
lib/supabaseClient.ts
middleware.ts
next.config.ts
package.json
postcss.config.mjs
PROJECT_INSTRUCTIONS.md
public/file.svg
public/globe.svg
public/logo.png
public/logos/bat-melech.png
public/logos/bnos-chabad.png
public/logos/clubs.png
public/logos/hapanasim.png
public/logos/temimim.png
public/next.svg
public/vercel.svg
public/window.svg
README.md
tailwind.config.ts
tsconfig.json
utils/supabase/client.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="app/dashboard/contact/page.tsx">
"use client"

import React, { useState } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { Header } from '@/components/layout/Header'
import { Button } from '@/components/ui/Button'
import { Input } from '@/components/ui/Input'
import { Send, CheckCircle, HelpCircle, Image as ImageIcon, X, AlertTriangle, Info } from 'lucide-react'

export default function ContactPage() {
  const [loading, setLoading] = useState(false);
  const [success, setSuccess] = useState(false);
  
  // סוג הפנייה: 'general' או 'bug'
  const [type, setType] = useState<'general' | 'bug'>('general');
  const [screenshot, setScreenshot] = useState<File | null>(null);
  const [previewUrl, setPreviewUrl] = useState<string | null>(null);

  const [formData, setFormData] = useState({ subject: '', message: '' });

  // טיפול בהדבקת תמונה (CTRL+V) - עובד בעיקר במחשב
  const handlePaste = (e: React.ClipboardEvent) => {
    const items = e.clipboardData.items;
    for (let i = 0; i < items.length; i++) {
      if (items[i].type.indexOf('image') !== -1) {
        const blob = items[i].getAsFile();
        if (blob) {
            setScreenshot(blob);
            setPreviewUrl(URL.createObjectURL(blob));
        }
      }
    }
  };

  // טיפול בבחירת קובץ ידנית (חשוב למובייל)
  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
      if (e.target.files && e.target.files[0]) {
          const file = e.target.files[0];
          setScreenshot(file);
          setPreviewUrl(URL.createObjectURL(file));
      }
  };

  const removeImage = () => {
      setScreenshot(null);
      setPreviewUrl(null);
  };

  const handleSubmit = async () => {
    if (!formData.subject || !formData.message) return alert('נא למלא נושא ותוכן. אם זו תקלה, אנא פרט מה ניסית לעשות.');
    setLoading(true);

    const { data: { user } } = await supabase.auth.getUser();
    let imageUrl = null;

    // 1. העלאת צילום מסך אם יש
    if (screenshot && user) {
        const fileName = `bugs/${user.id}_${Date.now()}.png`;
        const { error: uploadError } = await supabase.storage.from('trip-files').upload(fileName, screenshot);
        if (!uploadError) {
            const { data } = supabase.storage.from('trip-files').getPublicUrl(fileName);
            imageUrl = data.publicUrl;
        }
    }
    
    // 2. בניית תוכן ההודעה הסופי
    const finalMessage = imageUrl 
        ? `${formData.message}\n\n[צורף צילום מסך]: ${imageUrl}`
        : formData.message;

    // 3. שמירה בדאטהבייס
    const { error } = await supabase.from('contact_messages').insert([{
        user_id: user?.id,
        subject: `[${type === 'bug' ? 'תקלה' : 'פנייה'}] ${formData.subject}`,
        message: finalMessage,
        status: 'new'
    }]);

    setLoading(false);

    if (error) {
        alert('שגיאה בשליחה: ' + error.message);
    } else {
        setSuccess(true);
        setFormData({ subject: '', message: '' });
        removeImage();
        setTimeout(() => setSuccess(false), 3000);
    }
  };

  return (
    <>
      <Header title="צור קשר / דיווח על תקלה" />

      <div className="max-w-3xl mx-auto p-4 md:p-8 animate-fadeIn pb-32">
         <div className="bg-white rounded-[32px] border border-gray-200 p-6 md:p-8 shadow-sm text-center md:text-right">
             
             {/* בחירת סוג פנייה */}
             <div className="flex flex-col sm:flex-row gap-4 mb-6">
                 <button 
                    onClick={() => setType('general')}
                    className={`flex-1 py-4 rounded-2xl border-2 flex flex-col items-center gap-2 transition-all font-bold
                    ${type === 'general' ? 'border-[#00BCD4] bg-cyan-50 text-[#00BCD4]' : 'border-gray-100 text-gray-400 hover:bg-gray-50'}`}
                 >
                     <HelpCircle size={28}/>
                     שאלה כללית
                 </button>
                 <button 
                    onClick={() => setType('bug')}
                    className={`flex-1 py-4 rounded-2xl border-2 flex flex-col items-center gap-2 transition-all font-bold
                    ${type === 'bug' ? 'border-[#E91E63] bg-pink-50 text-[#E91E63]' : 'border-gray-100 text-gray-400 hover:bg-gray-50'}`}
                 >
                     <AlertTriangle size={28}/>
                     דיווח על תקלה
                 </button>
             </div>

             <div className="space-y-6">
                 
                 {/* תיבת הסבר מיוחדת לדיווח על תקלה */}
                 {type === 'bug' && (
                    <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-4 flex items-start gap-3 animate-fadeIn text-right">
                        <Info size={22} className="text-yellow-600 shrink-0 mt-0.5"/>
                        <div>
                            <p className="text-sm font-bold text-yellow-800 mb-1">איך מדווחים על תקלה ביעילות?</p>
                            <ul className="text-xs text-yellow-700 list-disc list-inside leading-relaxed space-y-1">
                                <li>חובה לצרף <b>צילום מסך</b> של הבעיה (ניתן להעלות קובץ או להדביק).</li>
                                <li>חובה להוסיף <b>הסבר מילולי</b>: מה ניסיתם לעשות? ומה קרה בפועל?</li>
                            </ul>
                        </div>
                    </div>
                 )}

                 <Input 
                    label="נושא" 
                    placeholder={type === 'bug' ? "בקצרה: מה הבעיה?" : "בנושא..."}
                    value={formData.subject}
                    onChange={e => setFormData({...formData, subject: e.target.value})}
                 />

                 <div>
                     <label className="text-xs font-bold text-gray-500 mb-1.5 mr-1 block text-right">
                        {type === 'bug' ? 'תיאור התקלה והדבקת צילום מסך' : 'תוכן ההודעה'}
                     </label>
                     <div className="relative">
                        <textarea 
                            className="w-full p-4 rounded-xl border border-gray-200 outline-none focus:border-[#00BCD4] min-h-[150px] resize-none text-base md:text-sm font-medium bg-gray-50 focus:bg-white transition-all text-right"
                            placeholder={type === 'bug' ? "אנא פרטו כאן את השלבים שגרמו לתקלה...\n\n(ניתן להדביק כאן צילום מסך או לבחור קובץ)" : "תוכן הפנייה..."}
                            value={formData.message}
                            onChange={e => setFormData({...formData, message: e.target.value})}
                            onPaste={handlePaste}
                        ></textarea>
                        
                        {/* כפתור העלאה ידני - מוגדל למובייל */}
                        <label className="absolute bottom-3 left-3 text-gray-400 hover:text-[#00BCD4] cursor-pointer p-3 bg-white rounded-lg shadow-sm border border-gray-200 transition-all active:scale-95" title="צרף קובץ תמונה">
                            <ImageIcon size={22}/>
                            <input type="file" accept="image/*" className="hidden" onChange={handleFileChange}/>
                        </label>
                     </div>
                 </div>

                 {/* תצוגה מקדימה של צילום מסך */}
                 {previewUrl && (
                     <div className="bg-gray-50 p-3 rounded-xl border border-gray-200 relative w-fit animate-fadeIn mx-auto md:mx-0">
                         <p className="text-xs font-bold text-gray-500 mb-2 flex items-center gap-1 justify-center md:justify-start"><ImageIcon size={12}/> צילום מסך מצורף:</p>
                         <img src={previewUrl} alt="Screenshot" className="max-h-48 rounded-lg border border-gray-200 shadow-sm"/>
                         <button onClick={removeImage} className="absolute -top-2 -left-2 bg-white text-red-500 rounded-full p-2 shadow-md hover:bg-red-50 border border-gray-200 transition-all active:scale-95">
                             <X size={16}/>
                         </button>
                     </div>
                 )}

                 <div className="pt-4 flex flex-col-reverse md:flex-row items-center justify-end gap-4 border-t border-gray-100">
                     {success && (
                         <span className="text-[#8BC34A] font-bold text-sm flex items-center gap-2 animate-fadeIn bg-green-50 px-4 py-2 rounded-xl w-full md:w-auto justify-center">
                             <CheckCircle size={18}/> נשלח בהצלחה!
                         </span>
                     )}
                     <Button 
                        onClick={handleSubmit} 
                        isLoading={loading}
                        className={`w-full md:w-auto px-12 shadow-lg h-12 md:h-10 text-base md:text-sm ${type === 'bug' ? 'bg-[#E91E63] hover:bg-pink-600 shadow-pink-100' : 'bg-[#00BCD4] hover:bg-cyan-600 shadow-cyan-100'}`}
                        icon={<Send size={18}/>}
                     >
                         שליחה
                     </Button>
                 </div>
             </div>
         </div>
      </div>
    </>
  )
}
</file>

<file path="app/dashboard/inbox/page.tsx">
"use client"

import React, { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { Header } from '@/components/layout/Header'
import { 
  Bell, CheckCircle, AlertTriangle, Info, X, Clock, MailOpen, Trash2, Send, 
  ChevronDown, ChevronUp, Loader2, MessageCircle, HelpCircle, Wrench
} from 'lucide-react'

// --- פונקציות עזר ---

const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('he-IL', {
        day: 'numeric', month: 'numeric', year: '2-digit', hour: '2-digit', minute: '2-digit'
    });
};

const parseMessageSubject = (originalSubject: string) => {
    let type = 'general';
    let cleanSubject = originalSubject || '';

    if (cleanSubject.includes('תקלה')) {
        type = 'bug';
        cleanSubject = cleanSubject.replace(/\[\s*תקלה\s*\]/g, '').trim();
    } else if (cleanSubject.includes('פניה') || cleanSubject.includes('פנייה')) {
        type = 'general';
        cleanSubject = cleanSubject.replace(/\[\s*פניה\s*\]/g, '').replace(/\[\s*פנייה\s*\]/g, '').trim();
    }

    cleanSubject = cleanSubject.replace(/^[:\-\s]+/, '');
    return { type, cleanSubject };
};

export default function InboxPage() {
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState<'incoming' | 'outgoing'>('incoming');
  const [expandedId, setExpandedId] = useState<string | null>(null);
  
  const [notifications, setNotifications] = useState<any[]>([]); 
  const [sentMessages, setSentMessages] = useState<any[]>([]);

  const fetchData = async () => {
    setLoading(true);
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    const { data: incomingData } = await supabase
      .from('notifications')
      .select('*')
      .eq('user_id', user.id)
      .order('created_at', { ascending: false });
    setNotifications(incomingData || []);

    const { data: outgoingData } = await supabase
      .from('contact_messages')
      .select('*')
      .eq('user_id', user.id)
      .order('created_at', { ascending: false });
    setSentMessages(outgoingData || []);
    setLoading(false);
  };

  useEffect(() => {
    fetchData();
  }, []);

  const markAsRead = async (id: string) => {
      setNotifications(prev => prev.map(n => n.id === id ? { ...n, is_read: true } : n));
      await supabase.from('notifications').update({ is_read: true }).eq('id', id);
  };

  const deleteNotification = async (id: string, e: React.MouseEvent) => {
      e.stopPropagation();
      if(!confirm('למחוק את ההודעה?')) return;
      setNotifications(prev => prev.filter(n => n.id !== id));
      await supabase.from('notifications').delete().eq('id', id);
  };

  const toggleExpand = (id: string, isRead: boolean = true) => {
      if (expandedId === id) {
          setExpandedId(null);
      } else {
          setExpandedId(id);
          if (activeTab === 'incoming' && !isRead) {
              markAsRead(id);
          }
      }
  };

  const getIcon = (type: string) => {
      switch (type) {
          case 'success': return <CheckCircle size={20} className="text-green-500" />;
          case 'warning': return <AlertTriangle size={20} className="text-orange-500" />;
          case 'error': return <X size={20} className="text-red-500" />;
          default: return <Info size={20} className="text-[#00BCD4]" />;
      }
  };

  const getStatusBadge = (status: string) => {
      const styles: any = {
          new: "bg-blue-50 text-blue-600 border-blue-200",
          in_progress: "bg-orange-50 text-orange-600 border-orange-200",
          closed: "bg-green-50 text-green-600 border-green-200"
      };
      const labels: any = { new: 'נשלח', in_progress: 'בטיפול', closed: 'טופל' };
      return (
          <span className={`px-2 py-0.5 rounded text-xs font-bold border ${styles[status] || styles.new}`}>
              {labels[status] || 'נשלח'}
          </span>
      );
  };

  return (
    <>
      <Header title="הודעות ועדכונים" />

      <div className="max-w-5xl mx-auto p-4 md:p-8 animate-fadeIn pb-32">
        
        <div className="flex bg-gray-100 p-1.5 rounded-2xl w-full md:w-fit mb-6 mx-auto md:mx-0">
            <button 
                onClick={() => { setActiveTab('incoming'); setExpandedId(null); }}
                className={`flex-1 md:flex-none px-6 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2
                ${activeTab === 'incoming' ? 'bg-white text-[#00BCD4] shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
            >
                <Bell size={16}/>
                דואר נכנס
                {notifications.filter(n => !n.is_read).length > 0 && (
                    <span className="bg-[#E91E63] text-white text-[10px] px-1.5 rounded-full min-w-[18px] h-[18px] flex items-center justify-center">
                        {notifications.filter(n => !n.is_read).length}
                    </span>
                )}
            </button>
            <button 
                onClick={() => { setActiveTab('outgoing'); setExpandedId(null); }}
                className={`flex-1 md:flex-none px-6 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2
                ${activeTab === 'outgoing' ? 'bg-white text-[#00BCD4] shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
            >
                <Send size={16}/>
                פניות ששלחתי
            </button>
        </div>

        <div className="bg-white rounded-[24px] shadow-sm border border-gray-200 overflow-hidden min-h-[400px]">
            
            {loading && (
                <div className="h-full flex items-center justify-center py-20">
                    <Loader2 className="animate-spin text-[#00BCD4]" size={40}/>
                </div>
            )}

            {!loading && activeTab === 'incoming' && (
                notifications.length === 0 ? (
                    <div className="flex flex-col items-center justify-center py-20 text-gray-400">
                        <MailOpen size={48} className="opacity-20 mb-4"/>
                        <p className="font-bold text-lg">אין הודעות חדשות</p>
                    </div>
                ) : (
                    <div className="divide-y divide-gray-100">
                        {notifications.map((note) => {
                            const isExpanded = expandedId === note.id;
                            return (
                                <div key={note.id} className={`transition-all hover:bg-gray-50 ${isExpanded ? 'bg-gray-50' : 'bg-white'}`}>
                                    <div 
                                        onClick={() => toggleExpand(note.id, note.is_read)}
                                        className={`p-4 flex items-center gap-4 cursor-pointer ${!note.is_read ? 'bg-cyan-50/30' : ''}`}
                                    >
                                        <div className="shrink-0">{getIcon(note.type)}</div>
                                        <div className="flex-1 min-w-0 grid grid-cols-1 md:grid-cols-12 gap-2 md:gap-4 items-center">
                                            <div className={`md:col-span-8 text-sm truncate ${!note.is_read ? 'text-gray-900 font-bold' : 'text-gray-600'}`}>
                                                {note.title}
                                            </div>
                                            <div className="md:col-span-4 text-xs text-gray-400 flex items-center justify-end gap-2">
                                                <span>{formatDate(note.created_at)}</span>
                                                {isExpanded ? <ChevronUp size={16}/> : <ChevronDown size={16}/>}
                                            </div>
                                        </div>
                                    </div>
                                    {isExpanded && (
                                        <div className="px-4 pb-6 pt-2 pl-12 border-t border-gray-100 animate-fadeIn">
                                            <p className="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">{note.message}</p>
                                            <div className="mt-4 flex items-center gap-3">
                                                {note.link && (
                                                    <a href={note.link} className="text-xs font-bold text-white bg-[#00BCD4] px-4 py-2 rounded-lg hover:bg-cyan-600 transition-colors">לפרטים נוספים</a>
                                                )}
                                                <button onClick={(e) => deleteNotification(note.id, e)} className="text-xs font-bold text-red-500 hover:bg-red-50 px-3 py-2 rounded-lg transition-colors flex items-center gap-1">
                                                    <Trash2 size={14}/> מחק הודעה
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                )
            )}

            {!loading && activeTab === 'outgoing' && (
                sentMessages.length === 0 ? (
                    <div className="flex flex-col items-center justify-center py-20 text-gray-400">
                        <Send size={48} className="opacity-20 mb-4"/>
                        <p className="font-bold text-lg">לא נשלחו פניות עדיין</p>
                    </div>
                ) : (
                    <div className="divide-y divide-gray-100">
                        {sentMessages.map((msg) => {
                            const isExpanded = expandedId === msg.id;
                            const { type, cleanSubject } = parseMessageSubject(msg.subject);
                            const isBug = type === 'bug';

                            return (
                                <div key={msg.id} className={`transition-all hover:bg-gray-50 relative overflow-hidden ${isExpanded ? 'bg-gray-50' : 'bg-white'}`}>
                                    
                                    {/* סרט בפינה הימנית (מוחזר לימין) */}
                                    <div className={`absolute top-0 right-0 px-3 py-1 rounded-bl-xl text-[10px] font-bold text-white flex items-center gap-1.5 shadow-sm z-10
                                        ${isBug ? 'bg-[#E91E63]' : 'bg-[#00BCD4]'}`}
                                    >
                                        {isBug ? <Wrench size={12}/> : <HelpCircle size={12}/>}
                                        {isBug ? 'דיווח תקלה' : 'פנייה כללית'}
                                    </div>

                                    {/* שורה סגורה - items-start כדי לשלוט בגובה */}
                                    <div 
                                        onClick={() => toggleExpand(msg.id)}
                                        className="p-4 flex items-start gap-3 cursor-pointer"
                                    >
                                        {/* סטטוס - מונמך (mt-6) כדי לא להתנגש עם הסרט */}
                                        <div className="shrink-0 w-16 mt-6">
                                            {getStatusBadge(msg.status)}
                                        </div>
                                        
                                        {/* תוכן ראשי - מונמך גם הוא (mt-6) כדי להתיישר עם הסטטוס */}
                                        <div className="flex-1 min-w-0 grid grid-cols-1 md:grid-cols-12 gap-1 md:gap-4 items-center mt-6">
                                            <div className="md:col-span-8 text-sm font-bold text-gray-800 truncate">
                                                {cleanSubject}
                                            </div>
                                            {/* תאריך במחשב */}
                                            <div className="md:col-span-4 text-xs text-gray-400 flex items-center justify-end gap-2">
                                                <span>{formatDate(msg.created_at)}</span>
                                                {isExpanded ? <ChevronUp size={16}/> : <ChevronDown size={16}/>}
                                            </div>
                                        </div>
                                    </div>

                                    {isExpanded && (
                                        <div className="px-4 pb-6 pt-2 pl-4 md:pl-12 border-t border-gray-100 animate-fadeIn space-y-4">
                                            <div className="bg-white p-4 rounded-xl border border-gray-100 relative">
                                                <div className="text-xs font-bold text-gray-400 mb-1">ההודעה שלך:</div>
                                                <p className="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">{msg.message}</p>
                                            </div>

                                            {msg.admin_reply && (
                                                <div className="bg-green-50 p-4 rounded-xl border border-green-100">
                                                    <div className="flex items-center gap-2 text-green-800 text-xs font-bold mb-2">
                                                        <MessageCircle size={14}/> תשובת המערכת:
                                                    </div>
                                                    <p className="text-sm text-gray-800 leading-relaxed whitespace-pre-wrap">{msg.admin_reply}</p>
                                                </div>
                                            )}
                                            
                                            {!msg.admin_reply && msg.status !== 'closed' && (
                                                <div className="text-xs text-gray-400 italic flex items-center gap-1">
                                                    <Loader2 size={12} className="animate-spin"/>
                                                    הפנייה בטיפול, טרם התקבלה תשובה.
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                )
            )}
        </div>
      </div>
    </>
  )
}
</file>

<file path="app/dashboard/profile/page.tsx">
"use client"

import React, { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { Header } from '@/components/layout/Header'
import { Button } from '@/components/ui/Button'
import { Input } from '@/components/ui/Input'
import { 
  User, Mail, Building2, Save, CheckCircle, Loader2, Camera, ShieldCheck, Lock, Trash2, Calendar, AlertTriangle
} from 'lucide-react'

// פונקציית עזר לפרמוט תאריך לתצוגה עם סלאשים
const formatDisplayDate = (dateStr: string) => {
    if (!dateStr) return '-';
    // הופך YYYY-MM-DD ל-DD/MM/YYYY
    return dateStr.split('-').reverse().join('/');
};

export default function ProfilePage() {
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [uploading, setUploading] = useState(false);
  const [user, setUser] = useState<any>(null);
  const [successMsg, setSuccessMsg] = useState('');
  
  // משתנה לניהול החלון הקופץ של המחיקה
  const [showDeleteModal, setShowDeleteModal] = useState(false);

  const [formData, setFormData] = useState({
    // נתונים בסיסיים
    officialName: '', 
    lastName: '',
    idNumber: '', 
    birthDate: '',
    nickname: '', 
    
    // נתונים נוספים
    fullNameAndMother: '',
    contactEmail: '',
    phone: '',
    branchAddress: '',
    startYear: '', 
    studentCount: '',
    staffCount: '',
    additionalStaff: '',
    profileImage: null as string | null
  });

  // בדיקה אם המשתמש הוא מטה
  const isHQ = user?.user_metadata?.branch === 'מטה' || !user?.user_metadata?.branch;

  useEffect(() => {
    const getUser = async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        setUser(user);
        
        // שליפת נתונים קיימים
        const { data: profile } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', user.id)
            .single();

        const meta = user.user_metadata || {};
        
        setFormData({
          officialName: profile?.official_name || meta.official_name || '',
          lastName: profile?.last_name || meta.last_name || '',
          idNumber: profile?.identity_number || meta.identity_number || '', 
          birthDate: profile?.birth_date || meta.birth_date || '',
          nickname: meta.nickname || '', 
          fullNameAndMother: meta.full_name_mother || '',
          contactEmail: profile?.email || meta.contact_email || user.email || '', 
          phone: profile?.phone || meta.phone || '',
          branchAddress: meta.branch_address || '',
          startYear: profile?.start_year || meta.start_year || '', 
          studentCount: meta.student_count || '',
          staffCount: meta.staff_count || '',
          additionalStaff: meta.additional_staff || '',
          profileImage: profile?.avatar_url || meta.avatar_url || null
        });
      }
      setLoading(false);
    };
    getUser();
  }, []);

  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    if (!e.target.files || !e.target.files[0]) return;
    const file = e.target.files[0];
    setUploading(true);

    try {
      if (!user) throw new Error("User not found");
      const fileExt = file.name.split('.').pop();
      const fileName = `avatars/${user.id}_${Date.now()}.${fileExt}`;
      
      const { error: uploadError } = await supabase.storage
        .from('trip-files')
        .upload(fileName, file, { upsert: true });

      if (uploadError) throw uploadError;

      const { data: { publicUrl } } = supabase.storage
        .from('trip-files')
        .getPublicUrl(fileName);

      setFormData(prev => ({ ...prev, profileImage: publicUrl }));
    } catch (error: any) {
      alert('שגיאה בהעלאת תמונה: ' + error.message);
    } finally {
      setUploading(false);
    }
  };

  // פתיחת המודל במקום הודעת דפדפן
  const handleRemoveImageClick = (e: React.MouseEvent) => {
      e.preventDefault();
      setShowDeleteModal(true);
  };

  // אישור מחיקה בתוך המודל
  const confirmRemoveImage = () => {
      setFormData(prev => ({ ...prev, profileImage: null }));
      setShowDeleteModal(false);
  };

  const handleSave = async () => {
    setSaving(true);
    setSuccessMsg('');

    try {
      // 1. עדכון מטא-דאטה
      await supabase.auth.updateUser({
        data: {
          official_name: formData.officialName,
          last_name: formData.lastName,
          identity_number: formData.idNumber,
          birth_date: formData.birthDate,
          nickname: formData.nickname,
          phone: formData.phone,
          avatar_url: formData.profileImage, 
          start_year: formData.startYear, 
          
          full_name_mother: formData.fullNameAndMother,
          contact_email: formData.contactEmail,
          branch_address: formData.branchAddress,
          student_count: formData.studentCount,
          staff_count: formData.staffCount,
          additional_staff: formData.additionalStaff,
        }
      });
      
      // 2. עדכון טבלת profiles
      if (user) {
          const updates = {
              id: user.id,
              official_name: formData.officialName,
              last_name: formData.lastName,
              identity_number: formData.idNumber,
              birth_date: formData.birthDate,
              phone: formData.phone,
              email: formData.contactEmail,
              full_name: `${formData.officialName} ${formData.lastName}`.trim(),
              avatar_url: formData.profileImage,
              start_year: formData.startYear, 
              updated_at: new Date()
          };

          const { error } = await supabase.from('profiles').upsert(updates);
          if (error) throw error;
      }

      setSuccessMsg('הפרטים נשמרו בהצלחה!');
      setTimeout(() => { window.location.reload(); }, 1000);
    } catch (e: any) {
      console.error(e);
      alert('שגיאה בשמירה: ' + e.message);
    } finally {
      setSaving(false);
    }
  };

  if (loading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-[#00BCD4]" size={40}/></div>;

  return (
    <>
      <Header title="פרופיל אישי" />

      <div className="max-w-5xl mx-auto p-8 space-y-8 animate-fadeIn pb-32">
        
        {/* כרטיס עליון */}
        <section className="bg-white rounded-[32px] border border-gray-200 p-8 shadow-sm flex flex-col md:flex-row items-center gap-10 relative overflow-hidden">
            <div className="absolute top-0 left-0 right-0 h-2 bg-gradient-to-r from-[#00BCD4] to-[#8BC34A]"></div>
            
            {/* תמונת פרופיל + כפתור מחיקה */}
            <div className="relative group">
                <div className="w-32 h-32 rounded-[30px] bg-gradient-to-tr from-[#00BCD4] to-cyan-100 flex items-center justify-center text-white font-bold text-5xl shadow-xl shadow-cyan-100 border-[5px] border-white ring-1 ring-gray-100 overflow-hidden cursor-pointer relative">
                    {uploading ? (
                       <Loader2 className="animate-spin text-[#00BCD4]" size={32}/>
                    ) : formData.profileImage ? (
                        <img src={formData.profileImage} alt="Profile" className="w-full h-full object-cover"/>
                    ) : (
                        formData.officialName?.[0] || <User size={48}/>
                    )}
                    
                    {/* שכבת העלאה */}
                    <label className="absolute inset-0 bg-black/40 flex flex-col items-center justify-center text-white opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer z-10">
                        <Camera size={24}/>
                        <span className="text-xs font-bold mt-1">שנה תמונה</span>
                        <input type="file" className="hidden" accept="image/*" onChange={handleImageUpload} disabled={uploading}/>
                    </label>
                </div>

                {/* כפתור מחיקת תמונה */}
                {formData.profileImage && (
                    <button 
                        onClick={handleRemoveImageClick}
                        className="absolute -bottom-2 -right-2 bg-white text-red-500 p-2 rounded-full shadow-md border border-gray-100 hover:bg-red-50 transition-colors z-20"
                        title="הסר תמונה"
                    >
                        <Trash2 size={16}/>
                    </button>
                )}
            </div>

            <div className="text-center md:text-right flex-1 space-y-3">
                <div className="flex flex-col md:items-start items-center">
                    <h2 className="text-3xl font-black text-gray-800">
                        {formData.officialName} {formData.lastName}
                    </h2>
                    {formData.nickname && (
                        <span className="text-lg text-gray-400 font-bold">({formData.nickname})</span>
                    )}
                </div>
                
                <div className="flex flex-wrap justify-center md:justify-start gap-3 mt-2">
                    <span className="bg-cyan-50 text-[#00BCD4] border border-cyan-100 px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2">
                        <Building2 size={16}/> {user?.user_metadata?.department} • {user?.user_metadata?.branch || 'מטה'}
                    </span>
                    {formData.startYear && (
                        <span className="bg-orange-50 text-orange-600 border border-orange-100 px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2">
                            <Calendar size={16}/> משנת {formData.startYear}
                        </span>
                    )}
                </div>
            </div>
        </section>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            {/* עמודה ימנית: נתונים מערכתיים */}
            <section className="bg-[#F1F8E9] rounded-[32px] border border-green-100 p-8 shadow-inner lg:col-span-1 h-fit">
                <div className="flex items-center gap-2 mb-6 text-[#8BC34A] font-bold text-sm uppercase tracking-wider">
                    <Lock size={14}/> נתונים מערכתיים (תצוגה)
                </div>
                <div className="space-y-6">
                    <div>
                        <label className="text-xs font-bold text-gray-400 block mb-1">שם (לפי ת"ז)</label>
                        <div className="font-bold text-gray-800 text-lg border-b border-green-200/50 pb-2">{formData.officialName || '-'}</div>
                    </div>
                    <div>
                        <label className="text-xs font-bold text-gray-400 block mb-1">שם משפחה</label>
                        <div className="font-bold text-gray-800 text-lg border-b border-green-200/50 pb-2">{formData.lastName || '-'}</div>
                    </div>
                    <div>
                        <label className="text-xs font-bold text-gray-400 block mb-1">תעודת זהות</label>
                        <div className="font-bold text-gray-800 text-lg border-b border-green-200/50 pb-2 tracking-wider">{formData.idNumber || '-'}</div>
                    </div>
                    <div>
                        <label className="text-xs font-bold text-gray-400 block mb-1">תאריך לידה</label>
                        <div className="font-bold text-gray-800 text-lg border-b border-green-200/50 pb-2">
                            {formatDisplayDate(formData.birthDate)}
                        </div>
                    </div>
                </div>
            </section>

            {/* עמודה שמאלית: טופס עריכה */}
            <section className="bg-white rounded-[32px] border border-gray-200 p-8 shadow-sm lg:col-span-2">
                <div className="flex items-center gap-3 mb-8 border-b border-gray-100 pb-4">
                    <ShieldCheck size={24} className="text-[#00BCD4]"/>
                    <h3 className="text-xl font-bold text-gray-800">עדכון פרטים אישיים</h3>
                </div>

                <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <Input 
                            label="שם פרטי (כפי שמופיע בתעודת הזהות)" 
                            value={formData.officialName} 
                            onChange={(e: any) => setFormData({...formData, officialName: e.target.value})}
                            placeholder="לדוגמה: יוסף חיים"
                        />
                        <Input 
                            label="כינוי / שם חיבה" 
                            value={formData.nickname} 
                            onChange={(e: any) => setFormData({...formData, nickname: e.target.value})}
                            placeholder="לדוגמה: יוסי"
                        />
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <Input 
                            label="שם משפחה" 
                            value={formData.lastName} 
                            onChange={(e: any) => setFormData({...formData, lastName: e.target.value})}
                        />
                         <Input 
                            label="שם מלא + שם האם" 
                            value={formData.fullNameAndMother} 
                            onChange={(e: any) => setFormData({...formData, fullNameAndMother: e.target.value})}
                        />
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <Input 
                            label="תעודת זהות" 
                            value={formData.idNumber} 
                            onChange={(e: any) => setFormData({...formData, idNumber: e.target.value})}
                        />
                        <Input 
                            label="תאריך לידה" 
                            type="date"
                            value={formData.birthDate} 
                            onChange={(e: any) => setFormData({...formData, birthDate: e.target.value})}
                        />
                    </div>

                    <Input 
                        label="טלפון נייד" 
                        value={formData.phone} 
                        onChange={(e: any) => setFormData({...formData, phone: e.target.value})}
                    />

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <Input 
                            label="אימייל ליצירת קשר" 
                            value={formData.contactEmail} 
                            onChange={(e: any) => setFormData({...formData, contactEmail: e.target.value})} 
                            icon={<Mail size={18}/>}
                            placeholder="example@gmail.com"
                        />
                        <Input 
                            label="שנת הצטרפות לצוות" 
                            type="number"
                            value={formData.startYear} 
                            onChange={(e: any) => setFormData({...formData, startYear: e.target.value})} 
                            placeholder="לדוגמה: 2020"
                        />
                    </div>

                    {/* שינוי התווית למטה/סניף */}
                    <Input 
                        label={isHQ ? "כתובת מגורים" : "כתובת הסניף למשלוח דואר"} 
                        value={formData.branchAddress} 
                        onChange={(e: any) => setFormData({...formData, branchAddress: e.target.value})}
                        placeholder="רחוב, מספר, עיר..."
                    />

                    <div className="h-px bg-gray-100 my-2"></div>

                    {/* הסתרת נתוני חניכים/צוות אם זה מטה */}
                    {!isHQ && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 animate-fadeIn">
                            <Input label="כמות חניכים" type="number" value={formData.studentCount} onChange={(e: any) => setFormData({...formData, studentCount: e.target.value})}/>
                            <Input label="כמות אנשי צוות" type="number" value={formData.staffCount} onChange={(e: any) => setFormData({...formData, staffCount: e.target.value})}/>
                        </div>
                    )}

                    <div className="bg-cyan-50/50 p-6 rounded-2xl border border-cyan-100">
                        <label className="text-sm font-bold text-gray-600 block mb-2">{isHQ ? 'שמות חברי מטה נוספים' : 'שמות רכזים נוספים בסניף'}</label>
                        <textarea 
                            className="w-full p-4 rounded-xl bg-white border border-gray-200 outline-none focus:border-[#00BCD4] min-h-[80px] resize-none text-sm font-medium"
                            placeholder="הזן שמות מופרדים בפסיקים..."
                            value={formData.additionalStaff}
                            onChange={e => setFormData({...formData, additionalStaff: e.target.value})}
                        ></textarea>
                    </div>
                </div>

                <div className="mt-10 flex items-center justify-end gap-4">
                    {successMsg && <div className="text-[#8BC34A] font-bold text-sm flex items-center gap-2 animate-fadeIn bg-green-50 px-4 py-2 rounded-xl"><CheckCircle size={18}/> {successMsg}</div>}
                    <Button onClick={handleSave} isLoading={saving} variant="secondary" className="w-full md:w-auto px-12 shadow-xl shadow-green-100" icon={<Save size={20}/>}>שמירת שינויים</Button>
                </div>
            </section>
        </div>

        {/* Modal למחיקת תמונה */}
        {showDeleteModal && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fadeIn">
                <div className="bg-white rounded-[24px] shadow-2xl p-8 max-w-sm w-full text-center border border-gray-100">
                    <div className="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <AlertTriangle size={32} />
                    </div>
                    <h3 className="text-xl font-black text-gray-800 mb-2">מחיקת תמונת פרופיל</h3>
                    <p className="text-gray-500 mb-8 text-sm font-medium leading-relaxed">
                        האם את/ה בטוח/ה שברצונך להסיר את התמונה?
                        <br/>
                        לא ניתן לשחזר את הפעולה לאחר השמירה.
                    </p>
                    <div className="flex gap-3 justify-center">
                       <button 
                           onClick={() => setShowDeleteModal(false)}
                           className="flex-1 py-3 bg-gray-50 text-gray-700 font-bold rounded-xl hover:bg-gray-100 transition-colors"
                       >
                           ביטול
                       </button>
                       <button 
                           onClick={confirmRemoveImage}
                           className="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl hover:bg-red-600 transition-colors shadow-lg shadow-red-200"
                       >
                           מחק תמונה
                       </button>
                    </div>
                </div>
            </div>
        )}

      </div>
    </>
  )
}
</file>

<file path="app/manager/profile/page.tsx">
"use client"

import React, { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { ManagerHeader } from '@/components/layout/ManagerHeader'
import { Button } from '@/components/ui/Button'
import { Input } from '@/components/ui/Input'
import { Save, User, Mail, Lock, ShieldCheck, Camera, Loader2 } from 'lucide-react'

export default function ManagerProfile() {
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [uploading, setUploading] = useState(false);
  const [user, setUser] = useState<any>(null);

  const [formData, setFormData] = useState({
    officialName: '', // שם פרטי לפי ת"ז
    lastName: '',
    idNumber: '', 
    birthDate: '',
    nickname: '',
    fullNameAndMother: '', // השדה שהיה חסר
    email: '',
    phone: '',
    profileImage: null as string | null
  });

  useEffect(() => {
    const getUser = async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        setUser(user);
        const meta = user.user_metadata || {};
        
        // לוגיקה חכמה לחילוץ ת"ז
        let extractedId = meta.id_number || '';
        if (!extractedId && user.email?.includes('@')) {
            const possibleId = user.email.split('@')[0];
            if (/^\d+$/.test(possibleId)) extractedId = possibleId;
        }

        // לוגיקה חכמה לחילוץ שם פרטי ומשפחה (למקרה שהשדות החדשים ריקים)
        const fallbackFirstName = meta.full_name?.split(' ')[0] || '';
        const fallbackLastName = meta.full_name?.split(' ').slice(1).join(' ') || '';

        setFormData({
            officialName: meta.official_name || meta.first_name || fallbackFirstName,
            lastName: meta.last_name || fallbackLastName,
            idNumber: extractedId,
            birthDate: meta.birth_date || '', // וודא שזה קיים בדאטה בייס, אחרת יישאר ריק
            nickname: meta.nickname || '',
            fullNameAndMother: meta.full_name_mother || '', // טעינת שם האם
            email: meta.contact_email || user.email || '',
            phone: meta.phone || '',
            profileImage: meta.avatar_url || null
        });
      }
      setLoading(false);
    };
    getUser();
  }, []);

  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    if (!e.target.files || !e.target.files[0]) return;
    const file = e.target.files[0];
    setUploading(true);

    try {
      const fileExt = file.name.split('.').pop();
      const fileName = `avatars/${user.id}_${Date.now()}.${fileExt}`;
      const { error } = await supabase.storage.from('trip-files').upload(fileName, file, { upsert: true });
      if (error) throw error;
      const { data } = supabase.storage.from('trip-files').getPublicUrl(fileName);
      setFormData(prev => ({ ...prev, profileImage: data.publicUrl }));
    } catch (error: any) {
      alert('שגיאה: ' + error.message);
    } finally {
      setUploading(false);
    }
  };

  const handleSave = async () => {
      setSaving(true);
      
      // שמירה של כל השדות בצורה מסודרת למטא-דאטה
      const { error } = await supabase.auth.updateUser({
          data: { 
              official_name: formData.officialName,
              first_name: formData.officialName, // שומרים גם וגם ליתר ביטחון
              last_name: formData.lastName,
              nickname: formData.nickname,
              birth_date: formData.birthDate,
              full_name_mother: formData.fullNameAndMother, // שמירת שם האם
              phone: formData.phone,
              contact_email: formData.email,
              avatar_url: formData.profileImage,
              // מעדכנים גם את ה-full_name הכללי לתצוגה יפה
              full_name: `${formData.officialName} ${formData.lastName}`
          }
      });

      setSaving(false);
      
      if (error) {
          alert('שגיאה בשמירה: ' + error.message);
      } else {
          alert('הפרופיל עודכן בהצלחה');
          window.location.reload(); // רענון כדי לראות את השינויים בכותרת העליונה
      }
  };

  if (loading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-gray-400"/></div>;

  return (
    <>
      <ManagerHeader title="פרופיל אישי - מנהל" />
      
      <div className="p-8 max-w-5xl mx-auto pb-32 animate-fadeIn">
          
          {/* כרטיס עליון */}
          <div className="bg-white rounded-[32px] p-8 border border-gray-200 shadow-sm flex items-center gap-8 mb-8">
               <div className="relative group w-24 h-24">
                   <div className="w-full h-full bg-gray-800 rounded-3xl flex items-center justify-center text-white text-3xl font-bold overflow-hidden border-4 border-white shadow-lg">
                      {formData.profileImage ? (
                          <img src={formData.profileImage} className="w-full h-full object-cover"/>
                      ) : (
                          formData.officialName?.[0] || <User/>
                      )}
                   </div>
                   <label className="absolute inset-0 bg-black/50 rounded-3xl flex items-center justify-center opacity-0 group-hover:opacity-100 cursor-pointer transition-all text-white">
                       <Camera size={24}/>
                       <input type="file" className="hidden" onChange={handleImageUpload} disabled={uploading} />
                   </label>
               </div>
               <div>
                   <h2 className="text-3xl font-black text-gray-800">{formData.officialName} {formData.lastName}</h2>
                   <div className="flex items-center gap-2 text-gray-500 font-bold mt-1">
                       <ShieldCheck size={18} className="text-[#00BCD4]"/> מנהל מערכת ראשי
                   </div>
               </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
              
              {/* צד ימין: נתונים נעולים (מערכת) */}
              <div className="bg-[#F1F8E9] p-6 rounded-3xl border border-green-100 h-fit">
                  <div className="flex items-center gap-2 mb-6 text-[#8BC34A] font-bold text-sm uppercase">
                      <Lock size={14}/> פרטי מערכת
                  </div>
                  <div className="space-y-4">
                      <div>
                          <label className="text-xs font-bold text-gray-400">שם פרטי (רשמי)</label>
                          <div className="font-bold text-gray-800 text-lg border-b border-green-200/50 pb-1">{formData.officialName || '-'}</div>
                      </div>
                      <div>
                          <label className="text-xs font-bold text-gray-400">שם משפחה</label>
                          <div className="font-bold text-gray-800 text-lg border-b border-green-200/50 pb-1">{formData.lastName || '-'}</div>
                      </div>
                      <div>
                          <label className="text-xs font-bold text-gray-400">תעודת זהות</label>
                          <div className="font-bold text-gray-800 text-lg border-b border-green-200/50 pb-1 tracking-wider">{formData.idNumber || '-'}</div>
                      </div>
                      <div>
                          <label className="text-xs font-bold text-gray-400">תאריך לידה</label>
                          <div className="font-bold text-gray-800 text-lg border-b border-green-200/50 pb-1">{formData.birthDate || '-'}</div>
                      </div>
                  </div>
              </div>

              {/* צד שמאל: טופס עריכה */}
              <div className="md:col-span-2 bg-white p-8 rounded-3xl border border-gray-200 shadow-sm">
                  <h3 className="text-xl font-bold text-gray-800 mb-6">עדכון פרטים</h3>
                  <div className="space-y-6">
                      
                      {/* שורת שמות לעריכה */}
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <Input 
                            label="שם פרטי (כפי שמופיע בתעודת זהות)" 
                            value={formData.officialName} 
                            onChange={e => setFormData({...formData, officialName: e.target.value})} 
                          />
                          <Input 
                            label="כינוי / שם חיבה" 
                            value={formData.nickname} 
                            onChange={e => setFormData({...formData, nickname: e.target.value})} 
                          />
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <Input 
                            label="שם משפחה" 
                            value={formData.lastName} 
                            onChange={e => setFormData({...formData, lastName: e.target.value})} 
                          />
                          <Input 
                            label="טלפון נייד" 
                            value={formData.phone} 
                            onChange={e => setFormData({...formData, phone: e.target.value})} 
                          />
                      </div>

                      {/* השדה החדש שביקשת! */}
                      <Input 
                        label="שם מלא + שם האם (לתפילה)" 
                        value={formData.fullNameAndMother} 
                        onChange={e => setFormData({...formData, fullNameAndMother: e.target.value})} 
                        placeholder="לדוגמה: יוסף בן שרה"
                      />

                      <Input 
                        label="אימייל ליצירת קשר" 
                        value={formData.email} 
                        onChange={e => setFormData({...formData, email: e.target.value})} 
                        icon={<Mail size={18}/>} 
                      />
                      
                      <div className="pt-6 flex justify-end border-t border-gray-100 mt-6">
                          <Button onClick={handleSave} isLoading={saving} icon={<Save size={18}/>} className="bg-gray-800 hover:bg-gray-900 px-10 shadow-lg shadow-gray-200">
                              שמור שינויים
                          </Button>
                      </div>
                  </div>
              </div>
          </div>
      </div>
    </>
  )
}
</file>

<file path="app/manifest.json">
{
  "name": "בטיחות ומפעלים נוער חבד",
  "short_name": "בטיחות ומפעלים",
  "description": "מערכת לניהול ואישור טיולים",
  "start_url": "/dashboard",
  "display": "standalone",
  "background_color": "#F8F9FA",
  "theme_color": "#00BCD4",
  "icons": [
    {
      "src": "/icon.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icon.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
</file>

<file path="components/layout/Header.tsx">
"use client";

import React, { useEffect, useState } from 'react';
import { supabase } from '@/lib/supabaseClient';
import Image from 'next/image';
import Link from 'next/link';
import { Bell, X, Mail } from 'lucide-react';

const DEPT_LOGOS: any = {
    'בת מלך': '/logos/bat-melech.png',
    'בנות חב״ד': '/logos/bnos-chabad.png',
    'הפנסאים': '/logos/hapanasim.png',
    'תמים': '/logos/temimim.png',
    'מועדוני המעשים הטובים': '/logos/clubs.png',
};

const getSimpleGreeting = (name: string) => {
    const firstName = name?.split(' ')[0] || '';
    return `שלום, ${firstName}`; 
};

// התיקון כאן: export const (ולא default)
export const Header = ({ title }: { title: string }) => {
  const [user, setUser] = useState<any>(null);
  const [avatarUrl, setAvatarUrl] = useState<string | null>(null);
  const [department, setDepartment] = useState('');
  
  // ניהול התראות לפעמון
  const [unreadNotifications, setUnreadNotifications] = useState<any[]>([]);
  const [isBellOpen, setIsBellOpen] = useState(false);

  useEffect(() => {
    const initData = async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        setUser(user);
        setDepartment(user.user_metadata?.department || '');
        setAvatarUrl(user.user_metadata?.avatar_url || null);
        fetchNotifications(user.id);
      }
    };
    initData();

    const channel = supabase.channel('header_desktop')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'notifications' }, () => {
          if (user?.id) fetchNotifications(user.id); 
      })
      .subscribe();

    return () => { supabase.removeChannel(channel); };
  }, [user?.id]);

  const fetchNotifications = async (userId: string) => {
      const { data } = await supabase.from('notifications')
          .select('id, title, is_read')
          .eq('user_id', userId)
          .eq('is_read', false)
          .order('created_at', { ascending: false })
          .limit(5);
      setUnreadNotifications(data || []);
  };

  const deptLogo = DEPT_LOGOS[department] || '/logo.png';

  return (
    <header className="hidden md:flex h-24 sticky top-0 z-30 px-8 items-center justify-between transition-all bg-[#F8F9FA]/90 backdrop-blur-md border-b border-gray-200">
      
      {/* צד ימין: כותרת + לוגו */}
      <div className="flex items-center gap-4">
        <div className="relative w-12 h-12 bg-white rounded-xl shadow-sm border border-gray-100 p-1 hidden md:block">
            <Image src={deptLogo} alt="Department Logo" fill className="object-contain p-1" />
        </div>
        
        <div>
            <h1 className="text-3xl font-bold text-gray-800 tracking-tight leading-none">
                {title}
            </h1>
            {user && (
                <p className="text-sm text-gray-500 font-medium mt-1">
                    {getSimpleGreeting(user.user_metadata?.full_name)}
                </p>
            )}
        </div>
      </div>
      
      {/* צד שמאל: פרופיל + פעמון */}
      <div className="flex items-center gap-6 relative">
            
            {/* פעמון דסקטופ עם חלון קופץ */}
            <div className="relative">
                <button 
                    onClick={() => setIsBellOpen(!isBellOpen)}
                    className="text-gray-400 hover:text-[#00BCD4] transition-colors relative p-3 bg-white rounded-2xl shadow-sm border border-gray-100 hover:border-[#00BCD4] group"
                >
                    <Bell size={22} className="group-hover:rotate-12 transition-transform" />
                    {unreadNotifications.length > 0 && (
                        <span className="absolute top-2 right-2 w-2.5 h-2.5 bg-[#E91E63] rounded-full border-2 border-white animate-pulse"></span>
                    )}
                </button>

                {/* חלונית ההתראות */}
                {isBellOpen && (
                    <div className="absolute top-full left-0 mt-4 bg-white rounded-2xl shadow-2xl border border-gray-100 w-80 overflow-hidden animate-fadeIn z-50">
                        <div className="bg-[#00BCD4] p-3 flex justify-between items-center text-white">
                            <span className="text-sm font-bold">הודעות חדשות</span>
                            <button onClick={() => setIsBellOpen(false)}><X size={16}/></button>
                        </div>
                        <div className="max-h-60 overflow-y-auto">
                            {unreadNotifications.length === 0 ? (
                                <div className="p-6 text-center text-gray-400 text-xs">אין הודעות חדשות עבורך</div>
                            ) : (
                                unreadNotifications.map(n => (
                                    <Link key={n.id} href="/dashboard/inbox" onClick={() => setIsBellOpen(false)} className="block p-3 border-b border-gray-50 hover:bg-gray-50 transition-colors">
                                        <div className="flex gap-2">
                                            <Mail size={14} className="text-[#00BCD4] mt-0.5 shrink-0"/>
                                            <span className="text-xs font-bold text-gray-700 line-clamp-2">{n.title}</span>
                                        </div>
                                    </Link>
                                ))
                            )}
                        </div>
                        <Link href="/dashboard/inbox" onClick={() => setIsBellOpen(false)} className="block p-2 text-center text-xs font-bold text-[#00BCD4] bg-gray-50 hover:underline">
                            לכל ההודעות
                        </Link>
                    </div>
                )}
            </div>

            <div className="h-10 w-px bg-gray-300 opacity-50"></div>

            <div className="flex items-center gap-4">
                <div className="text-left">
                    <div className="text-lg font-bold text-gray-800 leading-none mb-1">
                        {user?.user_metadata?.full_name} 
                    </div>
                    <div className="text-sm text-gray-500 font-medium">
                        {user?.user_metadata?.department} • {user?.user_metadata?.branch || 'מטה'}
                    </div>
                </div>
                
                <div className="w-14 h-14 rounded-2xl bg-gradient-to-tr from-[#00BCD4] to-cyan-400 flex items-center justify-center text-white font-bold text-2xl shadow-lg shadow-cyan-100 border-[3px] border-white ring-1 ring-gray-100 shrink-0 overflow-hidden relative">
                {avatarUrl ? (
                    <img src={avatarUrl} alt="Profile" className="w-full h-full object-cover" />
                ) : (
                    user?.user_metadata?.full_name?.[0]
                )}
                </div>
            </div>
      </div>
    </header>
  );
};
</file>

<file path="components/layout/ManagerHeader.tsx">
"use client";

import React, { useEffect, useState } from 'react';
import { supabase } from '@/lib/supabaseClient';
import { Bell, UserPlus } from 'lucide-react';
import Link from 'next/link';

export const ManagerHeader = ({ title }: { title: string }) => {
  const [user, setUser] = useState<any>(null);
  const [counts, setCounts] = useState({ newUsers: 0, newMessages: 0 });

  useEffect(() => {
    const fetchData = async () => {
      // 1. הבאת פרטי המנהל הנוכחי
      const { data: userData } = await supabase.auth.getUser();
      setUser(userData.user);

      // 2. ספירת משתמשים חדשים הממתינים לאישור
      // אנחנו מושכים את כל המשתמשים מה-VIEW ובודקים למי אין סטטוס או שהסטטוס הוא pending
      const { data: usersData } = await supabase.from('users_management_view').select('raw_user_meta_data');
      
      const pendingUsersCount = usersData?.filter((u: any) => {
          const status = u.raw_user_meta_data?.status;
          return !status || status === 'pending';
      }).length || 0;

      // 3. ספירת הודעות שלא טופלו
      const { count: pendingMessagesCount } = await supabase
        .from('contact_messages')
        .select('*', { count: 'exact', head: true })
        .neq('status', 'treated'); // כל מה שלא "טופל"

      setCounts({
          newUsers: pendingUsersCount,
          newMessages: pendingMessagesCount || 0
      });
    };

    fetchData();
  }, []);

  return (
    <header className="h-24 sticky top-0 z-40 px-8 flex items-center justify-between transition-all bg-white/90 backdrop-blur-md border-b border-gray-200">
      
      {/* צד ימין: כותרת */}
      <div>
        <h1 className="text-2xl font-black text-gray-800 tracking-tight">{title}</h1>
      </div>
      
      {/* צד שמאל: כלים */}
      <div className="flex items-center h-full gap-4">
        
        {/* פעמון 1: אישור משתמשים חדשים */}
        <Link href="/manager/users">
            <button className="text-gray-400 hover:text-[#00BCD4] transition-colors relative p-2.5 bg-white rounded-xl border border-gray-100 shadow-sm group">
                <UserPlus size={20} className="group-hover:scale-110 transition-transform"/>
                
                {/* נקודה כתומה רק אם יש משתמשים חדשים */}
                {counts.newUsers > 0 && (
                    <span className="absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-orange-500 text-[10px] text-white font-bold border border-white">
                        {counts.newUsers}
                    </span>
                )}
            </button>
        </Link>

        {/* פעמון 2: התראות / הודעות */}
        <Link href="/manager/inbox">
            <button className="text-gray-400 hover:text-[#00BCD4] transition-colors relative p-2.5 bg-white rounded-xl border border-gray-100 shadow-sm group">
                <Bell size={20} className="group-hover:rotate-12 transition-transform" />
                
                {/* נקודה אדומה רק אם יש הודעות חדשות */}
                {counts.newMessages > 0 && (
                    <span className="absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-red-500 text-[10px] text-white font-bold border border-white">
                        {counts.newMessages}
                    </span>
                )}
            </button>
        </Link>

        <div className="h-8 w-px bg-gray-200 mx-2"></div>

        {/* פרופיל מנהל */}
        <Link href="/manager/profile">
            <div className="flex items-center gap-3 cursor-pointer group">
                <div className="text-left hidden md:block">
                    <div className="text-sm font-bold text-gray-800 leading-none mb-1 group-hover:text-[#00BCD4] transition-colors">
                        {user?.user_metadata?.full_name || 'מנהל מערכת'}
                    </div>
                    <div className="text-xs text-gray-500 font-medium">
                        מטה ארצי
                    </div>
                </div>
                
                <div className="w-10 h-10 rounded-xl bg-[#1E293B] flex items-center justify-center text-white font-bold text-lg shadow-md border-2 border-white ring-1 ring-gray-100 group-hover:scale-105 transition-transform">
                {user?.user_metadata?.full_name?.[0] || 'M'}
                </div>
            </div>
        </Link>
      </div>
    </header>
  );
};
</file>

<file path="components/ui/Button.tsx">
import React from 'react';
import { Loader2 } from 'lucide-react';

interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary' | 'danger' | 'outline' | 'ghost' | 'dark';
  isLoading?: boolean;
  icon?: React.ReactNode;
}

export const Button = ({ 
  children, 
  variant = 'primary', 
  isLoading, 
  icon, 
  className = '', 
  disabled,
  ...props 
}: ButtonProps) => {
  
  // Base: גובה 60px (או padding תואם), פינות עגולות מאוד, פונט מודגש
  const baseStyles = "relative flex items-center justify-center gap-2 font-bold rounded-2xl transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed h-[60px]";
  
  const variants = {
    primary: "bg-brand-cyan hover:bg-[#00ACC1] text-white shadow-lg shadow-cyan-100 text-lg",
    secondary: "bg-brand-green hover:bg-[#7CB342] text-white shadow-lg shadow-green-100 text-lg",
    danger: "bg-brand-pink hover:bg-[#D81B60] text-white shadow-lg shadow-pink-100",
    dark: "bg-brand-dark hover:bg-black text-white shadow-lg",
    outline: "bg-white border-2 border-brand-pink text-brand-pink hover:bg-pink-50",
    ghost: "bg-transparent hover:bg-gray-100 text-gray-500 h-auto py-2" // Ghost לא חייב להיות ענק
  };

  return (
    <button 
      className={`${baseStyles} ${variants[variant]} ${className}`}
      disabled={disabled || isLoading}
      {...props}
    >
      {isLoading ? <Loader2 className="w-6 h-6 animate-spin" /> : (
        <>
          {children}
          {icon && <span className="shrink-0">{icon}</span>}
        </>
      )}
    </button>
  );
};
</file>

<file path="components/ui/Input.tsx">
import React from 'react';

interface InputProps extends React.InputHTMLAttributes<HTMLInputElement> {
  label?: string;
  error?: string;
  icon?: React.ReactNode; // הוספנו את זה כדי למנוע את השגיאה
}

export const Input = ({ label, error, icon, className = '', ...props }: InputProps) => {
  return (
    <div className="w-full">
      {label && <label className="block text-xs font-bold text-gray-500 mb-1.5 mr-1">{label}</label>}
      
      <div className="relative">
        {/* אם הועבר אייקון, נציג אותו */}
        {icon && (
            <div className="absolute top-1/2 right-4 -translate-y-1/2 text-gray-400 pointer-events-none">
                {icon}
            </div>
        )}
        
        <input 
          className={`w-full h-[60px] rounded-xl border outline-none font-bold text-sm transition-all
          ${icon ? 'pr-12 pl-4' : 'px-4'} /* ריווח אוטומטי לאייקון */
          ${error 
            ? 'border-red-200 bg-red-50 text-red-600 placeholder-red-300' 
            : 'bg-white border-gray-200 focus:border-[#E91E63] focus:ring-1 focus:ring-[#E91E63] text-[#263238]'
          } ${className}`}
          {...props}
        />
      </div>
      
      {error && <p className="text-xs text-red-500 font-bold mt-1 mr-1">{error}</p>}
    </div>
  );
};
</file>

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="next.config.ts">
/** @type {import('next').NextConfig} */
const nextConfig = {
  typescript: {
    ignoreBuildErrors: true,
  },
  // הגדרת אישור לטעינת תמונות מ-Supabase
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'ehndiifaaobawrnlcqld.supabase.co',
        port: '',
        pathname: '/**',
      },
    ],
  },
};

module.exports = nextConfig;
</file>

<file path="package.json">
{
  "name": "chabad-trips",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@supabase/ssr": "^0.8.0",
    "@supabase/supabase-js": "^2.90.1",
    "lucide-react": "^0.562.0",
    "next": "16.1.1",
    "react": "19.2.3",
    "react-dom": "19.2.3"
  },
  "devDependencies": {
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "autoprefixer": "^10.4.23",
    "eslint": "^9",
    "eslint-config-next": "16.1.1",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.1",
    "typescript": "^5"
  }
}
</file>

<file path="postcss.config.mjs">
/** @type {import('postcss-load-config').Config} */
const config = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};

export default config;
</file>

<file path="PROJECT_INSTRUCTIONS.md">
# הוראות פרויקט "מערכת הטיולים - נוער חב"ד" (מעודכן: ינואר 2026)

## 1. Tech Stack (טכנולוגיה)
* **Framework:** Next.js 14+ (App Router).
* **Language:** TypeScript.
* **Styling:** Tailwind CSS.
* **Icons:** Lucide React.
* **Database:** Supabase.

## 2. Design System (חוקי הברזל לעיצוב)
העיצוב מבוסס על סגנון "ידידותי, גדול וברור" (Friendly & Accessible).

### א. טיפוגרפיה (Typography)
* **פונט בלעדי:** `Rubik` (מוגדר ב-`layout.tsx` ו-`tailwind.config.ts`).
* **משקלים:**
  * כותרות ראשיות: `font-black` (רק במקרים חריגים) או `font-bold`.
  * טקסט רגיל וכותרות משנה: `font-bold` או `font-medium`.
  * יש להימנע מפונטים דקים מדי.

### ב. מידות וגדלים (Sizing) - קריטי!
* **שדות קלט (Inputs) וכפתורים (Buttons):** גובה קבוע של **60px** (`h-[60px]`).
* **כרטיסים (Cards):** פינות עגולות מאוד: `rounded-[32px]`.
* **כפתורים ואלמנטים פנימיים:** פינות עגולות: `rounded-xl` או `rounded-2xl`.

### ג. צבעים (Color Palette)
יש להשתמש במשתני ה-Tailwind שהוגדרו:
* **Brand Cyan (`text-[#00BCD4]` / `bg-[#00BCD4]`):** צבע מותג ראשי, כותרות, אייקונים.
* **Brand Green (`#8BC34A`):** כפתורי פעולה ראשיים ("שמור", "סיום"), אישורי הצלחה.
* **Brand Pink (`#E91E63`):** פוקוס (Focus Rings), מסגרות פעילות, שגיאות, והדגשות.
* **Brand Dark (`#263238`):** טקסטים ראשיים.

## 3. ארכיטקטורה ומבנה (Project Structure)
* **Layouts:**
  * אין לשכפל Header או Sidebar בכל דף.
  * יש להשתמש ב-`app/dashboard/layout.tsx` שמכיל את `Sidebar` ואת `Header`.
  * דפים פנימיים (כמו `new-trip`) צריכים להכיל רק את התוכן הייחודי שלהם.
* **Components:**
  * חובה להשתמש ב-`@/components/ui/Button` וב-`@/components/ui/Input` המותאמים אישית (בגודל 60px).
  * אין להשתמש ב-HTML tags רגילים (`<button>`, `<input>`) אלא אם כן יש צורך בסטייל ייחודי מאוד שלא נתמך בקומפוננטה.

## 4. אבטחה ונתונים (Data & Security)
* **Supabase:**
  * אין להשתמש ב-`createClient` בתוך הקומפוננטות.
  * חובה לייבא את הלקוח המאובטח: `import { supabase } from '@/lib/supabaseClient'`.
* **Environment Variables:**
  * מפתחות API לא ייכנסו לקוד לעולם.

## 5. הנחיות כלליות ל-AI
* בכל יצירת דף חדש, וודא שהוא תואם ויזואלית לדף `dashboard/new-trip`.
* שמור על קוד נקי: פצל פונקציות לוגיות (כמו `handleUpload`) מחוץ ל-JSX.
* השתמש ב-`lucide-react` עבור כל האייקונים.
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="tailwind.config.ts">
import type { Config } from "tailwindcss";

const config: Config = {
  content: [
    "./pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./components/**/*.{js,ts,jsx,tsx,mdx}",
    "./app/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  theme: {
    extend: {
      colors: {
        brand: {
          cyan: "var(--brand-cyan)",   // #00BCD4
          green: "var(--brand-green)", // #8BC34A
          pink: "var(--brand-pink)",   // #E91E63
          yellow: "var(--brand-yellow)",// #FFC107
          dark: "var(--brand-dark)",   // #263238
        },
        bg: {
          light: "var(--bg-light)",    // #F8F9FA
        },
      },
      // הוספתי את החלק הזה:
      fontFamily: {
        sans: ["var(--font-rubik)", "sans-serif"],
      },
    },
  },
  plugins: [],
};
export default config;
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
, "app/register/paga.js"  ],
  "exclude": ["node_modules"]
}
</file>

<file path="utils/supabase/client.ts">
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  // הקוד הזה מחבר את האתר למסד הנתונים באמצעות המפתחות ששמנו בקובץ הסודות
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}
</file>

<file path="app/dashboard/my-trips/page.tsx">
"use client"

import React, { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { Header } from '@/components/layout/Header'
import { 
  Loader2, Clock, CheckCircle, Search, 
  MapPin, ShieldAlert, Sun, ArrowRight, Calendar,
  Tent, Ticket, Layers, Timer, AlertTriangle, FileEdit, Trash2, XCircle, History
} from 'lucide-react'
import Link from 'next/link'
import { useRouter } from 'next/navigation'

// --- פונקציות עזר לתאריכים ---

const toHebrewDay = (day: number) => {
    const days = [
        '', 'א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ז', 'ח', 'ט', 'י', 
        'י"א', 'י"ב', 'י"ג', 'י"ד', 'ט"ו', 'ט"ז', 'י"ז', 'י"ח', 'י"ט', 'כ', 
        'כ"א', 'כ"ב', 'כ"ג', 'כ"ד', 'כ"ה', 'כ"ו', 'כ"ז', 'כ"ח', 'כ"ט', 'ל'
    ];
    return days[day] || day;
};

const formatHebrewYear = (yearNum: number) => {
    let year = yearNum % 1000; 
    let str = '';
    
    if (year >= 400) { str += 'ת'; year -= 400; }
    if (year >= 300) { str += 'ש'; year -= 300; }
    if (year >= 200) { str += 'ר'; year -= 200; }
    if (year >= 100) { str += 'ק'; year -= 100; }
    if (year >= 90) { str += 'צ'; year -= 90; }
    if (year >= 80) { str += 'פ'; year -= 80; }
    if (year >= 70) { str += 'ע'; year -= 70; }
    if (year >= 60) { str += 'ס'; year -= 60; }
    if (year >= 50) { str += 'נ'; year -= 50; }
    if (year >= 40) { str += 'מ'; year -= 40; }
    if (year >= 30) { str += 'ל'; year -= 30; }
    if (year >= 20) { str += 'כ'; year -= 20; }
    if (year >= 10) { str += 'י'; year -= 10; }
    
    const units = ['', 'א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ז', 'ח', 'ט'];
    if (year > 0) str += units[year];
    
    if (str.length > 1) {
        str = str.slice(0, -1) + '"' + str.slice(-1);
    } else {
        str += "'";
    }
    
    return str;
};

const formatHebrewDate = (dateString: string) => {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        const hebrewYearNum = date.getFullYear() + 3760;
        const yearLetters = formatHebrewYear(hebrewYearNum);
        const dayNum = parseInt(date.toLocaleDateString('he-IL', { calendar: 'hebrew', day: 'numeric' }));
        const dayLetters = toHebrewDay(dayNum);
        const monthName = date.toLocaleDateString('he-IL', { calendar: 'hebrew', month: 'long' });

        return `${dayLetters} ב${monthName} ${yearLetters}`;
    } catch (e) { return ''; }
};

const formatFullGregorianDate = (dateString: string) => {
    if (!dateString) return '';
    return new Date(dateString).toLocaleDateString('he-IL', { day: 'numeric', month: 'long', year: 'numeric' });
};

const getMonthNameHebrew = (dateString: string) => {
    if (!dateString) return '';
    return new Date(dateString).toLocaleDateString('he-IL', { month: 'long' });
};

const getRibbonColor = (type: string) => {
    if (!type) return 'bg-gray-500';
    if (type.includes('סמינר')) return 'bg-purple-600';
    if (type.includes('מחנה')) return 'bg-green-600';
    if (type.includes('טיול')) return 'bg-[#00BCD4]';
    return 'bg-blue-600';
};

const getStatusStyles = (status: string) => {
    const config: any = {
        approved: { text: 'מאושר', bg: 'bg-green-100', textCol: 'text-green-700', icon: CheckCircle },
        pending: { text: 'ממתין לבדיקה', bg: 'bg-amber-100', textCol: 'text-amber-700', icon: Clock },
        rejected: { text: 'לא אושר', bg: 'bg-red-100', textCol: 'text-red-700', icon: AlertTriangle },
        draft: { text: 'טיוטה', bg: 'bg-gray-100', textCol: 'text-gray-600', icon: FileEdit },
        cancelled: { text: 'בוטל', bg: 'bg-stone-100', textCol: 'text-stone-500', icon: XCircle }
    };
    return config[status] || config.pending;
};

export default function MyTripsPage() {
  const router = useRouter();
  const [loading, setLoading] = useState(true);
  const [trips, setTrips] = useState<any[]>([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [activeFilter, setActiveFilter] = useState('all');
  
  // מודלים
  const [cancelModal, setCancelModal] = useState<{show: boolean, tripId: string | null}>({show: false, tripId: null});
  const [deleteDraftModal, setDeleteDraftModal] = useState<{show: boolean, tripId: string | null}>({show: false, tripId: null});
  const [cancelReason, setCancelReason] = useState('');

  const fetchTrips = async () => {
      setLoading(true);
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { window.location.href = '/'; return; }
      
      try {
          const { data, error } = await supabase
              .from('trips')
              .select('*')
              .eq('user_id', user.id)
              .order('start_date', { ascending: false });
          if (error) throw error;
          setTrips(data || []);
      } catch (e) { console.error('Error fetching trips:', e); } 
      finally { setLoading(false); }
  };

  useEffect(() => {
    fetchTrips();
  }, []);

  const confirmDeleteDraft = async () => {
      if (!deleteDraftModal.tripId) return;
      const id = deleteDraftModal.tripId;
      
      const { error } = await supabase.from('trips').delete().eq('id', id);
      if (!error) {
          setTrips(prev => prev.filter(t => t.id !== id));
          setDeleteDraftModal({show: false, tripId: null});
      } else {
          alert('שגיאה במחיקה: ' + error.message);
      }
  };

  const handleEditDraft = (id: string, e: React.MouseEvent) => {
      e.preventDefault();
      e.stopPropagation();
      router.push(`/dashboard/new-trip?id=${id}`);
  };

  const handleCancelTrip = async () => {
      if (!cancelModal.tripId || !cancelReason.trim()) return;
      
      try {
          // שומרים את סיבת הביטול (בעמודה אם קיימת או ב-details) ומשנים סטטוס
          const trip = trips.find(t => t.id === cancelModal.tripId);
          const updatedDetails = { 
              ...trip.details, 
              cancellationReason: cancelReason 
          };

          const { error } = await supabase.from('trips').update({
              status: 'cancelled',
              cancellation_reason: cancelReason, 
              details: updatedDetails
          }).eq('id', cancelModal.tripId);
          
          if (error) throw error;
          
          setTrips(prev => prev.map(t => t.id === cancelModal.tripId ? {...t, status: 'cancelled', cancellation_reason: cancelReason, details: updatedDetails} : t));
          setCancelModal({show: false, tripId: null});
          setCancelReason('');
      } catch (e: any) {
          alert('שגיאה בביטול: ' + e.message);
      }
  };

  if (loading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-[#00BCD4]" size={40}/></div>;

  const displayTrips = trips.filter(t => {
      const today = new Date();
      today.setHours(0,0,0,0);
      const tripDate = new Date(t.start_date);
      
      // לוגיקת פילטור
      let matchesFilter = true;
      if (activeFilter === 'future') matchesFilter = tripDate >= today;
      else if (activeFilter === 'past') matchesFilter = tripDate < today;
      else if (activeFilter !== 'all') matchesFilter = t.status === activeFilter;

      const matchesSearch = t.name.toLowerCase().includes(searchTerm.toLowerCase());
      return matchesFilter && matchesSearch;
  });

  return (
    <>
      <Header title="הטיולים שלי" />

      {/* מודל ביטול טיול */}
      {cancelModal.show && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fadeIn">
              <div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm text-center">
                  <div className="w-14 h-14 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                      <Trash2 size={28}/>
                  </div>
                  <h3 className="text-lg font-black text-gray-800 mb-2">ביטול פעילות</h3>
                  <p className="text-sm text-gray-500 mb-4 font-medium leading-relaxed">
                      האם את/ה בטוח/ה שברצונך לבטל את הפעילות? <br/>
                      פעולה זו תעדכן את מחלקת המפעלים והבטיחות.
                  </p>
                  <textarea 
                      className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm mb-4 outline-none focus:border-red-400 min-h-[80px]"
                      placeholder="נא לפרט את סיבת הביטול..."
                      value={cancelReason}
                      onChange={e => setCancelReason(e.target.value)}
                  ></textarea>
                  <div className="flex gap-2">
                      <button onClick={() => setCancelModal({show: false, tripId: null})} className="flex-1 py-2 bg-gray-100 text-gray-700 font-bold rounded-xl text-sm">חזרה</button>
                      <button onClick={handleCancelTrip} className="flex-1 py-2 bg-red-500 text-white font-bold rounded-xl text-sm hover:bg-red-600 transition-colors">אשר ביטול</button>
                  </div>
              </div>
          </div>
      )}

      {/* מודל מחיקת טיוטה */}
      {deleteDraftModal.show && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fadeIn">
              <div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm text-center border-t-4 border-[#E91E63]">
                  <div className="w-14 h-14 bg-red-50 text-[#E91E63] rounded-full flex items-center justify-center mx-auto mb-4">
                      <Trash2 size={28}/>
                  </div>
                  <h3 className="text-lg font-black text-gray-800 mb-2">מחיקת טיוטה</h3>
                  <p className="text-sm text-gray-500 mb-4 font-medium">האם למחוק את הטיוטה לצמיתות? לא ניתן לשחזר פעולה זו.</p>
                  <div className="flex gap-2">
                      <button onClick={() => setDeleteDraftModal({show: false, tripId: null})} className="flex-1 py-2 bg-gray-100 text-gray-700 font-bold rounded-xl text-sm">ביטול</button>
                      <button onClick={confirmDeleteDraft} className="flex-1 py-2 bg-[#E91E63] text-white font-bold rounded-xl text-sm hover:bg-pink-600 transition-colors">מחק</button>
                  </div>
              </div>
          </div>
      )}

      <div className="p-4 md:p-8 space-y-6 animate-fadeIn pb-32 max-w-[100vw] overflow-x-hidden md:max-w-7xl md:mx-auto">
          
          <div className="space-y-4 pt-2">
              <div className="flex flex-col md:flex-row justify-between items-end gap-4">
                  
                  {/* פילטרים מורחבים - נוסף 'נדחה' */}
                  <div className="flex gap-2 bg-white p-1.5 rounded-2xl border border-gray-100 w-full md:w-auto overflow-x-auto no-scrollbar shadow-sm">
                      {[
                          { id: 'all', label: 'כל הטיולים' },
                          { id: 'future', label: 'עתידיים' },
                          { id: 'past', label: 'היסטוריה' },
                          { id: 'draft', label: 'טיוטות' },
                          { id: 'approved', label: 'אושר' },
                          { id: 'pending', label: 'בבדיקה' },
                          { id: 'rejected', label: 'נדחה' }, 
                          { id: 'cancelled', label: 'בוטל' },
                      ].map(f => {
                          const isActive = activeFilter === f.id;
                          return (
                            <button key={f.id} onClick={() => setActiveFilter(f.id)} 
                                className={`px-4 py-2 rounded-xl text-xs font-bold transition-all whitespace-nowrap flex-1 md:flex-none
                                ${isActive ? 'bg-[#00BCD4] text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'}`}>
                                {f.label}
                            </button>
                          )
                      })}
                  </div>

                  <div className="relative w-full md:w-72">
                      <input 
                        type="text" 
                        placeholder="חיפוש לפי שם טיול..." 
                        value={searchTerm} 
                        onChange={e => setSearchTerm(e.target.value)} 
                        className="w-full pl-4 pr-10 py-3 bg-white border border-gray-200 rounded-2xl text-sm font-bold focus:border-[#00BCD4] outline-none transition-all shadow-sm focus:ring-4 focus:ring-cyan-50"
                      />
                      <Search className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400" size={18}/>
                  </div>
              </div>

              <div className="grid grid-cols-1 gap-3">
                  {displayTrips.length === 0 ? (
                      <div className="py-20 text-center bg-white rounded-3xl border border-dashed border-gray-200 flex flex-col items-center">
                          <div className="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-3">
                              <History size={24} className="text-gray-300"/>
                          </div>
                          <span className="text-gray-400 font-bold">לא נמצאו טיולים</span>
                      </div>
                  ) : displayTrips.map(trip => {
                      const timeline = trip.details.timeline || [];
                      const statusStyle = getStatusStyles(trip.status);
                      const StatusIcon = statusStyle.icon;
                      const isDraft = trip.status === 'draft';
                      // בדיקה אם הטיול עבר (ללא אפשרות ביטול)
                      const isPast = new Date(trip.start_date) < new Date(new Date().setHours(0,0,0,0));
                      
                      const start = new Date(trip.start_date);
                      const diffTime = Math.abs((new Date(trip.details.endDate || trip.start_date)).getTime() - start.getTime());
                      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                      const isMultiDay = diffDays > 1;

                      const attractions = timeline.filter((t: any) => t.category === 'attraction').map((t: any) => t.finalSubCategory || t.details).filter(Boolean);
                      const uniqueAttractions = Array.from(new Set(attractions));

                      const sleeping = timeline.filter((t: any) => t.category === 'sleeping').map((t: any) => t.finalLocation || t.otherDetail).filter(Boolean);
                      const uniqueSleeping = Array.from(new Set(sleeping));

                      const allLocations = timeline.map((t: any) => t.finalLocation).filter(Boolean);
                      const uniqueLocations = Array.from(new Set(allLocations));
                      const locationsString = uniqueLocations.length > 0 ? uniqueLocations.join(' / ') : 'מיקום לא הוגדר';

                      const stepsCount = timeline.length;
                      const tripLink = isDraft ? '#' : `/dashboard/trip/${trip.id}`;

                      return (
                      <Link key={trip.id} href={tripLink} className={isDraft ? 'cursor-default' : ''}>
                          <div className={`bg-white border ${isDraft ? 'border-dashed border-gray-300 bg-gray-50/30' : 'border-gray-100'} ${isPast ? 'opacity-80 grayscale-[0.3]' : ''} rounded-3xl p-5 hover:border-[#00BCD4] transition-all group flex flex-col md:flex-row items-stretch gap-5 shadow-sm hover:shadow-md relative overflow-hidden`}>
                              
                              {/* קצוות */}
                              <div className={`absolute top-0 right-0 px-6 py-1.5 text-white font-bold text-xs rounded-bl-2xl shadow-sm ${getRibbonColor(trip.details.tripType)}`}>
                                  {trip.details.tripType} {trip.details.tripType === 'אחר' && trip.details.tripTypeOther ? `- ${trip.details.tripTypeOther}` : ''}
                              </div>

                              <div className={`absolute top-0 left-0 px-4 py-1.5 rounded-br-2xl shadow-sm flex items-center gap-1.5 font-bold text-xs ${statusStyle.bg} ${statusStyle.textCol}`}>
                                  <StatusIcon size={14}/>
                                  {statusStyle.text}
                              </div>

                              {/* תאריך */}
                              <div className={`flex flex-row md:flex-col items-center justify-center rounded-2xl px-6 py-4 w-full md:w-24 shrink-0 gap-3 md:gap-1 border group-hover:bg-cyan-50 group-hover:text-[#00BCD4] transition-colors mt-6 md:mt-0 ${isPast ? 'bg-gray-100 border-gray-200 text-gray-500' : 'bg-gray-50 border-gray-100 text-gray-800'}`}>
                                  <span className="text-3xl font-black leading-none">
                                      {start.getDate()}
                                  </span>
                                  <span className="text-[11px] font-bold uppercase tracking-wider opacity-70">
                                      {getMonthNameHebrew(trip.start_date)}
                                  </span>
                              </div>

                              {/* תוכן */}
                              <div className="flex-1 flex flex-col justify-center mt-2 md:mt-0 pt-4 md:pt-0">
                                  <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-2 mb-2 pt-2">
                                      <h3 className="text-xl font-black text-gray-800 group-hover:text-[#00BCD4] transition-colors leading-tight max-w-[70%]">
                                          {trip.name || 'ללא שם'}
                                      </h3>
                                      <div className="flex flex-wrap gap-2 pl-2">
                                          {uniqueAttractions.length > 0 && (
                                              <div className="flex items-center gap-1 bg-pink-50 text-pink-600 px-2 py-1 rounded-lg text-[10px] font-bold border border-pink-100 max-w-[150px]" title={uniqueAttractions.join(' / ')}>
                                                  <Ticket size={12} className="shrink-0"/>
                                                  <span className="truncate">{uniqueAttractions.join(' / ')}</span>
                                              </div>
                                          )}
                                          {uniqueSleeping.length > 0 && (
                                              <div className="flex items-center gap-1 bg-purple-50 text-purple-600 px-2 py-1 rounded-lg text-[10px] font-bold border border-purple-100 max-w-[150px]" title={uniqueSleeping.join(' / ')}>
                                                  <Tent size={12} className="shrink-0"/>
                                                  <span className="truncate">{uniqueSleeping.join(' / ')}</span>
                                              </div>
                                          )}
                                      </div>
                                  </div>
                                  
                                  <div className="flex flex-wrap items-center gap-3 text-xs font-medium text-gray-500">
                                      <div className="flex items-center gap-1.5 bg-gray-50 px-2 py-1 rounded-lg border border-gray-100">
                                          <Calendar size={14} className="text-[#E91E63]"/>
                                          <span className="font-bold">{formatHebrewDate(trip.start_date)}</span>
                                          <span className="text-gray-300">|</span>
                                          <span>{formatFullGregorianDate(trip.start_date)}</span>
                                          {isMultiDay && <span>- {formatFullGregorianDate(trip.details.endDate)}</span>}
                                      </div>
                                      <div className="flex items-center gap-1.5 bg-gray-50 px-2 py-1 rounded-lg border border-gray-100 max-w-[200px]" title={locationsString}>
                                          <MapPin size={14} className="text-[#00BCD4] shrink-0"/>
                                          <span className="truncate">{locationsString}</span>
                                      </div>
                                      {isMultiDay && (
                                          <div className="flex items-center gap-1.5 bg-blue-50 text-blue-600 px-2 py-1 rounded-lg border border-blue-100 font-bold">
                                              <Timer size={14}/> {diffDays} ימים
                                          </div>
                                      )}
                                      <div className="flex items-center gap-1.5 bg-gray-50 px-2 py-1 rounded-lg border border-gray-100">
                                          <Layers size={14} className="text-gray-400"/>
                                          <span>{stepsCount} שלבים</span>
                                      </div>
                                  </div>
                              </div>

                              {/* כפתורי פעולה */}
                              <div className="w-full md:w-auto flex items-center justify-end md:justify-center mt-4 md:mt-0 gap-3">
                                    {isDraft ? (
                                        <>
                                            <button 
                                                onClick={(e) => handleEditDraft(trip.id, e)} 
                                                className="flex items-center gap-1.5 bg-blue-50 text-blue-600 px-3 py-1.5 rounded-xl hover:bg-blue-100 transition-colors text-xs font-bold border border-blue-100 shadow-sm" 
                                                title="המשך עריכה"
                                            >
                                                <FileEdit size={16}/>
                                                <span>ערוך טיוטה</span>
                                            </button>
                                            <button 
                                                onClick={(e) => { e.preventDefault(); e.stopPropagation(); setDeleteDraftModal({show: true, tripId: trip.id}); }} 
                                                className="flex items-center gap-1.5 bg-red-50 text-red-600 px-3 py-1.5 rounded-xl hover:bg-red-100 transition-colors text-xs font-bold border border-red-100 shadow-sm" 
                                                title="מחק טיוטה"
                                            >
                                                <Trash2 size={16}/>
                                                <span>מחק</span>
                                            </button>
                                        </>
                                    ) : (
                                        <>
                                            {!isPast && trip.status !== 'cancelled' && (
                                                <button 
                                                    onClick={(e) => { e.preventDefault(); e.stopPropagation(); setCancelModal({show: true, tripId: trip.id}); }} 
                                                    className="flex items-center gap-1.5 bg-red-50 text-red-500 px-3 py-1.5 rounded-xl hover:bg-red-100 transition-colors text-xs font-bold border border-red-100 shadow-sm" 
                                                    title="ביטול פעילות"
                                                >
                                                    <Trash2 size={16}/>
                                                    <span>ביטול פעילות</span>
                                                </button>
                                            )}
                                            <div className="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 group-hover:bg-[#00BCD4] group-hover:text-white transition-all shadow-sm">
                                                <ArrowRight size={20}/>
                                            </div>
                                        </>
                                    )}
                              </div>
                          </div>
                      </Link>
                  )})}
              </div>
          </div>

      </div>
    </>
  )
}
</file>

<file path="app/dashboard/new-trip/page.tsx">
"use client"

import React, { useState, useEffect, useRef } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { Header } from '@/components/layout/Header'
import { 
  Calendar, MapPin, Bus, Tent, Utensils, Ticket, 
  AlertTriangle, Save, CheckCircle, FileUp, 
  Flag, ChevronDown, ChevronUp, Lock, Unlock, HelpCircle, 
  Check, Trash2, Loader2, Link as LinkIcon,
  Home, Navigation, MessageSquare, ArrowRight, FileEdit, Info, ArrowLeft
} from 'lucide-react'
import { useSearchParams } from 'next/navigation'

// ... (כל הקבועים והפונקציות העזר - אותו דבר כמו קודם) ...
// (כאן תדביק את הקבועים: ISRAEL_CITIES, GRADES, STAFF_AGES, TRIP_LOGIC, TRIP_TYPES_CONFIG, CATEGORIES)
// (ואת הפונקציות: toHebrewDay, getColorHex)

// --- קבועים ורשימות (מקוצר כדי לחסוך מקום, תשאיר את מה שהיה לך בקוד המלא הקודם) ---
// ... אנא השתמש בקוד המלא הקודם עבור הרשימות הארוכות ...
const ISRAEL_CITIES = ["ירושלים", "תל אביב", "חיפה", "רחובות", "כפר חב״ד", "צפת", "אילת", "טבריה", "נתניה", "אשדוד", "באר שבע", "לוד", "קריית מלאכי", "נחלת הר חב״ד", "נוף הגליל"].sort();
const GRADES = ['א׳', 'ב׳', 'ג׳', 'ד׳', 'ה׳', 'ו׳', 'ז׳', 'ח׳', 'ט׳', 'י׳', 'י״א', 'י״ב'];
const STAFF_AGES = ['גיל 13-18 (מד"צים)', 'מעל גיל 18', 'הורים מלווים', 'אחר'];

const TRIP_LOGIC: any = {
    "טיול מחוץ לסניף": { nameLabel: "שם הטיול", namePlaceholder: "לדוגמה: טיול לצפון", timelineTitle: "פירוט הטיול", minRows: 2 },
    "כנס/אירוע מחוץ לסניף": { nameLabel: "שם הפעילות", namePlaceholder: "לדוגמה: כנס סיום שנה", timelineTitle: "פירוט האירוע", minRows: 2 },
    "פעילות לא שגרתית בסניף": { nameLabel: "שם הפעילות", namePlaceholder: 'לדוגמה: התוועדות יו"ד שבט', timelineTitle: "פירוט הפעילות", minRows: 1 },
    "יציאה רגלית באזור הסניף": { nameLabel: "שם הפעילות", namePlaceholder: "לדוגמה: יציאה למבצעים", timelineTitle: "פירוט הפעילות", minRows: 2 },
    "אחר": { nameLabel: "שם הפעילות", namePlaceholder: 'לדוגמה: טיסה לרבי', timelineTitle: "פירוט הפעילות", minRows: 1 }
};

const TRIP_TYPES_CONFIG = [
    { id: "טיול מחוץ לסניף", label: "טיול מחוץ לסניף", icon: Bus, bg: "bg-blue-100", text: "text-blue-700", border: "border-blue-200" },
    { id: "כנס/אירוע מחוץ לסניף", label: "כנס/אירוע חוץ", icon: Ticket, bg: "bg-purple-100", text: "text-purple-700", border: "border-purple-200" },
    { id: "פעילות לא שגרתית בסניף", label: "פעילות לא שגרתית בסניף", icon: Home, bg: "bg-green-100", text: "text-green-700", border: "border-green-200" },
    { id: "יציאה רגלית באזור הסניף", label: "יציאה רגלית באזור הסניף", icon: Navigation, bg: "bg-orange-100", text: "text-orange-700", border: "border-orange-200" },
    { id: "אחר", label: "אחר...", icon: HelpCircle, bg: "bg-gray-100", text: "text-gray-700", border: "border-gray-200" }
];

const CATEGORIES: any = { 
  transport: { label: 'התניידות', icon: Bus, color: 'blue', options: [{ label: 'הליכה ביום', license: false }, { label: 'הליכה בלילה', license: false }, { label: 'נסיעה מאורגנת', license: false }, { label: 'תחבורה ציבורית', license: false }, { label: 'רכבת', license: false }, { label: 'רכבים פרטיים', license: false }, { label: 'אופניים', license: true }, { label: 'ג׳יפים', license: true }, { label: 'אחר', license: false }] }, 
  hiking: { label: 'מסלול בטבע', icon: Navigation, color: 'emerald', options: [{ label: 'מסלול יום', license: false }, { label: 'מסלול לילה', license: false }, { label: 'טיול ג׳יפים', license: true }, { label: 'אחר', license: false }] }, 
  attraction: { label: 'אטרקציה', icon: Ticket, color: 'pink', options: [{ label: 'פארק מים', license: true }, { label: 'קיאקים/רפטינג', license: true }, { label: 'שייט', license: true }, { label: 'בריכה', license: true }, { label: 'גלישה/סאפ', license: true }, { label: 'פארק חבלים', license: true }, { label: 'קיר טיפוס', license: true }, { label: 'טרקטורונים', license: true }, { label: 'פיינטבול', license: true }, { label: 'לונה פארק', license: true }, { label: 'קארטינג', license: true }, { label: 'מתקנים מתנפחים', license: true }, { label: 'איי ג\'אמפ', license: true }, { label: 'לייזר טאג', license: true }, { label: 'שייט טורנדו', license: true }, { label: 'מוזיאון', license: false }, { label: 'מרכז מבקרים', license: false }, { label: 'אתר מורשת', license: false }, { label: 'קבר צדיק', license: false }, { label: 'אחר', license: false }] }, 
  food: { label: 'אוכל', icon: Utensils, color: 'yellow', options: [{ label: 'הכנה עצמית', license: false }, { label: 'אוכל קנוי', license: false }, { label: 'מארזים סגורים קנויים', license: false }, { label: 'אוכל ביתי מבושל', license: false }, { label: 'קייטרינג', license: false }, { label: 'על האש', license: false }, { label: 'אחר', license: false }] }, 
  settlement: { label: 'פעילות ביישוב/מבנה', icon: Home, color: 'indigo', options: [{ label: 'פעילות בסניף', license: false }, { label: 'אירוע באולם', license: false }, { label: 'פעילות בבית כנסת', license: false }, { label: 'פעילות בבית חב״ד', license: false }, { label: 'פעילות במתנ״ס', license: false }, { label: 'פעילות בבית פרטי', license: false }, { label: 'פעילות בשטח פתוח', license: false }, { label: 'פעילות בשטח מגודר תחת כיפת השמיים', license: false }, { label: 'פארק/גינה', license: false }, { label: 'כנס', license: false }, { label: 'אחר', license: false }] },
  sleeping: { label: 'לינה', icon: Tent, color: 'purple', options: [{ label: 'לינת מבנה', license: false }, { label: 'לינת שטח', license: true }, { label: 'אחר', license: false }] }, 
  other: { label: 'אחר', icon: HelpCircle, color: 'gray', options: [{ label: 'פעילות כללית', license: false }, { label: 'טקס / התכנסות', license: false }, { label: 'זמן חופשי', license: false }, { label: 'אחר', license: false }] } 
};

const toHebrewDay = (day: number) => {
    const days = ['', 'א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ז', 'ח', 'ט', 'י', 'י"א', 'י"ב', 'י"ג', 'י"ד', 'ט"ו', 'ט"ז', 'י"ז', 'י"ח', 'י"ט', 'כ', 'כ"א', 'כ"ב', 'כ"ג', 'כ"ד', 'כ"ה', 'כ"ו', 'כ"ז', 'כ"ח', 'כ"ט', 'ל'];
    return days[day] || day;
};

const getColorHex = (colorName: string) => {
  const map: any = { blue: '#00BCD4', emerald: '#8BC34A', pink: '#E91E63', yellow: '#FFC107', indigo: '#3F51B5', purple: '#9C27B0', gray: '#9E9E9E', cyan: '#00BCD4', green: '#8BC34A' };
  return map[colorName] || '#00BCD4';
};

export default function NewTripPage() {
  const [user, setUser] = useState<any>(null);
  const [loading, setLoading] = useState(false);
  const [step, setStep] = useState(0); 
  const [userGender, setUserGender] = useState<'male' | 'female' | 'mixed'>('mixed');
  const searchParams = useSearchParams();
  const editId = searchParams.get('id'); // זיהוי אם אנחנו במצב עריכה
  
  const [isOtherSelected, setIsOtherSelected] = useState(false);
  const [tempOtherType, setTempOtherType] = useState('');

  // --- ניהול מודל מתקדם ---
  const [modalState, setModalState] = useState<{
      show: boolean;
      message: string;
      type: 'error' | 'success' | 'confirm' | 'info';
      onConfirm?: () => void;
  }>({ show: false, message: '', type: 'error' });
  
  const showModal = (type: 'error' | 'success' | 'confirm' | 'info', msg: string, onConfirm?: () => void) => {
      setModalState({ show: true, message: msg, type, onConfirm });
  };

  const handleModalClose = () => {
      setModalState(prev => ({ ...prev, show: false }));
      if (modalState.type === 'success' && modalState.message.includes('הצלחה')) {
          window.location.href = '/dashboard';
      }
  };

  const handleModalConfirm = () => {
      if (modalState.onConfirm) {
          modalState.onConfirm();
      }
      setModalState(prev => ({ ...prev, show: false }));
  };

  const [uploadingFileId, setUploadingFileId] = useState<string | null>(null); 
  const [isUploadingLicense, setIsUploadingLicense] = useState(false);
  const [isUploadingInsurance, setIsUploadingInsurance] = useState(false);
  
  const [expandedItem, setExpandedItem] = useState<string | null>(null);
  const [isRowsLocked, setIsRowsLocked] = useState(false);
  
  const [showLocationSuggestions, setShowLocationSuggestions] = useState(false);
  const [showCategoryDropdown, setShowCategoryDropdown] = useState(false);
  const [showSubCategoryDropdown, setShowSubCategoryDropdown] = useState(false);

  const startDateRef = useRef<HTMLInputElement>(null);
  const startTimeRef = useRef<HTMLInputElement>(null);
  const endDateRef = useRef<HTMLInputElement>(null);
  const endTimeRef = useRef<HTMLInputElement>(null);

  const [generalInfo, setGeneralInfo] = useState({ 
      name: '', 
      tripType: '', 
      tripTypeOther: '',
      startDate: '', 
      startTime: '08:00', 
      endDate: '', 
      endTime: '18:00', 
      gradeFrom: 'א', 
      gradeTo: 'ח', 
      chanichimCount: '', 
      totalTravelers: '', 
      staffAges: [] as string[], 
      staffOther: '', 
      generalComments: '' 
  });

  const [timeline, setTimeline] = useState<any[]>([]);
  
  const [currentLine, setCurrentLine] = useState({ 
    date: '', locationType: 'custom', locationValue: '', category: '', subCategory: '', 
    otherDetail: '', details: '', 
    licenseFile: null as {url: string, name: string} | null,
    insuranceFile: null as {url: string, name: string} | null
  });

  const [startHebrewDate, setStartHebrewDate] = useState('');
  const [endHebrewDate, setEndHebrewDate] = useState('');
  const [isUrgentError, setIsUrgentError] = useState(false);

  // --- התאמה מגדרית ---
  const checkGender = (dept: string) => {
      if (!dept) return 'mixed';
      if (['הפנסאים', 'התמים', 'בני חב"ד'].some(d => dept.includes(d))) return 'male';
      if (['בת מלך', 'בנות חב"ד', 'בנות חב״ד'].some(d => dept.includes(d))) return 'female';
      return 'mixed';
  };

  const t = (key: string) => {
      const dict: any = {
          'save_draft': { male: 'שמור כטיוטה', female: 'שמרי כטיוטה', mixed: 'שמור/שמרי כטיוטה' },
          'submit': { male: 'שלח בקשה', female: 'שלחי בקשה', mixed: 'שליחת בקשה' },
          'select_type': { male: 'בחר סוג פעילות', female: 'בחרי סוג פעילות', mixed: 'בחירת סוג פעילות' },
      };
      return dict[key]?.[userGender] || key;
  };

  const getHebrewDateString = (dateString: string) => {
      if (!dateString) return '';
      try {
          const date = new Date(dateString);
          const dayNum = parseInt(date.toLocaleDateString('he-IL', { calendar: 'hebrew', day: 'numeric' }));
          const dayLetters = toHebrewDay(dayNum);
          const monthName = date.toLocaleDateString('he-IL', { calendar: 'hebrew', month: 'long' });
          return `${dayLetters} ב${monthName}`;
      } catch (e) { return ''; }
  };

  useEffect(() => {
    const checkUser = async () => {
        const { data } = await supabase.auth.getUser();
        if (data?.user) {
            setUser(data.user);
            setUserGender(checkGender(data.user.user_metadata?.department));
        } else {
            window.location.href = '/';
        }
    };
    checkUser();
  }, []);

  // --- שליפת נתונים במצב עריכה ---
  useEffect(() => {
      const fetchTrip = async () => {
          if (!editId) return;
          setLoading(true);
          const { data, error } = await supabase.from('trips').select('*').eq('id', editId).single();
          if (data && !error) {
              // מילוי הנתונים מהדאטה בייס
              const d = data.details || {};
              setGeneralInfo({
                  name: data.name,
                  tripType: d.tripType,
                  tripTypeOther: d.tripTypeOther,
                  startDate: data.start_date,
                  startTime: d.startTime,
                  endDate: d.endDate,
                  endTime: d.endTime,
                  gradeFrom: d.gradeFrom,
                  gradeTo: d.gradeTo,
                  chanichimCount: d.chanichimCount,
                  totalTravelers: d.totalTravelers,
                  staffAges: d.staffAges || [],
                  staffOther: d.staffOther,
                  generalComments: d.generalComments
              });
              setTimeline(d.timeline || []);
              setStep(1); // דילוג על שלב הבחירה
          }
          setLoading(false);
      };
      fetchTrip();
  }, [editId]);

  useEffect(() => { 
    setStartHebrewDate(getHebrewDateString(generalInfo.startDate));
    setEndHebrewDate(getHebrewDateString(generalInfo.endDate));

    if (generalInfo.startDate && !currentLine.date) {
        setCurrentLine(prev => ({ ...prev, date: generalInfo.startDate }));
    }

    if (generalInfo.startDate) {
        const dateObj = new Date(generalInfo.startDate);
        const now = new Date();
        const diffTime = dateObj.getTime() - now.getTime();
        const diffHours = diffTime / (1000 * 3600);

        if (diffHours < 48 && diffTime > -86400000) {
            setIsUrgentError(true);
        } else {
            setIsUrgentError(false);
        }
    } else {
        setIsUrgentError(false);
    }
  }, [generalInfo.startDate, generalInfo.endDate]);

  const getNextDate = (d: string) => { if(!d) return ''; const x=new Date(d); x.setDate(x.getDate()+1); return x.toISOString().split('T')[0]; };
  const toggleStaffAge = (age: string) => setGeneralInfo(prev => ({ ...prev, staffAges: prev.staffAges.includes(age) ? prev.staffAges.filter(a => a !== age) : [...prev.staffAges, age] }));
  const isLicenseRequired = (cat: string, sub: string) => CATEGORIES[cat]?.options.find((o: any) => o.label === sub)?.license || false;

  const handleTypeSelect = (typeId: string) => {
      if (typeId === "אחר") {
          setIsOtherSelected(true);
      } else {
          setGeneralInfo(prev => ({ ...prev, tripType: typeId, tripTypeOther: '' }));
          setStep(1); 
          window.scrollTo(0,0);
      }
  };

  const submitOtherType = () => {
      if (!tempOtherType.trim()) return showModal('error', 'נא לפרט את סוג הפעילות');
      setGeneralInfo(prev => ({ ...prev, tripType: 'אחר', tripTypeOther: tempOtherType }));
      setStep(1);
      window.scrollTo(0,0);
  };

  const handleEndDateChange = (e: React.ChangeEvent<HTMLInputElement>) => {
      const newEnd = e.target.value;
      if (generalInfo.startDate && newEnd < generalInfo.startDate) {
          showModal('error', 'תאריך הסיום לא יכול להיות לפני תאריך ההתחלה.');
          setGeneralInfo(prev => ({ ...prev, endDate: '' }));
      } else {
          setGeneralInfo(prev => ({ ...prev, endDate: newEnd }));
      }
  };

  const handleAddLine = () => {
    if (!currentLine.category) return showModal('error', 'נא לבחור קטגוריה');
    if (!currentLine.subCategory) return showModal('error', 'נא לבחור פעילות');
    if (currentLine.locationType !== 'branch' && !currentLine.locationValue) return showModal('error', 'נא להזין מיקום');
    if (currentLine.subCategory === 'אחר' && !currentLine.otherDetail) return showModal('error', 'נא לפרט בשדה "אחר"');
    if (currentLine.subCategory === 'לינת מבנה' && !currentLine.otherDetail) return showModal('error', 'חובה להזין כתובת/שם מקום ללינה');

    // בדיקת חריגת תאריכים
    let nextDate = currentLine.date;
    let didDateChange = false;

    if (currentLine.category === 'sleeping') {
        const calculatedNextDate = getNextDate(currentLine.date);
        
        if (new Date(calculatedNextDate) > new Date(generalInfo.endDate)) {
            return showModal('error', `לא ניתן להוסיף לינה בתאריך זה.\nהטיול מוגדר להסתיים ב-${generalInfo.endDate.split('-').reverse().join('/')}.\nיש לעדכן את תאריכי הטיול בפרטים הכלליים למעלה.`);
        }
        
        nextDate = calculatedNextDate;
        didDateChange = true;
    }

    const needsLicense = isLicenseRequired(currentLine.category, currentLine.subCategory);
    
    const newLine = {
      id: Math.random().toString(36).substr(2, 9),
      ...currentLine,
      finalLocation: currentLine.locationType === 'branch' ? 'בסניף הקבוע' : currentLine.locationValue,
      finalSubCategory: currentLine.subCategory === 'אחר' ? currentLine.otherDetail : currentLine.subCategory,
      requiresLicense: needsLicense,
      licenseFile: currentLine.licenseFile,
      insuranceFile: currentLine.insuranceFile
    };
    
    setTimeline([...timeline, newLine]);
    setExpandedItem(null);

    if (didDateChange) {
        showModal('info', 'הוספת לינה: התאריך בשורה הבאה עודכן אוטומטית ליום המחרת.');
    }
    
    setCurrentLine({ 
        date: nextDate, locationType: 'custom', locationValue: '', category: '', subCategory: '', 
        otherDetail: '', details: '', licenseFile: null, insuranceFile: null
    });
  };

  const handleRemoveLine = (id: string, e: React.MouseEvent) => { e.stopPropagation(); setTimeline(timeline.filter(item => item.id !== id)); };

  const handleUpload = async (file: File, type: 'license' | 'insurance', itemId?: string) => {
    if(!file) return;
    
    if (itemId) {
        setUploadingFileId(`${itemId}_${type}`);
    } else {
        if(type === 'license') setIsUploadingLicense(true);
        else setIsUploadingInsurance(true);
    }

    try {
        const fileExt = file.name.split('.').pop();
        const storageName = `${user.id}/${Date.now()}_${type}_${Math.random().toString(36).substring(7)}.${fileExt}`;
        const { error } = await supabase.storage.from('trip-files').upload(storageName, file);
        if (error) throw error;
        const { data: { publicUrl } } = supabase.storage.from('trip-files').getPublicUrl(storageName);
        
        const fileObj = { url: publicUrl, name: file.name };
        
        if (itemId) {
            setTimeline(prev => prev.map(item => item.id === itemId ? { ...item, [type === 'license' ? 'licenseFile' : 'insuranceFile']: fileObj } : item));
        } else {
            setCurrentLine(prev => ({ ...prev, [type === 'license' ? 'licenseFile' : 'insuranceFile']: fileObj }));
        }
    } catch (e: any) { 
        showModal('error', 'שגיאה בהעלאה: ' + e.message); 
    } finally { 
        if (itemId) {
            setUploadingFileId(null); 
        } else { 
            if(type === 'license') setIsUploadingLicense(false); 
            else setIsUploadingInsurance(false); 
        } 
    }
  };

  const handleExistingLineDualUpload = async (event: any, itemId: string, type: 'license' | 'insurance') => {
    const file = event.target.files[0];
    if (!file) return;
    event.target.value = '';
    handleUpload(file, type, itemId);
  };

  const handleLockToggle = () => {
      const config = TRIP_LOGIC[generalInfo.tripType] || TRIP_LOGIC['אחר'];
      const minRows = config.minRows || 2;

      if (!isRowsLocked) {
          if (timeline.length < minRows) {
              return showModal('error', `לא ניתן לסיים הוספת שורות. בסוג פעילות זה נדרשות לפחות ${minRows} שורות בלו"ז.`);
          }
      }
      setIsRowsLocked(!isRowsLocked);
  };

  const executeSubmission = async (status: 'pending' | 'draft') => {
    setLoading(true);
    try {
        const tripData = {
            user_id: user.id, 
            coordinator_name: user.user_metadata.full_name, 
            branch: user.user_metadata.branch, 
            department: user.user_metadata.department,
            name: generalInfo.name || (status === 'draft' ? 'טיוטה ללא שם' : ''), 
            start_date: generalInfo.startDate || new Date().toISOString(), 
            status: status, 
            details: { ...generalInfo, timeline }
        };

        let error;
        if (editId) {
            // עדכון טיול קיים
            const { error: err } = await supabase.from('trips').update(tripData).eq('id', editId);
            error = err;
        } else {
            // יצירת חדש
            const { error: err } = await supabase.from('trips').insert([tripData]);
            error = err;
        }

        if (error) throw error;
        
        if (status === 'draft') {
            showModal('success', 'הטיוטה נשמרה בהצלחה!');
        } else {
            showModal('success', 'הטיול נשלח בהצלחה! תוך 48 שעות תתקבל תשובה.');
        }
    } catch(e: any) { showModal('error', 'שגיאה: ' + e.message); } 
    finally { setLoading(false); }
  };

  const handleSubmit = async () => {
    if (isUrgentError) return;
    if (!generalInfo.tripType || !generalInfo.name || !generalInfo.startDate || !generalInfo.endDate || !generalInfo.chanichimCount || !generalInfo.totalTravelers) return showModal('error', 'נא למלא את כל שדות החובה בפרטים הכלליים');
    if (timeline.length === 0) return showModal('error', 'יש להוסיף לפחות שורה אחת בפירוט הטיול');
    
    const config = TRIP_LOGIC[generalInfo.tripType] || TRIP_LOGIC['אחר'];
    const minRows = config.minRows || 2;
    if (timeline.length < minRows) return showModal('error', `נדרשות לפחות ${minRows} שורות בלו"ז.`);
    
    if (timeline.some(item => item.requiresLicense && (!item.licenseFile || !item.insuranceFile))) {
        showModal('confirm', 'יש פעילויות הדורשות אישורים שחסרים להן מסמכים. לשלוח בכל זאת?', () => executeSubmission('pending'));
        return;
    }
    executeSubmission('pending');
  };

  const handleSaveDraft = async () => {
      if (!generalInfo.tripType) return showModal('error', 'כדי לשמור טיוטה חובה לבחור לפחות את סוג הטיול');
      executeSubmission('draft');
  };

  const currentLineNeedsLicense = isLicenseRequired(currentLine.category, currentLine.subCategory);
  
  // שליפת הגדרות דינמיות
  const currentLogic = TRIP_LOGIC[generalInfo.tripType] || TRIP_LOGIC['אחר'];

  return (
    <>
      <Header title={step === 0 ? t('select_type') : (editId ? "עריכת טיול" : "הגשת טיול חדש")} />

      {/* מודלים */}
      {modalState.show && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm animate-fadeIn p-4">
              <div className={`bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center border-t-4 ${
                  modalState.type === 'success' ? 'border-[#8BC34A]' : 
                  modalState.type === 'confirm' ? 'border-[#FFC107]' : 
                  modalState.type === 'info' ? 'border-[#00BCD4]' : 'border-[#E91E63]'
              }`}>
                  <div className={`w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 ${
                      modalState.type === 'success' ? 'bg-green-50 text-[#8BC34A]' : 
                      modalState.type === 'confirm' ? 'bg-yellow-50 text-[#FFC107]' : 
                      modalState.type === 'info' ? 'bg-cyan-50 text-[#00BCD4]' : 'bg-red-50 text-[#E91E63]'
                  }`}>
                      {modalState.type === 'success' ? <CheckCircle size={32} /> : 
                       modalState.type === 'confirm' ? <HelpCircle size={32} /> : 
                       modalState.type === 'info' ? <Info size={32} /> : <AlertTriangle size={32} />}
                  </div>
                  <h3 className="font-black text-xl mb-2 text-gray-800">
                      {modalState.type === 'success' ? 'איזה יופי!' : 
                       modalState.type === 'confirm' ? 'רגע אחד...' : 
                       modalState.type === 'info' ? 'שים לב' : 'שגיאה'}
                  </h3>
                  <p className="text-gray-600 mb-6 text-sm font-medium leading-relaxed whitespace-pre-line">{modalState.message}</p>
                  <div className="flex gap-3">
                      {modalState.type === 'confirm' ? (
                          <>
                              <button onClick={handleModalClose} className="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-3 rounded-xl font-bold transition-colors">לא, אני רוצה לתקן</button>
                              <button onClick={handleModalConfirm} className="flex-1 bg-[#FFC107] hover:bg-yellow-500 text-white px-4 py-3 rounded-xl font-bold transition-colors shadow-lg shadow-yellow-100">כן, שלח בכל זאת</button>
                          </>
                      ) : (
                          <button onClick={handleModalClose} className={`text-white px-6 py-3 rounded-xl font-bold w-full transition-colors ${
                              modalState.type === 'success' ? 'bg-[#8BC34A] hover:bg-[#7CB342]' : 
                              modalState.type === 'info' ? 'bg-[#00BCD4] hover:bg-[#00ACC1]' : 'bg-[#E91E63] hover:bg-pink-600'
                          }`}>
                              {modalState.type === 'success' ? 'מעולה, תודה' : 'הבנתי'}
                          </button>
                      )}
                  </div>
              </div>
          </div>
      )}

      <div className="p-4 md:p-8 animate-fadeIn pb-32 max-w-[100vw] overflow-x-hidden">
        
        {/* שלב 0: בחירת סוג הפעילות - עיצוב חדש */}
        {step === 0 && (
            <div className="max-w-md mx-auto">
                <div className="text-center mb-8">
                    <h2 className="text-2xl font-black text-gray-800 mb-2">איזו פעילות מתכננים?</h2>
                    <p className="text-gray-500">בחרו את סוג הפעילות להתחלת התהליך</p>
                </div>
                
                <div className="flex flex-col gap-3">
                    {TRIP_TYPES_CONFIG.map(type => {
                        const Icon = type.icon;
                        
                        // מצב מיוחד ל"אחר" כשהוא נבחר
                        if (type.id === "אחר" && isOtherSelected) {
                            return (
                                <div key="other-input" className="bg-gray-50 p-4 rounded-2xl border border-gray-200 animate-fadeIn shadow-inner">
                                    <div className="flex gap-2">
                                        <input 
                                            type="text" 
                                            className="flex-1 px-3 py-2 rounded-xl border border-gray-300 text-sm focus:border-[#E91E63] outline-none"
                                            value={tempOtherType}
                                            onChange={e => setTempOtherType(e.target.value)}
                                            placeholder="נא לפרט..." 
                                            autoFocus
                                        />
                                        <button onClick={submitOtherType} className="bg-[#E91E63] text-white px-4 rounded-xl font-bold text-sm shadow-sm hover:bg-pink-600 transition-colors">
                                            המשך
                                        </button>
                                    </div>
                                    <button onClick={() => setIsOtherSelected(false)} className="text-xs text-gray-400 mt-2 hover:text-gray-600 underline">ביטול וחזרה</button>
                                </div>
                            );
                        }

                        return (
                            <button 
                                key={type.id} 
                                onClick={() => handleTypeSelect(type.id)}
                                className={`w-full p-4 rounded-2xl border ${type.border} ${type.bg} shadow-sm hover:shadow-md transition-all group flex flex-col items-center justify-center gap-2 hover:scale-[1.02]`}
                            >
                                <Icon size={24} className={type.text} />
                                <div className={`text-base font-black ${type.text}`}>{type.label}</div>
                            </button>
                        )
                    })}
                </div>
            </div>
        )}

        {/* שלב 1: מילוי הטופס המלא */}
        {step === 1 && (
            <>
                <button onClick={() => setStep(0)} className="flex items-center gap-1 text-gray-400 hover:text-[#00BCD4] mb-4 text-xs font-bold transition-colors">
                    <ArrowRight size={16} /> חזרה לבחירת סוג
                </button>

                {/* הצגת הסוג הנבחר */}
                <div className="mb-6 bg-white p-4 rounded-2xl border border-gray-100 flex items-center justify-between shadow-sm">
                    <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center shadow-sm ${TRIP_TYPES_CONFIG.find(t => t.id === generalInfo.tripType)?.bg || 'bg-gray-50'}`}>
                            {React.createElement(TRIP_TYPES_CONFIG.find(t => t.id === generalInfo.tripType)?.icon || Flag, { size: 20, className: TRIP_TYPES_CONFIG.find(t => t.id === generalInfo.tripType)?.text })}
                        </div>
                        <div>
                            <div className="text-xs text-gray-400 font-bold">סוג פעילות נבחר</div>
                            <div className="font-black text-gray-800 text-lg leading-tight">
                                {generalInfo.tripType === 'אחר' ? generalInfo.tripTypeOther : generalInfo.tripType}
                            </div>
                        </div>
                    </div>
                    <button onClick={() => setStep(0)} className="text-xs font-bold text-[#00BCD4] bg-cyan-50 px-3 py-1.5 rounded-lg hover:bg-cyan-100 transition-colors">שנה</button>
                </div>

                {/* חלק א: פרטים כלליים */}
                <section className="bg-white rounded-[32px] shadow-sm border border-gray-100 overflow-visible relative z-20 mb-8 animate-fadeIn">
                  <div className="bg-[#00BCD4] text-white h-12 flex items-center px-6 font-bold text-lg shadow-sm gap-2 rounded-t-3xl">
                        <Flag size={20} />
                        <span>פרטים כלליים</span>
                  </div>
                  
                  <div className="p-6 space-y-8">
                    <div className="grid grid-cols-1 md:grid-cols-12 gap-4 items-start">
                        
                        {/* שם הפעילות ותאריכים בשורה אחת */}
                        <div className="md:col-span-12 flex flex-col md:flex-row gap-4 w-full">
                            
                            {/* שם הפעילות (דינמי) */}
                            <div className="flex-1 w-full">
                                  <label className="text-xs font-bold text-gray-500 block mb-1">{currentLogic.nameLabel}</label>
                                  <input type="text" className="w-full px-3 rounded-xl border border-gray-200 focus:border-[#E91E63] focus:ring-1 focus:ring-[#E91E63] outline-none transition-all text-sm h-[60px]" 
                                      value={generalInfo.name} onChange={(e) => setGeneralInfo({...generalInfo, name: e.target.value})} placeholder={currentLogic.namePlaceholder} autoFocus />
                            </div>

                            {/* תאריכים ושעות */}
                            <div className="flex-1 grid grid-cols-2 gap-4 w-full">
                                {/* יציאה */}
                                <div>
                                    <label className="text-xs font-bold text-gray-500 block mb-1">התחלה</label>
                                    <div className="bg-gray-50 rounded-xl border border-gray-200 flex items-center h-[60px] focus-within:border-[#E91E63] focus-within:bg-white transition-colors overflow-hidden cursor-pointer" onClick={() => startDateRef.current?.showPicker()}>
                                         <div className="flex-1 px-3 border-r border-gray-200 relative h-full flex flex-col justify-center">
                                             <input ref={startDateRef} type="date" className="w-full bg-transparent text-sm font-bold text-gray-800 outline-none z-10 relative" 
                                                 value={generalInfo.startDate} onChange={(e) => setGeneralInfo({...generalInfo, startDate: e.target.value})} onClick={(e) => e.stopPropagation()} />
                                             <div className="text-[10px] text-[#00BCD4] font-bold leading-none mt-0.5 truncate">{startHebrewDate || '-'}</div>
                                         </div>
                                         <div className="w-24 h-full flex items-center justify-center bg-gray-50/50 relative z-20 hover:bg-gray-100 transition-colors" onClick={(e) => { e.stopPropagation(); startTimeRef.current?.showPicker(); }}>
                                             <input ref={startTimeRef} type="time" step="900" className="w-full h-full bg-transparent text-sm font-bold text-gray-800 outline-none text-center cursor-pointer" 
                                                 value={generalInfo.startTime} onChange={(e) => setGeneralInfo({...generalInfo, startTime: e.target.value})} />
                                         </div>
                                    </div>
                                </div>
                                {/* חזרה */}
                                <div>
                                    <label className="text-xs font-bold text-gray-500 block mb-1">סיום</label>
                                    <div className="bg-gray-50 rounded-xl border border-gray-200 flex items-center h-[60px] focus-within:border-[#E91E63] focus-within:bg-white transition-colors overflow-hidden cursor-pointer" onClick={() => endDateRef.current?.showPicker()}>
                                         <div className="flex-1 px-3 border-r border-gray-200 relative h-full flex flex-col justify-center">
                                             <input ref={endDateRef} type="date" className="w-full bg-transparent text-sm font-bold text-gray-800 outline-none z-10 relative" 
                                                 value={generalInfo.endDate} onChange={handleEndDateChange} onClick={(e) => e.stopPropagation()}/>
                                             <div className="text-[10px] text-[#00BCD4] font-bold leading-none mt-0.5 truncate">{endHebrewDate || '-'}</div>
                                         </div>
                                         <div className="w-24 h-full flex items-center justify-center bg-gray-50/50 relative z-20 hover:bg-gray-100 transition-colors" onClick={(e) => { e.stopPropagation(); endTimeRef.current?.showPicker(); }}>
                                             <input ref={endTimeRef} type="time" step="900" className="w-full h-full bg-transparent text-sm font-bold text-gray-800 outline-none text-center cursor-pointer" 
                                                 value={generalInfo.endTime} onChange={(e) => setGeneralInfo({...generalInfo, endTime: e.target.value})} />
                                         </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {isUrgentError && (
                        <div className="bg-red-50 border border-red-200 text-red-700 p-2 rounded-lg flex items-center gap-2 text-xs font-bold animate-fadeIn mt-2">
                            <AlertTriangle size={14} className="shrink-0"/>
                            <div>שגיאה: לא ניתן להגיש טיול פחות מ-48 שעות לפני היציאה.</div>
                        </div>
                    )}

                    <div className="h-px bg-gray-100"></div>

                    {/* שורה שניה - כמות וצוות */}
                    <div className="grid grid-cols-1 md:grid-cols-12 gap-4 items-start">
                        
                        <div className="md:col-span-3 w-full">
                            <label className="text-xs font-bold text-gray-500 block mb-1">שכבות גיל</label>
                            <div className="flex items-center gap-2 bg-gray-50 p-1 rounded-xl border border-gray-200 h-[60px] focus-within:border-[#E91E63] focus-within:bg-white transition-colors">
                                <select className="bg-transparent text-sm p-1 outline-none font-bold w-full cursor-pointer h-full text-gray-700" value={generalInfo.gradeFrom} onChange={(e) => setGeneralInfo({...generalInfo, gradeFrom: e.target.value})}>
                                    <option value="">מכיתה...</option>{GRADES.map(g => <option key={g} value={g}>כיתה {g}</option>)}
                                </select>
                                <span className="text-gray-300">-</span>
                                <select className="bg-transparent text-sm p-1 outline-none font-bold w-full cursor-pointer h-full text-gray-700" value={generalInfo.gradeTo} onChange={(e) => setGeneralInfo({...generalInfo, gradeTo: e.target.value})}>
                                    <option value="">עד כיתה...</option>{GRADES.map(g => <option key={g} value={g}>כיתה {g}</option>)}
                                </select>
                            </div>
                        </div>

                        <div className="md:col-span-2 w-full">
                            <label className="text-xs font-bold text-gray-500 block mb-1">ס"ה כמות חניכים</label>
                            <input type="number" className="w-full px-3 rounded-xl border border-gray-200 text-sm outline-none focus:border-[#E91E63] focus:bg-white h-[60px] transition-colors" value={generalInfo.chanichimCount} onChange={(e) => setGeneralInfo({...generalInfo, chanichimCount: e.target.value})} />
                        </div>

                        <div className="md:col-span-5 w-full relative bg-white rounded-xl border border-gray-100 p-2 min-h-[74px] flex flex-col justify-center group hover:border-pink-200 transition-colors">
                            <div className="flex items-center gap-2 px-1 mb-1">
                                <label className="text-xs font-bold text-gray-500 group-hover:text-[#E91E63] transition-colors">
                                    {currentLogic.staffLabel}
                                </label>
                                <span className="text-[10px] text-gray-400 font-normal">(ניתן לבחור מס' אפשרויות)</span>
                            </div>
                            
                            <div className="flex flex-wrap gap-1 items-center">
                                {STAFF_AGES.map(age => (
                                    <button key={age} onClick={() => toggleStaffAge(age)} 
                                        className={`px-2 py-1 rounded-full text-[10px] font-bold border transition-all flex items-center gap-1
                                        ${generalInfo.staffAges.includes(age) ? 'bg-[#E91E63] text-white border-[#E91E63] shadow-sm' : 'bg-white text-gray-500 border-gray-100 hover:bg-gray-100'}`}>
                                        {generalInfo.staffAges.includes(age) && <Check size={8}/>}
                                        {age}
                                    </button>
                                ))} 
                            </div>

                            {generalInfo.staffAges.includes('אחר') && (
                                <div className="absolute top-full left-0 right-0 mt-2 bg-white border border-pink-200 p-2 rounded-xl shadow-lg z-50 animate-fadeIn">
                                    <input type="text" placeholder="נא לפרט כאן..." className="w-full p-2 text-xs border-b border-gray-300 focus:border-[#E91E63] outline-none bg-gray-50 rounded" value={generalInfo.staffOther} onChange={(e) => setGeneralInfo({...generalInfo, staffOther: e.target.value})} autoFocus />
                                </div>
                            )}
                        </div>

                        <div className="md:col-span-2 w-full">
                            <label className="text-xs font-bold text-gray-500 block mb-1">ס"ה משתתפים</label>
                            <input type="number" className="w-full px-3 rounded-xl border border-gray-200 text-sm outline-none focus:border-[#E91E63] bg-[#E0F7FA] font-bold text-[#00BCD4] h-[60px] transition-colors" placeholder="חניכים + צוות" value={generalInfo.totalTravelers} onChange={(e) => setGeneralInfo({...generalInfo, totalTravelers: e.target.value})} />
                        </div>

                    </div>
                  </div>
                </section>

                {/* === חלק ב': פירוט הטיול === */}
                <section className="bg-white rounded-[32px] shadow-sm border border-gray-100 overflow-visible relative z-10 mb-8 animate-fadeIn">
                   <div className="bg-[#00BCD4] text-white h-12 flex items-center px-6 font-bold text-lg shadow-sm justify-between rounded-t-3xl">
                       <div className="flex items-center gap-2"><MapPin size={20}/> <span>{currentLogic.timelineTitle}</span></div>
                       <span className="text-xs bg-white/20 px-3 py-1 rounded-full">{timeline.length} שורות</span>
                   </div>
                   
                   <div className="p-6 space-y-4 bg-gray-50 rounded-b-3xl">
                      {timeline.map((item) => {
                          const catConfig = CATEGORIES[item.category];
                          const CatIcon = catConfig?.icon || Flag;
                          const isExpanded = expandedItem === item.id;
                          const colorClass = getColorHex(catConfig?.color);
                          const isMissingLicense = item.requiresLicense && (!item.licenseFile || !item.insuranceFile);

                          return (
                            <div key={item.id} className={`border rounded-xl overflow-hidden bg-white transition-all group shadow-sm hover:shadow-md ${isMissingLicense ? 'border-red-300 ring-1 ring-red-100' : 'border-gray-200 hover:border-[#E91E63]'}`}>
                                
                                {/* שורה סגורה */}
                                <div className="flex flex-col md:flex-row items-start md:items-center gap-4 p-4 cursor-pointer" onClick={() => setExpandedItem(isExpanded ? null : item.id)}>
                                    <div className="flex items-center gap-4 w-full md:w-auto">
                                        <div className={`p-3 rounded-xl text-white shadow-sm`} style={{backgroundColor: colorClass}}><CatIcon size={20} /></div>
                                        <div className="text-xs font-bold w-24 text-gray-500 bg-gray-50 border px-2 py-1.5 rounded-lg text-center flex flex-col justify-center">
                                            <span className="text-[10px] text-gray-400">תאריך</span>
                                            {item.date ? `${item.date.split('-')[2]}/${item.date.split('-')[1]}` : '-'}
                                        </div>
                                        {/* חץ למובייל */}
                                        <div className="md:hidden text-gray-300 ml-auto">
                                            {isExpanded ? <ChevronUp size={20}/> : <ChevronDown size={20}/>}
                                        </div>
                                    </div>

                                    <div className="flex-1 w-full pl-8 md:pl-0">
                                        <div className="text-sm font-black text-gray-800">{item.finalSubCategory}</div>
                                        <div className="text-xs text-gray-500 flex items-center gap-1 mt-0.5"><MapPin size={12} className="text-[#E91E63]"/> {item.finalLocation}</div>
                                    </div>
                                    
                                    {item.requiresLicense && (
                                     <div className={`text-xs px-3 py-1 rounded-full border items-center gap-1.5 font-bold flex w-fit
                                        ${(item.licenseFile && item.insuranceFile) ? 'bg-green-50 text-green-700 border-green-200' : 'bg-red-50 text-red-700 border-red-200'}`}>
                                        {(item.licenseFile && item.insuranceFile) ? <CheckCircle size={12}/> : <AlertTriangle size={12}/>}
                                        <span>{(item.licenseFile && item.insuranceFile) ? 'יש אישורים' : 'חסרים אישורים'}</span>
                                     </div>
                                    )}
                                    
                                    {/* חץ למחשב */}
                                    <div className="hidden md:block text-gray-300 group-hover:text-[#E91E63] transition-colors">{isExpanded ? <ChevronUp size={20}/> : <ChevronDown size={20}/>}</div>
                                </div>

                                {/* שורה פתוחה */}
                                {isExpanded && (
                                    <div className="p-5 border-t border-gray-100 bg-white animate-fadeIn">
                                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm mb-4">
                                        <div><span className="block text-xs font-bold text-gray-400 mb-1">מיקום מדויק</span><div className="p-3 bg-white rounded-xl border border-gray-200 shadow-sm">{item.finalLocation}</div></div>
                                        <div><span className="block text-xs font-bold text-gray-400 mb-1">פרטים נוספים</span><div className="p-3 bg-white rounded-xl border border-gray-200 shadow-sm min-h-[46px]">{item.details || '-'}</div></div>
                                      </div>
                                      
                                      {item.requiresLicense && (
                                        <div className="bg-orange-50 border border-orange-200 rounded-xl p-4">
                                            <div className="flex items-center gap-2 text-orange-900 text-xs font-bold mb-3">
                                                 <AlertTriangle size={16} className="text-orange-600"/>
                                                 <span>מסמכים מצורפים לפעילות זו:</span>
                                            </div>
                                            
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                 <div className={`p-3 rounded-xl border flex items-center justify-between gap-2 ${item.licenseFile ? 'bg-green-50 border-green-200' : 'bg-white border-orange-200'}`}>
                                                     <div className="text-xs truncate flex-1">
                                                         <span className="block font-bold text-gray-500 mb-0.5">רישוי עסק:</span>
                                                         {item.licenseFile ? <a href={item.licenseFile.url} target="_blank" rel="noreferrer" className="text-green-700 font-bold hover:underline flex items-center gap-1"><LinkIcon size={12}/> {item.licenseFile.name}</a> : <span className="text-red-500 font-bold">חסר קובץ!</span>}
                                                     </div>
                                                     <label className="cursor-pointer p-2 bg-white border border-gray-200 rounded-lg hover:border-[#E91E63] text-gray-400 hover:text-[#E91E63] transition-colors shadow-sm">
                                                         {uploadingFileId === `${item.id}_license` ? <Loader2 size={16} className="animate-spin"/> : <FileUp size={16}/>}
                                                         <input type="file" className="hidden" accept=".pdf,.jpg,.jpeg,.png" onChange={(e) => handleExistingLineDualUpload(e, item.id, 'license')} disabled={!!uploadingFileId} />
                                                     </label>
                                                 </div>

                                                 <div className={`p-3 rounded-xl border flex items-center justify-between gap-2 ${item.insuranceFile ? 'bg-green-50 border-green-200' : 'bg-white border-orange-200'}`}>
                                                     <div className="text-xs truncate flex-1">
                                                         <span className="block font-bold text-gray-500 mb-0.5">ביטוח:</span>
                                                         {item.insuranceFile ? <a href={item.insuranceFile.url} target="_blank" rel="noreferrer" className="text-green-700 font-bold hover:underline flex items-center gap-1"><LinkIcon size={12}/> {item.insuranceFile.name}</a> : <span className="text-red-500 font-bold">חסר קובץ!</span>}
                                                     </div>
                                                     <label className="cursor-pointer p-2 bg-white border border-gray-200 rounded-lg hover:border-[#E91E63] text-gray-400 hover:text-[#E91E63] transition-colors shadow-sm">
                                                         {uploadingFileId === `${item.id}_insurance` ? <Loader2 size={16} className="animate-spin"/> : <FileUp size={16}/>}
                                                         <input type="file" className="hidden" accept=".pdf,.jpg,.jpeg,.png" onChange={(e) => handleExistingLineDualUpload(e, item.id, 'insurance')} disabled={!!uploadingFileId} />
                                                     </label>
                                                 </div>
                                            </div>
                                        </div>
                                      )}
                                      
                                      <div className="mt-4 flex justify-end"><button onClick={(e) => handleRemoveLine(item.id, e)} className="text-[#E91E63] text-xs font-bold flex items-center gap-1 hover:bg-pink-50 px-3 py-1.5 rounded-lg transition-colors border border-transparent hover:border-pink-100"><Trash2 size={16} /> הסר שורה</button></div>
                                    </div>
                                )}
                            </div>
                          )
                      })}

                      {!isRowsLocked && (
                        <div className="bg-white p-5 rounded-2xl border-2 border-[#E91E63] border-dashed shadow-sm animate-fadeIn mt-4 relative">
                            <div className="absolute -top-3 right-4 bg-white px-2 text-xs font-bold text-[#E91E63]">הוספת שורה חדשה</div>
                            
                            {/* המהפך: גריד אנכי בטלפון */}
                            <div className="grid grid-cols-1 md:grid-cols-12 gap-2 items-end">
                                
                                {/* 1. תאריך */}
                                <div className="md:col-span-1 w-full">
                                    <label className="text-[10px] font-bold text-gray-400 mb-1 block">תאריך</label>
                                    <div className="w-full text-xs p-2 rounded-xl border border-gray-100 bg-gray-100 text-gray-500 h-[48px] flex items-center justify-center font-bold select-none cursor-default whitespace-nowrap overflow-hidden text-ellipsis">
                                        {currentLine.date ? `${currentLine.date.split('-')[2]}/${currentLine.date.split('-')[1]}/${currentLine.date.split('-')[0]}` : '-'}
                                    </div>
                                </div>
                                
                                {/* 2. מיקום */}
                                <div className="md:col-span-2 relative w-full">
                                    <label className="text-[10px] font-bold text-gray-400 mb-1 block">מיקום</label>
                                    <div className="relative">
                                        <input type="text" className={`w-full text-sm p-3 rounded-xl border outline-none h-[48px] transition-colors ${currentLine.locationType === 'branch' ? 'bg-pink-50 border-pink-200 text-[#E91E63] font-bold cursor-not-allowed' : 'bg-gray-50 border-gray-200 focus:border-[#E91E63] focus:bg-white'}`} placeholder="הזן מיקום" value={currentLine.locationValue} readOnly={currentLine.locationType === 'branch'} 
                                            onFocus={() => { if (currentLine.locationType !== 'branch') setShowLocationSuggestions(true); }}
                                            onChange={e => { setCurrentLine({...currentLine, locationValue: e.target.value, locationType: 'custom'}); setShowLocationSuggestions(true); }}
                                            onBlur={() => setTimeout(() => setShowLocationSuggestions(false), 200)}
                                        />
                                        {currentLine.locationType === 'branch' && (
                                            <div onClick={() => setCurrentLine({...currentLine, locationValue: '', locationType: 'custom'})} className="absolute top-full right-0 mt-1 text-[10px] text-red-400 font-bold cursor-pointer hover:text-red-600 hover:underline z-10 w-full text-center">לחץ להזנת מיקום אחר</div>
                                        )}
                                        {showLocationSuggestions && currentLine.locationType !== 'branch' && (
                                            <div className="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-xl z-50 max-h-48 overflow-y-auto">
                                                <div className="p-2 text-xs font-bold text-[#E91E63] hover:bg-pink-50 cursor-pointer border-b border-gray-100 flex items-center gap-2" onClick={() => setCurrentLine({...currentLine, locationValue: 'בסניף הקבוע', locationType: 'branch'})}><Home size={14} />הסניף הקבוע</div>
                                                {currentLine.locationValue.length >= 1 && ISRAEL_CITIES.filter(city => city.includes(currentLine.locationValue) && city !== currentLine.locationValue).map(city => (<div key={city} className="p-2 text-xs text-gray-700 hover:bg-gray-50 cursor-pointer border-b border-gray-50" onClick={() => setCurrentLine({...currentLine, locationValue: city, locationType: 'city'})}>{city}</div>))}
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* 3. התרחשות + פירוט */}
                                <div className="md:col-span-5 flex flex-col md:flex-row gap-2 w-full">
                                    <div className="flex-1 relative">
                                        <label className="text-[10px] font-bold text-gray-400 mb-1 block">התרחשות</label>
                                        <div className="w-full text-xs p-2 rounded-xl border border-gray-200 hover:border-[#E91E63] bg-gray-50 hover:bg-white cursor-pointer h-[48px] flex items-center justify-between px-3 transition-all" onClick={() => setShowCategoryDropdown(!showCategoryDropdown)}>
                                            <span className={`font-bold ${currentLine.category ? 'text-gray-800' : 'text-gray-400'}`}>{CATEGORIES[currentLine.category]?.label || 'בחר...'}</span><ChevronDown size={16} className="text-gray-400" />
                                        </div>
                                        {showCategoryDropdown && (
                                            <div className="absolute top-full right-0 w-48 mt-1 bg-white border border-gray-200 rounded-xl shadow-2xl z-[100] overflow-hidden">
                                                {Object.entries(CATEGORIES).map(([key, val]: any, index) => {
                                                    const Icon = val.icon; const colors = ['text-[#00BCD4]', 'text-[#8BC34A]', 'text-[#E91E63]']; const bgs = ['hover:bg-cyan-50', 'hover:bg-green-50', 'hover:bg-pink-50'];
                                                    return (<div key={key} className={`p-3 text-xs text-gray-700 ${bgs[index % 3]} cursor-pointer border-b border-gray-50 flex items-center gap-3 transition-colors`} onClick={() => { setCurrentLine({...currentLine, category: key, subCategory: '', otherDetail: ''}); setShowCategoryDropdown(false); }}><Icon size={16} className={colors[index % 3]} /><span className="font-bold">{val.label}</span></div>)
                                                })}
                                            </div>
                                        )}
                                        {showCategoryDropdown && <div className="fixed inset-0 z-[90] cursor-default" onClick={() => setShowCategoryDropdown(false)}></div>}
                                    </div>
                                    <div className="flex-[1.5] relative">
                                        <label className="text-[10px] font-bold text-gray-400 mb-1 block">פירוט ההתרחשות</label>
                                        {currentLine.subCategory === 'אחר' ? (
                                            <div className="relative"><input type="text" className="w-full text-xs p-2 rounded-xl border border-gray-200 focus:border-[#E91E63] outline-none bg-white h-[48px]" placeholder="פרט..." autoFocus value={currentLine.otherDetail} onChange={e => setCurrentLine({...currentLine, otherDetail: e.target.value})} /><div className="absolute left-2 top-1/2 -translate-y-1/2 text-xs text-gray-400 cursor-pointer font-bold" onClick={() => setCurrentLine({...currentLine, subCategory: ''})}>X</div></div>
                                        ) : (
                                            <><div className={`w-full text-xs p-2 rounded-xl border border-gray-200 h-[48px] flex items-center justify-between px-3 transition-all ${!currentLine.category ? 'bg-gray-100 cursor-not-allowed opacity-50' : 'hover:border-[#E91E63] bg-gray-50 hover:bg-white cursor-pointer'}`} onClick={() => { if(currentLine.category) setShowSubCategoryDropdown(!showSubCategoryDropdown) }}><span className={`font-bold ${currentLine.subCategory ? 'text-gray-800' : 'text-gray-400'}`}>{currentLine.subCategory || (currentLine.category ? 'בחר פירוט...' : '-')}</span><ChevronDown size={16} className="text-gray-400" /></div>
                                            {showSubCategoryDropdown && currentLine.category && (
                                                <div className="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-2xl z-[100] overflow-hidden max-h-48 overflow-y-auto">{CATEGORIES[currentLine.category]?.options.map((opt: any) => (<div key={opt.label} className="p-3 text-xs text-gray-700 hover:bg-pink-50 hover:text-[#E91E63] cursor-pointer border-b border-gray-50 font-bold transition-colors" onClick={() => { setCurrentLine({...currentLine, subCategory: opt.label}); setShowSubCategoryDropdown(false); }}>{opt.label}</div>))}</div>
                                            )}
                                            {showSubCategoryDropdown && <div className="fixed inset-0 z-[90] cursor-default" onClick={() => setShowSubCategoryDropdown(false)}></div>}</>
                                        )}
                                    </div>
                                </div>

                                {/* 4. פרטים וכפתור הוספה */}
                                <div className="md:col-span-4 flex gap-2 items-end w-full">
                                    {currentLine.subCategory === 'לינת מבנה' ? (
                                        <div className="flex-grow flex flex-col md:flex-row gap-2">
                                            <div className="flex-1"><label className="text-[10px] font-bold text-red-400 mb-1 block">שם המקום/כתובת (חובה)</label><input type="text" className="w-full text-xs p-3 rounded-xl border border-red-200 bg-red-50 focus:border-red-400 focus:bg-white outline-none h-[48px]" placeholder="שם המקום/כתובת" value={currentLine.otherDetail} onChange={e => setCurrentLine({...currentLine, otherDetail: e.target.value})} /></div>
                                            <div className="flex-1"><label className="text-[10px] font-bold text-gray-400 mb-1 block">פרטים נוספים</label><input type="text" className="w-full text-xs p-3 rounded-xl border border-gray-200 focus:border-[#E91E63] outline-none bg-gray-50 focus:bg-white h-[48px]" placeholder="הערות..." value={currentLine.details} onChange={e => setCurrentLine({...currentLine, details: e.target.value})} /></div>
                                        </div>
                                    ) : (
                                        <div className="flex-grow relative w-full">
                                            <div className="flex justify-between items-end mb-1"><label className="text-[10px] font-bold text-gray-400 block">{currentLine.category === 'hiking' ? 'פירוט המסלול' : 'פרטים נוספים'}</label>{currentLine.category === 'hiking' && (<a href="https://mokedteva.co.il/InfoCenter/TrackWizard" target="_blank" rel="noreferrer" className="text-[10px] font-bold text-[#E91E63] flex items-center gap-1 hover:underline"><LinkIcon size={10} />לכניסה לאשף המסלולים של מוקד טבע</a>)}</div>
                                            <input type="text" className="w-full text-xs p-3 rounded-xl border border-gray-200 focus:border-[#E91E63] outline-none bg-gray-50 focus:bg-white h-[48px]" placeholder={currentLine.category === 'hiking' ? 'מס\' המסלול וכו\'' : 'פרטים נוספים...'} value={currentLine.details} onChange={e => setCurrentLine({...currentLine, details: e.target.value})} />
                                        </div>
                                    )}
                                    <div className="w-full md:w-auto mt-2 md:mt-0">
                                        <button onClick={handleAddLine} className="bg-[#8BC34A] hover:bg-[#7CB342] text-white h-[48px] w-full md:w-[48px] rounded-xl flex items-center justify-center shadow-lg transition-all active:scale-95 flex-shrink-0 mb-[1px]" title="לאישור השורה ופתיחת שורה חדשה">
                                            <Check size={28} strokeWidth={3} />
                                            <span className="md:hidden mr-2 font-bold">הוסף שורה ללו"ז</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            {/* אזור העלאת קבצים החדש */}
                            {currentLineNeedsLicense && (
                                <div className="mt-3 bg-orange-50 border border-orange-200 rounded-xl p-3 flex flex-col gap-3 animate-fadeIn">
                                    <div className="flex items-center gap-2 text-orange-900 text-xs font-bold">
                                        <AlertTriangle size={18} className="text-orange-600"/>
                                        <span>פעילות זו דורשת אישורים. חובה להעלות את שני המסמכים הבאים:</span>
                                    </div>
                                    <div className="flex flex-col sm:flex-row gap-3">
                                        <label className={`flex-1 cursor-pointer bg-white border px-4 py-3 rounded-xl text-xs font-bold hover:shadow-md transition-all flex items-center justify-center gap-2 shadow-sm ${currentLine.licenseFile ? 'border-green-300 text-green-700 bg-green-50' : 'border-orange-200 text-orange-700 hover:bg-orange-100'}`}>
                                            {isUploadingLicense ? <Loader2 size={16} className="animate-spin" /> : currentLine.licenseFile ? <CheckCircle size={16}/> : <FileUp size={16} />} 
                                            {isUploadingLicense ? 'מעלה...' : currentLine.licenseFile ? `רישוי: ${currentLine.licenseFile?.name}` : 'העלאת רישוי עסק (חובה)'}
                                            <input type="file" className="hidden" accept=".pdf,.jpg,.jpeg,.png" onChange={(e) => handleUpload(e.target.files![0], 'license')} disabled={isUploadingLicense} />
                                        </label>
                                        <label className={`flex-1 cursor-pointer bg-white border px-4 py-3 rounded-xl text-xs font-bold hover:shadow-md transition-all flex items-center justify-center gap-2 shadow-sm ${currentLine.insuranceFile ? 'border-green-300 text-green-700 bg-green-50' : 'border-orange-200 text-orange-700 hover:bg-orange-100'}`}>
                                            {isUploadingInsurance ? <Loader2 size={16} className="animate-spin" /> : currentLine.insuranceFile ? <CheckCircle size={16}/> : <FileUp size={16} />} 
                                            {isUploadingInsurance ? 'מעלה...' : currentLine.insuranceFile ? `ביטוח: ${currentLine.insuranceFile?.name}` : 'העלאת ביטוח (חובה)'}
                                            <input type="file" className="hidden" accept=".pdf,.jpg,.jpeg,.png" onChange={(e) => handleUpload(e.target.files![0], 'insurance')} disabled={isUploadingInsurance} />
                                        </label>
                                    </div>
                                </div>
                            )}
                        </div>
                      )}
                      
                      <div className="flex justify-center pt-4 pb-20">
                          <button onClick={handleLockToggle} className={`text-xs flex items-center gap-2 px-6 py-2 rounded-full border transition-all font-bold ${isRowsLocked ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-[#E91E63] border-[#E91E63] hover:bg-[#E91E63] hover:text-white'}`}>
                              {isRowsLocked ? <><Lock size={14}/> מצב צפייה (לחץ לעריכה)</> : <><Unlock size={14}/> סיום הוספת שורות</>}
                          </button>
                      </div>
                   </div>
                </section>

                {/* === חלק ג': הערות וסיום === */}
                <section className="bg-white rounded-[32px] shadow-sm border border-gray-100 overflow-hidden mb-24 animate-fadeIn">
                    <div className="bg-[#00BCD4] text-white h-12 flex items-center px-6 font-bold text-lg shadow-sm gap-2">
                       <MessageSquare size={20} />
                       <span>הערות</span>
                    </div>
                    
                    <div className="p-6">
                         <label className="block text-sm font-bold text-gray-700 mb-2">משהו שחשוב לך שנדע</label>
                         <textarea className="w-full p-4 rounded-xl bg-gray-50 border border-gray-200 outline-none focus:border-[#E91E63] focus:ring-1 focus:ring-[#E91E63] min-h-[100px] resize-y" placeholder="דגשים מיוחדים, בקשות וכו'..." value={generalInfo.generalComments} onChange={(e) => setGeneralInfo({...generalInfo, generalComments: e.target.value})}></textarea>
                    </div>
                </section>
                
                {/* Footer Actions - דביק למטה במובייל */}
                <div className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-gray-100 p-4 z-40 transition-all md:pr-64">
                    <div className="max-w-6xl mx-auto flex flex-col md:flex-row justify-end gap-3">
                        {isUrgentError && <div className="bg-red-50 text-red-600 px-4 py-3 rounded-2xl text-xs font-bold flex items-center justify-center gap-2"><AlertTriangle size={16}/> תאריך היציאה קרוב מדי!</div>}
                        
                        {/* כפתור שמירה כטיוטה */}
                        <button onClick={handleSaveDraft} disabled={loading} className="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3.5 rounded-2xl font-bold text-base shadow-sm transition-all flex items-center justify-center gap-2 transform hover:-translate-y-1">
                            {loading ? <Loader2 size={20} className="animate-spin" /> : <FileEdit size={20} />}
                            <span>{t('save_draft')}</span>
                        </button>

                        {/* כפתור שליחה */}
                        <button onClick={handleSubmit} disabled={loading || isUrgentError} className={`bg-[#8BC34A] hover:bg-[#7CB342] text-white px-8 py-3.5 rounded-2xl font-black text-lg shadow-lg hover:shadow-green-200 transition-all flex items-center justify-center gap-3 transform hover:-translate-y-1 ${loading || isUrgentError ? 'opacity-50 cursor-not-allowed grayscale' : ''}`}>
                            {loading ? 'שולח...' : (<><span>{t('submit')}</span><Save size={20} /></>)}
                        </button>
                    </div>
                </div>
            </>
        )}

      </div>
      
      <style jsx>{`@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } .animate-fadeIn { animation: fadeIn 0.3s ease-out; }`}</style>
    </>
  )
}
</file>

<file path="app/dashboard/page.tsx">
"use client"

import React, { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { Header } from '@/components/layout/Header'
import { 
  Loader2, Clock, CheckCircle, Search, 
  MapPin, ShieldAlert, Sun, ArrowRight, Calendar,
  Tent, Ticket, Layers, Timer, AlertTriangle, FileEdit, Trash2, XCircle, HelpCircle
} from 'lucide-react'
import Link from 'next/link'
import { useRouter } from 'next/navigation'

// --- פונקציות עזר לתאריכים ---

const toHebrewDay = (day: number) => {
    const days = ['', 'א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ז', 'ח', 'ט', 'י', 'י"א', 'י"ב', 'י"ג', 'י"ד', 'ט"ו', 'ט"ז', 'י"ז', 'י"ח', 'י"ט', 'כ', 'כ"א', 'כ"ב', 'כ"ג', 'כ"ד', 'כ"ה', 'כ"ו', 'כ"ז', 'כ"ח', 'כ"ט', 'ל'];
    return days[day] || day;
};

const formatHebrewYear = (yearNum: number) => {
    let year = yearNum % 1000; 
    let str = '';
    if (year >= 400) { str += 'ת'; year -= 400; }
    if (year >= 300) { str += 'ש'; year -= 300; }
    if (year >= 200) { str += 'ר'; year -= 200; }
    if (year >= 100) { str += 'ק'; year -= 100; }
    if (year >= 90) { str += 'צ'; year -= 90; }
    if (year >= 80) { str += 'פ'; year -= 80; }
    if (year >= 70) { str += 'ע'; year -= 70; }
    if (year >= 60) { str += 'ס'; year -= 60; }
    if (year >= 50) { str += 'נ'; year -= 50; }
    if (year >= 40) { str += 'מ'; year -= 40; }
    if (year >= 30) { str += 'ל'; year -= 30; }
    if (year >= 20) { str += 'כ'; year -= 20; }
    if (year >= 10) { str += 'י'; year -= 10; }
    const units = ['', 'א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ז', 'ח', 'ט'];
    if (year > 0) str += units[year];
    if (str.length > 1) { str = str.slice(0, -1) + '"' + str.slice(-1); } else { str += "'"; }
    return str;
};

const formatHebrewDate = (dateString: string) => {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        const hebrewYearNum = date.getFullYear() + 3760;
        const yearLetters = formatHebrewYear(hebrewYearNum);
        const dayNum = parseInt(date.toLocaleDateString('he-IL', { calendar: 'hebrew', day: 'numeric' }));
        const dayLetters = toHebrewDay(dayNum);
        const monthName = date.toLocaleDateString('he-IL', { calendar: 'hebrew', month: 'long' });
        return `${dayLetters} ב${monthName} ${yearLetters}`;
    } catch (e) { return ''; }
};

const formatFullGregorianDate = (dateString: string) => {
    if (!dateString) return '';
    return new Date(dateString).toLocaleDateString('he-IL', { day: 'numeric', month: 'long', year: 'numeric' });
};

const getMonthNameHebrew = (dateString: string) => {
    if (!dateString) return '';
    return new Date(dateString).toLocaleDateString('he-IL', { month: 'long' });
};

const getRibbonColor = (type: string) => {
    if (!type) return 'bg-gray-500';
    if (type.includes('סמינר')) return 'bg-purple-600';
    if (type.includes('מחנה')) return 'bg-green-600';
    if (type.includes('טיול')) return 'bg-[#00BCD4]';
    return 'bg-blue-600';
};

const getStatusStyles = (status: string) => {
    const config: any = {
        approved: { text: 'מאושר', bg: 'bg-green-100', textCol: 'text-green-700', icon: CheckCircle },
        pending: { text: 'ממתין לבדיקה', bg: 'bg-amber-100', textCol: 'text-amber-700', icon: Clock },
        rejected: { text: 'לא אושר', bg: 'bg-red-100', textCol: 'text-red-700', icon: AlertTriangle },
        draft: { text: 'טיוטה', bg: 'bg-gray-100', textCol: 'text-gray-600', icon: FileEdit },
        cancelled: { text: 'בוטל', bg: 'bg-stone-100', textCol: 'text-stone-500', icon: XCircle }
    };
    return config[status] || config.pending;
};

export default function DashboardPage() {
  const router = useRouter();
  const [loading, setLoading] = useState(true);
  const [trips, setTrips] = useState<any[]>([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [activeFilter, setActiveFilter] = useState('all');
  
  // מודלים
  const [cancelModal, setCancelModal] = useState<{show: boolean, tripId: string | null}>({show: false, tripId: null});
  const [deleteDraftModal, setDeleteDraftModal] = useState<{show: boolean, tripId: string | null}>({show: false, tripId: null});
  const [cancelReason, setCancelReason] = useState('');

  const fetchTrips = async () => {
      setLoading(true);
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { window.location.href = '/'; return; }
      
      try {
          const { data, error } = await supabase
              .from('trips')
              .select('*')
              .eq('user_id', user.id)
              .order('start_date', { ascending: false });
          if (error) throw error;
          setTrips(data || []);
      } catch (e) { console.error('Error fetching trips:', e); } 
      finally { setLoading(false); }
  };

  useEffect(() => {
    fetchTrips();
  }, []);

  const confirmDeleteDraft = async () => {
      if (!deleteDraftModal.tripId) return;
      const id = deleteDraftModal.tripId;
      
      const { error } = await supabase.from('trips').delete().eq('id', id);
      if (!error) {
          setTrips(prev => prev.filter(t => t.id !== id));
          setDeleteDraftModal({show: false, tripId: null});
      } else {
          alert('שגיאה במחיקה');
      }
  };

  const handleEditDraft = (id: string, e: React.MouseEvent) => {
      e.preventDefault();
      e.stopPropagation();
      router.push(`/dashboard/new-trip?id=${id}`);
  };

  const handleCancelTrip = async () => {
      if (!cancelModal.tripId || !cancelReason.trim()) return;
      
      try {
          // שומרים את סיבת הביטול (בעמודה אם קיימת או ב-details) ומשנים סטטוס
          const trip = trips.find(t => t.id === cancelModal.tripId);
          const updatedDetails = { 
              ...trip.details, 
              cancellationReason: cancelReason 
          };

          // מעדכנים גם את העמודה הייעודית וגם את ה-details ליתר ביטחון
          const { error } = await supabase.from('trips').update({
              status: 'cancelled',
              cancellation_reason: cancelReason, 
              details: updatedDetails
          }).eq('id', cancelModal.tripId);
          
          if (error) throw error;
          
          setTrips(prev => prev.map(t => t.id === cancelModal.tripId ? {...t, status: 'cancelled', cancellation_reason: cancelReason, details: updatedDetails} : t));
          setCancelModal({show: false, tripId: null});
          setCancelReason('');
      } catch (e: any) {
          alert('שגיאה בביטול: ' + e.message);
      }
  };

  if (loading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-[#00BCD4]" size={40}/></div>;

  const today = new Date().toISOString().split('T')[0];
  
  // הטיול הבא: רק טיולים עתידיים, לא מבוטלים ולא טיוטות
  const upcomingTrip = trips
    .filter(t => t.start_date >= today && t.status !== 'rejected' && t.status !== 'cancelled' && t.status !== 'draft')
    .sort((a,b) => a.start_date.localeCompare(b.start_date))[0];

  // רשימת הטיולים: מסננים החוצה את המבוטלים בדף הראשי
  const displayTrips = trips.filter(t => {
      // **התיקון החשוב:** הסתרת מבוטלים
      if (t.status === 'cancelled') return false; 

      const matchesFilter = activeFilter === 'all' ? true : t.status === activeFilter;
      const matchesSearch = t.name.toLowerCase().includes(searchTerm.toLowerCase());
      return matchesFilter && matchesSearch;
  });

  const SafetyCard = () => (
      <div className="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm flex flex-col justify-center relative overflow-hidden h-full">
          <div className="absolute top-0 left-0 bg-red-500 text-white text-[9px] px-2 py-1 rounded-br-lg z-20 font-bold shadow-sm">
              אופציונלי - דורש תכנות
          </div>
          <div className="flex items-center gap-3 mb-3 relative z-10 pt-2">
              <div className="w-10 h-10 bg-green-50 rounded-2xl flex items-center justify-center text-green-600 shrink-0 shadow-sm">
                  <ShieldAlert size={20}/>
              </div>
              <h3 className="text-base font-bold text-gray-800">חדר מצב</h3>
          </div>
          <p className="text-sm text-gray-500 leading-relaxed relative z-10">
              אין התראות חריגות להיום.<br/>
              <span className="text-green-600 font-bold">ניתן לקיים פעילות כסדרה.</span>
          </p>
          <div className="absolute top-0 right-0 w-1 h-full bg-green-500"></div>
      </div>
  );

  const WeatherCard = () => (
      <div className="bg-gradient-to-br from-[#00BCD4] to-cyan-600 p-6 rounded-3xl text-white shadow-lg shadow-cyan-100/50 flex flex-col justify-between relative overflow-hidden h-full min-h-[140px]">
          <div className="absolute top-0 left-0 bg-red-500 text-white text-[9px] px-2 py-1 rounded-br-lg z-20 font-bold shadow-sm">
              אופציונלי - דורש תכנות
          </div>
          <div className="relative z-10 pt-2">
              <div className="flex justify-between items-start">
                  <div className="text-xs font-bold opacity-80 mb-1">תחזית להיום</div>
                  <MapPin size={16} className="opacity-60"/>
              </div>
              <div className="flex items-end gap-2 mt-2">
                  <div className="text-4xl font-black">24°</div>
                  <div className="text-sm font-medium opacity-90 mb-1.5">ירושלים</div>
              </div>
              <div className="text-sm opacity-80 mt-1">שמשי ונעים</div>
          </div>
          <Sun size={100} className="absolute -bottom-6 -left-6 text-white opacity-10 rotate-12"/>
      </div>
  );

  return (
    <>
      <Header title="לוח בקרה" />

      {/* מודל ביטול טיול */}
      {cancelModal.show && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fadeIn">
              <div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm text-center">
                  <div className="w-14 h-14 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                      <Trash2 size={28}/>
                  </div>
                  <h3 className="text-lg font-black text-gray-800 mb-2">ביטול פעילות</h3>
                  <p className="text-sm text-gray-500 mb-4 font-medium leading-relaxed">
                      האם את/ה בטוח/ה שברצונך לבטל את הפעילות? <br/>
                      פעולה זו תעדכן את מחלקת המפעלים והבטיחות.
                  </p>
                  <textarea 
                      className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm mb-4 outline-none focus:border-red-400 min-h-[80px]"
                      placeholder="נא לפרט את סיבת הביטול..."
                      value={cancelReason}
                      onChange={e => setCancelReason(e.target.value)}
                  ></textarea>
                  <div className="flex gap-2">
                      <button onClick={() => setCancelModal({show: false, tripId: null})} className="flex-1 py-2 bg-gray-100 text-gray-700 font-bold rounded-xl text-sm">חזרה</button>
                      <button onClick={handleCancelTrip} className="flex-1 py-2 bg-red-500 text-white font-bold rounded-xl text-sm hover:bg-red-600 transition-colors">אשר ביטול</button>
                  </div>
              </div>
          </div>
      )}

      {/* מודל מחיקת טיוטה */}
      {deleteDraftModal.show && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fadeIn">
              <div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm text-center border-t-4 border-[#E91E63]">
                  <div className="w-14 h-14 bg-red-50 text-[#E91E63] rounded-full flex items-center justify-center mx-auto mb-4">
                      <Trash2 size={28}/>
                  </div>
                  <h3 className="text-lg font-black text-gray-800 mb-2">מחיקת טיוטה</h3>
                  <p className="text-sm text-gray-500 mb-4 font-medium">האם למחוק את הטיוטה לצמיתות? לא ניתן לשחזר פעולה זו.</p>
                  <div className="flex gap-2">
                      <button onClick={() => setDeleteDraftModal({show: false, tripId: null})} className="flex-1 py-2 bg-gray-100 text-gray-700 font-bold rounded-xl text-sm">ביטול</button>
                      <button onClick={confirmDeleteDraft} className="flex-1 py-2 bg-[#E91E63] text-white font-bold rounded-xl text-sm hover:bg-pink-600 transition-colors">מחק</button>
                  </div>
              </div>
          </div>
      )}

      <div className="p-4 md:p-8 space-y-6 animate-fadeIn pb-32 max-w-[100vw] overflow-x-hidden md:max-w-7xl md:mx-auto">
          
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              {/* כרטיס טיול קרוב */}
              <div className="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm relative overflow-hidden group hover:shadow-md transition-all h-full md:col-span-1">
                  <div className="relative z-10">
                      <div className="flex justify-between items-start mb-2">
                        <div className="text-xs font-bold text-gray-400 uppercase tracking-widest">הפעילות הבאה</div>
                        {upcomingTrip && <div className="bg-cyan-50 text-[#00BCD4] px-2 py-1 rounded-lg text-[10px] font-bold">בקרוב</div>}
                      </div>
                      
                      {upcomingTrip ? (
                          <>
                            <h3 className="text-xl font-black text-gray-800 truncate mb-1 leading-tight">{upcomingTrip.name}</h3>
                            <div className="flex items-center gap-2 text-sm text-gray-500 font-bold mt-2">
                                <Calendar size={16} className="text-[#E91E63]"/>
                                <span>{formatHebrewDate(upcomingTrip.start_date)}</span>
                            </div>
                          </>
                      ) : (
                          <div className="flex flex-col items-center justify-center py-4 text-center">
                              <span className="text-gray-300 mb-2">--</span>
                              <div className="text-gray-400 font-medium text-sm">אין פעילויות מתוכננות בקרוב</div>
                          </div>
                      )}
                  </div>
                  <div className="w-32 h-32 bg-gradient-to-tr from-[#E91E63]/10 to-transparent rounded-full absolute -bottom-10 -left-10 transition-transform group-hover:scale-110"></div>
              </div>

              <div className="hidden md:block h-full"><SafetyCard /></div>
              <div className="hidden md:block h-full"><WeatherCard /></div>
          </div>

          <div className="space-y-4 pt-2">
              <div className="flex flex-col md:flex-row justify-between items-end gap-4">
                  
                  {/* פילטרים מורחבים */}
                  <div className="flex gap-2 bg-white p-1.5 rounded-2xl border border-gray-100 w-full md:w-auto overflow-x-auto no-scrollbar shadow-sm">
                      {[
                          { id: 'all', label: 'כל הטיולים' },
                          { id: 'future', label: 'עתידיים' },
                          { id: 'draft', label: 'טיוטות' },
                          { id: 'approved', label: 'אושר' },
                          { id: 'pending', label: 'בבדיקה' },
                      ].map(f => {
                          const isActive = activeFilter === f.id;
                          return (
                            <button key={f.id} onClick={() => setActiveFilter(f.id)} 
                                className={`px-4 py-2 rounded-xl text-xs font-bold transition-all whitespace-nowrap flex-1 md:flex-none
                                ${isActive ? 'bg-[#00BCD4] text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'}`}>
                                {f.label}
                            </button>
                          )
                      })}
                  </div>

                  <div className="relative w-full md:w-72">
                      <input 
                        type="text" 
                        placeholder="חיפוש לפי שם טיול..." 
                        value={searchTerm} 
                        onChange={e => setSearchTerm(e.target.value)} 
                        className="w-full pl-4 pr-10 py-3 bg-white border border-gray-200 rounded-2xl text-sm font-bold focus:border-[#00BCD4] outline-none transition-all shadow-sm focus:ring-4 focus:ring-cyan-50"
                      />
                      <Search className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400" size={18}/>
                  </div>
              </div>

              <div className="grid grid-cols-1 gap-3">
                  {displayTrips.length === 0 ? (
                      <div className="py-20 text-center bg-white rounded-3xl border border-dashed border-gray-200 flex flex-col items-center">
                          <div className="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-3">
                              <Search size={24} className="text-gray-300"/>
                          </div>
                          <span className="text-gray-400 font-bold">לא נמצאו טיולים תואמים</span>
                      </div>
                  ) : displayTrips.map(trip => {
                      const timeline = trip.details.timeline || [];
                      const statusStyle = getStatusStyles(trip.status);
                      const StatusIcon = statusStyle.icon;
                      const isDraft = trip.status === 'draft';
                      
                      const start = new Date(trip.start_date);
                      const end = new Date(trip.details.endDate || trip.start_date);
                      const diffTime = Math.abs(end.getTime() - start.getTime());
                      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                      const isMultiDay = diffDays > 1;

                      const attractions = timeline.filter((t: any) => t.category === 'attraction').map((t: any) => t.finalSubCategory || t.details).filter(Boolean);
                      const uniqueAttractions = Array.from(new Set(attractions));

                      const sleeping = timeline.filter((t: any) => t.category === 'sleeping').map((t: any) => t.finalLocation || t.otherDetail).filter(Boolean);
                      const uniqueSleeping = Array.from(new Set(sleeping));

                      const allLocations = timeline.map((t: any) => t.finalLocation).filter(Boolean);
                      const uniqueLocations = Array.from(new Set(allLocations));
                      const locationsString = uniqueLocations.length > 0 ? uniqueLocations.join(' / ') : 'מיקום לא הוגדר';

                      const stepsCount = timeline.length;

                      const tripLink = isDraft ? '#' : `/dashboard/trip/${trip.id}`;

                      return (
                      <Link key={trip.id} href={tripLink} className={isDraft ? 'cursor-default' : ''}>
                          <div className={`bg-white border ${isDraft ? 'border-dashed border-gray-300 bg-gray-50/30' : 'border-gray-100'} rounded-3xl p-5 hover:border-[#00BCD4] transition-all group flex flex-col md:flex-row items-stretch gap-5 shadow-sm hover:shadow-md relative overflow-hidden`}>
                              
                              {/* קצוות */}
                              <div className={`absolute top-0 right-0 px-6 py-1.5 text-white font-bold text-xs rounded-bl-2xl shadow-sm ${getRibbonColor(trip.details.tripType)}`}>
                                  {trip.details.tripType} {trip.details.tripType === 'אחר' && trip.details.tripTypeOther ? `- ${trip.details.tripTypeOther}` : ''}
                              </div>

                              <div className={`absolute top-0 left-0 px-4 py-1.5 rounded-br-2xl shadow-sm flex items-center gap-1.5 font-bold text-xs ${statusStyle.bg} ${statusStyle.textCol}`}>
                                  <StatusIcon size={14}/>
                                  {statusStyle.text}
                              </div>

                              {/* תאריך */}
                              <div className="flex flex-row md:flex-col items-center justify-center bg-gray-50 rounded-2xl px-6 py-4 w-full md:w-24 shrink-0 gap-3 md:gap-1 border border-gray-100 group-hover:bg-cyan-50 group-hover:text-[#00BCD4] transition-colors mt-6 md:mt-0">
                                  <span className="text-3xl font-black text-gray-800 group-hover:text-[#00BCD4] leading-none">
                                      {start.getDate()}
                                  </span>
                                  <span className="text-[11px] font-bold text-gray-500 uppercase tracking-wider">
                                      {getMonthNameHebrew(trip.start_date)}
                                  </span>
                              </div>

                              {/* תוכן */}
                              <div className="flex-1 flex flex-col justify-center mt-2 md:mt-0 pt-4 md:pt-0">
                                  <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-2 mb-2 pt-2">
                                      <h3 className="text-xl font-black text-gray-800 group-hover:text-[#00BCD4] transition-colors leading-tight max-w-[70%]">
                                          {trip.name || 'ללא שם'}
                                      </h3>
                                      <div className="flex flex-wrap gap-2 pl-2">
                                          {uniqueAttractions.length > 0 && (
                                              <div className="flex items-center gap-1 bg-pink-50 text-pink-600 px-2 py-1 rounded-lg text-[10px] font-bold border border-pink-100 max-w-[150px]" title={uniqueAttractions.join(' / ')}>
                                                  <Ticket size={12} className="shrink-0"/>
                                                  <span className="truncate">{uniqueAttractions.join(' / ')}</span>
                                              </div>
                                          )}
                                          {uniqueSleeping.length > 0 && (
                                              <div className="flex items-center gap-1 bg-purple-50 text-purple-600 px-2 py-1 rounded-lg text-[10px] font-bold border border-purple-100 max-w-[150px]" title={uniqueSleeping.join(' / ')}>
                                                  <Tent size={12} className="shrink-0"/>
                                                  <span className="truncate">{uniqueSleeping.join(' / ')}</span>
                                              </div>
                                          )}
                                      </div>
                                  </div>
                                  
                                  <div className="flex flex-wrap items-center gap-3 text-xs font-medium text-gray-500">
                                      <div className="flex items-center gap-1.5 bg-gray-50 px-2 py-1 rounded-lg border border-gray-100">
                                          <Calendar size={14} className="text-[#E91E63]"/>
                                          <span className="font-bold">{formatHebrewDate(trip.start_date)}</span>
                                          <span className="text-gray-300">|</span>
                                          <span>{formatFullGregorianDate(trip.start_date)}</span>
                                          {isMultiDay && <span>- {formatFullGregorianDate(trip.details.endDate)}</span>}
                                      </div>
                                      <div className="flex items-center gap-1.5 bg-gray-50 px-2 py-1 rounded-lg border border-gray-100 max-w-[200px]" title={locationsString}>
                                          <MapPin size={14} className="text-[#00BCD4] shrink-0"/>
                                          <span className="truncate">{locationsString}</span>
                                      </div>
                                      {isMultiDay && (
                                          <div className="flex items-center gap-1.5 bg-blue-50 text-blue-600 px-2 py-1 rounded-lg border border-blue-100 font-bold">
                                              <Timer size={14}/> {diffDays} ימים
                                          </div>
                                      )}
                                      <div className="flex items-center gap-1.5 bg-gray-50 px-2 py-1 rounded-lg border border-gray-100">
                                          <Layers size={14} className="text-gray-400"/>
                                          <span>{stepsCount} שלבים</span>
                                      </div>
                                  </div>
                              </div>

                              {/* כפתורי פעולה */}
                              <div className="w-full md:w-auto flex items-center justify-end md:justify-center mt-4 md:mt-0 gap-3">
                                    {isDraft ? (
                                        <>
                                            <button 
                                                onClick={(e) => handleEditDraft(trip.id, e)} 
                                                className="flex items-center gap-1.5 bg-blue-50 text-blue-600 px-3 py-1.5 rounded-xl hover:bg-blue-100 transition-colors text-xs font-bold border border-blue-100 shadow-sm" 
                                                title="המשך עריכה"
                                            >
                                                <FileEdit size={16}/>
                                                <span>ערוך טיוטה</span>
                                            </button>
                                            <button 
                                                onClick={(e) => { e.preventDefault(); e.stopPropagation(); setDeleteDraftModal({show: true, tripId: trip.id}); }} 
                                                className="flex items-center gap-1.5 bg-red-50 text-red-600 px-3 py-1.5 rounded-xl hover:bg-red-100 transition-colors text-xs font-bold border border-red-100 shadow-sm" 
                                                title="מחק טיוטה"
                                            >
                                                <Trash2 size={16}/>
                                                <span>מחק</span>
                                            </button>
                                        </>
                                    ) : (
                                        <>
                                            {trip.status !== 'cancelled' && (
                                                <button 
                                                    onClick={(e) => { e.preventDefault(); e.stopPropagation(); setCancelModal({show: true, tripId: trip.id}); }} 
                                                    className="flex items-center gap-1.5 bg-red-50 text-red-500 px-3 py-1.5 rounded-xl hover:bg-red-100 transition-colors text-xs font-bold border border-red-100 shadow-sm" 
                                                    title="ביטול פעילות"
                                                >
                                                    <Trash2 size={16}/>
                                                    <span>ביטול פעילות</span>
                                                </button>
                                            )}
                                            <div className="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 group-hover:bg-[#00BCD4] group-hover:text-white transition-all shadow-sm">
                                                <ArrowRight size={20}/>
                                            </div>
                                        </>
                                    )}
                              </div>
                          </div>
                      </Link>
                  )})}
              </div>
          </div>

          <div className="grid grid-cols-1 gap-4 md:hidden mt-8 border-t border-gray-100 pt-8">
              <div className="h-[140px]"><SafetyCard /></div>
              <div className="h-[160px]"><WeatherCard /></div>
          </div>

      </div>
    </>
  )
}
</file>

<file path="app/dashboard/trip/[id]/page.tsx">
"use client"

import React, { useState, useEffect } from 'react'
import { useParams, useRouter } from 'next/navigation'
import { supabase } from '@/lib/supabaseClient'
import { Header } from '@/components/layout/Header'
import { 
  Loader2, Calendar, MapPin, Clock, FileText, Phone, 
  Bus, Utensils, Tent, Ticket, CheckCircle, AlertTriangle, ChevronLeft, Download,
  Users, Info, Home, Navigation, HelpCircle, User, Mail, 
  ArrowLeft, ShieldCheck, ShieldAlert, FileCheck, FileX, CreditCard, BadgeCheck, Cake, XCircle
} from 'lucide-react'

// ... (כל פונקציות העזר שלך לתאריכים עבריים נשארות זהות) ...
// (תעתיק את פונקציות העזר מהקוד הקודם שלך או מהדפים האחרים: toHebrewDay, formatHebrewYear, getHebrewDateRange, etc...)

// כדי לחסוך מקום, אני מציג פה רק את פונקציות העזר הקריטיות (אבל תדביק את הכל)
const toHebrewDay = (day: number) => {
    const days = ['', 'א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ז', 'ח', 'ט', 'י', 'י"א', 'י"ב', 'י"ג', 'י"ד', 'ט"ו', 'ט"ז', 'י"ז', 'י"ח', 'י"ט', 'כ', 'כ"א', 'כ"ב', 'כ"ג', 'כ"ד', 'כ"ה', 'כ"ו', 'כ"ז', 'כ"ח', 'כ"ט', 'ל'];
    return days[day] || day;
};

const formatHebrewYear = (yearNum: number) => {
    let year = yearNum % 1000; 
    let str = '';
    if (year >= 400) { str += 'ת'; year -= 400; }
    if (year >= 300) { str += 'ש'; year -= 300; }
    if (year >= 200) { str += 'ר'; year -= 200; }
    if (year >= 100) { str += 'ק'; year -= 100; }
    if (year >= 90) { str += 'צ'; year -= 90; }
    if (year >= 80) { str += 'פ'; year -= 80; }
    if (year >= 70) { str += 'ע'; year -= 70; }
    if (year >= 60) { str += 'ס'; year -= 60; }
    if (year >= 50) { str += 'נ'; year -= 50; }
    if (year >= 40) { str += 'מ'; year -= 40; }
    if (year >= 30) { str += 'ל'; year -= 30; }
    if (year >= 20) { str += 'כ'; year -= 20; }
    if (year >= 10) { str += 'י'; year -= 10; }
    const units = ['', 'א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ז', 'ח', 'ט'];
    if (year > 0) str += units[year];
    if (str.length > 1) { str = str.slice(0, -1) + '"' + str.slice(-1); } else { str += "'"; }
    return str;
};

const getHebrewDateRange = (startDateStr: string, endDateStr: string) => {
    if (!startDateStr) return '';
    try {
        const start = new Date(startDateStr);
        const end = endDateStr ? new Date(endDateStr) : start;
        const hebrewYearNum = start.getFullYear() + 3760;
        const yearLetters = formatHebrewYear(hebrewYearNum);

        const hebrewDatePart = (date: Date) => {
            const dayNum = parseInt(date.toLocaleDateString('he-IL', { calendar: 'hebrew', day: 'numeric' }));
            const monthName = date.toLocaleDateString('he-IL', { calendar: 'hebrew', month: 'long' });
            return { day: toHebrewDay(dayNum), month: monthName };
        };

        const hStart = hebrewDatePart(start);
        if (!endDateStr || start.getTime() === end.getTime()) return `${hStart.day} ב${hStart.month} ${yearLetters}`;
        const hEnd = hebrewDatePart(end);
        if (hStart.month === hEnd.month) return `${hStart.day} - ${hEnd.day} ב${hStart.month} ${yearLetters}`;
        return `${hStart.day} ב${hStart.month} - ${hEnd.day} ב${hEnd.month} ${yearLetters}`;
    } catch (e) { return ''; }
};

// ... שאר פונקציות העזר (formatDate, getShortDate, getDayName, calculateAge, DEFAULT_STYLE, CATEGORY_STYLES) תעתיק מהקוד הקודם ... 
const formatDate = (dateString: string) => { if (!dateString) return ''; return new Date(dateString).toLocaleDateString('he-IL', { day: 'numeric', month: 'numeric', year: '2-digit' }); };
const getShortDate = (dateString: string) => { if (!dateString) return ''; return new Date(dateString).toLocaleDateString('he-IL', { day: 'numeric', month: 'numeric' }); };
const getDayName = (dateString: string) => { if (!dateString) return ''; return new Date(dateString).toLocaleDateString('he-IL', { weekday: 'long' }); };
const calculateAge = (birthDateString: string) => { if (!birthDateString) return null; const today = new Date(); const birthDate = new Date(birthDateString); let age = today.getFullYear() - birthDate.getFullYear(); const m = today.getMonth() - birthDate.getMonth(); if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) { age--; } return age; };
const DEFAULT_STYLE = { icon: HelpCircle, label: 'כללי', bg: 'bg-gray-500', text: 'text-gray-600', light: 'bg-gray-50', border: 'border-gray-100' };
const CATEGORY_STYLES: any = { transport: { icon: Bus, color: 'blue', label: 'התניידות', bg: 'bg-blue-500', text: 'text-blue-600', light: 'bg-blue-50', border: 'border-blue-100' }, hiking: { icon: Navigation, color: 'emerald', label: 'מסלול בטבע', bg: 'bg-emerald-500', text: 'text-emerald-600', light: 'bg-emerald-50', border: 'border-emerald-100' }, attraction: { icon: Ticket, color: 'pink', label: 'אטרקציה', bg: 'bg-pink-500', text: 'text-pink-600', light: 'bg-pink-50', border: 'border-pink-100' }, food: { icon: Utensils, color: 'yellow', label: 'אוכל', bg: 'bg-yellow-500', text: 'text-yellow-600', light: 'bg-yellow-50', border: 'border-yellow-100' }, settlement: { icon: Home, color: 'indigo', label: 'פעילות במבנה / יישוב', bg: 'bg-indigo-500', text: 'text-indigo-600', light: 'bg-indigo-50', border: 'border-indigo-100' }, sleeping: { icon: Tent, color: 'purple', label: 'לינה', bg: 'bg-purple-500', text: 'text-purple-600', light: 'bg-purple-50', border: 'border-purple-100' }, other: DEFAULT_STYLE };

export default function TripDetailsPage() {
  const params = useParams();
  const router = useRouter();
  const [loading, setLoading] = useState(true);
  const [trip, setTrip] = useState<any>(null);
  const [creatorProfile, setCreatorProfile] = useState<any>(null);
  const [activeTab, setActiveTab] = useState<'schedule' | 'files' | 'contacts'>('schedule');

  useEffect(() => {
    const fetchTripData = async () => {
        if (!params?.id) return;
        setLoading(true);
        const { data: tripData, error } = await supabase.from('trips').select('*').eq('id', params.id).single();
        if (error || !tripData) { console.error(error); setLoading(false); return; }
        setTrip(tripData);
        if (tripData.user_id) {
            const { data: profile } = await supabase.from('profiles').select('*').eq('id', tripData.user_id).single();
            if (profile) setCreatorProfile(profile);
        }
        setLoading(false);
    };
    fetchTripData();
  }, [params?.id]);

  const getCoordinatorTitle = (dept: string) => { if (!dept) return 'אחראי/ת הטיול'; if (['בת מלך', 'בנות חב״ד', 'בנות חב"ד'].some(d => dept.includes(d))) { return 'אחראית הטיול'; } return 'אחראי/ת הטיול'; };
  const getCategoryData = (catKey: string) => { if (!catKey) return DEFAULT_STYLE; return CATEGORY_STYLES[catKey] || DEFAULT_STYLE; };
  const getRibbonColor = (type: string) => { if (!type) return 'bg-gray-500'; if (type.includes('סמינר')) return 'bg-purple-600'; if (type.includes('מחנה')) return 'bg-green-600'; if (type.includes('טיול')) return 'bg-[#00BCD4]'; return 'bg-blue-600'; };

  const getStatusDisplay = (status: string) => {
      const config: any = {
          approved: { text: 'מאושר', bg: 'bg-green-100', textCol: 'text-green-700', icon: CheckCircle },
          pending: { text: 'ממתין לבדיקה', bg: 'bg-amber-100', textCol: 'text-amber-700', icon: Clock },
          rejected: { text: 'לא אושר', bg: 'bg-red-100', textCol: 'text-red-700', icon: AlertTriangle },
          cancelled: { text: 'בוטל', bg: 'bg-stone-100', textCol: 'text-stone-500', icon: XCircle }
      };
      const style = config[status] || config.pending;
      const Icon = style.icon;
      return (
          <div className={`absolute top-0 left-0 px-4 py-2 rounded-br-2xl shadow-sm flex items-center gap-2 font-bold text-sm ${style.bg} ${style.textCol}`}>
              <Icon size={16}/> {style.text}
          </div>
      );
  };

  const getSafeProfileData = () => {
      if (!creatorProfile) return { fullName: trip?.coordinator_name || 'לא ידוע', officialName: 'לא הוזן', idNumber: 'לא הוזן', birthDate: null, phone: '', email: '', avatarUrl: null };
      const officialFirst = creatorProfile.official_name || ''; const lastName = creatorProfile.last_name || ''; let officialFullName = (officialFirst && lastName) ? `${officialFirst} ${lastName}` : ''; if (!officialFullName) officialFullName = 'לא הוזן'; const displayName = creatorProfile.full_name || trip?.coordinator_name || 'לא הוזן';
      return { idNumber: creatorProfile.identity_number || creatorProfile.id_number || 'לא הוזן', fullName: displayName, officialName: officialFullName, birthDate: creatorProfile.birth_date || null, phone: creatorProfile.phone, email: creatorProfile.contact_email || creatorProfile.email, avatarUrl: creatorProfile.avatar_url || null };
  };

  if (loading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-[#00BCD4]" size={40}/></div>;
  if (!trip) return <div className="p-10 text-center text-xl font-bold text-gray-400">הטיול לא נמצא במערכת</div>;

  const d = trip.details || {};
  const timeline = d.timeline || [];
  const profileData = getSafeProfileData();
  const coordinatorAge = profileData.birthDate ? calculateAge(profileData.birthDate) : null;
  const allFiles = timeline.flatMap((item: any) => { const files = []; if (item.licenseFile) files.push({ ...item.licenseFile, type: 'רישוי עסק', itemTitle: item.finalSubCategory }); if (item.insuranceFile) files.push({ ...item.insuranceFile, type: 'ביטוח', itemTitle: item.finalSubCategory }); return files; });

  return (
    <>
      <Header title="פרטי טיול" />

      <div className="max-w-6xl mx-auto p-3 md:p-6 animate-fadeIn pb-32">
        <button onClick={() => router.back()} className="flex items-center gap-1 text-gray-500 hover:text-[#00BCD4] mb-4 text-xs font-bold transition-colors">
            <ChevronLeft size={16}/> חזרה לרשימה
        </button>

        {/* --- כותרת (Hero) --- */}
        <div className="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 pt-12 md:pt-6 mb-6 overflow-hidden relative">
            {getStatusDisplay(trip.status)}
            <div className={`absolute top-0 right-0 px-6 py-1.5 text-white font-bold text-sm shadow-md rounded-bl-2xl ${getRibbonColor(d.tripType)}`}>
                {d.tripType} {d.tripType === 'אחר' && d.tripTypeOther ? `- ${d.tripTypeOther}` : ''}
            </div>

            <div className="mt-6 md:mt-4 mb-4">
                <h1 className="text-3xl md:text-4xl font-black text-gray-900">{d.name}</h1>
            </div>

            {/* --- הצגת סיבת ביטול אם הטיול בוטל --- */}
            {trip.status === 'cancelled' && (
                <div className="bg-red-50 border border-red-100 p-4 rounded-xl mb-6 flex gap-4 items-start">
                    <div className="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center text-red-500 shrink-0">
                        <XCircle size={20}/>
                    </div>
                    <div>
                        <h3 className="font-bold text-red-800 mb-1">הפעילות בוטלה</h3>
                        <p className="text-sm text-red-700 leading-relaxed font-medium">
                            {trip.cancellation_reason || d.cancellationReason || 'לא צוינה סיבה'}
                        </p>
                    </div>
                </div>
            )}

            <div className="flex flex-wrap items-center gap-3 w-full">
                {/* קוביית תאריכים */}
                <div className="flex flex-col justify-center text-gray-700 bg-gray-50 px-4 py-2 rounded-xl border border-gray-100 min-h-[50px] shrink-0">
                    <div className="flex items-center gap-2">
                        <Calendar size={16} className="text-[#E91E63]"/>
                        <div className="flex flex-col leading-tight"><span className="font-bold text-sm">{formatDate(d.startDate)}</span>{d.startTime && <span className="text-[10px] text-gray-500">{d.startTime}</span>}</div>
                        <ArrowLeft size={14} className="text-gray-400 mx-1"/>
                        <div className="flex flex-col leading-tight"><span className="font-bold text-sm">{formatDate(d.endDate)}</span>{d.endTime && <span className="text-[10px] text-gray-500">{d.endTime}</span>}</div>
                    </div>
                    <div className="text-[12px] text-gray-900 text-center font-bold mt-1 border-t border-gray-200 pt-1">
                        {getHebrewDateRange(d.startDate, d.endDate)}
                    </div>
                </div>
                {(d.gradeFrom || d.gradeTo) && ( <div className="bg-gray-50 text-gray-600 px-3 py-1 rounded-xl border border-gray-200 flex flex-col justify-center min-w-[70px] min-h-[50px] shrink-0"><div className="text-[9px] font-bold text-gray-400 uppercase leading-none mb-0.5">שכבות</div><div className="font-bold text-xs leading-none">{d.gradeFrom}-{d.gradeTo}</div></div> )}
                <div className="bg-blue-50 text-blue-800 px-3 py-1 rounded-xl border border-blue-100 flex flex-col items-center justify-center min-w-[70px] min-h-[50px] shrink-0"><span className="font-black text-lg leading-none">{d.chanichimCount || '0'}</span><span className="text-[9px] opacity-70 font-bold leading-none">חניכים</span></div>
                <div className="bg-gray-50 text-gray-600 px-3 py-1 rounded-xl border border-gray-200 flex flex-col justify-center min-w-[90px] min-h-[50px] shrink-0"><div className="text-[9px] font-bold text-gray-400 uppercase leading-none mb-0.5">צוות</div><div className="font-bold text-xs leading-tight whitespace-normal max-w-[200px]">{d.staffAges?.join(', ') || '-'}</div></div>
                <div className="bg-purple-50 text-purple-800 px-3 py-1 rounded-xl border border-purple-100 flex flex-col items-center justify-center min-w-[80px] min-h-[50px] shrink-0"><span className="font-black text-lg leading-none">{d.totalTravelers || '0'}</span><span className="text-[9px] opacity-70 font-bold leading-none">סה"כ משתתפים</span></div>
            </div>
        </div>

        {/* --- טאבים --- */}
        <div className="flex border-b border-gray-200 mb-5">
            {[{ id: 'schedule', label: 'לו״ז ופעילויות', icon: Clock }, { id: 'contacts', label: getCoordinatorTitle(trip.department), icon: Phone }, { id: 'files', label: `קבצים (${allFiles.length})`, icon: FileText }].map(tab => (
                <button key={tab.id} onClick={() => setActiveTab(tab.id as any)} className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 border-b-2 transition-colors ${activeTab === tab.id ? 'border-[#00BCD4] text-[#00BCD4]' : 'border-transparent text-gray-400 hover:text-gray-600'}`}>
                    <tab.icon size={16}/>{tab.label}
                </button>
            ))}
        </div>

        {/* --- תוכן הטאבים --- */}
        <div className="bg-white rounded-2xl shadow-sm border border-gray-200 min-h-[300px] p-5">
            {activeTab === 'schedule' && (
                <div className="space-y-2">
                    {timeline.map((item: any, index: number) => {
                        const style = getCategoryData(item.category);
                        const CatIcon = style.icon;
                        let hoverBgClass = 'hover:bg-gray-50'; try { hoverBgClass = style.light.replace('bg-', 'hover:bg-'); } catch(e) {}
                        let titleColorClass = 'text-gray-900'; try { titleColorClass = style.text.replace('text-', 'text-').replace('600', '900'); } catch(e) {}
                        let detailPrefix = "פרטים נוספים:";
                        if (item.category === 'sleeping') detailPrefix = "מקום הלינה:"; if (item.category === 'attraction') detailPrefix = "שם האטרקציה:"; if (item.category === 'transport') detailPrefix = "פרטי התניידות:"; if (item.category === 'settlement') detailPrefix = "מיקום הפעילות:";
                        const fullDetails = [item.otherDetail ? `${item.otherDetail}` : null, item.details ? `${item.details}` : null].filter(Boolean).join(' • ');

                        return (
                            <div key={index} className="flex gap-3 group items-stretch">
                                <div className="flex flex-col items-center min-w-[50px] pt-2">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white shadow-sm ${style.bg || 'bg-gray-500'} shrink-0`}><CatIcon size={16}/></div>
                                    <div className="text-[10px] font-bold text-gray-400 mt-1 text-center leading-tight">{getShortDate(item.date)}<div className="font-normal opacity-70">{getDayName(item.date)}</div></div>
                                    {index !== timeline.length - 1 && <div className="w-px flex-1 bg-gray-200 my-1"></div>}
                                </div>
                                <div className={`flex-1 bg-white border border-gray-100 hover:border-[#00BCD4] rounded-lg p-3 transition-all mb-2 flex flex-col md:flex-row items-start md:items-center justify-between gap-3 shadow-sm ${hoverBgClass}`}>
                                    <div className="flex-1 min-w-0">
                                        <div className="flex flex-col gap-1 mb-1">
                                            <div className="flex items-center gap-2"><span className={`text-[12px] font-black uppercase tracking-wider ${style.text || 'text-gray-600'} bg-white border border-gray-100 px-2 py-0.5 rounded-md`}>{style.label || 'כללי'}</span></div>
                                            <h3 className={`font-black text-xl leading-none truncate ${titleColorClass}`}>{item.finalSubCategory}</h3>
                                        </div>
                                        <div className="flex flex-wrap items-center gap-3 text-sm text-gray-600 mt-2">
                                            {item.finalLocation && item.category !== 'branch' && (<div className="flex items-center gap-1 bg-gray-50 px-2 py-1 rounded text-xs font-bold text-gray-500 border border-gray-100"><MapPin size={12} className="text-gray-400"/>{item.finalLocation}</div>)}
                                            {fullDetails && (<div className="flex items-center gap-1 text-xs font-medium"><Info size={12} className="text-gray-400"/><span className="font-bold text-gray-500">{detailPrefix}</span><span>{fullDetails}</span></div>)}
                                        </div>
                                    </div>
                                    {item.requiresLicense && (<div className="flex gap-2 shrink-0">{item.licenseFile ? (<a href={item.licenseFile.url} target="_blank" rel="noopener noreferrer" className="flex flex-col items-center justify-center px-2 py-1 rounded border text-[10px] font-bold w-16 text-center bg-green-50 border-green-200 text-green-700 hover:bg-green-100 transition-colors"><FileCheck size={14}/><span>רישוי</span></a>) : (<div className="flex flex-col items-center justify-center px-2 py-1 rounded border text-[10px] font-bold w-16 text-center bg-red-50 border-red-200 text-red-600 opacity-70"><FileX size={14}/><span>חסר רישוי</span></div>)}{item.insuranceFile ? (<a href={item.insuranceFile.url} target="_blank" rel="noopener noreferrer" className="flex flex-col items-center justify-center px-2 py-1 rounded border text-[10px] font-bold w-16 text-center bg-green-50 border-green-200 text-green-700 hover:bg-green-100 transition-colors"><ShieldCheck size={14}/><span>ביטוח</span></a>) : (<div className="flex flex-col items-center justify-center px-2 py-1 rounded border text-[10px] font-bold w-16 text-center bg-red-50 border-red-200 text-red-600 opacity-70"><ShieldAlert size={14}/><span>חסר ביטוח</span></div>)}</div>)}
                                </div>
                            </div>
                        );
                    })}
                    {timeline.length === 0 && (<div className="text-center py-10 text-gray-400 text-sm">לא הוזן פירוט לטיול זה</div>)}
                    {d.generalComments && (<div className="mt-8 pt-6 border-t border-dashed border-gray-200"><div className="bg-yellow-50 border border-yellow-100 p-4 rounded-xl flex gap-3 items-start"><Info size={18} className="text-yellow-600 mt-0.5 shrink-0"/><div><h4 className="font-bold text-yellow-800 text-xs mb-1">הערות כלליות שהוזנו בטופס:</h4><p className="text-sm text-yellow-900 leading-relaxed font-medium whitespace-pre-wrap">{d.generalComments}</p></div></div></div>)}
                </div>
            )}

            {activeTab === 'contacts' && (
                <div className="animate-fadeIn">
                     <div className="p-6 bg-gray-50 border border-gray-100 rounded-2xl flex flex-col md:flex-row gap-8">
                         <div className="flex flex-col items-center md:w-1/3 text-center border-b md:border-b-0 md:border-l border-gray-200 pb-6 md:pb-0 md:pl-6">
                             <div className="w-24 h-24 rounded-full bg-white flex items-center justify-center text-[#00BCD4] font-black text-4xl shadow-sm border-2 border-white ring-1 ring-gray-100 mb-3 overflow-hidden">{profileData.avatarUrl ? (<img src={profileData.avatarUrl} alt="Avatar" className="w-full h-full object-cover"/>) : (profileData.fullName?.[0] || 'U')}</div>
                             <div className="font-black text-gray-900 text-2xl mb-1">{profileData.fullName}</div>
                             <div className="text-sm text-gray-500 font-bold bg-white px-3 py-1 rounded-full border border-gray-200 shadow-sm">{getCoordinatorTitle(trip.department)}</div>
                         </div>
                         <div className="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div className="bg-white p-3 rounded-xl border border-gray-200 flex items-center gap-3 shadow-sm hover:border-blue-200 transition-colors"><div className="w-10 h-10 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center shrink-0"><BadgeCheck size={20}/></div><div className="overflow-hidden"><div className="text-[10px] text-gray-400 font-bold uppercase">שם מלא (עפ"י ת.ז.)</div><div className="font-bold text-gray-800 truncate" title={profileData.officialName}>{profileData.officialName}</div></div></div>
                             <div className="bg-white p-3 rounded-xl border border-gray-200 flex items-center gap-3 shadow-sm hover:border-indigo-200 transition-colors"><div className="w-10 h-10 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center shrink-0"><CreditCard size={20}/></div><div><div className="text-[10px] text-gray-400 font-bold uppercase">תעודת זהות</div><div className="font-bold text-gray-800 tracking-wider">{profileData.idNumber}</div></div></div>
                             <div className="bg-white p-3 rounded-xl border border-gray-200 flex items-center gap-3 shadow-sm hover:border-pink-200 transition-colors"><div className="w-10 h-10 rounded-lg bg-pink-50 text-pink-600 flex items-center justify-center shrink-0"><Cake size={20}/></div><div><div className="text-[10px] text-gray-400 font-bold uppercase">תאריך לידה</div><div className="flex items-center gap-2"><span className="font-bold text-gray-800">{profileData.birthDate ? formatDate(profileData.birthDate) : 'לא הוזן'}</span>{coordinatorAge !== null && (<span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${coordinatorAge >= 18 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>גיל: {coordinatorAge}</span>)}</div></div></div>
                             <div className="bg-white p-3 rounded-xl border border-gray-200 flex items-center gap-3 shadow-sm hover:border-green-200 transition-colors"><div className="w-10 h-10 rounded-lg bg-green-50 text-green-600 flex items-center justify-center shrink-0"><Phone size={20}/></div><div className="overflow-hidden"><div className="text-[10px] text-gray-400 font-bold uppercase">טלפון נייד</div>{profileData.phone ? (<a href={`tel:${profileData.phone}`} className="font-bold text-gray-800 hover:text-green-600 transition-colors">{profileData.phone}</a>) : <span className="text-gray-400 font-medium text-sm">לא הוזן</span>}</div></div>
                             <div className="bg-white p-3 rounded-xl border border-gray-200 flex items-center gap-3 shadow-sm hover:border-cyan-200 transition-colors md:col-span-2"><div className="w-10 h-10 rounded-lg bg-cyan-50 text-cyan-600 flex items-center justify-center shrink-0"><Mail size={20}/></div><div className="overflow-hidden"><div className="text-[10px] text-gray-400 font-bold uppercase">דואר אלקטרוני</div>{profileData.email ? (<a href={`mailto:${profileData.email}`} className="font-bold text-gray-800 hover:text-cyan-600 transition-colors truncate block">{profileData.email}</a>) : <span className="text-gray-400 font-medium text-sm">לא הוזן</span>}</div></div>
                         </div>
                     </div>
                </div>
            )}

            {activeTab === 'files' && (
                <div className="grid grid-cols-1 gap-3 animate-fadeIn">
                    {allFiles.length > 0 ? allFiles.map((file: any, i: number) => (
                        <div key={i} className="flex items-center justify-between p-3 bg-gray-50 rounded-xl border border-gray-100 hover:border-[#00BCD4] hover:bg-white transition-all">
                            <div className="flex items-center gap-3 overflow-hidden">
                                <div className="w-9 h-9 rounded-lg bg-white flex items-center justify-center text-[#00BCD4] shadow-sm border border-gray-100"><FileText size={18}/></div>
                                <div className="truncate"><div className="text-[10px] text-gray-400 font-bold">{file.type} עבור {file.itemTitle}</div><div className="font-bold text-gray-800 text-xs truncate">{file.name}</div></div>
                            </div>
                            <a href={file.url} target="_blank" rel="noopener noreferrer" className="p-2 text-gray-400 hover:text-[#00BCD4] hover:bg-cyan-50 rounded-lg transition-all"><Download size={18}/></a>
                        </div>
                    )) : (<div className="text-center py-10 text-gray-400 text-sm"><FileText size={32} className="opacity-20 mx-auto mb-2"/>לא הועלו קבצים לטיול זה</div>)}
                </div>
            )}
        </div>
      </div>
    </>
  )
}
</file>

<file path="app/manager/approvals/[id]/page.tsx">
"use client"

import React, { useState, useEffect } from 'react'
import { useParams, useRouter } from 'next/navigation' // שים לב לשינוי כאן
import { supabase } from '@/lib/supabaseClient'
import { Button } from '@/components/ui/Button'
import { 
  Loader2, ArrowRight, MapPin, Calendar, User, FileText, 
  CheckCircle, XCircle, AlertTriangle, Send, Link as LinkIcon, Shield, FileCheck, Clock 
} from 'lucide-react'
import Link from 'next/link'

export default function TripActionPage() {
  // בגרסאות חדשות של נקסט, עדיף להשתמש ב-useParams ישירות או ב-React.use()
  // כדי לשמור על פשטות, נשתמש ב-useParams הסטנדרטי שעובד ברוב המקרים
  const params = useParams();
  const id = params?.id as string;
  const router = useRouter();
  
  const [trip, setTrip] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [processing, setProcessing] = useState(false);
  
  // ניהול טופס דחייה/הערה
  const [actionType, setActionType] = useState<'approve' | 'reject' | null>(null);
  const [adminNote, setAdminNote] = useState('');

  useEffect(() => {
    if (!id) return;

    const fetchTrip = async () => {
      const { data, error } = await supabase
        .from('trips')
        .select('*')
        .eq('id', id)
        .single();

      if (data) setTrip(data);
      setLoading(false);
    };
    fetchTrip();
  }, [id]);

  // פונקציית האישור/דחייה
  const handleAction = async () => {
    if (!actionType) return;
    if (actionType === 'reject' && !adminNote) return alert('חובה לכתוב סיבת דחייה');

    setProcessing(true);

    try {
        const newStatus = actionType === 'approve' ? 'approved' : 'rejected';
        
        // 1. עדכון סטטוס הטיול
        const { error: tripError } = await supabase
            .from('trips')
            .update({ status: newStatus })
            .eq('id', id);
        
        if (tripError) throw tripError;

        // 2. שליחת התראה לרכז (Notification)
        const title = actionType === 'approve' ? 'הטיול שלך אושר! 🎉' : 'הטיול לא אושר ⚠️';
        const message = actionType === 'approve' 
            ? `שמחים לבשר כי הטיול "${trip.name}" אושר. ${adminNote ? `\nהערות המטה: ${adminNote}` : ''}`
            : `הטיול "${trip.name}" לא אושר. סיבה: ${adminNote}`;

        await supabase.from('notifications').insert([{
            user_id: trip.user_id, // שולחים למי שיצר את הטיול
            title: title,
            message: message,
            type: actionType === 'approve' ? 'success' : 'error',
            link: `/dashboard/my-trips` // קישור לצפייה בטיול
        }]);

        alert('הפעולה בוצעה בהצלחה והודעה נשלחה לרכז.');
        router.push('/manager/approvals'); // חזרה לטבלה

    } catch (error: any) {
        alert('שגיאה: ' + error.message);
    } finally {
        setProcessing(false);
    }
  };

  if (loading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-[#00BCD4]" size={40}/></div>;
  if (!trip) return <div className="p-10 text-center">טיול לא נמצא</div>;

  const details = trip.details || {};
  const timeline = details.timeline || [];

  return (
    <div className="p-8 max-w-6xl mx-auto animate-fadeIn pb-32">
        
        {/* כפתור חזרה */}
        <Link href="/manager/approvals" className="flex items-center gap-2 text-gray-500 hover:text-gray-800 mb-6 font-bold w-fit transition-colors">
            <ArrowRight size={20}/> חזרה לרשימה
        </Link>

        {/* כותרת ראשית */}
        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8 bg-white p-6 rounded-3xl border border-gray-200 shadow-sm">
            <div>
                <h1 className="text-3xl font-black text-gray-800">{trip.name}</h1>
                <div className="flex items-center gap-2 text-gray-500 mt-2 text-sm">
                    <User size={16}/> הוגש ע"י: <span className="font-bold text-gray-700">{trip.coordinator_name}</span> 
                    <span className="w-1 h-1 bg-gray-300 rounded-full"></span>
                    <span>{trip.branch}</span>
                    <span className="w-1 h-1 bg-gray-300 rounded-full"></span>
                    <span>{new Date(trip.created_at).toLocaleDateString('he-IL')}</span>
                </div>
            </div>
            <div className={`px-4 py-2 rounded-xl text-sm font-bold border flex items-center gap-2
                ${trip.status === 'pending' ? 'bg-orange-50 text-orange-600 border-orange-200' : 
                  trip.status === 'approved' ? 'bg-green-50 text-green-600 border-green-200' : 'bg-red-50 text-red-600 border-red-200'}`}>
                {trip.status === 'pending' ? <Clock size={16}/> : trip.status === 'approved' ? <CheckCircle size={16}/> : <XCircle size={16}/>}
                {trip.status === 'pending' ? 'ממתין לבדיקה' : trip.status === 'approved' ? 'אושר' : 'נדחה'}
            </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            {/* צד ימין: פרטי הטיול והלו"ז */}
            <div className="lg:col-span-2 space-y-6">
                
                {/* נתונים יבשים */}
                <div className="bg-white p-6 rounded-3xl border border-gray-200 shadow-sm">
                    <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <FileText size={20} className="text-[#00BCD4]"/> פרטי הבקשה
                    </h3>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-y-6 gap-x-4">
                        <div>
                            <label className="text-xs font-bold text-gray-400 block mb-1">תאריכים</label>
                            <div className="font-bold text-gray-800">{new Date(trip.start_date).toLocaleDateString('he-IL')} <span className="text-gray-300">|</span> {details.startTime || '08:00'}</div>
                        </div>
                        <div>
                            <label className="text-xs font-bold text-gray-400 block mb-1">סוג פעילות</label>
                            <div className="font-bold text-gray-800">{details.tripType}</div>
                        </div>
                        <div>
                            <label className="text-xs font-bold text-gray-400 block mb-1">משתתפים</label>
                            <div className="font-bold text-gray-800">{details.totalTravelers} <span className="text-xs text-gray-500 font-medium">(חניכים: {details.chanichimCount})</span></div>
                        </div>
                        <div>
                            <label className="text-xs font-bold text-gray-400 block mb-1">שכבות גיל</label>
                            <div className="font-bold text-gray-800">{details.gradeFrom} - {details.gradeTo}</div>
                        </div>
                    </div>
                    
                    {details.generalComments && (
                        <div className="mt-6 pt-6 border-t border-gray-100">
                             <label className="text-xs font-bold text-gray-400 flex items-center gap-1 mb-2"><AlertTriangle size={12}/> דגשים מהרכז:</label>
                             <p className="text-sm text-gray-700 bg-yellow-50 p-3 rounded-xl border border-yellow-100 leading-relaxed">
                                 {details.generalComments}
                             </p>
                        </div>
                    )}
                </div>

                {/* לו"ז וקבצים - התיקון הגדול נמצא כאן */}
                <div className="bg-white rounded-3xl border border-gray-200 shadow-sm overflow-hidden">
                    <div className="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                        <h3 className="text-lg font-bold text-gray-800">לו"ז וקבצים מצורפים</h3>
                        <span className="text-xs font-bold bg-white px-3 py-1 rounded-full border border-gray-200">{timeline.length} פעילויות</span>
                    </div>
                    <div className="divide-y divide-gray-100">
                        {timeline.map((item: any, idx: number) => {
                            // בדיקה האם יש קבצים (תיקון הלוגיקה שלך)
                            const hasLicense = !!item.licenseFile;
                            const hasInsurance = !!item.insuranceFile;
                            const needsLicense = item.requiresLicense;

                            return (
                                <div key={idx} className="p-6 hover:bg-gray-50 transition-colors">
                                    <div className="flex items-start gap-4">
                                        <div className="bg-[#00BCD4]/10 text-[#00BCD4] font-bold px-3 py-1 rounded-lg text-sm min-w-[60px] text-center mt-1 border border-[#00BCD4]/20">
                                            {item.date ? item.date.split('-')[2] + '/' + item.date.split('-')[1] : '?'}
                                        </div>
                                        <div className="flex-1">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <h4 className="font-bold text-gray-900 text-lg flex items-center gap-2">
                                                        {item.finalSubCategory}
                                                    </h4>
                                                    <div className="flex items-center gap-3 mt-1 text-sm text-gray-500">
                                                        <span className="flex items-center gap-1"><MapPin size={14} className="text-[#E91E63]"/> {item.finalLocation}</span>
                                                        <span className="text-gray-300">|</span>
                                                        <span>{item.category}</span>
                                                    </div>
                                                </div>
                                                
                                                {/* תצוגת סטטוס מסמכים */}
                                                {needsLicense && (
                                                    <div className="flex gap-2">
                                                        {hasLicense ? (
                                                            <a href={item.licenseFile.url} target="_blank" rel="noreferrer" className="flex items-center gap-1 bg-green-50 text-green-700 px-3 py-1.5 rounded-lg text-xs font-bold border border-green-200 hover:bg-green-100 transition-colors">
                                                                <FileCheck size={14}/> רישיון עסק
                                                            </a>
                                                        ) : (
                                                            <span className="flex items-center gap-1 bg-red-50 text-red-600 px-3 py-1.5 rounded-lg text-xs font-bold border border-red-200">
                                                                <XCircle size={14}/> חסר רישיון
                                                            </span>
                                                        )}

                                                        {hasInsurance ? (
                                                            <a href={item.insuranceFile.url} target="_blank" rel="noreferrer" className="flex items-center gap-1 bg-blue-50 text-blue-700 px-3 py-1.5 rounded-lg text-xs font-bold border border-blue-200 hover:bg-blue-100 transition-colors">
                                                                <Shield size={14}/> ביטוח
                                                            </a>
                                                        ) : (
                                                            <span className="flex items-center gap-1 bg-red-50 text-red-600 px-3 py-1.5 rounded-lg text-xs font-bold border border-red-200">
                                                                <XCircle size={14}/> חסר ביטוח
                                                            </span>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {item.details && <div className="mt-3 text-sm text-gray-600 bg-white p-3 rounded-xl border border-gray-100">{item.details}</div>}
                                        </div>
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                </div>
            </div>

            {/* צד שמאל: פעולות ניהול */}
            <div className="lg:col-span-1">
                <div className="bg-white p-6 rounded-3xl border border-gray-200 shadow-xl sticky top-24">
                    <h3 className="text-lg font-bold text-gray-800 mb-6 border-b border-gray-100 pb-4">פעולות מנהל</h3>
                    
                    <div className="space-y-3">
                        <button 
                            onClick={() => setActionType('approve')}
                            className={`w-full py-4 rounded-xl border-2 font-bold flex items-center justify-center gap-2 transition-all
                            ${actionType === 'approve' 
                                ? 'border-green-500 bg-green-50 text-green-700 ring-2 ring-green-200 ring-offset-2' 
                                : 'border-gray-100 text-gray-500 hover:border-green-200 hover:text-green-600 hover:bg-green-50/50'}`}
                        >
                            <CheckCircle size={20}/> אשר את הטיול
                        </button>
                        
                        <button 
                            onClick={() => setActionType('reject')}
                            className={`w-full py-4 rounded-xl border-2 font-bold flex items-center justify-center gap-2 transition-all
                            ${actionType === 'reject' 
                                ? 'border-red-500 bg-red-50 text-red-700 ring-2 ring-red-200 ring-offset-2' 
                                : 'border-gray-100 text-gray-500 hover:border-red-200 hover:text-red-600 hover:bg-red-50/50'}`}
                        >
                            <XCircle size={20}/> דחה / החזר לתיקון
                        </button>
                    </div>

                    {/* אזור כתיבת הערות */}
                    {actionType && (
                        <div className="mt-6 animate-fadeIn">
                            <label className="text-xs font-bold text-gray-500 mb-2 block">
                                {actionType === 'approve' ? 'הערות סיכום (ישלחו לרכז)' : 'פרט את סיבת הדחייה (חובה)'}
                            </label>
                            <textarea 
                                className={`w-full p-3 rounded-xl border text-sm min-h-[120px] outline-none transition-all resize-none
                                ${actionType === 'approve' ? 'border-green-200 focus:border-green-500' : 'border-red-200 focus:border-red-500'}`}
                                placeholder={actionType === 'approve' ? "למשל: תהנו! נא לשלוח תמונות." : "למשל: חסר ביטוח ליום השני..."}
                                value={adminNote}
                                onChange={e => setAdminNote(e.target.value)}
                                autoFocus
                            ></textarea>

                            <Button 
                                onClick={handleAction} 
                                isLoading={processing}
                                className={`w-full mt-4 shadow-lg h-[50px] ${actionType === 'approve' ? 'bg-green-600 hover:bg-green-700 shadow-green-200' : 'bg-red-600 hover:bg-red-700 shadow-red-200'}`}
                                icon={<Send size={18}/>}
                            >
                                {actionType === 'approve' ? 'שלח אישור סופי' : 'שלח דחייה לרכז'}
                            </Button>
                        </div>
                    )}
                </div>
            </div>
        </div>
    </div>
  )
}
</file>

<file path="app/manager/approvals/page.tsx">
"use client"

import React, { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { ManagerHeader } from '@/components/layout/ManagerHeader'
import { Loader2, MapPin, Search, Eye, Calendar, User } from 'lucide-react'
import Link from 'next/link'
import { Input } from '@/components/ui/Input'

export default function ApprovalsPage() {
  const [loading, setLoading] = useState(true);
  const [trips, setTrips] = useState<any[]>([]);
  const [filter, setFilter] = useState('pending');
  const [searchTerm, setSearchTerm] = useState('');

  useEffect(() => {
    fetchTrips();
  }, []);

  const fetchTrips = async () => {
    const { data } = await supabase
      .from('trips')
      .select('*')
      .order('created_at', { ascending: false });

    if (data) setTrips(data);
    setLoading(false);
  };

  const filteredTrips = trips.filter(trip => {
      const matchesStatus = filter === 'all' ? true : trip.status === filter;
      const matchesSearch = trip.name?.includes(searchTerm) || 
                            trip.branch?.includes(searchTerm) || 
                            trip.coordinator_name?.includes(searchTerm);
      return matchesStatus && matchesSearch;
  });

  const getStatusBadge = (status: string) => {
      const styles: any = {
          approved: "bg-green-100 text-green-700 border-green-200",
          pending: "bg-orange-100 text-orange-700 border-orange-200",
          rejected: "bg-red-100 text-red-700 border-red-200"
      };
      const labels: any = { approved: 'אושר', pending: 'ממתין', rejected: 'נדחה' };
      return (
          <span className={`px-3 py-1 rounded-full text-xs font-bold border w-fit ${styles[status] || styles.pending}`}>
              {labels[status]}
          </span>
      );
  };

  if (loading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-gray-400"/></div>;

  return (
    <>
        <ManagerHeader title="אישור ובקרת טיולים" />

        <div className="p-4 md:p-8 animate-fadeIn pb-32 max-w-[100vw] overflow-x-hidden">
            
            {/* סרגל כלים וחיפוש */}
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                
                {/* פילטרים - בטלפון הם יהיו בגלילה אופקית אם צריך */}
                <div className="flex bg-white p-1 rounded-xl border border-gray-200 shadow-sm w-full md:w-auto overflow-x-auto">
                    {['pending', 'approved', 'rejected', 'all'].map((f) => (
                        <button
                            key={f}
                            onClick={() => setFilter(f)}
                            className={`px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap flex-1 md:flex-none
                            ${filter === f ? 'bg-gray-800 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'}`}
                        >
                            {f === 'pending' ? 'ממתינים' : f === 'approved' ? 'אושרו' : f === 'rejected' ? 'נדחו' : 'הכל'}
                        </button>
                    ))}
                </div>

                <div className="relative w-full md:w-80">
                    <Input 
                        placeholder="חיפוש..." 
                        value={searchTerm}
                        onChange={e => setSearchTerm(e.target.value)}
                        icon={<Search size={18}/>}
                        className="bg-white"
                    />
                </div>
            </div>

            {/* --- תצוגה 1: טבלה (רק למחשב) --- */}
            <div className="hidden md:block bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-sm">
                <div className="overflow-x-auto">
                    <table className="w-full text-right">
                        <thead className="bg-gray-50 border-b border-gray-100 text-gray-500 text-xs font-bold uppercase">
                            <tr>
                                <th className="p-5">שם הטיול</th>
                                <th className="p-5">רכז / סניף</th>
                                <th className="p-5">תאריכים</th>
                                <th className="p-5">סטטוס</th>
                                <th className="p-5 text-left">פעולות</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-50">
                            {filteredTrips.map((trip) => (
                                <tr key={trip.id} className="hover:bg-gray-50 transition-colors">
                                    <td className="p-5">
                                        <div className="font-bold text-gray-800">{trip.name}</div>
                                        <div className="text-xs text-gray-400 flex items-center gap-1 mt-1">
                                            <MapPin size={12}/> {trip.details?.timeline?.[0]?.finalLocation || 'לא צוין מיקום'}
                                        </div>
                                    </td>
                                    <td className="p-5">
                                        <div className="flex items-center gap-2">
                                            <div className="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 font-bold text-xs shrink-0">
                                                {trip.coordinator_name?.[0]}
                                            </div>
                                            <div>
                                                <div className="font-bold text-gray-700 text-sm">{trip.coordinator_name}</div>
                                                <div className="text-xs text-gray-400">{trip.branch}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td className="p-5 text-sm font-medium text-gray-600">
                                        {new Date(trip.start_date).toLocaleDateString('he-IL')}
                                    </td>
                                    <td className="p-5">
                                        {getStatusBadge(trip.status)}
                                    </td>
                                    <td className="p-5 text-left">
                                        <Link href={`/manager/approvals/${trip.id}`}>
                                            <button className="bg-[#00BCD4] hover:bg-cyan-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md shadow-cyan-100 transition-all flex items-center gap-2 ml-auto">
                                                <Eye size={16}/> צפה וטפל
                                            </button>
                                        </Link>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>

            {/* --- תצוגה 2: כרטיסים (רק לטלפון) --- */}
            <div className="md:hidden space-y-4">
                {filteredTrips.map((trip) => (
                    <div key={trip.id} className="bg-white p-5 rounded-2xl border border-gray-200 shadow-sm">
                        
                        {/* כותרת וסטטוס */}
                        <div className="flex justify-between items-start mb-3">
                            <div>
                                <h3 className="font-black text-gray-800 text-lg">{trip.name}</h3>
                                <div className="text-xs text-gray-500 flex items-center gap-1 mt-1">
                                    <MapPin size={12}/> {trip.details?.timeline?.[0]?.finalLocation || 'לא צוין'}
                                </div>
                            </div>
                            {getStatusBadge(trip.status)}
                        </div>

                        {/* פרטים נוספים */}
                        <div className="bg-gray-50 rounded-xl p-3 mb-4 space-y-2 text-sm text-gray-600">
                            <div className="flex items-center gap-2">
                                <User size={14} className="text-gray-400"/>
                                <span className="font-bold">{trip.coordinator_name}</span> 
                                <span className="text-gray-400">|</span> 
                                <span>{trip.branch}</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <Calendar size={14} className="text-gray-400"/>
                                <span>{new Date(trip.start_date).toLocaleDateString('he-IL')}</span>
                            </div>
                        </div>

                        {/* כפתור פעולה */}
                        <Link href={`/manager/approvals/${trip.id}`} className="block">
                            <button className="w-full bg-[#00BCD4] text-white py-3 rounded-xl font-bold shadow-md shadow-cyan-100 flex items-center justify-center gap-2 active:scale-95 transition-all">
                                <Eye size={18}/> כנס לטיפול בבקשה
                            </button>
                        </Link>
                    </div>
                ))}
            </div>

            {filteredTrips.length === 0 && <div className="p-12 text-center text-gray-400 font-medium">לא נמצאו טיולים</div>}
        </div>
    </>
  )
}
</file>

<file path="app/manager/layout.tsx">
"use client"

import React, { useState } from 'react';
import { ManagerSidebar } from '@/components/layout/ManagerSidebar'; 
import { Menu } from 'lucide-react';
import Image from 'next/image';

export default function ManagerLayout({ children }: { children: React.ReactNode }) {
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

  return (
    <div className="min-h-screen bg-[#F1F5F9] dir-rtl font-sans text-right relative">
      
      {/* --- כפתור המבורגר למובייל (Header) --- */}
      <div className="md:hidden flex items-center justify-between p-4 bg-[#0F172A] text-white sticky top-0 z-30 shadow-md h-16">
          <button 
            onClick={() => setIsMobileMenuOpen(true)} 
            className="p-2 hover:bg-white/10 rounded-lg transition-colors"
          >
              <Menu size={24}/>
          </button>
          
          <div className="flex items-center gap-2">
              <span className="font-bold text-sm">ממשק ניהול</span>
              {/* לוגו קטן */}
              <div className="w-8 h-8 relative">
                 <Image src="/logo.png" alt="Logo" fill className="object-contain brightness-0 invert"/>
              </div>
          </div>
          
          <div className="w-8"></div> {/* סתם תופס מקום כדי לאזן את האמצע */}
      </div>

      {/* --- הסרגל (Sidebar) --- */}
      {/* אנחנו מעבירים לו את הפקודה להיפתח או להיסגר */}
      <ManagerSidebar 
          isOpen={isMobileMenuOpen} 
          onClose={() => setIsMobileMenuOpen(false)} 
      />
      
      {/* --- התוכן הראשי --- */}
      {/* במחשב: זז שמאלה 256 פיקסלים. במובייל: תופס הכל */}
      <div className="md:mr-64 mr-0 transition-all duration-300">
        {children}
      </div>
      
    </div>
  );
}
</file>

<file path="app/manager/page.tsx">
"use client"

import React, { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { ManagerHeader } from '@/components/layout/ManagerHeader'
import { Loader2, AlertCircle, CheckCircle, Clock, UserPlus } from 'lucide-react'
import Link from 'next/link'

export default function ManagerHomePage() {
  const [stats, setStats] = useState({ pendingTrips: 0, approvedTrips: 0, totalTrips: 0, pendingUsers: 0 });
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchStats = async () => {
        try {
            // 1. נתוני טיולים
            const { count: pendingTrips } = await supabase.from('trips').select('*', { count: 'exact', head: true }).eq('status', 'pending');
            const { count: approvedTrips } = await supabase.from('trips').select('*', { count: 'exact', head: true }).eq('status', 'approved');
            const { count: totalTrips } = await supabase.from('trips').select('*', { count: 'exact', head: true });

            // 2. נתוני משתמשים (נרשמים חדשים)
            // מביאים את כל המשתמשים ובודקים ידנית למי אין סטטוס או שהוא pending
            const { data: usersData } = await supabase.from('users_management_view').select('raw_user_meta_data');
            
            const pendingUsersCount = usersData?.filter((u: any) => {
                const status = u.raw_user_meta_data?.status;
                return !status || status === 'pending'; // נחשב ממתין אם אין סטטוס או שהוא 'pending'
            }).length || 0;

            setStats({
                pendingTrips: pendingTrips || 0,
                approvedTrips: approvedTrips || 0,
                totalTrips: totalTrips || 0,
                pendingUsers: pendingUsersCount
            });

        } catch (error) {
            console.error('Error fetching stats:', error);
        } finally {
            setLoading(false);
        }
    };
    fetchStats();
  }, []);

  if (loading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-gray-400"/></div>;

  return (
    <>
      <ManagerHeader title="לוח בקרה ראשי" />
      
      <div className="p-4 md:p-10 animate-fadeIn pb-32 max-w-[100vw] overflow-x-hidden">
        <header className="mb-10">
            <h2 className="text-xl font-bold text-gray-500">תמונת מצב - ניהול מפעלים וטיולים</h2>
        </header>

        {/* שינינו את הגריד ל-4 עמודות כדי להכניס את כרטיס המשתמשים */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
             
             {/* 1. כרטיס משתמשים חדשים (חדש!) */}
             <Link href="/manager/users" className="group">
                <div className="bg-white p-6 rounded-3xl border border-gray-200 shadow-sm hover:shadow-xl hover:border-orange-500 transition-all cursor-pointer relative overflow-hidden h-full">
                    <div className="absolute top-0 right-0 w-2 h-full bg-orange-500"></div>
                    <div className="flex justify-between items-start">
                        <div>
                            <div className="text-4xl font-black text-gray-800 mb-2">{stats.pendingUsers}</div>
                            <div className="text-sm font-bold text-gray-500 group-hover:text-orange-600 transition-colors">נרשמים לאישור</div>
                        </div>
                        <div className="p-3 bg-orange-50 text-orange-500 rounded-2xl"><UserPlus size={24}/></div>
                    </div>
                </div>
            </Link>

             {/* 2. כרטיס טיולים ממתינים */}
             <Link href="/manager/approvals" className="group">
                <div className="bg-white p-6 rounded-3xl border border-gray-200 shadow-sm hover:shadow-xl hover:border-[#E91E63] transition-all cursor-pointer relative overflow-hidden h-full">
                    <div className="absolute top-0 right-0 w-2 h-full bg-[#E91E63]"></div>
                    <div className="flex justify-between items-start">
                        <div>
                            <div className="text-4xl font-black text-gray-800 mb-2">{stats.pendingTrips}</div>
                            <div className="text-sm font-bold text-gray-500 group-hover:text-[#E91E63] transition-colors">טיולים לאישור</div>
                        </div>
                        <div className="p-3 bg-red-50 text-[#E91E63] rounded-2xl"><AlertCircle size={24}/></div>
                    </div>
                </div>
            </Link>
            
            {/* 3. כרטיס מאושרים */}
             <div className="bg-white p-6 rounded-3xl border border-gray-200 shadow-sm">
                <div className="flex justify-between items-start">
                    <div>
                        <div className="text-4xl font-black text-gray-800 mb-2">{stats.approvedTrips}</div>
                        <div className="text-sm font-bold text-gray-500">טיולים שאושרו</div>
                    </div>
                    <div className="p-3 bg-green-50 text-green-600 rounded-2xl"><CheckCircle size={24}/></div>
                </div>
            </div>

            {/* 4. כרטיס סה"כ */}
            <div className="bg-white p-6 rounded-3xl border border-gray-200 shadow-sm">
                <div className="flex justify-between items-start">
                    <div>
                        <div className="text-4xl font-black text-gray-800 mb-2">{stats.totalTrips}</div>
                        <div className="text-sm font-bold text-gray-500">סה"כ פעילות</div>
                    </div>
                    <div className="p-3 bg-blue-50 text-blue-500 rounded-2xl"><Clock size={24}/></div>
                </div>
            </div>
        </div>
      </div>
    </>
  )
}
</file>

<file path="app/manager/trip/[id]/page.tsx">
"use client"

import React, { useState, useEffect, use } from 'react' // הוספתי את use
import { createClient } from '@supabase/supabase-js'
import { ArrowRight, Calendar, MapPin, CheckCircle, XCircle, Clock, AlertTriangle, Link as LinkIcon, User, FileText, Check, X } from 'lucide-react'

import { supabase } from '@/lib/supabaseClient'

// הגדרת הטיפוסים החדשה (Promise)
export default function ManagerTripView({ params }: { params: Promise<{ id: string }> }) {
  // --- התיקון הקריטי: "פתיחת" הפרמטרים באמצעות use ---
  const { id } = use(params); 
  
  const [trip, setTrip] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [processing, setProcessing] = useState(false);

  useEffect(() => {
    const fetchTrip = async () => {
      // משתמשים ב-id שכבר חילצנו למעלה
      const { data, error } = await supabase
        .from('trips')
        .select('*')
        .eq('id', id)
        .single();
        
      if (error) {
        console.error(error);
        alert('שגיאה בטעינת הטיול');
        return;
      }
      setTrip(data);
      setLoading(false);
    };
    
    if (id) {
        fetchTrip();
    }
  }, [id]); // התלות היא ב-id המחולץ

  const handleStatusUpdate = async (newStatus: 'approved' | 'rejected') => {
      if (!confirm(`האם אתה בטוח שברצונך ${newStatus === 'approved' ? 'לאשר' : 'לדחות'} את הטיול?`)) return;
      
      setProcessing(true);
      const { error } = await supabase
        .from('trips')
        .update({ status: newStatus })
        .eq('id', trip.id);

      if (error) {
          alert('שגיאה בעדכון הסטטוס');
      } else {
          setTrip({ ...trip, status: newStatus });
          alert(newStatus === 'approved' ? 'הטיול אושר בהצלחה!' : 'הטיול נדחה.');
      }
      setProcessing(false);
  };

  if (loading) return <div className="min-h-screen flex items-center justify-center"><div className="animate-spin h-10 w-10 border-4 border-[#00BCD4] rounded-full"></div></div>;

  const details = trip.details || {};
  const timeline = details.timeline || [];

  return (
    <div className="min-h-screen bg-[#F5F5F5] font-sans text-gray-800 pb-20" dir="rtl">
      <header className="bg-[#212121] text-white shadow-md sticky top-0 z-30 border-b-4 border-[#00BCD4]">
        <div className="max-w-5xl mx-auto px-6 h-16 flex items-center justify-between">
          <div className="flex items-center gap-4">
            <button onClick={() => window.history.back()} className="hover:bg-white/10 p-2 rounded-full transition-colors"><ArrowRight size={20} /></button>
            <div>
                <h1 className="font-bold text-lg">{trip.name}</h1>
                <p className="text-xs text-gray-400">רכז: {trip.coordinator_name} | סניף: {trip.branch}</p>
            </div>
          </div>
          <div className={`px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1.5 
            ${trip.status === 'approved' ? 'bg-green-500 text-white' : trip.status === 'rejected' ? 'bg-red-500 text-white' : 'bg-orange-500 text-white'}`}>
            {trip.status === 'approved' ? <CheckCircle size={14}/> : trip.status === 'rejected' ? <XCircle size={14}/> : <Clock size={14}/>}
            {trip.status === 'approved' ? 'מאושר' : trip.status === 'rejected' ? 'נדחה' : 'ממתין לאישור'}
          </div>
        </div>
      </header>

      <main className="max-w-5xl mx-auto p-6 space-y-6">
        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
            <h3 className="text-lg font-black mb-4 flex items-center gap-2 text-gray-800"><FileText size={20} className="text-[#00BCD4]"/> פרטי הבקשה</h3>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-6 bg-gray-50 p-4 rounded-xl border border-gray-100">
              <div><span className="text-xs font-bold text-gray-400 block mb-1">תאריכים</span><div className="font-bold text-sm">{details.startDate} - {details.endDate}</div></div>
              <div><span className="text-xs font-bold text-gray-400 block mb-1">משתתפים</span><div className="font-bold text-sm">{details.totalTravelers} (מתוכם {details.chanichimCount} חניכים)</div></div>
              <div><span className="text-xs font-bold text-gray-400 block mb-1">גילאים</span><div className="font-bold text-sm">{details.gradeFrom} - {details.gradeTo}</div></div>
              <div><span className="text-xs font-bold text-gray-400 block mb-1">מחלקת</span><div className="font-bold text-sm">{trip.department || 'כללי'}</div></div>
            </div>
            
            {details.generalComments && (
                <div className="mt-4 pt-4 border-t">
                    <span className="text-xs font-bold text-gray-400 block mb-1">הערות רכז:</span>
                    <p className="text-sm bg-yellow-50 p-3 rounded-lg border border-yellow-100 text-gray-700">{details.generalComments}</p>
                </div>
            )}
        </div>

        <section>
          <div className="flex items-center justify-between mb-4">
             <h3 className="text-xl font-black text-gray-800">פירוט הפעילות והאישורים</h3>
          </div>
          <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden divide-y divide-gray-100">
             {timeline.length === 0 && <div className="p-10 text-center text-gray-400">אין פעילויות מוזנות</div>}
             {timeline.map((item: any, idx: number) => {
                 const isMissing = item.requiresLicense && !item.files;
                 return (
                   <div key={idx} className={`p-5 transition-colors ${isMissing ? 'bg-red-50/50' : 'hover:bg-gray-50'}`}>
                      <div className="flex items-start gap-4">
                         <div className="bg-gray-100 text-gray-600 font-bold px-3 py-1 rounded-lg text-sm min-w-[60px] text-center mt-1 border border-gray-200">
                             {item.date ? item.date.split('-').slice(1).reverse().join('/') : '?'}
                         </div>
                         <div className="flex-1">
                            <div className="flex justify-between items-start">
                               <div>
                                   <h4 className="font-bold text-gray-900 text-lg flex items-center gap-2">
                                       {item.finalSubCategory}
                                       {item.requiresLicense && <span className="bg-orange-100 text-orange-800 px-2 py-0.5 rounded text-[10px] font-bold border border-orange-200">דורש רישוי</span>}
                                   </h4>
                                   <div className="flex items-center gap-4 mt-1 text-sm text-gray-500">
                                      <span className="flex items-center gap-1"><MapPin size={14} className="text-[#00BCD4]"/> {item.finalLocation}</span>
                                      <span className="text-gray-400">| {item.category}</span>
                                   </div>
                               </div>
                               {item.requiresLicense && (
                                   <div className="flex-shrink-0">
                                       {item.files ? (
                                           <a href={item.files.url} target="_blank" className="flex items-center gap-2 bg-green-50 text-green-700 border border-green-200 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-green-100 transition-colors">
                                               <LinkIcon size={14}/> צפה ברישיון
                                           </a>
                                       ) : (
                                           <div className="flex items-center gap-2 bg-red-100 text-red-700 border border-red-200 px-3 py-1.5 rounded-lg text-xs font-bold">
                                               <AlertTriangle size={14}/> חסר קובץ!
                                           </div>
                                       )}
                                   </div>
                               )}
                            </div>
                            {item.details && <div className="mt-3 text-sm text-gray-600 bg-white p-2.5 rounded border border-gray-100">{item.details}</div>}
                         </div>
                      </div>
                   </div>
                 )
             })}
          </div>
        </section>
      </main>

      <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 z-40 shadow-[0_-5px_20px_rgba(0,0,0,0.1)]">
         <div className="max-w-5xl mx-auto flex items-center justify-between gap-4">
            <div className="text-sm text-gray-500">
                פעולות ניהול עבור טיול #{trip.id}
            </div>
            <div className="flex gap-3">
                <button onClick={() => handleStatusUpdate('rejected')} disabled={processing} className="px-6 py-2.5 rounded-xl border border-red-200 text-red-600 font-bold hover:bg-red-50 transition-colors flex items-center gap-2 disabled:opacity-50">
                    <X size={18}/> דחה טיול
                </button>
                <button onClick={() => handleStatusUpdate('approved')} disabled={processing} className="px-8 py-2.5 rounded-xl bg-[#00BCD4] text-white font-bold hover:bg-[#00ACC1] shadow-lg transition-all flex items-center gap-2 disabled:opacity-50">
                    {processing ? <div className="animate-spin h-4 w-4 border-2 border-white rounded-full"></div> : <Check size={18}/>}
                    אשר טיול לביצוע
                </button>
            </div>
         </div>
      </div>
    </div>
  )
}
</file>

<file path="app/manager/users/page.tsx">
"use client"

import React, { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { ManagerHeader } from '@/components/layout/ManagerHeader'
import { Loader2, Shield, User, MapPin, CheckCircle, XCircle, ChevronDown, ChevronUp } from 'lucide-react'

export default function UsersManagement() {
  const [loading, setLoading] = useState(true);
  const [users, setUsers] = useState<any[]>([]);
  const [filter, setFilter] = useState('pending');
  const [expandedUser, setExpandedUser] = useState<string | null>(null);

  useEffect(() => {
    fetchUsers();
  }, []);

  const fetchUsers = async () => {
    const { data } = await supabase.from('users_management_view').select('*');
    if (data) setUsers(data);
    setLoading(false);
  };

  const updateUserStatus = async (userId: string, newStatus: string) => {
      const { error } = await supabase.rpc('update_user_status', { 
          user_id: userId, 
          new_status: newStatus 
      });
      
      if (error) {
          alert('שגיאה בעדכון: ' + error.message);
      } else {
          setUsers(prev => prev.map(u => {
              if (u.id === userId) {
                  const newMeta = { ...u.raw_user_meta_data, status: newStatus };
                  return { ...u, raw_user_meta_data: newMeta };
              }
              return u;
          }));
      }
  };

  const filteredUsers = users.filter(u => {
      const status = u.raw_user_meta_data.status || 'pending';
      return status === filter;
  });

  if (loading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-gray-400"/></div>;

  return (
    <>
      <ManagerHeader title="ניהול משתמשים ורכזים" />
      
      {/* התיקון לגלילה ולרוחב */}
      <div className="p-4 md:p-8 animate-fadeIn max-w-[100vw] overflow-x-hidden pb-32">
          
          {/* סרגל סינון - גלילה אופקית בטלפון */}
          <div className="flex gap-2 md:gap-4 mb-8 overflow-x-auto pb-2">
              {['pending', 'approved', 'rejected'].map(f => (
                  <button 
                    key={f} 
                    onClick={() => setFilter(f)}
                    className={`px-4 md:px-6 py-2 rounded-xl font-bold text-sm transition-all whitespace-nowrap flex items-center
                    ${filter === f ? 'bg-gray-800 text-white shadow-lg' : 'bg-white text-gray-500 border border-gray-200'}`}
                  >
                      {f === 'pending' ? 'ממתינים' : f === 'approved' ? 'פעילים' : 'חסומים'}
                      <span className="mr-2 bg-white/20 px-2 py-0.5 rounded-full text-xs">
                          {users.filter(u => (u.raw_user_meta_data.status || 'pending') === f).length}
                      </span>
                  </button>
              ))}
          </div>

          <div className="space-y-4">
              {filteredUsers.map((u) => {
                  const meta = u.raw_user_meta_data || {};
                  const isExpanded = expandedUser === u.id;
                  const isHQ = meta.branch === 'מטה';

                  return (
                    <div key={u.id} className="bg-white rounded-3xl border border-gray-200 shadow-sm overflow-hidden transition-all">
                        {/* שורה ראשית */}
                        <div className="p-4 md:p-6 flex flex-col md:flex-row items-start md:items-center gap-4 cursor-pointer hover:bg-gray-50 relative" onClick={() => setExpandedUser(isExpanded ? null : u.id)}>
                            
                            <div className="flex items-center gap-4 w-full md:w-auto">
                                <div className={`w-12 h-12 rounded-2xl flex items-center justify-center text-white font-bold text-xl shrink-0 ${isHQ ? 'bg-gray-800' : 'bg-[#00BCD4]'}`}>
                                    {meta.full_name?.[0] || <User/>}
                                </div>
                                <div className="flex-1">
                                    <h3 className="font-bold text-gray-800">{meta.full_name || 'ללא שם'}</h3>
                                    <div className="text-xs text-gray-500">{u.email}</div>
                                </div>
                                {/* חץ במובייל */}
                                <div className="md:hidden text-gray-400">
                                    {isExpanded ? <ChevronUp/> : <ChevronDown/>}
                                </div>
                            </div>
                            
                            <div className="flex-1 grid grid-cols-2 md:grid-cols-3 gap-2 w-full md:w-auto pl-8 md:pl-0">
                                <div className="flex items-center gap-2">
                                    <span className={`px-2 py-1 rounded-lg text-xs font-bold flex items-center gap-1 w-fit ${isHQ ? 'bg-gray-100 text-gray-700' : 'bg-cyan-50 text-cyan-700'}`}>
                                        {isHQ ? <Shield size={12}/> : <User size={12}/>}
                                        {isHQ ? 'מנהל מטה' : 'רכז סניף'}
                                    </span>
                                </div>
                                <div className="text-sm font-medium text-gray-600 flex items-center gap-1 col-span-2 md:col-span-1">
                                    <MapPin size={14}/> {meta.branch || '-'} • {meta.department || '-'}
                                </div>
                            </div>

                            {/* חץ במחשב */}
                            <button className="hidden md:block text-gray-400 ml-auto">
                                {isExpanded ? <ChevronUp/> : <ChevronDown/>}
                            </button>
                        </div>

                        {/* הרחבה */}
                        {isExpanded && (
                            <div className="p-6 bg-gray-50 border-t border-gray-100 animate-fadeIn">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 mb-6">
                                    <div className="space-y-2">
                                        <p className="text-xs font-bold text-gray-400">תעודת זהות</p>
                                        <p className="font-medium text-gray-800 bg-white p-2 rounded border border-gray-100">{meta.id_number || '-'}</p>
                                    </div>
                                    <div className="space-y-2">
                                        <p className="text-xs font-bold text-gray-400">טלפון</p>
                                        <p className="font-medium text-gray-800 bg-white p-2 rounded border border-gray-100">{meta.phone || '-'}</p>
                                    </div>
                                    <div className="space-y-2">
                                        <p className="text-xs font-bold text-gray-400">כתובת למשלוח</p>
                                        <p className="font-medium text-gray-800 bg-white p-2 rounded border border-gray-100">{meta.branch_address || '-'}</p>
                                    </div>
                                    <div className="space-y-2">
                                        <p className="text-xs font-bold text-gray-400">הצטרף בתאריך</p>
                                        <p className="font-medium text-gray-800">{new Date(u.created_at).toLocaleDateString('he-IL')}</p>
                                    </div>
                                </div>

                                <div className="flex flex-col md:flex-row justify-end gap-3 pt-4 border-t border-gray-200">
                                    {filter !== 'approved' && (
                                        <button onClick={() => updateUserStatus(u.id, 'approved')} className="flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-green-100 transition-all w-full md:w-auto">
                                            <CheckCircle size={18}/> אשר משתמש
                                        </button>
                                    )}
                                    {filter !== 'rejected' && (
                                        <button onClick={() => updateUserStatus(u.id, 'rejected')} className="flex items-center justify-center gap-2 bg-white border border-red-200 text-red-600 hover:bg-red-50 px-6 py-3 rounded-xl font-bold transition-all w-full md:w-auto">
                                            <XCircle size={18}/> חסום / דחה
                                        </button>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                  )
              })}
              {filteredUsers.length === 0 && <div className="text-center p-10 text-gray-400">לא נמצאו משתמשים בסטטוס זה</div>}
          </div>
      </div>
    </>
  )
}
</file>

<file path="lib/supabaseClient.ts">
import { createBrowserClient } from '@supabase/ssr';

// 1. קריאה למשתני הסביבה
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

// בדיקת בטיחות (השארתי את זה כי זה רעיון טוב)
if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error('Missing Supabase Environment Variables!');
}

// 2. יצירת הקליינט החדש - שים לב לשינוי כאן!
// אנחנו משתמשים ב-createBrowserClient במקום createClient הרגיל
export const supabase = createBrowserClient(supabaseUrl, supabaseAnonKey);

// 3. פונקציית העזר (שמרנו אותה כדי לא לשבור קבצים אחרים שמשתמשים בה)
export const getIdAsEmail = (idNumber: string) => {
  return `${idNumber}@noar.chabad.co.il`;
};
</file>

<file path="app/dashboard/layout.tsx">
"use client"

import React, { useState, useEffect } from 'react';
import { Sidebar } from '@/components/layout/Sidebar';
import { Menu, Bell, X, Mail } from 'lucide-react';
import Image from 'next/image';
import { supabase } from '@/lib/supabaseClient';
import Link from 'next/link';

const DEPT_LOGOS: any = {
    'בת מלך': '/logos/bat-melech.png',
    'בנות חב״ד': '/logos/bnos-chabad.png',
    'הפנסאים': '/logos/hapanasim.png',
    'תמים': '/logos/temimim.png',
    'מועדוני המעשים הטובים': '/logos/clubs.png',
};

export default function DashboardLayout({ children }: { children: React.ReactNode }) {
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
  const [user, setUser] = useState<any>(null);
  const [unreadNotifications, setUnreadNotifications] = useState<any[]>([]);
  const [isBellOpen, setIsBellOpen] = useState(false);

  useEffect(() => {
      const initData = async () => {
          const { data: { user } } = await supabase.auth.getUser();
          if (user) {
              setUser(user);
              fetchNotifications(user.id);
          }
      };
      initData();

      const channel = supabase.channel('layout_notifications')
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications' }, () => {
              if (user?.id) fetchNotifications(user.id);
          })
          .subscribe();

      return () => { supabase.removeChannel(channel); }
  }, []);

  const fetchNotifications = async (userId: string) => {
      const { data } = await supabase.from('notifications')
          .select('id, title, is_read')
          .eq('user_id', userId)
          .eq('is_read', false)
          .order('created_at', { ascending: false })
          .limit(5);
      setUnreadNotifications(data || []);
  };

  const deptLogo = user ? (DEPT_LOGOS[user.user_metadata?.department] || '/logo.png') : '/logo.png';

  return (
    <div className="min-h-screen bg-[#F8F9FA] dir-rtl text-right font-sans">
      
      <div className="md:hidden flex items-center justify-between p-3 bg-white/95 backdrop-blur-md border-b border-gray-200 sticky top-0 z-40 shadow-sm h-16">
          <div className="flex items-center gap-3">
              <button 
                onClick={() => setIsMobileMenuOpen(true)}
                className="p-2 rounded-xl bg-gray-50 text-gray-600 hover:bg-gray-100 active:scale-95 border border-gray-200"
              >
                  <Menu size={20} />
              </button>
              <div className="w-8 h-8 relative">
                 <Image src="/logo.png" alt="Logo" fill className="object-contain"/>
              </div>
              <div className="h-5 w-px bg-gray-200"></div>
              <div className="w-8 h-8 relative">
                 <Image src={deptLogo} alt="Dept" fill className="object-contain"/>
              </div>
          </div>
          
          <Link href="/dashboard/profile" className="flex items-center gap-2 bg-gray-50 p-1 pl-1 pr-3 rounded-full border border-gray-100 shadow-sm">
              <div className="flex flex-col items-end">
                  <span className="text-xs font-bold text-gray-800 leading-none truncate max-w-[80px]">
                      {user?.user_metadata?.full_name?.split(' ')[0]}
                  </span>
                  <span className="text-[9px] text-gray-500 leading-none truncate max-w-[80px] mt-0.5">
                      {user?.user_metadata?.branch || 'מטה'}
                  </span>
              </div>
              <div className="w-8 h-8 rounded-full bg-cyan-100 border border-white overflow-hidden relative">
                  {user?.user_metadata?.avatar_url ? (
                      <Image src={user.user_metadata.avatar_url} alt="User" fill className="object-cover" />
                  ) : (
                      <div className="w-full h-full flex items-center justify-center text-cyan-600 font-bold text-xs">
                          {user?.user_metadata?.full_name?.[0]}
                      </div>
                  )}
              </div>
          </Link>
      </div>

      <Sidebar isOpen={isMobileMenuOpen} onClose={() => setIsMobileMenuOpen(false)} />
      
      <div className="transition-all duration-300 md:mr-56 mr-0 min-h-screen">
        {children}
      </div>

      {/* תיקון: md:hidden - מוסתר במחשב, מוצג רק במובייל */}
      <div className="fixed bottom-6 left-6 z-50 flex flex-col items-end gap-2 md:hidden">
          {isBellOpen && (
              <div className="bg-white rounded-2xl shadow-2xl border border-gray-100 w-72 mb-2 overflow-hidden animate-fadeIn">
                  <div className="bg-[#00BCD4] p-3 flex justify-between items-center text-white">
                      <span className="text-sm font-bold">הודעות חדשות</span>
                      <button onClick={() => setIsBellOpen(false)}><X size={16}/></button>
                  </div>
                  <div className="max-h-60 overflow-y-auto">
                      {unreadNotifications.length === 0 ? (
                          <div className="p-6 text-center text-gray-400 text-xs">אין הודעות חדשות עבורך</div>
                      ) : (
                          unreadNotifications.map(n => (
                              <Link key={n.id} href="/dashboard/inbox" onClick={() => setIsBellOpen(false)} className="block p-3 border-b border-gray-50 hover:bg-gray-50 transition-colors">
                                  <div className="flex gap-2">
                                      <Mail size={14} className="text-[#00BCD4] mt-0.5 shrink-0"/>
                                      <span className="text-xs font-bold text-gray-700 line-clamp-2">{n.title}</span>
                                  </div>
                              </Link>
                          ))
                      )}
                  </div>
                  <Link href="/dashboard/inbox" onClick={() => setIsBellOpen(false)} className="block p-2 text-center text-xs font-bold text-[#00BCD4] bg-gray-50 hover:underline">
                      לכל ההודעות
                  </Link>
              </div>
          )}

          <button 
            onClick={() => setIsBellOpen(!isBellOpen)}
            className="w-12 h-12 bg-white rounded-full shadow-lg shadow-gray-300 border border-gray-100 flex items-center justify-center text-gray-600 hover:text-[#00BCD4] transition-all hover:scale-110 active:scale-95 relative"
          >
              <Bell size={22} />
              {unreadNotifications.length > 0 && (
                  <span className="absolute top-0 right-0 w-4 h-4 bg-[#E91E63] text-white text-[10px] font-bold rounded-full flex items-center justify-center border border-white animate-pulse">
                      {unreadNotifications.length}
                  </span>
              )}
          </button>
      </div>

    </div>
  );
}
</file>

<file path="app/globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --brand-cyan: #00BCD4;
  --brand-green: #8BC34A;
  --brand-pink: #E91E63;
  --brand-yellow: #FFC107;
  --brand-dark: #263238;
  --bg-light: #F8F9FA;
  
  /* משתני הפונט מוגדרים ב-Layout */
}

body {
  @apply bg-[#F4F6F8] text-brand-dark font-sans; /* רקע טיפה יותר אפרפר-כחלחל מודרני */
  direction: rtl;
}

/* אפקט זכוכית יוקרתי */
.glass {
  @apply bg-white/80 backdrop-blur-xl border-b border-white/20;
}

/* כרטיס יוקרתי - רך, עגול, עם צל עדין */
.card-premium {
  @apply bg-white rounded-[32px] shadow-[0_8px_30px_rgba(0,0,0,0.04)] border border-gray-100/50 hover:shadow-[0_8px_30px_rgba(0,188,212,0.1)] transition-all duration-300;
}
</file>

<file path="app/manager/inbox/page.tsx">
"use client"

import React, { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { ManagerHeader } from '@/components/layout/ManagerHeader'
import { Button } from '@/components/ui/Button'
import { Loader2, HelpCircle, CheckCircle, Bug, Reply, Send, X, Clock, User } from 'lucide-react'

export default function ManagerInbox() {
  const [loading, setLoading] = useState(true);
  const [messages, setMessages] = useState<any[]>([]);
  const [isSuperAdmin, setIsSuperAdmin] = useState(false);
  
  // ניהול תגובה
  const [replyingTo, setReplyingTo] = useState<string | null>(null);
  const [replyText, setReplyText] = useState('');
  const [sendingReply, setSendingReply] = useState(false);

  useEffect(() => {
    const init = async () => {
        const { data: { user } } = await supabase.auth.getUser();
        const myEmail = 'avremihalperin@gmail.com'; 

        if (user?.email === myEmail || user?.user_metadata?.contact_email === myEmail) {
            setIsSuperAdmin(true);
        }
        fetchMessages();
    };
    init();
  }, []);

  const fetchMessages = async () => {
    const { data } = await supabase
      .from('contact_messages')
      .select('*, user:user_id ( email, raw_user_meta_data )') 
      .order('created_at', { ascending: false });
    
    if (data) setMessages(data);
    setLoading(false);
  };

  const markAsTreated = async (id: string) => {
      await supabase.from('contact_messages').update({ status: 'treated' }).eq('id', id);
      fetchMessages();
  };

  const sendReply = async (originalMsg: any) => {
      if (!replyText) return;
      setSendingReply(true);

      try {
          await supabase.from('notifications').insert([{
              user_id: originalMsg.user_id,
              title: `תשובה לפנייתך: ${originalMsg.subject}`,
              message: `מטה בטיחות ענה:\n"${replyText}"`,
              type: 'info',
              link: '/dashboard/contact'
          }]);

          await markAsTreated(originalMsg.id);
          
          setReplyingTo(null);
          setReplyText('');
          alert('התשובה נשלחה בהצלחה!');

      } catch (e) {
          alert('שגיאה בשליחה');
      } finally {
          setSendingReply(false);
      }
  };

  if (loading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-gray-400"/></div>;

  return (
    <>
      <ManagerHeader title="דואר נכנס והודעות" />

      {/* התיקון לגלילה: max-w-[100vw] overflow-x-hidden */}
      <div className="p-4 md:p-8 animate-fadeIn max-w-[100vw] overflow-x-hidden pb-32">
          
          {/* --- תצוגה 1: טבלה (רק למחשב) --- */}
          <div className="hidden md:block bg-white rounded-3xl border border-gray-200 shadow-sm overflow-hidden">
              <div className="overflow-x-auto">
                <table className="w-full text-right">
                    <thead className="bg-gray-50 text-gray-500 text-xs font-bold uppercase border-b border-gray-100">
                        <tr>
                            <th className="p-5">נושא</th>
                            <th className="p-5">מאת</th>
                            <th className="p-5">תוכן</th>
                            <th className="p-5">סטטוס</th>
                            <th className="p-5 text-left">פעולות</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-50">
                        {messages.map((msg) => {
                            const isBug = msg.subject?.includes('תקלה') || msg.subject?.includes('באג');
                            if (isBug && !isSuperAdmin) return null;
                            const isReplying = replyingTo === msg.id;
                            const senderName = msg.user?.raw_user_meta_data?.full_name || 'משתמש לא ידוע';

                            return (
                                <React.Fragment key={msg.id}>
                                    <tr className={`transition-colors ${isReplying ? 'bg-blue-50' : 'hover:bg-gray-50'}`}>
                                        <td className="p-5 font-bold text-gray-800 flex items-center gap-2">
                                            {isBug ? <Bug size={16} className="text-red-500"/> : <HelpCircle size={16} className="text-blue-500"/>}
                                            {msg.subject}
                                        </td>
                                        <td className="p-5 text-sm text-gray-600">
                                            <div className="font-bold">{senderName}</div>
                                            <div className="text-xs text-gray-400">{new Date(msg.created_at).toLocaleDateString('he-IL')}</div>
                                        </td>
                                        <td className="p-5 text-sm text-gray-600 max-w-xs truncate cursor-pointer" title={msg.message} onClick={() => alert(msg.message)}>
                                            {msg.message}
                                        </td>
                                        <td className="p-5">
                                            {msg.status === 'treated' 
                                                ? <span className="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold border border-green-200">טופל</span>
                                                : <span className="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-xs font-bold border border-yellow-200">חדש</span>
                                            }
                                        </td>
                                        <td className="p-5 text-left flex justify-end gap-2">
                                            {msg.status !== 'treated' && !isReplying && (
                                                <>
                                                    <button onClick={() => setReplyingTo(msg.id)} className="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg text-xs font-bold shadow-md transition-all flex items-center gap-1">
                                                        <Reply size={16}/> ענה
                                                    </button>
                                                    <button onClick={() => markAsTreated(msg.id)} className="text-green-600 hover:bg-green-50 p-2 rounded-lg text-xs font-bold border border-transparent hover:border-green-200 transition-all">
                                                        <CheckCircle size={16}/>
                                                    </button>
                                                </>
                                            )}
                                        </td>
                                    </tr>
                                    {isReplying && (
                                        <tr className="bg-blue-50/50 animate-fadeIn">
                                            <td colSpan={5} className="p-5">
                                                <div className="bg-white border border-blue-100 rounded-xl p-4 shadow-sm max-w-2xl mr-auto">
                                                    <p className="text-xs font-bold text-blue-600 mb-2">תגובה ל: {senderName}</p>
                                                    <textarea 
                                                        className="w-full p-3 border border-gray-200 rounded-lg text-sm focus:border-blue-500 outline-none"
                                                        placeholder="כתוב את תשובתך כאן..."
                                                        rows={3}
                                                        value={replyText}
                                                        onChange={e => setReplyText(e.target.value)}
                                                    ></textarea>
                                                    <div className="flex justify-end gap-2 mt-2">
                                                        <Button variant="secondary" onClick={() => setReplyingTo(null)} className="bg-gray-200 text-gray-600 h-8 px-4"><X size={14}/></Button>
                                                        <Button onClick={() => sendReply(msg)} isLoading={sendingReply} icon={<Send size={14}/>} className="bg-blue-600 h-8 px-6 text-xs">שלח תשובה וסגור</Button>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    )}
                                </React.Fragment>
                            )
                        })}
                    </tbody>
                </table>
              </div>
          </div>

          {/* --- תצוגה 2: כרטיסים (רק לטלפון) --- */}
          <div className="md:hidden space-y-4">
              {messages.map((msg) => {
                  const isBug = msg.subject?.includes('תקלה') || msg.subject?.includes('באג');
                  if (isBug && !isSuperAdmin) return null;
                  const isReplying = replyingTo === msg.id;
                  const senderName = msg.user?.raw_user_meta_data?.full_name || 'משתמש לא ידוע';

                  return (
                      <div key={msg.id} className={`bg-white p-5 rounded-2xl border shadow-sm ${isReplying ? 'border-blue-300 ring-2 ring-blue-50' : 'border-gray-200'}`}>
                          
                          {/* כותרת הכרטיס */}
                          <div className="flex justify-between items-start mb-3">
                              <div className="flex items-start gap-2">
                                  {isBug ? <Bug size={18} className="text-red-500 mt-1"/> : <HelpCircle size={18} className="text-blue-500 mt-1"/>}
                                  <div>
                                      <h3 className="font-bold text-gray-800 text-sm leading-tight">{msg.subject}</h3>
                                      <div className="flex items-center gap-2 mt-1">
                                          <span className="text-xs text-gray-500 flex items-center gap-1"><User size={12}/> {senderName}</span>
                                          <span className="text-gray-300">|</span>
                                          <span className="text-xs text-gray-500 flex items-center gap-1"><Clock size={12}/> {new Date(msg.created_at).toLocaleDateString('he-IL')}</span>
                                      </div>
                                  </div>
                              </div>
                              {msg.status === 'treated' 
                                  ? <span className="bg-green-100 text-green-700 px-2 py-0.5 rounded text-[10px] font-bold border border-green-200">טופל</span>
                                  : <span className="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-[10px] font-bold border border-yellow-200">חדש</span>
                              }
                          </div>

                          {/* תוכן ההודעה */}
                          <div className="bg-gray-50 p-3 rounded-xl text-sm text-gray-700 mb-4 border border-gray-100">
                              {msg.message}
                          </div>

                          {/* פעולות */}
                          {msg.status !== 'treated' && !isReplying && (
                              <div className="flex gap-2">
                                  <button onClick={() => setReplyingTo(msg.id)} className="flex-1 bg-blue-600 text-white py-2.5 rounded-xl font-bold text-sm shadow-md flex items-center justify-center gap-2">
                                      <Reply size={16}/> השב להודעה
                                  </button>
                                  <button onClick={() => markAsTreated(msg.id)} className="bg-green-50 text-green-600 border border-green-200 py-2.5 px-4 rounded-xl font-bold text-sm flex items-center justify-center">
                                      <CheckCircle size={18}/>
                                  </button>
                              </div>
                          )}

                          {/* אזור תגובה בתוך הכרטיס */}
                          {isReplying && (
                              <div className="animate-fadeIn mt-2 pt-2 border-t border-blue-100">
                                  <p className="text-xs font-bold text-blue-600 mb-2">תגובה שלך:</p>
                                  <textarea 
                                      className="w-full p-3 border border-gray-200 rounded-xl text-sm focus:border-blue-500 outline-none bg-blue-50/30"
                                      placeholder="הקלד תשובה..."
                                      rows={3}
                                      value={replyText}
                                      onChange={e => setReplyText(e.target.value)}
                                  ></textarea>
                                  <div className="flex gap-2 mt-3">
                                      <Button variant="secondary" onClick={() => setReplyingTo(null)} className="bg-gray-100 text-gray-500 h-10 px-0 w-12 flex items-center justify-center"><X size={18}/></Button>
                                      <Button onClick={() => sendReply(msg)} isLoading={sendingReply} icon={<Send size={16}/>} className="bg-blue-600 h-10 text-sm flex-1">שלח</Button>
                                  </div>
                              </div>
                          )}
                      </div>
                  )
              })}
          </div>
      </div>
    </>
  )
}
</file>

<file path="components/layout/Sidebar.tsx">
"use client"

import React from 'react'
import Link from 'next/link'
import Image from 'next/image'
import { usePathname } from 'next/navigation'
import { supabase } from '@/lib/supabaseClient'
import { 
  Home, PlusCircle, FileText, User, MessageSquare, LogOut, Bell, X
} from 'lucide-react'

interface SidebarProps {
    isOpen?: boolean;
    onClose?: () => void;
}

export const Sidebar = ({ isOpen = true, onClose }: SidebarProps) => {
  const pathname = usePathname();

  const menuItems = [
    { label: 'ראשי', href: '/dashboard', icon: Home, exact: true },
    { label: 'הודעות ועדכונים', href: '/dashboard/inbox', icon: Bell },
    { label: 'טיול חדש', href: '/dashboard/new-trip', icon: PlusCircle },
    { label: 'הטיולים שלי', href: '/dashboard/my-trips', icon: FileText },
    { label: 'פרופיל אישי', href: '/dashboard/profile', icon: User },
    { label: 'עזרה ותמיכה', href: '/dashboard/contact', icon: MessageSquare }
  ];

  const handleLogout = async () => {
    await supabase.auth.signOut();
    window.location.href = '/';
  };

  return (
    <>
        {/* Overlay */}
        <div 
            className={`fixed inset-0 bg-black/60 z-[90] transition-opacity duration-300 md:hidden backdrop-blur-sm
            ${isOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`}
            onClick={onClose}
        ></div>

        <aside className={`w-56 bg-white border-l border-gray-200 h-screen fixed right-0 top-0 z-[100] flex flex-col shadow-2xl transition-transform duration-300
            ${isOpen ? 'translate-x-0' : 'translate-x-full'} 
            md:translate-x-0 md:z-40 md:shadow-none`}
        >
          
          <div className="h-24 flex flex-col items-center justify-center border-b border-gray-100 p-4 relative">
              <button 
                onClick={(e) => {
                    e.stopPropagation();
                    if (onClose) onClose();
                }}
                className="absolute top-3 left-3 md:hidden text-gray-400 hover:text-red-500 p-1.5 bg-gray-50 rounded-lg hover:bg-red-50 transition-all z-50 cursor-pointer active:scale-90"
              >
                  <X size={20} />
              </button>

              <div className="relative w-full h-10 md:h-12 flex items-center justify-center mt-1">
                 <Image src="/logo.png" alt="נוער חב״ד" fill className="object-contain" priority />
              </div>
          </div>

          <nav className="flex-1 p-3 space-y-1.5 overflow-y-auto custom-scrollbar">
            {menuItems.map((item) => {
              const isActive = item.exact 
                ? pathname === item.href
                : pathname?.startsWith(item.href);
              const Icon = item.icon;

              return (
                <Link 
                  key={item.href} 
                  href={item.href}
                  onClick={() => { if(onClose) onClose() }} 
                  className={`flex items-center gap-3 px-3 py-3 rounded-xl transition-all duration-200 font-bold text-sm whitespace-nowrap
                    ${isActive 
                      ? 'bg-cyan-50 text-[#00BCD4] shadow-sm' 
                      : 'text-gray-500 hover:bg-gray-50 hover:text-gray-900'
                    }`}
                >
                  <Icon size={18} strokeWidth={isActive ? 2.5 : 2} />
                  {item.label}
                </Link>
              )
            })}
          </nav>

          <div className="p-3 border-t border-gray-100">
            {/* תיקון: הוספתי justify-center כדי למרכז את התוכן */}
            <button onClick={handleLogout} className="flex items-center justify-center gap-3 px-3 py-3 rounded-xl w-full text-red-500 hover:bg-red-50 transition-all font-bold text-sm group">
              <LogOut size={18} className="group-hover:-translate-x-1 transition-transform"/>
              יציאה
            </button>
          </div>
        </aside>
    </>
  )
}
</file>

<file path="app/layout.tsx">
import type { Metadata } from "next";
import { Rubik } from "next/font/google";
import "./globals.css"; // <--- חייב להיות כאן!

const rubik = Rubik({
  subsets: ["hebrew", "latin"],
  weight: ["300", "400", "500", "700", "900"],
  variable: "--font-rubik",
});

export const metadata: Metadata = {
  title: 'בטיחות ומפעלים | נוער חב"ד',
  description: 'מערכת לניהול, תכנון ואישור טיולים ואירועים',
  manifest: '/manifest.json', // הוספנו את זה
  icons: {
    icon: '/icon.png',        // הוספנו את זה
    apple: '/icon.png',       // אייקון לאייפון
  },
  themeColor: '#00BCD4',      // צבע הדפדפן במובייל
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="he" dir="rtl">
      <body className={`${rubik.variable} bg-[#F8F9FA] text-[#263238] font-sans antialiased`}>
        <main className="min-h-screen flex flex-col">
           {children}
        </main>
      </body>
    </html>
  );
}
</file>

<file path="middleware.ts">
import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function middleware(request: NextRequest) {
  let response = NextResponse.next({
    request: {
      headers: request.headers,
    },
  })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() { return request.cookies.getAll() },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) => request.cookies.set(name, value))
          response = NextResponse.next({ request: { headers: request.headers } })
          cookiesToSet.forEach(({ name, value, options }) => response.cookies.set(name, value, options))
        },
      },
    }
  )

  const { data: { user } } = await supabase.auth.getUser()

  // רק אם מישהו מנסה להיכנס לדשבורד ואין לו יוזר - תעיף אותו
  if (!user && request.nextUrl.pathname.startsWith('/dashboard')) {
   return NextResponse.redirect(new URL('/', request.url))
}
  
  if (!user && request.nextUrl.pathname.startsWith('/manager')) {
    return NextResponse.redirect(new URL('/', request.url))
  }

  return response
}

export const config = {
  // הקשחנו את המאצ'ר: ה-Middleware ירוץ *רק* על הנתיבים האלה ולא על דף הבית
  matcher: ['/dashboard/:path*', '/manager/:path*'],
}
</file>

<file path="app/page.tsx">
"use client";

import React, { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabaseClient';
import { ArrowLeft, UserPlus, ShieldCheck, Users, Briefcase, ArrowRight, Check } from 'lucide-react';
import { Button } from '@/components/ui/Button';
import { Input } from '@/components/ui/Input';
import { useRouter } from 'next/navigation';
import Image from 'next/image'; 

// --- הגדרות עיצוב ומגדר לכל מחלקה ---
const DEPARTMENTS_CONFIG: Record<string, { color: string; gender: 'male' | 'female' | 'mixed'; logo: string }> = {
  "בת מלך": { 
      color: "border-pink-400 text-pink-600 bg-pink-50 hover:bg-pink-100", 
      gender: "female", 
      logo: "/logos/bat-melech.png" 
  },
  "בנות חב\"ד": { 
      color: "border-pink-400 text-pink-600 bg-pink-50 hover:bg-pink-100", 
      gender: "female", 
      logo: "/logos/bnos-chabad.png" 
  },
  "הפנסאים": { 
      color: "border-blue-400 text-blue-600 bg-blue-50 hover:bg-blue-100", 
      gender: "male", 
      logo: "/logos/hapanasim.png" 
  },
  "תמים": { 
      color: "border-blue-400 text-blue-600 bg-blue-50 hover:bg-blue-100", 
      gender: "male", 
      logo: "/logos/temimim.png" 
  },
  "מועדוני המעשים הטובים": { 
      color: "border-green-400 text-green-600 bg-green-50 hover:bg-green-100", 
      gender: "mixed", 
      logo: "/logos/clubs.png" 
  }
};

const SUPER_ADMIN_EMAIL = process.env.NEXT_PUBLIC_SUPER_ADMIN_EMAIL;

export default function Home() {
  const router = useRouter();
  const [view, setView] = useState<'landing' | 'login' | 'dept_selection' | 'role_selection' | 'register_form'>('landing');
  const [loading, setLoading] = useState(false);
  const [errorMsg, setErrorMsg] = useState('');
  const [successMsg, setSuccessMsg] = useState('');

  // דאטה
  const [selectedDept, setSelectedDept] = useState(''); 
  const [selectedRoleType, setSelectedRoleType] = useState(''); 
  const [formData, setFormData] = useState({
    idNumber: '', password: '', fullName: '', phone: '', email: '', birthDate: '', branch: '', role: ''
  });

  const getRoleLabel = (roleType: 'coordinator' | 'hq') => {
    const config = DEPARTMENTS_CONFIG[selectedDept];
    const gender = config?.gender || 'mixed';

    if (roleType === 'coordinator') {
        if (gender === 'female') return 'רכזת סניף';
        if (gender === 'male') return 'רכז סניף';
        return 'רכז/ת סניף';
    } else { // HQ
        return 'צוות מטה';
    }
  };

  useEffect(() => {
    const autoLogin = async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        setLoading(true);
        try {
          await checkRoleAndRedirect(session.user);
        } catch (error) {
          console.log("Auto-login failed:", error);
          await supabase.auth.signOut();
          setLoading(false);
        }
      }
    };
    autoLogin();
  }, []);

  const checkRoleAndRedirect = async (user: any) => {
    const meta = user.user_metadata || {};
    const status = meta.status || 'pending';

    if (user.email !== SUPER_ADMIN_EMAIL && status !== 'approved') {
        await supabase.auth.signOut();
        throw new Error(status === 'pending' ? 'ההרשמה נקלטה אך טרם אושרה.' : 'הגישה למערכת נחסמה.');
    }

    router.refresh(); 
    await new Promise(resolve => setTimeout(resolve, 500));

    if (meta.department === 'בטיחות ומפעלים' || meta.role === 'safety_admin') {
        router.push('/manager');
    } else {
        router.push('/dashboard');
    }
  };

  const handleInputChange = (e: any) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  const handleLogin = async (e: any) => {
    e.preventDefault();
    setLoading(true); setErrorMsg('');

    try {
        const email = formData.idNumber.includes('@') ? formData.idNumber : `${formData.idNumber}@noar.chabad.co.il`; 
        const { data, error } = await supabase.auth.signInWithPassword({ email: email, password: formData.password });

        if (error) {
          setErrorMsg('שגיאה בהתחברות: בדוק את תעודת הזהות והסיסמה.');
          setLoading(false);
          return;
        }
        await checkRoleAndRedirect(data.user);
    } catch (err: any) {
        console.error(err);
        setErrorMsg(err.message || 'שגיאה כללית במערכת');
        setLoading(false);
    }
  };

  const handleRegister = async (e: any) => {
    e.preventDefault();
    setLoading(true); setErrorMsg('');

    try {
        const email = `${formData.idNumber}@noar.chabad.co.il`;
        const { error } = await supabase.auth.signUp({
          email: email,
          password: formData.password,
          options: {
            data: {
              full_name: formData.fullName,
              identity_number: formData.idNumber,
              department: selectedDept, 
              role: selectedRoleType,   
              branch_name: selectedRoleType === 'coordinator' ? formData.branch : null,
              phone: formData.phone,
              contact_email: formData.email,
              birth_date: formData.birthDate,
              status: 'pending'
            },
          },
        });

        if (error) {
          setErrorMsg(error.message);
          setLoading(false);
        } else {
          setSuccessMsg('נרשמת בהצלחה! החשבון ממתין לאישור מנהל.');
          setTimeout(() => {
              setSuccessMsg('');
              setView('login');
              setLoading(false);
          }, 2000);
        }
    } catch (err) {
        console.error(err);
        setLoading(false);
    }
  };

  // --- View: Landing (דף כניסה) ---
  if (view === 'landing') {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-[#F8F9FA] p-4 relative overflow-hidden">
        <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-[#00BCD4] via-[#4CAF50] to-[#E91E63]"></div>
        
        <main className="max-w-md w-full text-center space-y-8 relative z-10 animate-fadeIn">
          
          <div className="relative mx-auto w-32 h-20 bg-white p-3 rounded-2xl shadow-lg flex items-center justify-center mb-6 border border-gray-50 transform hover:scale-105 transition-transform duration-500">
            <Image 
                src="/logo.png" 
                alt="לוגו נוער חב״ד" 
                fill
                className="object-contain p-1"
                priority
            />
          </div>

          <div className="space-y-3">
            <h1 className="text-3xl md:text-4xl font-black text-[#00BCD4] leading-tight drop-shadow-sm">
                מערכת הטיולים והאירועים
                <span className="block text-2xl md:text-3xl text-gray-800 mt-1">של ארגון נוער חב"ד</span>
            </h1>
            
            <p className="text-gray-500 font-medium text-lg px-4">
                פלטפורמת הניהול לתכנון, אישור ובקרה
            </p>
          </div>

          <div className="space-y-4 pt-4 px-6">
            
            <Button 
                onClick={() => setView('login')} 
                className="w-full bg-[#4DD0E1] border-2 border-[#00BCD4] text-white text-lg py-6 rounded-2xl shadow-lg transition-all font-bold justify-center hover:bg-[#00BCD4]"
            >
              כניסה למערכת
            </Button>

            <div className="pt-2 space-y-3">
                <div className="relative flex py-2 items-center">
                    <div className="flex-grow border-t border-gray-200"></div>
                    <span className="flex-shrink-0 mx-4 text-gray-400 text-xs font-bold">משתמש/ת חדש/ה?</span>
                    <div className="flex-grow border-t border-gray-200"></div>
                </div>

                <Button 
                    onClick={() => setView('dept_selection')} 
                    className="w-full bg-white border-2 border-[#E91E63] !text-[#E91E63] hover:bg-[#FCE4EC] text-lg py-6 rounded-2xl transition-all font-bold justify-center flex items-center gap-2"
                >
                    <UserPlus size={20} className="text-[#E91E63]" />
                    <span className="text-[#E91E63]">להרשמה</span>
                </Button>
            </div>
          </div>

          <div className="mt-16 text-xs text-gray-300 font-medium">© ארגון נוער חב"ד</div>
        </main>
      </div>
    );
  }

  // --- View: Login ---
  if (view === 'login') {
    return (
      <div className="min-h-screen bg-white flex flex-col items-center justify-center p-6">
        <button onClick={() => setView('landing')} className="absolute top-6 right-6 text-gray-400 hover:text-[#00BCD4] transition-colors">
            <ArrowLeft size={24} className="rotate-180" />
        </button>

        <div className="w-full max-w-sm animate-fadeIn">
            <div className="text-center mb-8">
                <h2 className="text-2xl font-black text-gray-800">התחברות</h2>
                <p className="text-gray-400 text-sm mt-1">הזן את פרטיך לכניסה למערכת</p>
            </div>

            <form onSubmit={handleLogin} className="space-y-5">
              <Input label="תעודת זהות" name="idNumber" required onChange={handleInputChange} autoFocus />
              <Input label="סיסמה" type="password" name="password" required onChange={handleInputChange} />

              {errorMsg && (
                  <div className="bg-red-50 text-red-600 p-3 rounded-xl text-sm font-bold border border-red-100 flex items-center gap-2">
                      <span className="block w-1.5 h-1.5 bg-red-600 rounded-full"></span>{errorMsg}
                  </div>
              )}

              <Button type="submit" isLoading={loading} className="w-full mt-4 bg-[#00BCD4] hover:bg-cyan-600">כניסה</Button>
            </form>
        </div>
      </div>
    );
  }

  // --- View: Dept Selection ---
  if (view === 'dept_selection') {
    return (
      <div className="min-h-screen bg-[#F8F9FA] p-6 flex flex-col items-center">
        <header className="w-full max-w-md flex justify-between items-center mb-8 mt-4">
            <button onClick={() => setView('landing')} className="text-gray-400 hover:text-[#00BCD4]"><ArrowLeft className="rotate-180"/></button>
            <div className="text-xs font-bold text-gray-300">שלב 1 מתוך 3</div>
        </header>

        <main className="w-full max-w-md animate-fadeIn">
          <h2 className="text-2xl font-black text-gray-800 mb-2 text-center">לאיזו מחלקה את/ה שייך/ת?</h2>
          <p className="text-center text-gray-400 mb-8 text-sm">בחר/י את המחלקה הרלוונטית להמשך ההרשמה</p>
          
          <div className="grid grid-cols-1 gap-3">
            {Object.keys(DEPARTMENTS_CONFIG).map((dept) => {
                const config = DEPARTMENTS_CONFIG[dept];
                return (
                    <button 
                        key={dept} 
                        onClick={() => { setSelectedDept(dept); setView('role_selection'); }}
                        className={`p-4 rounded-2xl border-2 transition-all flex flex-row items-center justify-between gap-4 relative bg-white
                        ${config.color} hover:shadow-md group`}
                    >
                        <div className="flex items-center gap-4">
                            <div className="relative w-12 h-12 shrink-0">
                                <Image 
                                    src={config.logo} 
                                    alt={dept} 
                                    fill 
                                    className="object-contain"
                                    onError={(e) => {
                                        (e.target as HTMLImageElement).src = '/logo.png'; 
                                    }}
                                />
                            </div>
                            <span className="font-bold text-lg">{dept}</span>
                        </div>
                        <ArrowLeft size={20} className="opacity-0 group-hover:opacity-100 transition-opacity" />
                    </button>
                )
            })}
          </div>

          <div className="mt-10 border-t border-gray-200 pt-6">
             <Button variant="dark" onClick={() => { setSelectedDept('בטיחות ומפעלים'); setSelectedRoleType('safety_admin'); setView('register_form'); }} className="w-full justify-center" icon={<ShieldCheck size={20} className="text-[#8BC34A]" />}>
                הרשמה למחלקת בטיחות ומפעלים
             </Button>
          </div>
        </main>
      </div>
    );
  }

  // --- View: Role Selection ---
  if (view === 'role_selection') {
    return (
      <div className="min-h-screen bg-[#F8F9FA] p-6 flex flex-col items-center">
        <header className="w-full max-w-md flex justify-between items-center mb-8 mt-4">
            <button onClick={() => setView('dept_selection')} className="text-gray-400 hover:text-[#00BCD4]"><ArrowLeft className="rotate-180"/></button>
            <div className="text-xs font-bold text-gray-300">שלב 2 מתוך 3</div>
        </header>

        <main className="w-full max-w-md animate-fadeIn">
          <h2 className="text-2xl font-black text-gray-800 mb-2 text-center">הגדרת תפקיד</h2>
          <p className="text-center text-gray-400 mb-8">מחלקה נבחרת: <span className="font-bold text-[#00BCD4]">{selectedDept}</span></p>
          
          <div className="space-y-4">
            <button onClick={() => { setSelectedRoleType('coordinator'); setView('register_form'); }}
              className="w-full bg-white p-6 rounded-2xl shadow-sm border-2 border-transparent hover:border-pink-400 hover:bg-pink-50 text-right group relative overflow-hidden transition-all">
              <div className="flex items-center justify-between relative z-10">
                  <div>
                    <h3 className="font-black text-lg text-gray-800 group-hover:text-pink-600">{getRoleLabel('coordinator')}</h3>
                    <p className="text-sm text-gray-400 mt-1">ניהול פעילות סניפית והגשת טיולים</p>
                  </div>
                  <Users className="text-gray-200 group-hover:text-pink-300 transition-colors" size={32} />
              </div>
            </button>

            <button onClick={() => { setSelectedRoleType('dept_staff'); setView('register_form'); }}
              className="w-full bg-white p-6 rounded-2xl shadow-sm border-2 border-transparent hover:border-blue-400 hover:bg-blue-50 text-right group relative overflow-hidden transition-all">
              <div className="flex items-center justify-between relative z-10">
                  <div>
                    <h3 className="font-black text-lg text-gray-800 group-hover:text-blue-600">{getRoleLabel('hq')}</h3>
                    <p className="text-sm text-gray-400 mt-1">מטה {selectedDept}</p>
                  </div>
                  <Briefcase className="text-gray-200 group-hover:text-blue-300 transition-colors" size={32} />
              </div>
            </button>
          </div>
        </main>
      </div>
    );
  }

  // --- View: Register Form ---
  if (view === 'register_form') {
    const isSafety = selectedRoleType === 'safety_admin';

    return (
      <div className="min-h-screen bg-[#F8F9FA] p-6 flex flex-col items-center">
        <header className="w-full max-w-md flex justify-between items-center mb-6 mt-4">
            <button onClick={() => isSafety ? setView('dept_selection') : setView('role_selection')} className="text-gray-400 hover:text-[#00BCD4]"><ArrowLeft className="rotate-180"/></button>
            <div className="text-xs font-bold text-gray-300">שלב 3 מתוך 3</div>
        </header>

        {/* תיקון מובייל: הוספנו p-5 למובייל ו-p-8 לדסקטופ */}
        <main className="w-full max-w-md bg-white p-5 md:p-8 rounded-[32px] shadow-sm border border-gray-100 animate-fadeIn">
            
            <h2 className="text-2xl font-black text-gray-800 mb-2">יצירת חשבון</h2>
            <div className="flex items-center gap-2 mb-6">
                <span className={`h-2 w-2 rounded-full ${isSafety ? 'bg-[#8BC34A]' : 'bg-[#00BCD4]'}`}></span>
                <p className="text-sm text-gray-500 font-bold">
                    {isSafety ? 'מחלקת בטיחות ומפעלים' : `${selectedDept} - ${getRoleLabel(selectedRoleType === 'coordinator' ? 'coordinator' : 'hq')}`}
                </p>
            </div>

            <form onSubmit={handleRegister} className="space-y-4">
              
              {selectedRoleType === 'coordinator' && (
                <Input label="שם הסניף" name="branch" required onChange={handleInputChange} />
              )}

              {/* תיקון מובייל: בטלפון שורה אחת (grid-cols-1), במחשב שתיים (md:grid-cols-2) */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <Input label="שם מלא" name="fullName" required onChange={handleInputChange} />
                <Input label="טלפון נייד" name="phone" type="tel" required onChange={handleInputChange} />
              </div>

              <Input label="תעודת זהות" name="idNumber" required maxLength={9} onChange={handleInputChange} />

              {/* תיקון מובייל: בטלפון שורה אחת, במחשב שתיים */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                 <Input label="אימייל" name="email" type="email" required onChange={handleInputChange} />
                 <Input label="תאריך לידה" name="birthDate" type="date" required onChange={handleInputChange} />
              </div>

              <Input label="סיסמה" name="password" type="password" required minLength={6} placeholder="לפחות 6 תווים" onChange={handleInputChange} />

              {errorMsg && <p className="text-red-600 text-sm bg-red-50 p-2 rounded-lg font-bold border border-red-100 text-center">{errorMsg}</p>}
              {successMsg && <div className="text-green-700 text-sm bg-green-50 p-4 rounded-lg font-bold border border-green-200 text-center">{successMsg}</div>}

              <Button type="submit" isLoading={loading} variant={isSafety ? 'dark' : 'primary'} className="w-full mt-6 bg-[#4CAF50] hover:bg-green-600">
                סיום הרשמה
              </Button>
            </form>
        </main>
      </div>
    );
  }

  return null;
}
</file>

<file path="components/layout/ManagerSidebar.tsx">
"use client"

import React, { useEffect, useState } from 'react'
import Link from 'next/link'
import Image from 'next/image'
import { usePathname } from 'next/navigation'
import { supabase } from '@/lib/supabaseClient'
import { 
  LayoutDashboard, CheckSquare, Users, FileBarChart, Settings, LogOut, Mail, UserCircle, X
} from 'lucide-react'

interface SidebarProps {
    isOpen?: boolean;
    onClose?: () => void;
}

export const ManagerSidebar = ({ isOpen = true, onClose }: SidebarProps) => {
  const pathname = usePathname();
  const [isSuperAdmin, setIsSuperAdmin] = useState(false);
  
  const [debugInfo, setDebugInfo] = useState({ detectedEmail: '', contactEmail: '' });

  useEffect(() => {
    const checkRole = async () => {
        const { data: { user } } = await supabase.auth.getUser();
        const ADMIN_EMAIL = 'avremihalperin@gmail.com'; 
        const loginEmail = user?.email?.toLowerCase() || '';
        const contactEmail = user?.user_metadata?.contact_email?.toLowerCase() || '';
        setDebugInfo({ detectedEmail: loginEmail, contactEmail: contactEmail });

        if (loginEmail === ADMIN_EMAIL || contactEmail === ADMIN_EMAIL) {
            setIsSuperAdmin(true);
        }
    };
    checkRole();
  }, []);

  const baseItems = [
    { label: 'לוח בקרה ראשי', href: '/manager', icon: LayoutDashboard, exact: true },
    { label: 'דואר נכנס והודעות', href: '/manager/inbox', icon: Mail },
    { label: 'אישור טיולים', href: '/manager/approvals', icon: CheckSquare },
    { label: 'ניהול משתמשים', href: '/manager/users', icon: Users },
    { label: 'דוחות ונתונים', href: '/manager/reports', icon: FileBarChart },
    { label: 'פרופיל אישי', href: '/manager/profile', icon: UserCircle },
  ];

  const menuItems = isSuperAdmin 
    ? [...baseItems, { label: 'הגדרות מערכת', href: '/manager/settings', icon: Settings }]
    : baseItems;

  const handleLogout = async () => {
    await supabase.auth.signOut();
    window.location.href = '/';
  };

  return (
    <>
        <div 
            className={`fixed inset-0 bg-black/60 z-40 transition-opacity duration-300 md:hidden 
            ${isOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`}
            onClick={onClose}
        ></div>

        <aside className={`w-64 bg-[#1E293B] text-white h-screen fixed right-0 top-0 z-50 flex flex-col shadow-xl border-l border-gray-700 transition-transform duration-300
            ${isOpen ? 'translate-x-0' : 'translate-x-full'} 
            md:translate-x-0`}
        >
          
          <div className="h-32 flex flex-col items-center justify-center border-b border-gray-700 p-6 bg-[#0F172A] relative">
              
              {/* כפתור סגירה - מודגש ולחיץ */}
              <button 
                onClick={onClose} 
                className="absolute top-4 left-4 md:hidden text-white hover:text-red-400 p-2 bg-white/10 rounded-full transition-colors z-50"
              >
                  <X size={24} />
              </button>

              {/* לוגו - הורדנו את הפילטרים כדי שיראו את הלוגו המקורי */}
              <div className="relative w-full h-16 flex items-center justify-center mb-2">
                 <Image 
                    src="/logo.png" 
                    alt="Logo" 
                    width={140} 
                    height={70} 
                    className="object-contain" // הורדנו את brightness-0 invert
                    priority
                 />
              </div>
              <div className="text-[10px] text-gray-400 font-bold bg-gray-800 px-3 py-1 rounded-full uppercase tracking-wider">
                  ממשק ניהול בטיחות
              </div>
          </div>

          <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
            {menuItems.map((item) => {
              const isActive = item.exact ? pathname === item.href : pathname?.startsWith(item.href);
              const Icon = item.icon;
              return (
                <Link 
                    key={item.href} 
                    href={item.href} 
                    onClick={() => { if(onClose) onClose() }}
                    className={`flex items-center gap-3 px-4 py-3.5 rounded-xl transition-all duration-200 font-bold text-sm 
                    ${isActive ? 'bg-[#00BCD4] text-white shadow-lg shadow-cyan-900/20' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}`}
                >
                  <Icon size={20} strokeWidth={isActive ? 2.5 : 2} />
                  {item.label}
                </Link>
              )
            })}
          </nav>

          {!isSuperAdmin && (
              <div className="bg-red-600 text-white text-[10px] p-2 text-center" dir="ltr">
                  Login: {debugInfo.detectedEmail} <br/>
                  Contact: {debugInfo.contactEmail}
              </div>
          )}

          <div className="p-4 border-t border-gray-700 bg-[#0F172A]">
            <button onClick={handleLogout} className="flex items-center gap-3 px-4 py-3.5 rounded-xl w-full text-red-400 hover:bg-red-900/20 transition-all font-bold text-sm">
              <LogOut size={20} /> יציאה מאובטחת
            </button>
          </div>
        </aside>
    </>
  )
}
</file>

</files>
